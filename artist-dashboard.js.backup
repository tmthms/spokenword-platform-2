// ⭐ REPLACE THE ENTIRE artist-dashboard.js FILE with this version

import { getStore, setStore } from './store.js';
import { db } from './firebase.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { doc, updateDoc } from "firebase/firestore";

/**
 * Sets up the artist dashboard
 */
export function setupArtistDashboard() {
  const editBtn = document.getElementById('edit-artist-profile-btn');
  const editor = document.getElementById('artist-profile-editor');
  
  if (!editBtn || !editor) {
    console.warn("Artist dashboard elements not found");
    return;
  }
  
  // Setup edit button toggle
  setupEditProfileButton();
  
  // Setup profile picture preview
  setupProfilePicPreview();
  
  // Handle form submission
  const form = document.getElementById('artist-profile-form');
  if (form) {
    form.addEventListener('submit', handleProfileSubmit);
  }
  
  console.log("Artist dashboard setup complete");
}

/**
 * Setup edit profile button with toggle
 */
function setupEditProfileButton() {
  const editBtn = document.getElementById('edit-artist-profile-btn');
  const editor = document.getElementById('artist-profile-editor');
  
  if (!editBtn || !editor) return;
  
  // Remove old listeners by cloning
  const newBtn = editBtn.cloneNode(true);
  editBtn.parentNode.replaceChild(newBtn, editBtn);
  
  // Add new listener
  newBtn.addEventListener('click', () => {
    const isHidden = editor.style.display === 'none' || editor.style.display === '';
    editor.style.display = isHidden ? 'block' : 'none';
    
    // Populate form when opening
    if (isHidden) {
      populateArtistEditor();
    }
  });
}

/**
 * Setup profile picture preview on file selection
 */
function setupProfilePicPreview() {
  const fileInput = document.getElementById('artist-edit-profile-pic');
  const previewImg = document.getElementById('artist-profile-pic-preview');
  
  if (!fileInput || !previewImg) return;
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        fileInput.value = '';
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        fileInput.value = '';
        return;
      }
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

/**
 * Helper function to set multi-select values
 */
function setSelectValues(selectId, values) {
  const select = document.getElementById(selectId);
  if (!select || !values) return;
  
  // Clear all selections
  for (let option of select.options) {
    option.selected = false;
  }
  
  // Select the provided values
  for (let option of select.options) {
    if (values.includes(option.value)) {
      option.selected = true;
    }
  }
}

/**
 * Populates the editor with current user data
 */
export function populateArtistEditor() {
  const currentUserData = getStore('currentUserData');
  
  if (!currentUserData) {
    console.warn("No artist data found to populate editor");
    return;
  }
  
  console.log("Populating artist editor with:", currentUserData);
  
  // Personal Details
  document.getElementById('artist-edit-firstname').value = currentUserData.firstName || '';
  document.getElementById('artist-edit-lastname').value = currentUserData.lastName || '';
  document.getElementById('artist-edit-stagename').value = currentUserData.stageName || '';
  document.getElementById('artist-edit-phone').value = currentUserData.phone || '';
  document.getElementById('artist-edit-dob').value = currentUserData.dob || '';
  document.getElementById('artist-edit-gender').value = currentUserData.gender || '';
  document.getElementById('artist-edit-location').value = currentUserData.location || '';
  
  // Professional Details (multi-selects)
  setSelectValues('artist-edit-genres', currentUserData.genres || []);
  setSelectValues('artist-edit-languages', currentUserData.languages || []);
  setSelectValues('artist-edit-payment', currentUserData.paymentMethods || []);
  
  // Bio & Pitch
  document.getElementById('artist-edit-bio').value = currentUserData.bio || '';
  document.getElementById('artist-edit-pitch').value = currentUserData.pitch || '';
  
  // Media
  document.getElementById('artist-edit-video').value = currentUserData.videoUrl || '';
  document.getElementById('artist-edit-audio').value = currentUserData.audioUrl || '';
  document.getElementById('artist-edit-text').value = currentUserData.textContent || '';
  
  // Notification Settings
  document.getElementById('artist-edit-notify-email').checked = currentUserData.notifyEmail !== false; // Default true
  document.getElementById('artist-edit-notify-sms').checked = currentUserData.notifySms || false;
  
  // Profile Picture
  const previewImg = document.getElementById('artist-profile-pic-preview');
  if (currentUserData.profilePicUrl) {
    previewImg.src = currentUserData.profilePicUrl;
  } else {
    previewImg.src = "https://placehold.co/100x100/e0e7ff/6366f1?text=" + 
                     encodeURIComponent((currentUserData.stageName || currentUserData.firstName || 'A').charAt(0));
  }
}

/**
 * Helper function to get multi-select values
 */
function getSelectValues(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return [];
  return Array.from(select.selectedOptions).map(option => option.value);
}

/**
 * Handles form submission to save profile changes
 */
async function handleProfileSubmit(e) {
  e.preventDefault();
  
  const successMsg = document.getElementById('artist-profile-success');
  const errorMsg = document.getElementById('artist-profile-error');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');
  
  // Reset messages
  successMsg.textContent = '';
  errorMsg.textContent = '';
  
  // Disable button
  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';
  
  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }
    
    const uid = currentUser.uid;
    const docRef = doc(db, 'artists', uid);
    
    // Collect all form data
    const dataToUpdate = {
      // Personal Details
      firstName: document.getElementById('artist-edit-firstname').value.trim(),
      lastName: document.getElementById('artist-edit-lastname').value.trim(),
      stageName: document.getElementById('artist-edit-stagename').value.trim(),
      phone: document.getElementById('artist-edit-phone').value.trim(),
      dob: document.getElementById('artist-edit-dob').value,
      gender: document.getElementById('artist-edit-gender').value,
      location: document.getElementById('artist-edit-location').value.trim(),
      
      // Professional Details
      genres: getSelectValues('artist-edit-genres'),
      languages: getSelectValues('artist-edit-languages'),
      paymentMethods: getSelectValues('artist-edit-payment'),
      bio: document.getElementById('artist-edit-bio').value.trim(),
      pitch: document.getElementById('artist-edit-pitch').value.trim(),
      
      // Media
      videoUrl: document.getElementById('artist-edit-video').value.trim(),
      audioUrl: document.getElementById('artist-edit-audio').value.trim(),
      textContent: document.getElementById('artist-edit-text').value.trim(),
      
      // Notification Settings
      notifyEmail: document.getElementById('artist-edit-notify-email').checked,
      notifySms: document.getElementById('artist-edit-notify-sms').checked
    };
    
    // Validate required fields
    if (!dataToUpdate.firstName || !dataToUpdate.lastName || !dataToUpdate.phone || 
        !dataToUpdate.dob || !dataToUpdate.gender || !dataToUpdate.location ||
        dataToUpdate.genres.length === 0 || dataToUpdate.languages.length === 0 ||
        dataToUpdate.paymentMethods.length === 0 || !dataToUpdate.bio || !dataToUpdate.pitch) {
      throw new Error("Please fill in all required fields (marked with *)");
    }
    
    // Handle profile picture upload
    const fileInput = document.getElementById('artist-edit-profile-pic');
    const file = fileInput.files[0];
    
    if (file) {
      console.log("Uploading profile picture...");
      const storage = getStorage();
      const storageRef = ref(storage, `artists/${uid}/profile.jpg`);
      
      // Upload file
      const snapshot = await uploadBytes(storageRef, file);
      
      // Get download URL
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Profile picture uploaded:", downloadURL);
      
      // Add URL to data
      dataToUpdate.profilePicUrl = downloadURL;
      
      // Update preview
      document.getElementById('artist-profile-pic-preview').src = downloadURL;
    }
    
    // Update Firestore
    await updateDoc(docRef, dataToUpdate);
    console.log("Profile updated successfully");
    
    // Update local store
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...dataToUpdate });
    
    // Show success message
    successMsg.textContent = '✓ Profile updated successfully!';
    
    // Clear file input
    if (file) {
      fileInput.value = '';
    }
    
    // Scroll to success message
    successMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
  } catch (error) {
    console.error("Error saving profile:", error);
    errorMsg.textContent = 'Error: ' + error.message;
    errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Save All Changes';
  }
}