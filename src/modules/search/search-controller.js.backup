/**
 * search-controller.js
 * Controller that connects data and UI layers
 * Manages event listeners, user interactions, and browser history
 */

import { loadArtistsData, fetchArtistById, requireAuth, isAuthenticatedProgrammer } from './search-data.js';
import { renderArtistSearch, renderArtists, populateArtistDetail } from './search-ui.js';
import { loadRecommendations, openRecommendationModal } from '../recommendations/recommendations.js';
import { getStore } from '../../utils/store.js';
import { showErrorToast } from '../../ui/toast.js';
import { forceSearchResultsVisible, hideProfileSectionsForSearch } from './search-visibility-fix.js';

/**
 * Setup artist search functionality (SECURED)
 * Sets up search button, back button, and browser history
 */
export function setupArtistSearch() {
  console.log("[SETUP ARTIST SEARCH] Starting artist search setup...");

  // ‚úÖ GUARD: Prevent duplicate setup
  const artistSearchSection = document.getElementById('artist-search-section');
  if (artistSearchSection && artistSearchSection.dataset.setupComplete === 'true') {
    console.log("[SETUP ARTIST SEARCH] Already set up, skipping");
    return;
  }

  // Setup mobile pill filters
  setupMobileFilterPills();

  // Setup Clear Filters button
  const clearFiltersBtn = document.getElementById('clear-filters-btn');
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    console.log("[SETUP] Clear filters button listener added");
  }

  // Setup search button
  const searchButton = document.getElementById('search-artists-btn');
  if (searchButton) {
    searchButton.addEventListener('click', loadArtists);
    console.log("[SETUP] Search button listener added");
  } else {
    console.warn("[SETUP] ‚ö†Ô∏è Search button not found in DOM");
  }

  // Setup real-time filtering on filter inputs
  setupFilterListeners();

  // Setup back button for detail view
  const backToSearchBtn = document.getElementById('back-to-search-btn');
  if (backToSearchBtn) {
    backToSearchBtn.addEventListener('click', (e) => {
      e.preventDefault();

      // Security check before navigation
      if (!requireAuth()) return;

      showSearchView();
      // Update browser history
      window.history.pushState({ view: 'search' }, '', '#search');
    });
    console.log("[SETUP] Back button listener added");
  }

  // Setup browser back/forward buttons (SECURED)
  setupBrowserHistory();

  // ‚úÖ Mark setup as complete
  if (artistSearchSection) {
    artistSearchSection.dataset.setupComplete = 'true';
  }

  console.log("[SETUP ARTIST SEARCH] ‚úÖ Artist search setup complete");
}

/**
 * Setup filter change listeners for real-time filtering
 * ‚úÖ FIX: Uses event delegation to handle dynamic filter elements
 */
function setupFilterListeners() {
  const filtersSidebar = document.getElementById('filters-sidebar');
  if (!filtersSidebar) {
    console.warn("[SETUP] Filters sidebar not found");
    return;
  }

  // Check if listener already attached
  if (filtersSidebar.dataset.filtersAttached === 'true') {
    console.log("[SETUP] Filter listeners already attached");
    return;
  }

  // Debounce timer for text inputs
  let debounceTimer;
  const debouncedSearch = () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      loadArtists();
    }, 500); // Wait 500ms after user stops typing
  };

  // ‚úÖ EVENT DELEGATION: Listen on the sidebar container
  filtersSidebar.addEventListener('input', (e) => {
    const target = e.target;

    // Text inputs: name, location, age
    if (target.id === 'filter-name' ||
        target.id === 'filter-location' ||
        target.id === 'filter-age-min' ||
        target.id === 'filter-age-max') {
      debouncedSearch();
    }
  });

  filtersSidebar.addEventListener('change', (e) => {
    const target = e.target;

    // 'Alle Genres' checkbox
    if (target.id === 'genre-all') {
      if (target.checked) {
        // Uncheck all individual genre checkboxes
        const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]');
        genreCheckboxes.forEach(cb => cb.checked = false);
      }
      loadArtists();
      return;
    }

    // Individual genre checkbox
    if (target.name === 'genre-filter') {
      // Uncheck 'Alle Genres' when selecting specific genre
      const allGenresCheckbox = document.getElementById('genre-all');
      if (allGenresCheckbox && target.checked) {
        allGenresCheckbox.checked = false;
      }
      loadArtists();
      return;
    }

    // Gender select
    if (target.id === 'filter-gender') {
      loadArtists();
    }

    // Checkboxes: languages, payment methods
    if (target.name === 'language-filter' ||
        target.name === 'payment-filter') {
      loadArtists();
    }
  });

  // Mark as attached
  filtersSidebar.dataset.filtersAttached = 'true';
  console.log("[SETUP] Filter listeners added via event delegation");

  // Listen for quick genre filter event from cards
  document.addEventListener('quick-genre-filter', () => {
    loadArtists();
  });
  console.log("[SETUP] Quick genre filter listener added");
}

/**
 * Setup mobile filter pill click handlers
 * Opens horizontal sliding bar instead of bottom sheet
 */
function setupMobileFilterPills() {
  const pillGenre = document.getElementById('pill-genre');
  const pillLocation = document.getElementById('pill-location');
  const pillName = document.getElementById('pill-name');
  const pillOther = document.getElementById('pill-other');

  if (pillGenre) {
    pillGenre.addEventListener('click', () => showMobileFilterBar('genre'));
  }

  if (pillLocation) {
    pillLocation.addEventListener('click', () => showMobileFilterBar('location'));
  }

  if (pillName) {
    pillName.addEventListener('click', () => showMobileFilterBar('name'));
  }

  if (pillOther) {
    pillOther.addEventListener('click', () => showMobileFilterBar('other'));
  }

  console.log("[SETUP] Mobile filter pill listeners added (horizontal bar mode)");
}

/**
 * Show horizontal sliding filter bar for mobile
 */
function showMobileFilterBar(type) {
  const filterBar = document.getElementById('mobile-filter-bar');
  const filterBarContent = document.getElementById('mobile-filter-bar-content');

  if (!filterBar || !filterBarContent) return;

  let contentHTML = '';

  switch(type) {
    case 'genre':
      menuHTML = `
        <div class="mobile-filter-panel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Selecteer Genre</h3>
            <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>
          <div class="space-y-2">
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="performance-poetry" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Performance Poetry</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="poetry-slam" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Poetry Slam</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="jazz-poetry" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Jazz Poetry</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="rap" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Rap</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="storytelling" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Storytelling</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="comedy" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>Comedy</span>
            </label>
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
              <input type="checkbox" name="mobile-genre-filter" value="1-on-1" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
              <span>1-op-1 Sessies</span>
            </label>
          </div>
          <button id="apply-mobile-filter" class="w-full mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md font-medium">
            Toepassen
          </button>
        </div>
      `;
      break;

    case 'location':
      menuHTML = `
        <div class="mobile-filter-panel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Locatie</h3>
            <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>
          <input id="mobile-filter-location" type="text" placeholder="Bijv. Brussel, Antwerpen..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <button id="apply-mobile-filter" class="w-full mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md font-medium">
            Toepassen
          </button>
        </div>
      `;
      break;

    case 'name':
      menuHTML = `
        <div class="mobile-filter-panel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Naam</h3>
            <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>
          <input id="mobile-filter-name" type="text" placeholder="Naam van artiest..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <button id="apply-mobile-filter" class="w-full mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md font-medium">
            Toepassen
          </button>
        </div>
      `;
      break;

    case 'other':
      menuHTML = `
        <div class="mobile-filter-panel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Overige Filters</h3>
            <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>

          <select id="mobile-other-filter-type" class="w-full mb-4 px-3 py-2 border border-gray-300 rounded-md">
            <option value="">Kies een filter...</option>
            <option value="gender">Geslacht</option>
            <option value="age">Leeftijd</option>
            <option value="languages">Talen</option>
            <option value="payment">Betaalmethoden</option>
          </select>

          <div id="mobile-other-filter-content"></div>

          <button id="apply-mobile-filter" class="w-full mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md font-medium">
            Toepassen
          </button>
        </div>
      `;
      break;
  }

  menuContainer.innerHTML = menuHTML;
  menuContainer.classList.remove('hidden');
  menuContainer.classList.add('mobile-filter-menu-open');

  // Re-initialize Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }

  // Setup close handler
  const closeBtn = document.getElementById('close-mobile-menu');
  if (closeBtn) {
    closeBtn.addEventListener('click', hideMobileFilterMenu);
  }

  // Setup apply handler
  const applyBtn = document.getElementById('apply-mobile-filter');
  if (applyBtn) {
    applyBtn.addEventListener('click', () => {
      applyMobileFilters(type);
      hideMobileFilterMenu();
    });
  }

  // For 'other' filter, setup dynamic content
  if (type === 'other') {
    const selector = document.getElementById('mobile-other-filter-type');
    if (selector) {
      selector.addEventListener('change', (e) => {
        showOtherFilterContent(e.target.value);
      });
    }
  }

  console.log(`[MOBILE] Filter menu opened: ${type}`);
}

/**
 * Hide mobile filter menu
 */
function hideMobileFilterMenu() {
  const menuContainer = document.getElementById('mobile-filter-menu');
  if (menuContainer) {
    menuContainer.classList.add('hidden');
    menuContainer.classList.remove('mobile-filter-menu-open');
    menuContainer.innerHTML = '';
  }
  console.log("[MOBILE] Filter menu closed");
}

/**
 * Apply mobile filters and sync met desktop sidebar
 */
function applyMobileFilters(type) {
  switch(type) {
    case 'genre':
      const mobileGenreChecks = document.querySelectorAll('input[name="mobile-genre-filter"]:checked');
      const desktopGenreChecks = document.querySelectorAll('input[name="genre-filter"]');

      // Uncheck all desktop
      desktopGenreChecks.forEach(cb => cb.checked = false);

      // Sync mobile -> desktop
      mobileGenreChecks.forEach(cb => {
        const desktopCb = document.querySelector(`input[name="genre-filter"][value="${cb.value}"]`);
        if (desktopCb) desktopCb.checked = true;
      });
      break;

    case 'location':
      const mobileLocation = document.getElementById('mobile-filter-location');
      const desktopLocation = document.getElementById('filter-location');
      if (mobileLocation && desktopLocation) {
        desktopLocation.value = mobileLocation.value;
      }
      break;

    case 'name':
      const mobileName = document.getElementById('mobile-filter-name');
      const desktopName = document.getElementById('filter-name');
      if (mobileName && desktopName) {
        desktopName.value = mobileName.value;
      }
      break;

    case 'other':
      const selectedType = document.getElementById('mobile-other-filter-type')?.value;
      if (selectedType === 'gender') {
        const mobileGender = document.getElementById('mobile-filter-gender');
        const desktopGender = document.getElementById('filter-gender');
        if (mobileGender && desktopGender) {
          desktopGender.value = mobileGender.value;
        }
      } else if (selectedType === 'age') {
        const mobileAgeMin = document.getElementById('mobile-filter-age-min');
        const mobileAgeMax = document.getElementById('mobile-filter-age-max');
        const desktopAgeMin = document.getElementById('filter-age-min');
        const desktopAgeMax = document.getElementById('filter-age-max');
        if (mobileAgeMin && desktopAgeMin) desktopAgeMin.value = mobileAgeMin.value;
        if (mobileAgeMax && desktopAgeMax) desktopAgeMax.value = mobileAgeMax.value;
      } else if (selectedType === 'languages') {
        const mobileLanguageChecks = document.querySelectorAll('input[name="mobile-language-filter"]:checked');
        const desktopLanguageChecks = document.querySelectorAll('input[name="language-filter"]');
        desktopLanguageChecks.forEach(cb => cb.checked = false);
        mobileLanguageChecks.forEach(cb => {
          const desktopCb = document.querySelector(`input[name="language-filter"][value="${cb.value}"]`);
          if (desktopCb) desktopCb.checked = true;
        });
      } else if (selectedType === 'payment') {
        const mobilePaymentChecks = document.querySelectorAll('input[name="mobile-payment-filter"]:checked');
        const desktopPaymentChecks = document.querySelectorAll('input[name="payment-filter"]');
        desktopPaymentChecks.forEach(cb => cb.checked = false);
        mobilePaymentChecks.forEach(cb => {
          const desktopCb = document.querySelector(`input[name="payment-filter"][value="${cb.value}"]`);
          if (desktopCb) desktopCb.checked = true;
        });
      }
      break;
  }

  // Reload artists
  loadArtists();
  console.log(`[MOBILE] Filters applied: ${type}`);
}

/**
 * Show dynamic content for 'other' filter
 */
function showOtherFilterContent(filterType) {
  const container = document.getElementById('mobile-other-filter-content');
  if (!container) return;

  let html = '';

  switch(filterType) {
    case 'gender':
      html = `
        <select id="mobile-filter-gender" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Alle Geslachten</option>
          <option value="f">Vrouw</option>
          <option value="m">Man</option>
          <option value="x">Anders</option>
        </select>
      `;
      break;

    case 'age':
      html = `
        <div class="flex items-center gap-2">
          <input id="mobile-filter-age-min" type="number" placeholder="Min"
                 class="w-1/2 px-3 py-2 border border-gray-300 rounded-md">
          <span>-</span>
          <input id="mobile-filter-age-max" type="number" placeholder="Max"
                 class="w-1/2 px-3 py-2 border border-gray-300 rounded-md">
        </div>
      `;
      break;

    case 'languages':
      html = `
        <div class="space-y-2">
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-language-filter" value="nl" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Nederlands</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-language-filter" value="en" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Engels</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-language-filter" value="fr" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Frans</span>
          </label>
        </div>
      `;
      break;

    case 'payment':
      html = `
        <div class="space-y-2">
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-payment-filter" value="invoice" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Factuur</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-payment-filter" value="payrolling" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Payrolling</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-payment-filter" value="sbk" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>SBK</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-payment-filter" value="volunteer-fee" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Vrijwilligersvergoeding</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="mobile-payment-filter" value="other" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <span>Anders</span>
          </label>
        </div>
      `;
      break;
  }

  container.innerHTML = html;
}

/**
 * Setup browser history management (SECURED)
 */
function setupBrowserHistory() {
  // Handle browser back/forward buttons with security
  window.addEventListener('popstate', (event) => {
    console.log("Popstate event:", event.state);

    // Security check: Block if not authenticated
    if (!isAuthenticatedProgrammer()) {
      console.error("Popstate blocked: User not authenticated");

      // Redirect to login
      const loginView = document.getElementById('login-view');
      if (loginView) {
        loginView.style.display = 'block';
      }

      // Hide programmer views
      document.getElementById('programmer-dashboard')?.classList.add('hidden');
      document.getElementById('artist-detail-view')?.classList.add('hidden');

      return;
    }

    if (event.state) {
      if (event.state.view === 'search') {
        showSearchView();
      } else if (event.state.view === 'artist-detail' && event.state.artistId) {
        showArtistDetail(event.state.artistId, false); // false = don't push to history again
      }
    } else {
      // No state, probably initial page load or back to main
      showSearchView();
    }
  });

  // Set initial state
  if (!window.history.state) {
    window.history.replaceState({ view: 'search' }, '', '#search');
  }
}

/**
 * Load artists with filters (SECURED)
 * Wrapper function that collects filter values, calls data layer, and updates UI
 */
export async function loadArtists() {
  const resultsContainer = document.getElementById('artist-list-container');
  const noResultsDiv = document.getElementById('artist-list-empty');

  if (!resultsContainer) {
    console.error("Artist list container not found!");
    return;
  }

  // Show loading skeleton
  resultsContainer.innerHTML = `
    ${Array(6).fill(0).map(() => `
      <div class="bg-white rounded-2xl shadow-sm overflow-hidden animate-pulse h-full">
        <!-- Skeleton image -->
        <div class="w-24 h-24 md:w-full md:h-64 bg-gray-200"></div>
        <!-- Skeleton content -->
        <div class="p-4 space-y-3">
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
          <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          <div class="h-3 bg-gray-200 rounded w-2/3"></div>
        </div>
      </div>
    `).join('')}
  `;
  if (noResultsDiv) noResultsDiv.classList.add('hidden');

  // Helper function to normalize values (trim, lowercase, replace spaces with dashes)
  const normalize = (value) => {
    if (!value || typeof value !== 'string') return '';
    return value.trim().toLowerCase().replace(/\s+/g, '-');
  };

  try {
    // Collect filter values from UI
    const nameFilter = document.getElementById('filter-name')?.value.toLowerCase().trim() || '';
    const locationFilter = document.getElementById('filter-location')?.value.toLowerCase().trim() || '';
    const genderFilter = document.getElementById('filter-gender')?.value || '';

    // Payment filter (using checkboxes)
    const paymentCheckboxes = document.querySelectorAll('input[name="payment-filter"]:checked');
    const paymentFilters = Array.from(paymentCheckboxes).map(cb => normalize(cb.value));

    // Genre filter (using checkboxes)
    // Check if 'Alle Genres' is selected (bypass genre filtering)
    const genreAllCheckbox = document.getElementById('genre-all');
    let genreFilters = [];
    if (genreAllCheckbox && genreAllCheckbox.checked) {
      // 'Alle Genres' is checked - bypass genre filtering
      genreFilters = null;
    } else {
      const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]:checked');
      genreFilters = Array.from(genreCheckboxes).map(cb => normalize(cb.value));
    }

    // Language filter (using checkboxes)
    const languageCheckboxes = document.querySelectorAll('input[name="language-filter"]:checked');
    const languageFilters = Array.from(languageCheckboxes).map(cb => cb.value.toLowerCase().trim());

    // Age range filter
    const ageMinInput = document.getElementById('filter-age-min')?.value;
    const ageMaxInput = document.getElementById('filter-age-max')?.value;
    const ageMin = ageMinInput ? parseInt(ageMinInput) : null;
    const ageMax = ageMaxInput ? parseInt(ageMaxInput) : null;

    // Call data layer with filters
    const artists = await loadArtistsData({
      nameFilter,
      locationFilter,
      genderFilter,
      paymentFilters,
      genreFilters,
      languageFilters,
      ageMin,
      ageMax
    });

    // Update UI with results
    if (artists.length === 0) {
      resultsContainer.innerHTML = '';
      if (noResultsDiv) noResultsDiv.classList.remove('hidden');
    } else {
      if (noResultsDiv) noResultsDiv.classList.add('hidden');

      // üî• NUCLEAR OPTION 1: Force visibility BEFORE rendering
      console.log('[LOAD ARTISTS] üî• STEP 1: FORCE VISIBILITY ON CONTAINERS BEFORE RENDER');

      // Force container visibility
      resultsContainer.classList.remove('hidden');
      resultsContainer.style.display = 'grid';
      resultsContainer.style.opacity = '1';
      resultsContainer.style.visibility = 'visible';
      resultsContainer.style.zIndex = '1';
      resultsContainer.style.minHeight = '200px';
      console.log('[LOAD ARTISTS] ‚úÖ Container forced visible:', resultsContainer);

      // Force parent <main> visibility
      const resultsMain = document.getElementById('artist-results-main');
      if (resultsMain) {
        resultsMain.classList.remove('hidden');
        resultsMain.style.display = 'block';
        resultsMain.style.opacity = '1';
        resultsMain.style.visibility = 'visible';
        resultsMain.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Parent <main> forced visible:', resultsMain);
      } else {
        console.error('[LOAD ARTISTS] ‚ùå Parent <main> NOT FOUND!');
      }

      // Force artist search section visibility
      const artistSearchSection = document.getElementById('artist-search-section');
      if (artistSearchSection) {
        artistSearchSection.classList.remove('hidden');
        artistSearchSection.style.display = 'block';
        artistSearchSection.style.opacity = '1';
        artistSearchSection.style.visibility = 'visible';
        artistSearchSection.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Search section forced visible:', artistSearchSection);
      }

      // Force programmer dashboard visibility
      const programmerDashboard = document.getElementById('programmer-dashboard');
      if (programmerDashboard) {
        programmerDashboard.classList.remove('hidden');
        programmerDashboard.style.display = 'block';
        programmerDashboard.style.opacity = '1';
        programmerDashboard.style.visibility = 'visible';
        programmerDashboard.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Programmer dashboard forced visible:', programmerDashboard);
      }

      console.log('[LOAD ARTISTS] üî• STEP 2: RENDER ARTISTS');
      renderArtists(artists);

      // üî• NUCLEAR OPTION 2: Force visibility AFTER rendering (double-check)
      console.log('[LOAD ARTISTS] üî• STEP 3: FORCE VISIBILITY AFTER RENDER (DOUBLE-CHECK)');
      forceSearchResultsVisible();

      // Setup event delegation for artist card clicks (only once)
      setupArtistCardClickHandlers();

      console.log('[LOAD ARTISTS] ‚úÖ Rendered and forced visibility on', artists.length, 'artist cards');
    }

  } catch (error) {
    console.error("‚ùå Error loading artists:", error);

    // Check if it's a Firestore index error
    if (error.message && error.message.includes('index')) {
      console.error("üîó FIRESTORE INDEX REQUIRED!");
      console.error("Click this link to create the index:", error.message.match(/https:\/\/[^\s]+/)?.[0]);
    }

    const errorMessage = error.message || 'Error loading artists. Please try again.';

    resultsContainer.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-800 font-semibold">Error loading artists</p>
        <p class="text-red-600 text-sm mt-2">${error.message}</p>
        ${error.message.includes('index') ?
          `<p class="text-red-600 text-sm mt-2">Please check the console for a link to create the required Firestore index.</p>` :
          ''}
      </div>
    `;

    // Show toast notification
    showErrorToast(errorMessage);
  }
}

/**
 * Setup event delegation for artist card clicks
 * ‚úÖ FIX: Uses event delegation on container to handle dynamic cards
 */
function setupArtistCardClickHandlers() {
  const resultsContainer = document.getElementById('artist-list-container');
  if (!resultsContainer) {
    console.warn('[ARTIST CARDS] Results container not found');
    return;
  }

  // Check if listener already attached
  if (resultsContainer.dataset.clickHandlerAttached === 'true') {
    console.log('[ARTIST CARDS] Click handler already attached');
    return;
  }

  // Use event delegation on the container
  resultsContainer.addEventListener('click', (e) => {
    // Find the closest artist card
    const card = e.target.closest('.artist-card');
    if (card && card.dataset.artistId) {
      const artistId = card.dataset.artistId;
      console.log('[ARTIST CARDS] Card clicked, artist ID:', artistId);
      showArtistDetail(artistId);
    }
  });

  // Mark as attached
  resultsContainer.dataset.clickHandlerAttached = 'true';
  console.log('[ARTIST CARDS] Click handler attached via event delegation');
}

/**
 * Show artist detail view (SECURED)
 */
export async function showArtistDetail(artistId, pushHistory = true) {
  // Security check: Only allow authenticated programmers
  if (!requireAuth()) {
    console.error("Show artist detail blocked: Authentication required");
    return;
  }

  try {
    console.log("Loading artist detail:", artistId);

    // Fetch artist data from data layer
    const artist = await fetchArtistById(artistId);

    if (!artist) {
      alert("Artist not found");
      return;
    }

    // Vul de detail view met de data (UI layer)
    populateArtistDetail(artist);

    // Toon de detail view en verberg de search results
    document.getElementById('programmer-dashboard').style.display = 'none';
    const detailView = document.getElementById('artist-detail-view');
    detailView.style.display = 'block';

    // Store artistId in detail view for later use
    detailView.dataset.artistId = artistId;

    // Load recommendations for this artist
    loadRecommendations(artistId);

    // Setup "Write Recommendation" button (only for programmers)
    const writeRecommendationBtn = document.getElementById('write-recommendation-btn');
    if (writeRecommendationBtn) {
      const currentUserData = getStore('currentUserData');
      if (currentUserData && currentUserData.role === 'programmer') {
        writeRecommendationBtn.classList.remove('hidden');
        writeRecommendationBtn.onclick = () => openRecommendationModal(artistId, artist);
      } else {
        writeRecommendationBtn.classList.add('hidden');
      }
    }

    // Push to browser history
    if (pushHistory) {
      window.history.pushState(
        { view: 'artist-detail', artistId: artistId },
        '',
        `#artist/${artistId}`
      );
    }

    // Scroll naar boven
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Activeer Lucide icons
    if (window.lucide) {
      window.lucide.createIcons();
    }

  } catch (error) {
    console.error("Error loading artist detail:", error);
    const errorMessage = error.message || 'Could not load artist details. Please try again.';
    showErrorToast(errorMessage);
  }
}

/**
 * Gaat terug naar de search results view (SECURED)
 */
function showSearchView() {
  // Security check
  if (!requireAuth()) {
    return;
  }

  document.getElementById('artist-detail-view').style.display = 'none';
  document.getElementById('programmer-dashboard').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Clear all filter inputs and checkboxes
 * Then reload artists with no filters
 */
function clearAllFilters() {
  console.log("[CLEAR FILTERS] Clearing all filters...");

  // Clear text inputs
  const filterName = document.getElementById('filter-name');
  const filterLocation = document.getElementById('filter-location');
  const filterAgeMin = document.getElementById('filter-age-min');
  const filterAgeMax = document.getElementById('filter-age-max');

  if (filterName) filterName.value = '';
  if (filterLocation) filterLocation.value = '';
  if (filterAgeMin) filterAgeMin.value = '';
  if (filterAgeMax) filterAgeMax.value = '';

  // Reset gender select
  const filterGender = document.getElementById('filter-gender');
  if (filterGender) filterGender.value = '';

  // Uncheck 'Alle Genres' checkbox
  const genreAllCheckbox = document.getElementById('genre-all');
  if (genreAllCheckbox) genreAllCheckbox.checked = false;

  // Uncheck all genre checkboxes
  const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]');
  genreCheckboxes.forEach(cb => cb.checked = false);

  // Uncheck all language checkboxes
  const languageCheckboxes = document.querySelectorAll('input[name="language-filter"]');
  languageCheckboxes.forEach(cb => cb.checked = false);

  // Uncheck all payment checkboxes
  const paymentCheckboxes = document.querySelectorAll('input[name="payment-filter"]');
  paymentCheckboxes.forEach(cb => cb.checked = false);

  console.log("[CLEAR FILTERS] ‚úÖ All filters cleared");

  // Reload artists with no filters
  loadArtists();
}
