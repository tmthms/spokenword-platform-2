/**
 * IMPROVED programmer-dashboard.js v2.1
 * Met age filtering, payment filtering, en browser history
 */

import { collection, getDocs, query, where, doc, getDoc, updateDoc } from "firebase/firestore";
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { db } from './firebase.js';
import { getStore, setStore } from './store.js';
import { openMessageModal } from './messaging.js';

/**
 * Setup programmer dashboard
 */
export function setupProgrammerDashboard() {
  // Setup search button
  const searchButton = document.getElementById('search-artists-btn');
  if (searchButton) {
    searchButton.addEventListener('click', loadArtists);
    console.log("Search button listener added");
  }
  
  // Setup back button for detail view
  const backToSearchBtn = document.getElementById('back-to-search-btn');
  if (backToSearchBtn) {
    backToSearchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showSearchView();
      // Update browser history
      window.history.pushState({ view: 'search' }, '', '#search');
    });
  }
  
  // Setup profile editor
  setupProgrammerProfileEditor();
  
  // Display profile overview
  displayProgrammerProfileOverview();
  
  // Setup browser back/forward buttons
  setupBrowserHistory();
  
  console.log("Programmer dashboard setup complete");
}

/**
 * Setup browser history management
 */
function setupBrowserHistory() {
  // Handle browser back/forward buttons
  window.addEventListener('popstate', (event) => {
    console.log("Popstate event:", event.state);
    
    if (event.state) {
      if (event.state.view === 'search') {
        showSearchView();
      } else if (event.state.view === 'artist-detail' && event.state.artistId) {
        showArtistDetail(event.state.artistId, false); // false = don't push to history again
      }
    } else {
      // No state, probably initial page load or back to main
      showSearchView();
    }
  });
  
  // Set initial state
  if (!window.history.state) {
    window.history.replaceState({ view: 'search' }, '', '#search');
  }
}

/**
 * Displays the programmer profile overview
 */
function displayProgrammerProfileOverview() {
  const currentUserData = getStore('currentUserData');
  const currentUser = getStore('currentUser');
  
  if (!currentUserData) {
    console.warn("No programmer data found for overview");
    return;
  }
  
  // Profile Picture
  const overviewPic = document.getElementById('programmer-overview-pic');
  if (overviewPic) {
    overviewPic.src = currentUserData.profilePicUrl || 
                      `https://placehold.co/200x200/e0e7ff/6366f1?text=${encodeURIComponent((currentUserData.firstName || 'P').charAt(0))}`;
  }
  
  // Name & Organization
  document.getElementById('programmer-overview-name').textContent = 
    `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim() || 'Programmer Name';
  document.getElementById('programmer-overview-org').textContent = 
    currentUserData.organizationName || 'Organization Name';
  
  // Contact Info
  document.getElementById('programmer-overview-email').textContent = currentUser?.email || 'email@example.com';
  document.getElementById('programmer-overview-phone').textContent = currentUserData.phone || 'Not specified';
  
  // Website
  const websiteElement = document.getElementById('programmer-overview-website');
  if (currentUserData.website) {
    websiteElement.href = currentUserData.website;
    websiteElement.textContent = currentUserData.website.replace(/^https?:\/\//, '');
  } else {
    websiteElement.href = '#';
    websiteElement.textContent = 'Not specified';
  }
  
  // About
  document.getElementById('programmer-overview-about').textContent = 
    currentUserData.organizationAbout || 'No description available';
}

/**
 * Setup programmer profile editor
 */
function setupProgrammerProfileEditor() {
  const editBtn = document.getElementById('edit-programmer-profile-btn');
  const editor = document.getElementById('programmer-profile-editor');
  const overview = document.getElementById('programmer-profile-overview');
  
  if (!editBtn || !editor || !overview) {
    console.warn("Programmer profile editor elements not found");
    return;
  }
  
  // Remove old listeners
  const newBtn = editBtn.cloneNode(true);
  editBtn.parentNode.replaceChild(newBtn, editBtn);
  
  // Add new listener
  newBtn.addEventListener('click', () => {
    const isHidden = editor.classList.contains('hidden');
    
    if (isHidden) {
      editor.classList.remove('hidden');
      overview.classList.add('hidden');
      populateProgrammerEditor();
    } else {
      editor.classList.add('hidden');
      overview.classList.remove('hidden');
      displayProgrammerProfileOverview();
    }
  });
  
  // Setup profile picture preview
  const fileInput = document.getElementById('programmer-edit-profile-pic');
  const previewImg = document.getElementById('programmer-profile-pic-preview');
  
  if (fileInput && previewImg) {
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          fileInput.value = '';
          return;
        }
        
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          fileInput.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          previewImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }
  
  // Handle form submission
  const form = document.getElementById('programmer-profile-form');
  if (form) {
    form.addEventListener('submit', handleProgrammerProfileSubmit);
  }
}

/**
 * Populates the programmer editor with current data
 */
function populateProgrammerEditor() {
  const currentUserData = getStore('currentUserData');
  
  if (!currentUserData) {
    console.warn("No programmer data found to populate editor");
    return;
  }
  
  console.log("Populating programmer editor with:", currentUserData);
  
  document.getElementById('programmer-edit-firstname').value = currentUserData.firstName || '';
  document.getElementById('programmer-edit-lastname').value = currentUserData.lastName || '';
  document.getElementById('programmer-edit-phone').value = currentUserData.phone || '';
  document.getElementById('programmer-edit-org-name').value = currentUserData.organizationName || '';
  document.getElementById('programmer-edit-org-about').value = currentUserData.organizationAbout || '';
  document.getElementById('programmer-edit-website').value = currentUserData.website || '';
  
  const previewImg = document.getElementById('programmer-profile-pic-preview');
  if (currentUserData.profilePicUrl) {
    previewImg.src = currentUserData.profilePicUrl;
  } else {
    previewImg.src = `https://placehold.co/100x100/e0e7ff/6366f1?text=${encodeURIComponent((currentUserData.firstName || 'P').charAt(0))}`;
  }
}

/**
 * Handles programmer profile form submission
 */
async function handleProgrammerProfileSubmit(e) {
  e.preventDefault();
  
  const successMsg = document.getElementById('programmer-profile-success');
  const errorMsg = document.getElementById('programmer-profile-error');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');
  
  // Reset messages
  successMsg.textContent = '';
  errorMsg.textContent = '';
  
  // Disable button
  submitBtn.disabled = true;
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Saving...';
  
  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }
    
    const uid = currentUser.uid;
    const docRef = doc(db, 'programmers', uid);
    
    // Collect form data
    const dataToUpdate = {
      firstName: document.getElementById('programmer-edit-firstname').value.trim(),
      lastName: document.getElementById('programmer-edit-lastname').value.trim(),
      phone: document.getElementById('programmer-edit-phone').value.trim(),
      organizationName: document.getElementById('programmer-edit-org-name').value.trim(),
      organizationAbout: document.getElementById('programmer-edit-org-about').value.trim(),
      website: document.getElementById('programmer-edit-website').value.trim()
    };
    
    // Validate required fields
    if (!dataToUpdate.firstName || !dataToUpdate.lastName || !dataToUpdate.organizationName) {
      throw new Error("Please fill in all required fields (marked with *)");
    }
    
    // Handle profile picture upload
    const fileInput = document.getElementById('programmer-edit-profile-pic');
    const file = fileInput.files[0];
    
    if (file) {
      console.log("Uploading profile picture...");
      const storage = getStorage();
      const storageRef = ref(storage, `programmers/${uid}/profile.jpg`);
      
      const snapshot = await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Profile picture uploaded:", downloadURL);
      
      dataToUpdate.profilePicUrl = downloadURL;
      document.getElementById('programmer-profile-pic-preview').src = downloadURL;
    }
    
    // Update Firestore
    await updateDoc(docRef, dataToUpdate);
    console.log("Programmer profile updated successfully");
    
    // Update local store
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...dataToUpdate });
    
    // Show success message
    successMsg.textContent = '✓ Profile updated successfully!';
    
    // Clear file input
    if (file) {
      fileInput.value = '';
    }
    
    // Update overview and switch back to it
    displayProgrammerProfileOverview();
    document.getElementById('programmer-profile-editor').classList.add('hidden');
    document.getElementById('programmer-profile-overview').classList.remove('hidden');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
  } catch (error) {
    console.error("Error saving programmer profile:", error);
    errorMsg.textContent = 'Error: ' + error.message;
    errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

/**
 * Calculate age from date of birth
 */
function calculateAge(dob) {
  const birthDate = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  return age;
}

/**
 * Haalt artiesten op uit Firestore op basis van de actieve filters.
 * NOW WITH AGE AND PAYMENT FILTERING!
 */
export async function loadArtists() {
  const artistListContainer = document.getElementById('artist-list-container');
  let artistListEmpty = document.getElementById('artist-list-empty');
  
  // FIX: Als het element niet bestaat, maak het dan aan
  if (!artistListEmpty && artistListContainer) {
    console.warn("artist-list-empty niet gevonden, element wordt aangemaakt");
    artistListEmpty = document.createElement('p');
    artistListEmpty.id = 'artist-list-empty';
    artistListEmpty.className = 'text-gray-500';
    artistListContainer.appendChild(artistListEmpty);
  }
  
  if (!artistListContainer || !artistListEmpty) {
    console.error("Required elements not found!", {
      artistListContainer: !!artistListContainer,
      artistListEmpty: !!artistListEmpty
    });
    return;
  }

  console.log("Artiesten laden...");
  artistListEmpty.textContent = "Artiesten laden...";
  artistListEmpty.style.display = 'block';
  artistListContainer.innerHTML = '';
  
  try {
    // 1. Bouw de basis-query
    let artistQuery = query(collection(db, "artists"));

    // 2. Haal filterwaarden op
    const name = document.getElementById('filter-name').value.trim();
    const location = document.getElementById('filter-location').value.trim();
    const gender = document.getElementById('filter-gender').value;
    const genre = document.getElementById('filter-genre').value;
    const language = document.getElementById('filter-language').value;
    const paymentMethod = document.getElementById('filter-payment').value;
    const ageFrom = document.getElementById('filter-age-from').value;
    const ageTo = document.getElementById('filter-age-to').value;

    console.log("Filter values:", { name, location, gender, genre, language, paymentMethod, ageFrom, ageTo });

    // 3. Voeg 'where' clausules toe (Firestore server-side filtering)
    if (location) {
      artistQuery = query(artistQuery, where("location", "==", location));
    }
    if (gender) {
      artistQuery = query(artistQuery, where("gender", "==", gender));
    }
    if (genre) {
      artistQuery = query(artistQuery, where("genres", "array-contains", genre));
    }
    if (language) {
      artistQuery = query(artistQuery, where("languages", "array-contains", language));
    }
    // Payment method filtering (NEW!)
    if (paymentMethod) {
      artistQuery = query(artistQuery, where("paymentMethods", "array-contains", paymentMethod));
    }

    // 4. Voer de query uit
    const querySnapshot = await getDocs(artistQuery);
    
    let artists = [];
    querySnapshot.forEach((doc) => {
      artists.push({ id: doc.id, ...doc.data() });
    });

    console.log(`Found ${artists.length} artists before client-side filtering`);

    // 5. Client-side filtering op naam
    if (name) {
      artists = artists.filter(artist => 
        (artist.firstName && artist.firstName.toLowerCase().includes(name.toLowerCase())) ||
        (artist.lastName && artist.lastName.toLowerCase().includes(name.toLowerCase())) ||
        (artist.stageName && artist.stageName.toLowerCase().includes(name.toLowerCase()))
      );
    }
    
    // 6. Client-side AGE filtering (NEW!)
    if (ageFrom || ageTo) {
      artists = artists.filter(artist => {
        if (!artist.dob) return false; // Skip artists without DOB
        
        const age = calculateAge(artist.dob);
        
        // Check age from
        if (ageFrom && age < parseInt(ageFrom)) {
          return false;
        }
        
        // Check age to
        if (ageTo && age > parseInt(ageTo)) {
          return false;
        }
        
        return true;
      });
    }
    
    console.log(`${artists.length} artists after all filtering`);
    
    // 7. Toon de resultaten
    displayArtists(artists);

  } catch (error) {
    console.error("Fout bij laden van artiesten:", error);
    artistListEmpty.textContent = "Fout bij laden van artiesten. Controleer de console (en Firestore Indexes).";
    artistListEmpty.style.display = 'block';
  }
}

/**
 * Toont de lijst met artiesten op de pagina.
 */
async function displayArtists(artists) {
  const artistListContainer = document.getElementById('artist-list-container');
  let artistListEmpty = document.getElementById('artist-list-empty');
  
  // FIX: Als het element niet bestaat, maak het dan aan
  if (!artistListEmpty && artistListContainer) {
    console.warn("artist-list-empty niet gevonden in displayArtists, element wordt aangemaakt");
    artistListEmpty = document.createElement('p');
    artistListEmpty.id = 'artist-list-empty';
    artistListEmpty.className = 'text-gray-500';
    artistListContainer.appendChild(artistListEmpty);
  }
  
  if (!artistListContainer || !artistListEmpty) {
    console.error("displayArtists: Required elements not found!", {
      artistListContainer: !!artistListContainer,
      artistListEmpty: !!artistListEmpty
    });
    return;
  }
  
  if (artists.length === 0) {
    artistListEmpty.textContent = "Geen artiesten gevonden die aan uw criteria voldoen.";
    artistListEmpty.style.display = 'block';
    return;
  }
  
  artistListEmpty.style.display = 'none';
  
  // Maak voor elke artiest een HTML-kaart
  for (const artist of artists) {
    let imageUrl = "https://placehold.co/400x300/e0e7ff/6366f1?text=Geen+Foto";
    if (artist.profilePicUrl) {
      imageUrl = artist.profilePicUrl;
    }

    const artistCard = document.createElement('div');
    artistCard.className = "bg-white shadow-lg rounded-lg overflow-hidden flex flex-col md:flex-row cursor-pointer hover:shadow-xl transition duration-300";
    
    artistCard.innerHTML = `
      <img class="h-56 w-full md:w-48 object-cover flex-shrink-0" src="${imageUrl}" alt="Profielfoto van ${artist.stageName || artist.firstName}">
      <div class="p-6">
        <h4 class="text-2xl font-semibold">${artist.stageName || `${artist.firstName} ${artist.lastName}`}</h4>
        <p class="text-indigo-600 font-medium">${(artist.genres || []).join(', ')}</p>
        <p class="text-gray-600 mt-2"><i data-lucide="map-pin" class="inline-block h-4 w-4 mr-1"></i>${artist.location || 'Geen locatie'}</p>
        <p class="text-gray-700 mt-3">${artist.pitch || 'Geen pitch beschikbaar.'}</p>
        <p class="text-indigo-600 mt-4 font-medium">Click to view full profile →</p>
      </div>
    `;
    
    // Voeg click event toe om de detail view te tonen
    artistCard.addEventListener('click', () => showArtistDetail(artist.id));
    
    artistListContainer.appendChild(artistCard);
  }
  
  // Activeer Lucide-iconen
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * Toont de detail view van een specifieke artiest
 * @param {string} artistId - The artist ID
 * @param {boolean} pushHistory - Whether to push to browser history (default: true)
 */
async function showArtistDetail(artistId, pushHistory = true) {
  console.log("Loading artist detail for:", artistId);
  
  try {
    // Haal de artiest data op uit Firestore
    const artistRef = doc(db, 'artists', artistId);
    const artistSnap = await getDoc(artistRef);
    
    if (!artistSnap.exists()) {
      console.error("Artist not found:", artistId);
      alert("Artist not found.");
      return;
    }
    
    const artist = { id: artistSnap.id, ...artistSnap.data() };
    
    // Vul de detail view met de data
    populateArtistDetail(artist);
    
    // Toon de detail view en verberg de search results
    document.getElementById('programmer-dashboard').style.display = 'none';
    document.getElementById('artist-detail-view').style.display = 'block';
    
    // Push to browser history
    if (pushHistory) {
      window.history.pushState(
        { view: 'artist-detail', artistId: artistId }, 
        '', 
        `#artist/${artistId}`
      );
    }
    
    // Scroll naar boven
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Activeer Lucide icons
    if (window.lucide) {
      window.lucide.createIcons();
    }
    
  } catch (error) {
    console.error("Error loading artist detail:", error);
    alert("Could not load artist details: " + error.message);
  }
}

/**
 * Vult de detail view met artiest data
 */
function populateArtistDetail(artist) {
  // Profile Picture
  const detailProfilePic = document.getElementById('detail-profile-pic');
  if (detailProfilePic) {
    detailProfilePic.src = artist.profilePicUrl || "https://placehold.co/400x400/e0e7ff/6366f1?text=No+Photo";
  }
  
  // Basic Info
  document.getElementById('detail-artist-name').textContent = `${artist.firstName || ''} ${artist.lastName || ''}`.trim();
  document.getElementById('detail-stage-name').textContent = artist.stageName || 'N/A';
  document.getElementById('detail-location').textContent = artist.location || 'Not specified';
  
  // Gender
  const genderMap = { 'f': 'Female', 'm': 'Male', 'x': 'Other' };
  document.getElementById('detail-gender').textContent = genderMap[artist.gender] || 'Not specified';
  
  // Age
  if (artist.dob) {
    document.getElementById('detail-age').textContent = `${calculateAge(artist.dob)} years old`;
  } else {
    document.getElementById('detail-age').textContent = 'Age not specified';
  }
  
  // Genres
  const detailGenres = document.getElementById('detail-genres');
  detailGenres.innerHTML = '';
  if (artist.genres && artist.genres.length > 0) {
    artist.genres.forEach(genre => {
      const badge = document.createElement('span');
      badge.className = 'inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium';
      badge.textContent = genre;
      detailGenres.appendChild(badge);
    });
  } else {
    detailGenres.textContent = 'No genres specified';
  }
  
  // Languages
  const detailLanguages = document.getElementById('detail-languages');
  detailLanguages.innerHTML = '';
  if (artist.languages && artist.languages.length > 0) {
    artist.languages.forEach(lang => {
      const badge = document.createElement('span');
      badge.className = 'inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
      badge.textContent = lang.toUpperCase();
      detailLanguages.appendChild(badge);
    });
  } else {
    detailLanguages.textContent = 'No languages specified';
  }
  
  // Bio & Pitch
  document.getElementById('detail-bio').textContent = artist.bio || 'No bio available.';
  document.getElementById('detail-pitch').textContent = artist.pitch || 'No pitch available.';
  
  // Video Material
  if (artist.videoUrl && artist.videoUrl.trim()) {
    document.getElementById('detail-video-section').style.display = 'block';
    const embedUrl = getEmbedUrl(artist.videoUrl, 'video');
    if (embedUrl) {
      document.getElementById('detail-video-container').innerHTML = `
        <iframe class="w-full h-full" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      `;
    } else {
      document.getElementById('detail-video-container').innerHTML = `
        <div class="flex items-center justify-center h-full">
          <a href="${artist.videoUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium">View Video (External Link)</a>
        </div>
      `;
    }
  } else {
    document.getElementById('detail-video-section').style.display = 'none';
  }
  
  // Audio Material
  if (artist.audioUrl && artist.audioUrl.trim()) {
    document.getElementById('detail-audio-section').style.display = 'block';
    const embedUrl = getEmbedUrl(artist.audioUrl, 'audio');
    if (embedUrl) {
      document.getElementById('detail-audio-container').innerHTML = `
        <iframe class="w-full" height="166" scrolling="no" frameborder="no" allow="autoplay" src="${embedUrl}"></iframe>
      `;
    } else {
      document.getElementById('detail-audio-container').innerHTML = `
        <a href="${artist.audioUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium">Listen to Audio (External Link)</a>
      `;
    }
  } else {
    document.getElementById('detail-audio-section').style.display = 'none';
  }
  
  // Text Material
  if (artist.textContent && artist.textContent.trim()) {
    document.getElementById('detail-text-section').style.display = 'block';
    document.getElementById('detail-text-content').textContent = artist.textContent;
  } else {
    document.getElementById('detail-text-section').style.display = 'none';
  }
  
  // Document Material
  const documentSection = document.getElementById('detail-document-section');
  const documentLink = document.getElementById('detail-document-link');
  
  if (artist.documentUrl && artist.documentUrl.trim()) {
    documentSection.style.display = 'block';
    documentLink.href = artist.documentUrl;
    documentLink.textContent = artist.documentName || 'Download/View Document';
  } else {
    documentSection.style.display = 'none';
  }
  
  // Contact Information - Access Control
  const currentUserData = getStore('currentUserData');
  const isPro = currentUserData && currentUserData.status === 'pro';
  
  if (isPro) {
    // Show contact info for Pro users
    document.getElementById('detail-trial-message').style.display = 'none';
    document.getElementById('detail-contact-info').style.display = 'block';
    
    document.getElementById('detail-email').textContent = artist.email || 'Not available';
    document.getElementById('detail-email').href = `mailto:${artist.email || ''}`;
    
    document.getElementById('detail-phone').textContent = artist.phone || 'Not available';
    document.getElementById('detail-phone').href = `tel:${artist.phone || ''}`;
    
    // Setup Send Message button
    const sendMessageBtn = document.getElementById('send-message-btn');
    if (sendMessageBtn) {
      // Remove any existing listeners
      const newBtn = sendMessageBtn.cloneNode(true);
      sendMessageBtn.parentNode.replaceChild(newBtn, sendMessageBtn);
      
      // Add new listener
      newBtn.addEventListener('click', () => {
        openMessageModal(artist);
      });
    }
  } else {
    // Show upgrade message for Trial users
    document.getElementById('detail-trial-message').style.display = 'block';
    document.getElementById('detail-contact-info').style.display = 'none';
  }
}

/**
 * Converteert een video/audio URL naar een embed URL
 */
function getEmbedUrl(url, type) {
  if (!url) return null;
  
  if (type === 'video') {
    // YouTube
    const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
    if (youtubeMatch) {
      return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
    }
    
    // Vimeo
    const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
    if (vimeoMatch) {
      return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
    }
  }
  
  if (type === 'audio') {
    // SoundCloud
    if (url.includes('soundcloud.com')) {
      return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
    }
    
    // Spotify
    const spotifyMatch = url.match(/spotify\.com\/(track|album|playlist)\/([^?]+)/);
    if (spotifyMatch) {
      return `https://open.spotify.com/embed/${spotifyMatch[1]}/${spotifyMatch[2]}`;
    }
  }
  
  return null;
}

/**
 * Gaat terug naar de search results view
 */
function showSearchView() {
  document.getElementById('artist-detail-view').style.display = 'none';
  document.getElementById('programmer-dashboard').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}