This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  settings.local.json
.github/
  workflows/
    deploy.yml
functions/
  .gitignore
  index.js
  package.json
scripts/
  validate-env.cjs
src/
  modules/
    artist/
      artist-media.js
      artist-own-profile.js
    calendar/
      calendar-controller.js
      calendar-map.js
      calendar-service.js
      calendar-ui.js
      calendar-views.js
      poster-generator.js
    dashboard/
      dashboard-controller.js
      dashboard-service.js
      dashboard-ui.js
      media-gallery.js
    messaging/
      messaging-controller.js
      messaging-service.js
      messaging-ui.js
    navigation/
      navigation.js
    programmer/
      programmer-dashboard.js
      programmer-profile.js
    recommendations/
      recommendations.js
    search/
      profile-chat.js
      search-controller.js
      search-data.js
      search-lightbox.js
      search-ui.js
      search-visibility-fix.js
    settings/
      user-settings.js
  services/
    auth.js
    data.js
    firebase.js
  ui/
    toast.js
    ui.js
    view-renderers.js
  utils/
    checkbox-helpers.js
    store.js
    translations.js
.gitignore
Development_Notes.md
firebase.json
firestore.indexes.json
firestore.rules
index.html
main.js
MOBILE-UI-IMPROVEMENTS.md
normalize-genres-admin.js
normalize-genres-auto.sh
normalize-genres-cli.js
package.json
postcss.config.js
REFACTOR_SUMMARY.md
run-once-normalize-genres.js
seed-energy-keywords.js
seed-test-data-local.js
seed-test-data.js
setup-service-account.sh
storage.rules
style.css
tailwind.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(npm run dev:*)",
      "Bash(node:*)",
      "Bash(curl:*)",
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(grep:*)",
      "Bash(ping:*)",
      "Bash(nc -zv -w 5 community.dansdichterdans.be 21:*)",
      "WebFetch(domain:community.dansdichterdans.be)",
      "Bash(md5:*)",
      "Bash(zip:*)",
      "Bash(firebase use:*)",
      "Bash(npm i:*)",
      "Bash(sudo npm i:*)",
      "Bash(awk:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nRefactor: Move artist-dashboard HTML to JS render function\n\n- Create renderArtistDashboard\\(\\) function in artist-dashboard.js\n- Replace static HTML in index.html with empty container\n- Call renderArtistDashboard\\(\\) from ui.js when showing artist dashboard\n- Maintains all existing functionality while improving code organization\n\nü§ñ Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nRefactor: Move programmer-dashboard HTML to JS render function\n\n- Create renderProgrammerDashboard\\(\\) function in programmer-dashboard.js\n- Replace static HTML in index.html with empty container\n- Call renderProgrammerDashboard\\(\\) from ui.js when showing programmer dashboard\n- Maintains all existing functionality while improving code organization\n\nü§ñ Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(firebase deploy:*)",
      "Bash(npm run build:*)",
      "Bash(git commit:*)",
      "Bash(find:*)",
      "Bash(git push:*)",
      "Bash(git revert:*)",
      "Bash(git checkout:*)",
      "Bash(mv:*)",
      "Bash(npm run build:staging:*)",
      "Bash(npm run build:prod:*)",
      "Bash(npm run dev:staging:*)",
      "Bash(npm run:*)",
      "Bash(tree:*)",
      "Bash(wc:*)",
      "Bash(rm:*)",
      "Bash(test:*)",
      "Bash(mkdir:*)",
      "Bash(chmod:*)",
      "Bash(python3:*)"
    ]
  }
}
</file>

<file path=".github/workflows/deploy.yml">
name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # Stap 1: Haal de code op uit je GitHub repo
      - name: Check out code
        uses: actions/checkout@v4

      # Stap 2: Setup Node.js (Nodig voor de build-stap)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Of '18' als je dat liever hebt
          cache: 'npm'

      # Stap 3: Installeer de dependencies
      - name: Install dependencies
        run: npm ci

      # Stap 4: Bouw het project (dit maakt de 'dist' map aan)
      - name: Build project
        run: npm run build

      # Stap 5: Publiceer naar Firebase
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: dans-dichter-db
          channelId: live
</file>

<file path="functions/.gitignore">
node_modules/
*.local
</file>

<file path="functions/index.js">
/**
 * Cloud Functions for Spoken Word Database
 *
 * This file contains three functions:
 * 1. onProgrammerSignup: Emails the admin when a new programmer signs up.
 * 2. approveProgrammer: An HTTPS function (a "webhook") that the admin clicks to approve a programmer.
 * 3. onProgrammerApproved: Emails the programmer *after* their account is approved.
 */

// Import all necessary modules
// We specificeren de regio "europe-west4" voor alle functies
const { onDocumentCreated, onDocumentUpdated } = require("firebase-functions/v2/firestore");
const { onRequest } = require("firebase-functions/v2/https");
const { getFirestore } = require("firebase-admin/firestore");
const { initializeApp } = require("firebase-admin/app");

// Initialize the Firebase Admin SDK
initializeApp();

// --- CONFIGURATION ---
// VERVANG DIT MET UW EIGEN E-MAILADRES
const ADMIN_EMAIL = "timthomaes@gmail.com";
// ---------------------


/**
 * ROBOT 1: NOTIFY ADMIN ON SIGNUP
 * Triggers when a new document is created in the 'programmers' collection.
 * Sends an email to the admin with an approval link.
 */
exports.onProgrammerSignup = onDocumentCreated({
  document: "programmers/{programmerId}",
  region: "europe-west4"
}, async (event) => {
  const data = event.data.data();
  const programmerId = event.params.programmerId;

  console.log(`New programmer signed up: ${data.email}. Sending admin notification.`);

  // Make sure all data is present
  if (!data.email || !data.firstName || !data.organizationName) {
    console.error("Missing data in new programmer document. Cannot send admin email.");
    return null;
  }

  // Create the email document in the 'mail' collection for the ADMIN
  try {
    await getFirestore().collection("mail").add({
      to: [ADMIN_EMAIL],
      template: {
        name: "admin-approval-request", // This MUST match your template ID
        data: {
          firstName: data.firstName,
          lastName: data.lastName,
          organizationName: data.organizationName,
          email: data.email,
          programmerId: programmerId, // We pass this so the template can build the link
        },
      },
    });
    console.log("Admin notification email created successfully.");
    return null;
  } catch (error) {
    console.error("Error creating admin mail document:", error);
    return null;
  }
});


/**
 * ROBOT 2: APPROVE PROGRAMMER VIA HTTPS LINK
 * Triggers when the admin clicks the "Approve" link in their email.
 * This is a public-facing URL.
 */
exports.approveProgrammer = onRequest({ region: "europe-west4" }, async (req, res) => {
  // 1. Get the programmer's ID from the URL (e.g., ?id=XXXXX)
  const programmerId = req.query.id;

  if (!programmerId) {
    console.error("No programmer ID provided in request.");
    res.status(400).send("Error: No ID provided. Please check the link.");
    return;
  }

  console.log(`Approval request received for programmer: ${programmerId}`);

  try {
    // 2. Create references to BOTH documents that need to be updated.
    const programmerRef = getFirestore().collection("programmers").doc(programmerId);
    const userRef = getFirestore().collection("users").doc(programmerId); // <-- DE BUGFIX

    const doc = await programmerRef.get();

    if (!doc.exists) {
      console.error("Programmer document not found.");
      res.status(404).send("Error: This programmer account was not found. It may have been deleted.");
      return;
    }
    
    // Check if already approved
    if (doc.data().status === "trial") {
        console.log("Programmer was already approved.");
        res.status(200).send("This programmer has already been approved. No action was taken.");
        return;
    }

    // 3. --- DE BUGFIX ---
    // Gebruik een "batch" om BEIDE documenten tegelijk bij te werken.
    const batch = getFirestore().batch();
    
    // Update de status in 'programmers'
    batch.update(programmerRef, { status: "trial" });
    
    // Update de status in 'users' (dit was de ontbrekende stap)
    batch.update(userRef, { status: "trial" });

    // Voer beide updates tegelijk uit
    await batch.commit();

    // 4. Send a "Success" message back to the admin's browser
    console.log(`Successfully approved programmer: ${programmerId}`);
    res.status(200).send(
      `<html>
        <head>
          <style>body { font-family: sans-serif; text-align: center; padding-top: 50px; background-color: #f0f9f0; color: #333; } h1 { color: #28a745; }</style>
        </head>
        <body>
          <h1>Success!</h1>
          <p>The programmer account has been approved and moved to 'trial' status.</p>
          <p>Both the 'programmers' and 'users' collections have been updated.</p>
          <p>They will now receive their welcome email automatically.</p>
        </body>
      </html>`
    );

  } catch (error) {
    console.error(`Failed to approve programmer ${programmerId}:`, error);
    res.status(500).send("An internal error occurred. Please check the function logs.");
  }
});


/**
 * ROBOT 3: NOTIFY PROGRAMMER ON APPROVAL (Your existing function)
 * Listens for updates on any document in the 'programmers' collection.
 * If a programmer's status is changed from 'pending' to 'trial',
 * it automatically creates a new email document in the 'mail' collection.
 */
exports.onProgrammerApproved = onDocumentUpdated({
  document: "programmers/{programmerId}",
  region: "europe-west4"
}, async (event) => {
  // Get the data from before and after the change
  const dataBefore = event.data.before.data();
  const dataAfter = event.data.after.data();

  // Check if the status was changed from 'pending' to 'trial'
  if (dataBefore.status === "pending" && dataAfter.status === "trial") {
    console.log(`Programmer ${event.params.programmerId} approved. Sending email to programmer...`);

    // Get the user's details from the updated document
    const email = dataAfter.email;
    const firstName = dataAfter.firstName;
    const organizationName = dataAfter.organizationName;

    // Make sure all data is present before sending
    if (!email || !firstName || !organizationName) {
      console.error("Missing user data (email, firstName, or organizationName). Cannot send email.");
      return null;
    }

    // Create the email document in the 'mail' collection
    try {
      await getFirestore().collection("mail").add({
        to: [email],
        template: {
          name: "programmer-approved", // This MUST match your programmer-facing template ID
          data: {
            firstName: firstName,
            organizationName: organizationName,
          },
        },
      });
      console.log("Programmer welcome email created successfully.");
      return null;
    } catch (error) {
      console.error("Error creating programmer mail document:", error);
      return null;
    }
  }

  // If the status wasn't changed from pending to trial, do nothing.
  return null;
});


/**
 * ROBOT 4: NOTIFY ARTIST ON NEW RECOMMENDATION
 * Triggers when a programmer writes a recommendation for an artist.
 * Sends an email notification to the artist.
 */
exports.onRecommendationCreated = onDocumentCreated({
  document: "recommendations/{recommendationId}",
  region: "europe-west4"
}, async (event) => {
  const recommendation = event.data.data();
  const recommendationId = event.params.recommendationId;

  console.log(`New recommendation created for artist ${recommendation.artistId}. Sending email notification.`);

  try {
    // Fetch artist data
    const artistRef = getFirestore().collection("artists").doc(recommendation.artistId);
    const artistSnap = await artistRef.get();

    if (!artistSnap.exists) {
      console.error("Artist document not found.");
      return null;
    }

    const artistData = artistSnap.data();
    const artistEmail = artistData.email;
    const artistName = artistData.stageName || `${artistData.firstName} ${artistData.lastName}`;

    if (!artistEmail) {
      console.error("Artist email not found. Cannot send notification.");
      return null;
    }

    // Build the inline HTML email template
    const emailHtml = `
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nieuwe Aanbeveling Ontvangen</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; margin: 0; padding: 0;">
    <div style="max-width: 600px; margin: 40px auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">

        <!-- Header -->
        <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 600;">üåü Nieuwe Aanbeveling Ontvangen!</h1>
        </div>

        <!-- Content -->
        <div style="padding: 30px;">
            <p style="margin: 0 0 15px 0;">Hallo <strong>${artistName}</strong>,</p>

            <p style="margin: 0 0 20px 0;">Goed nieuws! Je hebt een nieuwe aanbeveling ontvangen van <strong>${recommendation.programmerName}</strong>${recommendation.programmerOrganization ? ` (${recommendation.programmerOrganization})` : ''}.</p>

            <div style="background-color: #ffffff; border: 2px solid #6366f1; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <p style="margin: 0; font-style: italic; color: #555; font-size: 16px;">
                    "${recommendation.text}"
                </p>
            </div>

            <div style="text-align: center; margin: 25px 0;">
                <a href="https://community.dansdichterdans.be" style="display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 6px; font-weight: 600;">
                    Bekijk Je Profiel ‚Üí
                </a>
            </div>

            <div style="height: 1px; background-color: #e9ecef; margin: 20px 0;"></div>

            <p style="color: #6c757d; font-size: 14px; margin: 15px 0 0 0;">
                <strong>Tip:</strong> Aanbevelingen zijn zichtbaar op je profiel voor alle programmeurs. Ze helpen je om meer boekingen te krijgen!
            </p>
        </div>

        <!-- Footer -->
        <div style="background-color: #f8f9fa; padding: 20px 30px; text-align: center; color: #6c757d; font-size: 14px;">
            <p style="margin: 0 0 10px 0;">Je ontvangt deze email omdat je een profiel hebt op SpokenWord DB.</p>
            <p style="margin: 0;">
                <a href="https://community.dansdichterdans.be" style="color: #6366f1; text-decoration: none;">Bezoek SpokenWord DB</a>
            </p>
            <p style="margin: 15px 0 0 0; font-size: 12px; color: #999;">
                ¬© 2024 SpokenWord Database. Alle rechten voorbehouden.
            </p>
        </div>
    </div>
</body>
</html>
    `;

    // Send email via Firebase Extension
    await getFirestore().collection("mail").add({
      to: [artistEmail],
      message: {
        subject: `üåü Nieuwe aanbeveling van ${recommendation.programmerName}`,
        html: emailHtml,
      },
    });

    console.log(`Email notification sent to ${artistEmail} for new recommendation`);
    return null;

  } catch (error) {
    console.error("Error sending recommendation notification:", error);
    return null;
  }
});


/**
 * ROBOT 5: NOTIFY USER ON NEW MESSAGE (FASE 4)
 * Triggers when a new message is created in any conversation.
 * Sends an email notification to the recipient.
 * SMTP VERSION: Uses inline HTML template (geen external template nodig)
 */
exports.onNewMessage = onDocumentCreated({
  document: "conversations/{conversationId}/messages/{messageId}",
  region: "europe-west4"
}, async (event) => {
  const messageData = event.data.data();
  const conversationId = event.params.conversationId;
  const messageId = event.params.messageId;

  console.log(`New message in conversation ${conversationId}. Preparing email notification.`);

  // Get the conversation document to find the recipient
  try {
    const conversationRef = getFirestore().collection("conversations").doc(conversationId);
    const conversationSnap = await conversationRef.get();

    if (!conversationSnap.exists) {
      console.error("Conversation document not found.");
      return null;
    }

    const conversationData = conversationSnap.data();

    // Determine who the recipient is (not the sender)
    const senderId = messageData.senderId;
    const recipientId = conversationData.participants.find(id => id !== senderId);

    if (!recipientId) {
      console.error("Could not determine recipient.");
      return null;
    }

    // Get recipient details
    const recipientEmail = conversationData.participantEmails[recipientId];
    const recipientName = conversationData.participantNames[recipientId];
    const senderName = messageData.senderName;
    const subject = conversationData.subject || "No subject";
    
    // Create message preview (first 100 characters)
    const messagePreview = messageData.text.length > 100 
      ? messageData.text.substring(0, 100) + "..." 
      : messageData.text;

    // Validate required data
    if (!recipientEmail || !recipientName || !senderName) {
      console.error("Missing required email data. Cannot send notification.");
      return null;
    }

    // Create conversation link
    const conversationLink = `https://community.dansdichterdans.be`;

    // Build the inline HTML email template
    const emailHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Message Notification</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; margin: 0; padding: 0;">
    <div style="max-width: 600px; margin: 40px auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 600;">üí¨ New Message Received</h1>
        </div>

        <!-- Content -->
        <div style="padding: 30px;">
            <p style="margin: 0 0 15px 0;">Hello <strong>${recipientName}</strong>,</p>
            
            <p style="margin: 0 0 20px 0;">You have received a new message from <strong>${senderName}</strong>.</p>

            <div style="background-color: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 4px;">
                <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 16px;">üìã Subject</h3>
                <p style="margin: 0;">${subject}</p>
            </div>

            <div style="background-color: #ffffff; border: 1px solid #e9ecef; padding: 15px; border-radius: 4px; margin: 15px 0; font-style: italic; color: #555;">
                <strong>Message Preview:</strong><br>
                "${messagePreview}"
            </div>

            <div style="text-align: center; margin: 25px 0;">
                <a href="${conversationLink}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 6px; font-weight: 600;">
                    View Full Conversation ‚Üí
                </a>
            </div>

            <div style="height: 1px; background-color: #e9ecef; margin: 20px 0;"></div>

            <p style="color: #6c757d; font-size: 14px; margin: 15px 0 0 0;">
                <strong>Quick tip:</strong> Reply directly from your messages dashboard to continue the conversation.
            </p>
        </div>

        <!-- Footer -->
        <div style="background-color: #f8f9fa; padding: 20px 30px; text-align: center; color: #6c757d; font-size: 14px;">
            <p style="margin: 0 0 10px 0;">You're receiving this email because you have an active conversation on SpokenWord DB.</p>
            <p style="margin: 0;">
                <a href="https://community.dansdichterdans.be" style="color: #667eea; text-decoration: none;">Visit SpokenWord DB</a>
            </p>
            <p style="margin: 15px 0 0 0; font-size: 12px; color: #999;">
                ¬© 2024 SpokenWord Database. All rights reserved.
            </p>
        </div>
    </div>
</body>
</html>
    `;

    // Create the email document in the 'mail' collection (SMTP version)
    await getFirestore().collection("mail").add({
      to: [recipientEmail],
      message: {
        subject: `New message from ${senderName} - ${subject}`,
        html: emailHtml,
      },
    });

    console.log(`Email notification sent to ${recipientEmail} for new message from ${senderName}`);
    return null;

  } catch (error) {
    console.error("Error sending message notification:", error);
    return null;
  }
});
</file>

<file path="functions/package.json">
{
  "name": "functions",
  "description": "Cloud Functions for Firebase",
  "scripts": {
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "20"
  },
  "main": "index.js",
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^5.0.0"
  },
  "devDependencies": {},
  "private": true
}
</file>

<file path="scripts/validate-env.cjs">
#!/usr/bin/env node

/**
 * Build Guard: Pre-build Environment Validation
 *
 * This script validates that all required VITE_ environment variables
 * are present before allowing the build to proceed.
 *
 * Usage:
 *   node scripts/validate-env.js staging
 *   node scripts/validate-env.js production
 */

const fs = require('fs');
const path = require('path');

// Get the mode from command line argument
const mode = process.argv[2];

if (!mode) {
  console.error('‚ùå ERROR: Mode argument is required (staging or production)');
  console.error('Usage: node scripts/validate-env.js <staging|production>');
  process.exit(1);
}

if (mode !== 'staging' && mode !== 'production') {
  console.error(`‚ùå ERROR: Invalid mode "${mode}". Must be "staging" or "production"`);
  process.exit(1);
}

// Determine which .env file to check
const envFile = mode === 'production' ? '.env.production' : '.env.staging';
const envPath = path.join(__dirname, '..', envFile);

console.log('üîç BUILD GUARD: Validating environment configuration...');
console.log(`üìã Mode: ${mode}`);
console.log(`üìÑ File: ${envFile}`);

// Check if the env file exists
if (!fs.existsSync(envPath)) {
  console.error(`‚ùå FATAL: Environment file ${envFile} not found!`);
  console.error(`Expected path: ${envPath}`);
  process.exit(1);
}

// Read and parse the env file
const envContent = fs.readFileSync(envPath, 'utf8');
const envVars = {};

envContent.split('\n').forEach(line => {
  const trimmed = line.trim();
  if (trimmed && !trimmed.startsWith('#')) {
    const [key, ...valueParts] = trimmed.split('=');
    if (key && valueParts.length > 0) {
      // Remove quotes from value if present
      let value = valueParts.join('=').trim();
      value = value.replace(/^["']|["']$/g, '');
      envVars[key] = value;
    }
  }
});

// Required environment variables
const requiredVars = [
  'VITE_FIREBASE_API_KEY',
  'VITE_FIREBASE_AUTH_DOMAIN',
  'VITE_FIREBASE_PROJECT_ID',
  'VITE_FIREBASE_STORAGE_BUCKET',
  'VITE_FIREBASE_MESSAGING_SENDER_ID',
  'VITE_FIREBASE_APP_ID'
];

// Validate each required variable
const missing = [];
const invalid = [];

requiredVars.forEach(varName => {
  if (!envVars[varName]) {
    missing.push(varName);
  } else if (envVars[varName].length < 5) {
    invalid.push(varName);
  }
});

// Expected project IDs for validation
const expectedProjectId = mode === 'production' ? 'dans-dichter-db' : 'ddd-spark';
const actualProjectId = envVars['VITE_FIREBASE_PROJECT_ID'];

// Report results
console.log('');
console.log('‚úì Environment file exists');
console.log(`‚úì Found ${Object.keys(envVars).length} environment variables`);

if (missing.length > 0) {
  console.error('');
  console.error('‚ùå FATAL: Missing required environment variables:');
  missing.forEach(v => console.error(`   - ${v}`));
  process.exit(1);
}

if (invalid.length > 0) {
  console.error('');
  console.error('‚ùå FATAL: Invalid (too short) environment variables:');
  invalid.forEach(v => console.error(`   - ${v}: "${envVars[v]}"`));
  process.exit(1);
}

// Validate project ID matches expected environment
if (actualProjectId !== expectedProjectId) {
  console.error('');
  console.error('‚ùå FATAL: Project ID mismatch!');
  console.error(`   Expected for ${mode}: ${expectedProjectId}`);
  console.error(`   Found in ${envFile}: ${actualProjectId}`);
  console.error('');
  console.error('This prevents accidental cross-environment deployment.');
  process.exit(1);
}

// All checks passed
console.log(`‚úì All ${requiredVars.length} required variables present`);
console.log(`‚úì Project ID verified: ${actualProjectId}`);
console.log('');
console.log('‚úÖ BUILD GUARD: Environment validation passed');
console.log(`üöÄ Proceeding with ${mode} build...`);
console.log('');

process.exit(0);
</file>

<file path="src/modules/calendar/calendar-map.js">
/**
 * calendar-map.js
 * Community Map voor events met Leaflet.js
 */

// Predefined coordinates voor steden (NL/BE)
const CITY_COORDINATES = {
  // Nederland
  'amsterdam': [52.3676, 4.9041],
  'rotterdam': [51.9225, 4.4792],
  'den haag': [52.0705, 4.3007],
  'utrecht': [52.0907, 5.1214],
  'eindhoven': [51.4416, 5.4697],
  'groningen': [53.2194, 6.5665],
  'tilburg': [51.5555, 5.0913],
  'almere': [52.3508, 5.2647],
  'breda': [51.5719, 4.7683],
  'nijmegen': [51.8426, 5.8546],
  'arnhem': [51.9851, 5.8987],
  'haarlem': [52.3874, 4.6462],
  'enschede': [52.2215, 6.8937],
  'maastricht': [50.8514, 5.6910],
  'leiden': [52.1601, 4.4970],
  'dordrecht': [51.8133, 4.6901],
  'zwolle': [52.5168, 6.0830],
  'deventer': [52.2551, 6.1639],
  'delft': [52.0116, 4.3571],
  'alkmaar': [52.6324, 4.7534],

  // Belgi√´ - Vlaanderen
  'antwerpen': [51.2194, 4.4025],
  'gent': [51.0543, 3.7174],
  'brugge': [51.2093, 3.2247],
  'leuven': [50.8798, 4.7005],
  'mechelen': [51.0259, 4.4776],
  'aalst': [50.9365, 4.0382],
  'kortrijk': [50.8279, 3.2649],
  'hasselt': [50.9307, 5.3378],
  'oostende': [51.2154, 2.9286],
  'sint-niklaas': [51.1565, 4.1434],
  'genk': [50.9654, 5.5022],
  'roeselare': [50.9446, 3.1256],
  'turnhout': [51.3227, 4.9484],

  // Brussel
  'brussel': [50.8503, 4.3517],
  'brussels': [50.8503, 4.3517],
  'bruxelles': [50.8503, 4.3517]
};

// Map instance
let mapInstance = null;
let markersLayer = null;

/**
 * Haal coordinates op voor een stad
 * @param {string} city - Stad naam
 * @returns {Array|null} [lat, lng] of null
 */
export function getCityCoordinates(city) {
  if (!city) return null;
  const cityLower = city.toLowerCase().trim();

  // Directe match
  if (CITY_COORDINATES[cityLower]) {
    return CITY_COORDINATES[cityLower];
  }

  // Partial match
  for (const [key, coords] of Object.entries(CITY_COORDINATES)) {
    if (cityLower.includes(key) || key.includes(cityLower)) {
      return coords;
    }
  }

  return null;
}

/**
 * Groepeer events per stad met coordinates
 * @param {Array} events - Array van events
 * @returns {Object} Object met stad als key en {coords, events} als value
 */
export function groupEventsByCity(events) {
  const grouped = {};

  events.forEach(event => {
    if (!event.city) return;

    const cityLower = event.city.toLowerCase().trim();
    const coords = getCityCoordinates(event.city);

    if (!coords) {
      console.warn(`[MAP] No coordinates for city: ${event.city}`);
      return;
    }

    const cityKey = cityLower;

    if (!grouped[cityKey]) {
      grouped[cityKey] = {
        city: event.city,
        coords: coords,
        events: []
      };
    }

    grouped[cityKey].events.push(event);
  });

  return grouped;
}

/**
 * Initialize de kaart
 * @param {string} containerId - ID van de container
 * @returns {Object} Leaflet map instance
 */
export function initMap(containerId) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error('[MAP] Container not found:', containerId);
    return null;
  }

  // Prevent clicks from bubbling up to prevent unwanted redirects
  container.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Cleanup bestaande map
  if (mapInstance) {
    mapInstance.remove();
    mapInstance = null;
  }

  // Maak nieuwe map, gecentreerd op BeNeLux
  mapInstance = L.map(containerId, {
    center: [51.5, 4.5], // Centrum van NL/BE
    zoom: 7,
    minZoom: 6,
    maxZoom: 15
  });

  // Voeg tile layer toe (OpenStreetMap)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(mapInstance);

  // Maak markers layer
  markersLayer = L.layerGroup().addTo(mapInstance);

  // Handle clicks on popup content
  mapInstance.on('popupopen', function(e) {
    const popup = e.popup;
    const container = popup.getElement();

    if (container) {
      container.addEventListener('click', async function(evt) {
        const eventItem = evt.target.closest('.map-popup-event[data-artist-id]');
        if (eventItem) {
          evt.preventDefault();
          evt.stopPropagation();

          const artistId = eventItem.dataset.artistId;
          if (artistId) {
            console.log('[MAP] Navigating to artist:', artistId);

            // Sluit popup eerst
            mapInstance.closePopup();

            // Navigeer naar artiest profiel via import
            try {
              const { showArtistDetail } = await import('../search/search-controller.js');
              await showArtistDetail(artistId);
            } catch (error) {
              console.error('[MAP] Error navigating to artist:', error);
            }
          }
        }
      });
    }
  });

  console.log('[MAP] Map initialized');
  return mapInstance;
}

/**
 * Update markers op de kaart
 * @param {Array} events - Array van events
 * @param {Function} onCityClick - Callback wanneer op stad wordt geklikt
 */
export function updateMapMarkers(events, onCityClick = null) {
  if (!mapInstance || !markersLayer) {
    console.warn('[MAP] Map not initialized');
    return;
  }

  // Clear bestaande markers
  markersLayer.clearLayers();

  // Groepeer events per stad
  const grouped = groupEventsByCity(events);

  // Voeg markers toe
  for (const [cityKey, data] of Object.entries(grouped)) {
    const { city, coords, events: cityEvents } = data;
    const eventCount = cityEvents.length;

    // Custom marker icon met aantal
    const markerIcon = L.divIcon({
      className: 'custom-map-marker',
      html: `
        <div class="relative">
          <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg border-2 border-white cursor-pointer hover:bg-indigo-700 transition-colors">
            ${eventCount}
          </div>
          <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-indigo-600"></div>
        </div>
      `,
      iconSize: [40, 48],
      iconAnchor: [20, 48]
    });

    const marker = L.marker(coords, { icon: markerIcon });

    // Popup met event info
    const popupContent = createPopupContent(city, cityEvents);
    marker.bindPopup(popupContent, {
      maxWidth: 300,
      className: 'custom-map-popup'
    });

    // Click handler
    marker.on('click', function(e) {
      // Stop propagation om te voorkomen dat andere handlers dit opvangen
      if (e.originalEvent) {
        e.originalEvent.stopPropagation();
        e.originalEvent.preventDefault();
      }

      console.log('[MAP] Marker clicked:', city);
      this.openPopup();

      if (onCityClick) {
        onCityClick(city, cityEvents);
      }
    });

    markersLayer.addLayer(marker);
  }

  console.log(`[MAP] Added ${Object.keys(grouped).length} markers`);
}

/**
 * Maak popup content voor een stad
 * @param {string} city - Stad naam
 * @param {Array} events - Events in deze stad
 * @returns {string} HTML string
 */
function createPopupContent(city, events) {
  const eventsList = events.slice(0, 5).map(event => {
    const date = event.date ? new Date(event.date).toLocaleDateString('nl-BE', {
      day: 'numeric',
      month: 'short'
    }) : 'TBA';

    const artistId = event.artistId || '';
    const cursorClass = artistId ? 'cursor-pointer hover:bg-gray-50' : '';
    const dataAttr = artistId ? `data-artist-id="${artistId}"` : '';

    return `
      <div class="map-popup-event flex items-center justify-between py-2 border-b border-gray-100 last:border-0 ${cursorClass} rounded px-2 -mx-2 transition-colors" ${dataAttr}>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">${event.venue || 'TBA'}</p>
          <p class="text-xs text-gray-500">${event.artistName || 'Artiest'}</p>
        </div>
        <span class="text-xs font-medium text-indigo-600 ml-2">${date}</span>
      </div>
    `;
  }).join('');

  const moreText = events.length > 5 ? `<p class="text-xs text-gray-500 mt-2">+ ${events.length - 5} meer</p>` : '';

  return `
    <div class="map-popup-content p-1">
      <h3 class="font-bold text-gray-900 mb-2">${city}</h3>
      <p class="text-xs text-gray-500 mb-3">${events.length} event${events.length > 1 ? 's' : ''}</p>
      <div class="max-h-48 overflow-y-auto">
        ${eventsList}
      </div>
      ${moreText}
    </div>
  `;
}

/**
 * Resize map (nodig na container size change)
 */
export function resizeMap() {
  if (mapInstance) {
    setTimeout(() => {
      mapInstance.invalidateSize();
    }, 100);
  }
}

/**
 * Destroy map instance
 */
export function destroyMap() {
  if (mapInstance) {
    mapInstance.remove();
    mapInstance = null;
    markersLayer = null;
    console.log('[MAP] Map destroyed');
  }
}

/**
 * Fly to een specifieke stad
 * @param {string} city - Stad naam
 */
export function flyToCity(city) {
  if (!mapInstance) return;

  const coords = getCityCoordinates(city);
  if (coords) {
    mapInstance.flyTo(coords, 12, { duration: 1 });
  }
}
</file>

<file path="src/modules/calendar/calendar-views.js">
/**
 * calendar-views.js
 * View rendering functies voor Gigs, Agenda en Evenementen pagina's
 */

/**
 * Shows the Gigs page for artists (their own gigs)
 */
export async function showGigsPage() {
  const { getStore } = await import('../../utils/store.js');
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'artist') {
    console.warn('[UI] Only artists can access gigs page');
    return;
  }

  console.log('[UI] Showing gigs page');

  // Render navigation
  const navModule = await import('../navigation/navigation.js');
  navModule.renderDesktopNav();
  navModule.renderMobileNav();

  // Show dashboard view container
  const { showPage } = await import('../../ui/ui.js');
  showPage('dashboard-view', false);
  window.history.pushState({ view: 'gigs' }, '', '#gigs');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  if (artistDashboard) {
    artistDashboard.style.display = 'block';
    artistDashboard.innerHTML = `
      <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <div id="upcoming-gigs-container">
          <!-- Calendar module renders here -->
        </div>
      </div>
    `;
  }
  if (programmerDashboard) {
    programmerDashboard.style.display = 'none';
  }

  // Initialize calendar
  const { initCalendar } = await import('./calendar-controller.js');
  await initCalendar();

  // Update mobile nav active state
  const { updateMobileNavActive } = await import('../navigation/navigation.js');
  updateMobileNavActive('gigs');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows the Agenda page for programmers (all upcoming gigs)
 */
export async function showAgendaPage() {
  const { getStore } = await import('../../utils/store.js');
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn('[UI] Only programmers can access agenda page');
    return;
  }

  console.log('[UI] Showing agenda page');

  // Render navigation
  const navModule = await import('../navigation/navigation.js');
  navModule.renderDesktopNav();
  navModule.renderMobileNav();

  // Show dashboard view container
  const { showPage } = await import('../../ui/ui.js');
  showPage('dashboard-view', false);
  window.history.pushState({ view: 'agenda' }, '', '#agenda');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  if (artistDashboard) {
    artistDashboard.style.display = 'none';
  }
  if (programmerDashboard) {
    programmerDashboard.style.display = 'block';
    programmerDashboard.innerHTML = `
      <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-900">Agenda</h1>
          <p class="text-gray-500 mt-1">Ontdek waar artiesten binnenkort optreden</p>
        </div>

        <!-- Main Content: Responsive Layout -->
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Filters Sidebar (Desktop Only) -->
          <aside id="agenda-filters-container" class="hidden lg:block w-64 flex-shrink-0">
            <!-- Month Calendar & Filters render here -->
          </aside>

          <!-- Events List -->
          <main class="flex-1">
            <!-- Mobile Date Selector -->
            <div id="mobile-date-selector" class="lg:hidden mb-4">
              <!-- Month/Year header met navigatie -->
              <div class="flex items-center justify-between mb-3">
                <button id="mobile-month-prev" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                  <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
                </button>
                <span id="mobile-month-label" class="font-semibold text-gray-900">Januari 2026</span>
                <button id="mobile-month-next" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                  <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                </button>
              </div>

              <!-- Compact calendar grid -->
              <div id="mobile-calendar-grid" class="bg-white rounded-xl border border-gray-200 p-3 shadow-sm">
                <!-- Weekday headers -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  <div class="text-center text-xs font-medium text-gray-500">Ma</div>
                  <div class="text-center text-xs font-medium text-gray-500">Di</div>
                  <div class="text-center text-xs font-medium text-gray-500">Wo</div>
                  <div class="text-center text-xs font-medium text-gray-500">Do</div>
                  <div class="text-center text-xs font-medium text-gray-500">Vr</div>
                  <div class="text-center text-xs font-medium text-gray-500">Za</div>
                  <div class="text-center text-xs font-medium text-gray-500">Zo</div>
                </div>
                <!-- Days grid renders here -->
                <div id="mobile-calendar-days" class="grid grid-cols-7 gap-1">
                  <!-- Days -->
                </div>
              </div>
            </div>

            <!-- View Mode Toggle -->
            <div class="flex items-center justify-between mb-4">
              <div id="filter-mode-container"></div>

              <!-- List/Map Toggle -->
              <div class="flex gap-2">
                <button id="view-mode-list" class="view-mode-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-600 text-white">
                  <i data-lucide="list" class="w-4 h-4 inline-block mr-1"></i>
                  Lijst
                </button>
                <button id="view-mode-map" class="view-mode-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
                  <i data-lucide="map" class="w-4 h-4 inline-block mr-1"></i>
                  Kaart
                </button>
              </div>
            </div>

            <!-- List View -->
            <div id="agenda-events-list" class="space-y-4">
              <!-- Loading -->
              <div class="flex justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
              </div>
            </div>

            <!-- Map View (hidden by default) -->
            <div id="agenda-map-container" class="hidden">
              <div id="community-map" class="w-full h-[500px] lg:h-[600px] rounded-2xl border border-gray-200 shadow-sm"></div>
            </div>
          </main>
        </div>
      </div>
    `;
  }

  // Initialize the new Agenda View
  const { initAgendaView } = await import('./calendar-controller.js');
  await initAgendaView();

  // Update mobile nav active state
  const { updateMobileNavActive } = await import('../navigation/navigation.js');
  updateMobileNavActive('agenda');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows the Events page for artists (all upcoming events)
 */
export async function showEventsPage() {
  const { getStore } = await import('../../utils/store.js');
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'artist') {
    console.warn('[UI] Only artists can access events page');
    return;
  }

  console.log('[UI] Showing events page');

  // Render navigation
  const navModule = await import('../navigation/navigation.js');
  navModule.renderDesktopNav();
  navModule.renderMobileNav();

  // Show dashboard view container
  const { showPage } = await import('../../ui/ui.js');
  showPage('dashboard-view', false);
  window.history.pushState({ view: 'events' }, '', '#events');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  // Use artist dashboard for artists
  if (programmerDashboard) {
    programmerDashboard.style.display = 'none';
  }
  if (artistDashboard) {
    artistDashboard.style.display = 'block';
    artistDashboard.innerHTML = `
      <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-900">Evenementen</h1>
          <p class="text-gray-500 mt-1">Ontdek waar andere artiesten optreden</p>
        </div>

        <!-- Main Content: Responsive Layout -->
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Filters Sidebar (Desktop Only) -->
          <aside id="agenda-filters-container" class="hidden lg:block w-64 flex-shrink-0">
            <!-- Month Calendar & Filters render here -->
          </aside>

          <!-- Events List -->
          <main class="flex-1">
            <!-- Mobile Date Selector -->
            <div id="mobile-date-selector" class="lg:hidden mb-4">
              <!-- Month/Year header met navigatie -->
              <div class="flex items-center justify-between mb-3">
                <button id="mobile-month-prev" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                  <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
                </button>
                <span id="mobile-month-label" class="font-semibold text-gray-900">Januari 2026</span>
                <button id="mobile-month-next" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                  <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                </button>
              </div>

              <!-- Compact calendar grid -->
              <div id="mobile-calendar-grid" class="bg-white rounded-xl border border-gray-200 p-3 shadow-sm">
                <!-- Weekday headers -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  <div class="text-center text-xs font-medium text-gray-500">Ma</div>
                  <div class="text-center text-xs font-medium text-gray-500">Di</div>
                  <div class="text-center text-xs font-medium text-gray-500">Wo</div>
                  <div class="text-center text-xs font-medium text-gray-500">Do</div>
                  <div class="text-center text-xs font-medium text-gray-500">Vr</div>
                  <div class="text-center text-xs font-medium text-gray-500">Za</div>
                  <div class="text-center text-xs font-medium text-gray-500">Zo</div>
                </div>
                <!-- Days grid renders here -->
                <div id="mobile-calendar-days" class="grid grid-cols-7 gap-1">
                  <!-- Days -->
                </div>
              </div>
            </div>

            <!-- View Mode Toggle -->
            <div class="flex items-center justify-between mb-4">
              <div id="filter-mode-container"></div>

              <!-- List/Map Toggle -->
              <div class="flex gap-2">
                <button id="view-mode-list" class="view-mode-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-600 text-white">
                  <i data-lucide="list" class="w-4 h-4 inline-block mr-1"></i>
                  Lijst
                </button>
                <button id="view-mode-map" class="view-mode-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
                  <i data-lucide="map" class="w-4 h-4 inline-block mr-1"></i>
                  Kaart
                </button>
              </div>
            </div>

            <!-- List View -->
            <div id="agenda-events-list" class="space-y-4">
              <!-- Loading -->
              <div class="flex justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
              </div>
            </div>

            <!-- Map View (hidden by default) -->
            <div id="agenda-map-container" class="hidden">
              <div id="community-map" class="w-full h-[500px] lg:h-[600px] rounded-2xl border border-gray-200 shadow-sm"></div>
            </div>
          </main>
        </div>
      </div>
    `;
  }

  // Initialize the Agenda View (reuse same logic)
  const { initAgendaView } = await import('./calendar-controller.js');
  await initAgendaView();

  // Update mobile nav active state
  const { updateMobileNavActive } = await import('../navigation/navigation.js');
  updateMobileNavActive('events');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}
</file>

<file path="src/modules/calendar/poster-generator.js">
/**
 * poster-generator.js
 * Genereer downloadbare tour posters voor artiesten
 */

// Poster dimensies (Instagram Story formaat)
const POSTER_WIDTH = 1080;
const POSTER_HEIGHT = 1920;

/**
 * Poster thema's met kleuren
 */
export const POSTER_THEMES = {
  indigo: {
    name: 'Indigo Night',
    preview: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 100%)',
    background: ['#1e1b4b', '#312e81', '#1e1b4b'],
    accent: '#4f46e5',
    accentLight: '#818cf8',
    text: '#ffffff',
    textMuted: '#a5b4fc',
    decorCircle: '#818cf8'
  },
  purple: {
    name: 'Purple Haze',
    preview: 'linear-gradient(135deg, #2e1065 0%, #581c87 100%)',
    background: ['#2e1065', '#581c87', '#2e1065'],
    accent: '#9333ea',
    accentLight: '#c084fc',
    text: '#ffffff',
    textMuted: '#d8b4fe',
    decorCircle: '#a855f7'
  },
  midnight: {
    name: 'Midnight Black',
    preview: 'linear-gradient(135deg, #0a0a0a 0%, #171717 100%)',
    background: ['#0a0a0a', '#171717', '#0a0a0a'],
    accent: '#525252',
    accentLight: '#a3a3a3',
    text: '#ffffff',
    textMuted: '#a3a3a3',
    decorCircle: '#404040'
  },
  clean: {
    name: 'Clean White',
    preview: 'linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%)',
    background: ['#ffffff', '#fafafa', '#ffffff'],
    accent: '#6366f1',
    accentLight: '#818cf8',
    text: '#111827',
    textMuted: '#6b7280',
    decorCircle: '#e0e7ff'
  },
  sunset: {
    name: 'Sunset Glow',
    preview: 'linear-gradient(135deg, #7c2d12 0%, #c2410c 100%)',
    background: ['#7c2d12', '#c2410c', '#7c2d12'],
    accent: '#f97316',
    accentLight: '#fdba74',
    text: '#ffffff',
    textMuted: '#fed7aa',
    decorCircle: '#fb923c'
  },
  ocean: {
    name: 'Ocean Deep',
    preview: 'linear-gradient(135deg, #0c4a6e 0%, #0369a1 100%)',
    background: ['#0c4a6e', '#0369a1', '#0c4a6e'],
    accent: '#0ea5e9',
    accentLight: '#7dd3fc',
    text: '#ffffff',
    textMuted: '#bae6fd',
    decorCircle: '#38bdf8'
  },
  forest: {
    name: 'Forest Green',
    preview: 'linear-gradient(135deg, #14532d 0%, #166534 100%)',
    background: ['#14532d', '#166534', '#14532d'],
    accent: '#22c55e',
    accentLight: '#86efac',
    text: '#ffffff',
    textMuted: '#bbf7d0',
    decorCircle: '#4ade80'
  }
};

/**
 * Huidige geselecteerde thema
 */
let currentTheme = 'indigo';

/**
 * Get thema keys als array
 */
export function getThemeKeys() {
  return Object.keys(POSTER_THEMES);
}

/**
 * Set het huidige thema
 */
export function setCurrentTheme(themeKey) {
  if (POSTER_THEMES[themeKey]) {
    currentTheme = themeKey;
  }
}

/**
 * Get het huidige thema
 */
export function getCurrentTheme() {
  return currentTheme;
}

/**
 * Genereer een tour poster canvas
 * @param {object} artistData - Artiest gegevens
 * @param {Array} events - Array van gigs (minimaal 3)
 * @param {string} themeKey - Thema key (default: 'indigo')
 * @returns {Promise<HTMLCanvasElement>} Canvas element
 */
export async function generatePosterCanvas(artistData, events, themeKey = 'indigo') {
  const theme = POSTER_THEMES[themeKey] || POSTER_THEMES.indigo;

  const canvas = document.createElement('canvas');
  canvas.width = POSTER_WIDTH;
  canvas.height = POSTER_HEIGHT;
  const ctx = canvas.getContext('2d');

  // Achtergrond gradient met thema kleuren
  const gradient = ctx.createLinearGradient(0, 0, 0, POSTER_HEIGHT);
  gradient.addColorStop(0, theme.background[0]);
  gradient.addColorStop(0.5, theme.background[1]);
  gradient.addColorStop(1, theme.background[2]);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, POSTER_WIDTH, POSTER_HEIGHT);

  // Decoratieve elementen met thema kleur
  ctx.globalAlpha = 0.1;
  ctx.fillStyle = theme.decorCircle;
  ctx.beginPath();
  ctx.arc(900, 200, 300, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(100, 1600, 250, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // ====== DYNAMIC SCALING ======
  const eventCount = Math.min(events.length, 10);

  // Bereken scaling factor op basis van aantal events
  // Minder events = grotere tekst en meer spacing
  // Meer events = kleinere tekst en minder spacing
  const scaleFactor = eventCount <= 3 ? 1.5 : eventCount <= 5 ? 1.2 : eventCount <= 7 ? 1.0 : 0.85;

  // Base sizes
  const profileSize = Math.round(200 * scaleFactor);
  const nameSize = Math.round(72 * scaleFactor);
  const tourLabelSize = Math.round(36 * scaleFactor);
  const gigDateSize = Math.round(36 * scaleFactor);
  const gigMonthSize = Math.round(20 * scaleFactor);
  const gigVenueSize = Math.round(32 * scaleFactor);
  const gigCitySize = Math.round(26 * scaleFactor);
  const dateBoxWidth = Math.round(120 * scaleFactor);
  const dateBoxHeight = Math.round(80 * scaleFactor);
  const gigHeight = Math.round(140 * scaleFactor);

  // Bereken verticale centrering
  const totalContentHeight = profileSize + 100 + (eventCount * gigHeight) + 200;
  let yOffset = Math.max(100, (POSTER_HEIGHT - totalContentHeight) / 2);

  // Load en draw profielfoto (als beschikbaar)
  if (artistData.profilePicUrl) {
    try {
      const img = await loadImage(artistData.profilePicUrl);

      // Circulaire clip voor profielfoto
      const imgSize = profileSize;
      const imgX = (POSTER_WIDTH - imgSize) / 2;
      const imgY = yOffset;

      ctx.save();
      ctx.beginPath();
      ctx.arc(imgX + imgSize/2, imgY + imgSize/2, imgSize/2, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(img, imgX, imgY, imgSize, imgSize);
      ctx.restore();

      // Border rond foto
      ctx.strokeStyle = theme.accentLight;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(imgX + imgSize/2, imgY + imgSize/2, imgSize/2, 0, Math.PI * 2);
      ctx.stroke();

      yOffset += imgSize + Math.round(40 * scaleFactor);
    } catch (error) {
      console.warn('[POSTER] Could not load profile image:', error);
      yOffset += Math.round(40 * scaleFactor);
    }
  }

  // Artiest naam
  ctx.fillStyle = theme.text;
  ctx.font = `bold ${nameSize}px system-ui, -apple-system, sans-serif`;
  ctx.textAlign = 'center';
  const artistName = artistData.stageName || `${artistData.firstName} ${artistData.lastName}`;
  ctx.fillText(artistName.toUpperCase(), POSTER_WIDTH / 2, yOffset + nameSize * 0.8);
  yOffset += nameSize + Math.round(20 * scaleFactor);

  // "ON TOUR" label
  ctx.fillStyle = theme.textMuted;
  ctx.font = `bold ${tourLabelSize}px system-ui, -apple-system, sans-serif`;
  ctx.fillText('ON TOUR', POSTER_WIDTH / 2, yOffset + tourLabelSize);
  yOffset += tourLabelSize + Math.round(40 * scaleFactor);

  // Divider lijn
  ctx.strokeStyle = theme.accent;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(POSTER_WIDTH * 0.2, yOffset);
  ctx.lineTo(POSTER_WIDTH * 0.8, yOffset);
  ctx.stroke();
  yOffset += Math.round(50 * scaleFactor);

  // Gigs lijst
  const maxGigs = Math.min(events.length, 10);

  for (let i = 0; i < maxGigs; i++) {
    const event = events[i];
    const date = event.date ? new Date(event.date) : null;

    // Datum box X positie (links uitlijnen met scaling)
    const dateBoxX = Math.round(100 * scaleFactor);
    const textStartX = dateBoxX + dateBoxWidth + Math.round(30 * scaleFactor);

    // Datum
    if (date) {
      const day = date.getDate();
      const month = date.toLocaleDateString('nl-BE', { month: 'short' }).toUpperCase();

      // Datum box
      ctx.fillStyle = theme.accent;
      roundRect(ctx, dateBoxX, yOffset, dateBoxWidth, dateBoxHeight, 12);
      ctx.fill();

      ctx.fillStyle = theme.text;
      ctx.font = `bold ${gigDateSize}px system-ui, -apple-system, sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText(day.toString(), dateBoxX + dateBoxWidth/2, yOffset + dateBoxHeight * 0.45);
      ctx.font = `${gigMonthSize}px system-ui, -apple-system, sans-serif`;
      ctx.fillText(month, dateBoxX + dateBoxWidth/2, yOffset + dateBoxHeight * 0.8);
    }

    // Venue en stad
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.text;
    ctx.font = `bold ${gigVenueSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillText(event.venue || 'TBA', textStartX, yOffset + dateBoxHeight * 0.4);

    ctx.fillStyle = theme.textMuted;
    ctx.font = `${gigCitySize}px system-ui, -apple-system, sans-serif`;
    ctx.fillText(event.city || '', textStartX, yOffset + dateBoxHeight * 0.75);

    yOffset += gigHeight;
  }

  // "Meer shows" indicator als er meer dan 10 gigs zijn
  if (events.length > 10) {
    ctx.fillStyle = theme.textMuted;
    ctx.font = `${Math.round(24 * scaleFactor)}px system-ui, -apple-system, sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillText(`+ ${events.length - 10} meer shows`, POSTER_WIDTH / 2, yOffset + 20);
  }

  // Footer (altijd onderaan)
  ctx.fillStyle = theme.accent;
  ctx.font = '20px system-ui, -apple-system, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('spokenword.community', POSTER_WIDTH / 2, POSTER_HEIGHT - 60);

  return canvas;
}

/**
 * Helper: Load image als Promise
 */
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

/**
 * Helper: Draw rounded rectangle
 */
function roundRect(ctx, x, y, width, height, radius) {
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
}

/**
 * Download poster als PNG
 * @param {HTMLCanvasElement} canvas - Canvas element
 * @param {string} filename - Bestandsnaam
 */
export function downloadPoster(canvas, filename = 'tour-poster.png') {
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

/**
 * Render poster preview modal
 * @param {HTMLCanvasElement} canvas - Canvas element
 * @param {string} currentThemeKey - Huidige thema key
 * @returns {string} HTML string
 */
export function renderPosterModal(canvas, currentThemeKey = 'indigo') {
  // Converteer canvas naar data URL voor preview
  const previewUrl = canvas.toDataURL('image/png');

  // Render thema knoppen
  const themeButtons = Object.entries(POSTER_THEMES).map(([key, theme]) => `
    <button
      class="theme-select-btn w-10 h-10 rounded-lg border-2 transition-all ${
        key === currentThemeKey
          ? 'border-indigo-600 ring-2 ring-indigo-300'
          : 'border-gray-200 hover:border-gray-400'
      }"
      data-theme="${key}"
      title="${theme.name}"
      style="background: ${theme.preview};"
    ></button>
  `).join('');

  return `
    <div id="poster-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0,0,0,0.8);">
      <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-100 flex-shrink-0">
          <h2 class="text-xl font-bold text-gray-900">Tour Poster</h2>
          <button id="close-poster-modal" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Theme Selector -->
        <div class="px-4 py-3 border-b border-gray-100 flex-shrink-0">
          <p class="text-sm font-medium text-gray-700 mb-2">Kies een stijl:</p>
          <div class="flex gap-2 flex-wrap">
            ${themeButtons}
          </div>
        </div>

        <!-- Preview (scrollable) -->
        <div class="p-4 bg-gray-100 overflow-y-auto flex-1">
          <div id="poster-preview-container" class="aspect-[9/16] max-h-[50vh] mx-auto rounded-xl overflow-hidden shadow-lg">
            <img id="poster-preview-img" src="${previewUrl}" alt="Tour Poster Preview" class="w-full h-full object-contain">
          </div>
        </div>

        <!-- Actions -->
        <div class="p-4 flex gap-3 flex-shrink-0">
          <button id="download-poster-btn" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
            <i data-lucide="download" class="w-5 h-5"></i>
            Download PNG
          </button>
          <button id="close-poster-modal-btn" class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors">
            Sluiten
          </button>
        </div>

        <!-- Tip -->
        <div class="px-4 pb-4 flex-shrink-0">
          <p class="text-xs text-gray-500 text-center">
            üí° Perfect formaat voor Instagram Stories (1080x1920px)
          </p>
        </div>
      </div>
    </div>
  `;
}

/**
 * Render de "Maak Tour Poster" knop
 * @param {number} eventCount - Aantal events
 * @returns {string} HTML string
 */
export function renderPosterButton(eventCount) {
  if (eventCount < 3) {
    return `
      <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center">
        <p class="text-sm text-gray-500">
          <i data-lucide="image" class="w-4 h-4 inline-block mr-1"></i>
          Voeg nog ${3 - eventCount} gig${3 - eventCount > 1 ? 's' : ''} toe om een tour poster te maken
        </p>
      </div>
    `;
  }

  return `
    <button id="generate-poster-btn" class="w-full px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-3">
      <i data-lucide="sparkles" class="w-5 h-5"></i>
      Maak Tour Poster
      <span class="text-indigo-200 text-sm">(${eventCount} shows)</span>
    </button>
  `;
}
</file>

<file path=".gitignore">
# Dependencies
node_modules/
.npm/

# Build output
dist/
build/
.output/

# Firebase
.firebase/
.firebaserc
firebase-debug.log
firebase-debug.*.log
ui-debug.log
database-debug.log
firestore-debug.log
pubsub-debug.log

# Service Account Keys (BELANGRIJK!)
serviceAccountKey.json
*-firebase-adminsdk-*.json
serviceAccountKey*.json
.env*.local

# Environment variables
.env
.env.production
.env.staging
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Temporary files
*.tmp
.cache/deploy.js
.env
deploy.js
.aider*
</file>

<file path="firebase.json">
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ]
    }
  ],
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "headers": [
      {
        "source": "**/*.@(jpg|jpeg|gif|png|svg|webp)",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "max-age=31536000"
          }
        ]
      },
      {
        "source": "**/*.@(js|css)",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "max-age=31536000"
          }
        ]
      }
    ]
  },
  "storage": {
    "rules": "storage.rules"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="seed-test-data-local.js">
/**
 * seed-test-data-local.js
 * 
 * Script om test users en conversations aan te maken voor platform testing
 * 
 * GEBRUIK:
 * 1. Plaats dit bestand in je project root
 * 2. Run: node seed-test-data-local.js
 * 
 * BELANGRIJK: Dit script gebruikt Firebase Admin SDK
 * Je hebt je service account key nodig!
 */

import admin from 'firebase-admin';
import { readFileSync } from 'fs';

// Read service account key
const serviceAccount = JSON.parse(
  readFileSync('./serviceAccountKey-ddd-spark.json', 'utf8')
);

// Initialize Firebase Admin
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const db = admin.firestore();
const auth = admin.auth();

// Test data configuratie
const TEST_PASSWORD = 'TestPassword123!'; // Alle test users krijgen dit password

const TEST_PROGRAMMERS = [
  {
    email: 'programmer1@test.com',
    firstName: 'Jan',
    lastName: 'Janssen',
    organizationName: 'EventCo Amsterdam',
    status: 'pro', // Pro user - kan messages sturen
    phone: '+31612345671',
    website: 'https://eventco.nl',
    organizationAbout: 'Wij organiseren culturele evenementen in Amsterdam'
  },
  {
    email: 'programmer2@test.com',
    firstName: 'Marie',
    lastName: 'de Vries',
    organizationName: 'Festival Productions',
    status: 'trial', // Trial user - kan ook messages sturen
    phone: '+31612345672',
    website: 'https://festivalproductions.nl',
    organizationAbout: 'Muziekfestivals door heel Nederland'
  },
  {
    email: 'programmer3@test.com',
    firstName: 'Peter',
    lastName: 'Bakker',
    organizationName: 'Theater de Kleine Komedie',
    status: 'pending', // Pending - kan GEEN messages sturen
    phone: '+31612345673',
    website: 'https://kleinekomedie.nl',
    organizationAbout: 'Intiem theater in hartje Rotterdam'
  },
  {
    email: 'programmer4@test.com',
    firstName: 'Lisa',
    lastName: 'van Dijk',
    organizationName: 'Poetry Night Events',
    status: 'pro',
    phone: '+31612345674',
    website: 'https://poetrynight.nl',
    organizationAbout: 'Spoken word events in Utrecht'
  },
  {
    email: 'programmer5@test.com',
    firstName: 'Ahmed',
    lastName: 'Hassan',
    organizationName: 'Multicultureel Festival Den Haag',
    status: 'trial',
    phone: '+31612345675',
    website: 'https://mcfestival.nl',
    organizationAbout: 'Diverse cultural events in The Hague'
  }
];

const TEST_ARTISTS = [
  {
    email: 'artist1@test.com',
    firstName: 'Emma',
    lastName: 'Peters',
    stageName: 'Emma Speaks',
    phone: '+31687654321',
    dob: '1995-03-15',
    gender: 'f',
    location: 'Amsterdam',
    genres: ['Performance Poetry', 'Slam Poetry'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Performance poet uit Amsterdam met focus op maatschappelijke thema\'s',
    pitch: 'Krachtige spoken word over identiteit en sociale rechtvaardigheid. Perfect voor festivals en culturele evenementen.',
    videoUrl: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
    audioUrl: 'https://soundcloud.com/example',
    textContent: 'Sample poem text here...',
    published: true
  },
  {
    email: 'artist2@test.com',
    firstName: 'Jamal',
    lastName: 'Williams',
    stageName: 'J-Flow',
    phone: '+31687654322',
    dob: '1992-07-22',
    gender: 'm',
    location: 'Rotterdam',
    genres: ['Hip Hop Poetry', 'Rap'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Hip hop poet combining rhythm and storytelling',
    pitch: 'Energieke shows met een mix van rap en poetry. Ideaal voor jongeren events.',
    published: true
  },
  {
    email: 'artist3@test.com',
    firstName: 'Fatima',
    lastName: 'El Amrani',
    stageName: 'Fatima Flames',
    phone: '+31687654323',
    dob: '1998-11-08',
    gender: 'f',
    location: 'Utrecht',
    genres: ['Slam Poetry', 'Performance Poetry'],
    languages: ['nl', 'ar', 'fr'],
    paymentMethods: ['bank'],
    bio: 'Meertalige spoken word artist met Marokkaanse roots',
    pitch: 'Krachtige performances in Nederlands, Arabisch en Frans over identiteit en cultuur.',
    published: true
  },
  {
    email: 'artist4@test.com',
    firstName: 'Sophie',
    lastName: 'van Bergen',
    stageName: 'Sophie Softly',
    phone: '+31687654324',
    dob: '1990-05-30',
    gender: 'f',
    location: 'Den Haag',
    genres: ['Lyrical Poetry', 'Storytelling'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Intieme verhalen verteller met focus op persoonlijke groei',
    pitch: 'Zachte, emotionele poetry voor intieme settings en workshops.',
    published: true
  },
  {
    email: 'artist5@test.com',
    firstName: 'Marcus',
    lastName: 'Johnson',
    stageName: 'MC Truth',
    phone: '+31687654325',
    dob: '1988-01-12',
    gender: 'm',
    location: 'Amsterdam',
    genres: ['Hip Hop Poetry', 'Political Poetry'],
    languages: ['en', 'nl'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Political spoken word artist addressing social issues',
    pitch: 'Thought-provoking performances about equality and justice.',
    published: true
  },
  {
    email: 'artist6@test.com',
    firstName: 'Yuki',
    lastName: 'Tanaka',
    stageName: 'Yuki Words',
    phone: '+31687654326',
    dob: '1996-09-25',
    gender: 'x',
    location: 'Rotterdam',
    genres: ['Experimental Poetry', 'Performance Poetry'],
    languages: ['nl', 'en', 'ja'],
    paymentMethods: ['bank'],
    bio: 'Experimental artist blending Japanese and Dutch poetry traditions',
    pitch: 'Unique multicultural performances exploring identity and belonging.',
    published: true
  },
  {
    email: 'artist7@test.com',
    firstName: 'David',
    lastName: 'Cohen',
    stageName: 'David Verse',
    phone: '+31687654327',
    dob: '1985-12-03',
    gender: 'm',
    location: 'Utrecht',
    genres: ['Lyrical Poetry', 'Slam Poetry'],
    languages: ['nl', 'en', 'he'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Veteran spoken word artist with 10+ years experience',
    pitch: 'Experienced performer for any occasion. Workshop facilitator.',
    published: true
  },
  {
    email: 'artist8@test.com',
    firstName: 'Nina',
    lastName: 'Kowalski',
    stageName: 'Nina Rhythm',
    phone: '+31687654328',
    dob: '1993-04-18',
    gender: 'f',
    location: 'Den Haag',
    genres: ['Performance Poetry', 'Musical Poetry'],
    languages: ['nl', 'pl', 'en'],
    paymentMethods: ['bank'],
    bio: 'Poetry with live music and beatbox elements',
    pitch: 'Dynamic shows combining spoken word with music and rhythm.',
    published: true
  },
  {
    email: 'artist9@test.com',
    firstName: 'Lucas',
    lastName: 'Silva',
    stageName: 'Lucas Flow',
    phone: '+31687654329',
    dob: '1991-08-07',
    gender: 'm',
    location: 'Amsterdam',
    genres: ['Hip Hop Poetry', 'Rap'],
    languages: ['nl', 'pt', 'es'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Brazilian-Dutch artist blending cultures through rap poetry',
    pitch: 'Energetic multilingual performances celebrating diversity.',
    published: true
  },
  {
    email: 'artist10@test.com',
    firstName: 'Amira',
    lastName: 'Hassan',
    stageName: 'Amira Voice',
    phone: '+31687654330',
    dob: '1997-02-14',
    gender: 'f',
    location: 'Rotterdam',
    genres: ['Political Poetry', 'Slam Poetry'],
    languages: ['nl', 'ar', 'en'],
    paymentMethods: ['bank'],
    bio: 'Activist poet focusing on refugee stories and integration',
    pitch: 'Powerful narratives about migration, belonging and hope.',
    published: true
  }
];

// Helper functions
async function createAuthUser(email, password) {
  try {
    const userRecord = await auth.createUser({
      email: email,
      password: password,
      emailVerified: true // Skip email verification for test accounts
    });
    console.log(`‚úÖ Auth user created: ${email}`);
    return userRecord.uid;
  } catch (error) {
    if (error.code === 'auth/email-already-exists') {
      console.log(`‚ö†Ô∏è  User already exists: ${email}, fetching UID...`);
      const userRecord = await auth.getUserByEmail(email);
      return userRecord.uid;
    }
    throw error;
  }
}

async function createProgrammer(programmerData) {
  try {
    const uid = await createAuthUser(programmerData.email, TEST_PASSWORD);
    
    // Create user role document
    await db.collection('users').doc(uid).set({
      role: 'programmer',
      email: programmerData.email,
      status: programmerData.status
    });
    
    // Create programmer profile
    await db.collection('programmers').doc(uid).set({
      uid: uid,
      email: programmerData.email,
      firstName: programmerData.firstName,
      lastName: programmerData.lastName,
      phone: programmerData.phone,
      organizationName: programmerData.organizationName,
      organizationAbout: programmerData.organizationAbout,
      website: programmerData.website,
      notifyEmail: true,
      createdAt: new Date().toISOString(),
      status: programmerData.status,
      trialStartedAt: new Date().toISOString()
    });
    
    console.log(`‚úÖ Programmer created: ${programmerData.email} (${programmerData.status})`);
    return uid;
  } catch (error) {
    console.error(`‚ùå Error creating programmer ${programmerData.email}:`, error.message);
    return null;
  }
}

async function createArtist(artistData) {
  try {
    const uid = await createAuthUser(artistData.email, TEST_PASSWORD);
    
    // Create user role document
    await db.collection('users').doc(uid).set({
      role: 'artist',
      email: artistData.email,
      status: 'active'
    });
    
    // Create artist profile
    await db.collection('artists').doc(uid).set({
      uid: uid,
      email: artistData.email,
      firstName: artistData.firstName,
      lastName: artistData.lastName,
      stageName: artistData.stageName,
      phone: artistData.phone,
      dob: artistData.dob,
      gender: artistData.gender,
      location: artistData.location,
      genres: artistData.genres,
      languages: artistData.languages,
      paymentMethods: artistData.paymentMethods,
      bio: artistData.bio,
      pitch: artistData.pitch,
      videoUrl: artistData.videoUrl || '',
      audioUrl: artistData.audioUrl || '',
      textContent: artistData.textContent || '',
      notifyEmail: true,
      notifySms: false,
      createdAt: new Date().toISOString(),
      profilePicUrl: '',
      published: artistData.published
    });
    
    console.log(`‚úÖ Artist created: ${artistData.stageName} (${artistData.email})`);
    return uid;
  } catch (error) {
    console.error(`‚ùå Error creating artist ${artistData.email}:`, error.message);
    return null;
  }
}

async function createTestConversation(programmerUid, programmerData, artistUid, artistData, messageCount = 3) {
  try {
    const conversationData = {
      participants: [programmerUid, artistUid],
      participantNames: {
        [programmerUid]: `${programmerData.firstName} ${programmerData.lastName}`,
        [artistUid]: artistData.stageName || `${artistData.firstName} ${artistData.lastName}`
      },
      participantRoles: {
        [programmerUid]: 'programmer',
        [artistUid]: 'artist'
      },
      participantEmails: {
        [programmerUid]: programmerData.email,
        [artistUid]: artistData.email
      },
      subject: `Booking inquiry for ${artistData.stageName}`,
      lastMessage: '',
      lastMessageAt: admin.firestore.FieldValue.serverTimestamp(),
      unreadBy: [artistUid], // Artist has not read yet
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    };
    
    const conversationRef = await db.collection('conversations').add(conversationData);
    console.log(`‚úÖ Conversation created between ${programmerData.firstName} and ${artistData.stageName}`);
    
    // Add test messages
    const messages = [
      {
        senderId: programmerUid,
        senderName: `${programmerData.firstName} ${programmerData.lastName}`,
        senderRole: 'programmer',
        text: `Hi ${artistData.firstName}! I'm organizing an event and would love to have you perform. Are you available in December?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 24 * 2)), // 2 days ago
        read: false
      },
      {
        senderId: artistUid,
        senderName: artistData.stageName,
        senderRole: 'artist',
        text: `Hi ${programmerData.firstName}! Thanks for reaching out. Yes, I have some availability in December. What dates were you thinking?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 24 * 1)), // 1 day ago
        read: false
      },
      {
        senderId: programmerUid,
        senderName: `${programmerData.firstName} ${programmerData.lastName}`,
        senderRole: 'programmer',
        text: `Great! We're looking at December 15th. It's an evening event with about 200 attendees. Would that work for you?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 12)), // 12 hours ago
        read: false
      }
    ];
    
    for (let i = 0; i < Math.min(messageCount, messages.length); i++) {
      await db.collection(`conversations/${conversationRef.id}/messages`).add(messages[i]);
    }
    
    // Update conversation with last message
    await conversationRef.update({
      lastMessage: messages[Math.min(messageCount, messages.length) - 1].text.substring(0, 100),
      lastMessageAt: messages[Math.min(messageCount, messages.length) - 1].createdAt
    });
    
    console.log(`‚úÖ Added ${messageCount} messages to conversation`);
    
    return conversationRef.id;
  } catch (error) {
    console.error(`‚ùå Error creating conversation:`, error.message);
    return null;
  }
}

// Main seeding function
async function seedDatabase() {
  console.log('\nüå± Starting database seeding...\n');
  
  try {
    // Create programmers
    console.log('üë®‚Äçüíª Creating programmers...');
    const programmerUids = [];
    for (const programmer of TEST_PROGRAMMERS) {
      const uid = await createProgrammer(programmer);
      if (uid) {
        programmerUids.push({ uid, data: programmer });
      }
    }
    console.log(`\n‚úÖ Created ${programmerUids.length} programmers\n`);
    
    // Create artists
    console.log('üé§ Creating artists...');
    const artistUids = [];
    for (const artist of TEST_ARTISTS) {
      const uid = await createArtist(artist);
      if (uid) {
        artistUids.push({ uid, data: artist });
      }
    }
    console.log(`\n‚úÖ Created ${artistUids.length} artists\n`);
    
    // Create test conversations
    console.log('üí¨ Creating test conversations...');
    let conversationCount = 0;
    
    // Create conversations between first 2 PRO programmers and various artists
    const proOrTrialProgrammers = programmerUids.filter(p => p.data.status === 'pro' || p.data.status === 'trial');
    
    for (let i = 0; i < Math.min(2, proOrTrialProgrammers.length); i++) {
      for (let j = 0; j < Math.min(3, artistUids.length); j++) {
        await createTestConversation(
          proOrTrialProgrammers[i].uid,
          proOrTrialProgrammers[i].data,
          artistUids[j].uid,
          artistUids[j].data,
          3
        );
        conversationCount++;
      }
    }
    
    console.log(`\n‚úÖ Created ${conversationCount} conversations with messages\n`);
    
    // Summary
    console.log('\nüìä SEEDING COMPLETE!\n');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`‚úÖ ${programmerUids.length} Programmers created`);
    console.log(`‚úÖ ${artistUids.length} Artists created`);
    console.log(`‚úÖ ${conversationCount} Conversations created`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    console.log('üîë TEST LOGIN CREDENTIALS:\n');
    console.log('All users have password: ' + TEST_PASSWORD + '\n');
    
    console.log('üë®‚Äçüíª PROGRAMMERS:');
    programmerUids.forEach(p => {
      console.log(`  - ${p.data.email} (${p.data.status}) - ${p.data.organizationName}`);
    });
    
    console.log('\nüé§ ARTISTS:');
    artistUids.forEach(a => {
      console.log(`  - ${a.data.email} - ${a.data.stageName}`);
    });
    
    console.log('\n‚ú® Ready to test! Log in with any email above.\n');
    
  } catch (error) {
    console.error('‚ùå Fatal error during seeding:', error);
  }
  
  process.exit(0);
}

// Run the seeding
seedDatabase();
</file>

<file path="seed-test-data.js">
/**
 * seed-test-data.js
 * 
 * Script om test users en conversations aan te maken voor platform testing
 * 
 * GEBRUIK:
 * 1. Plaats dit bestand in je project root
 * 2. Run: node seed-test-data.js
 * 
 * BELANGRIJK: Dit script gebruikt Firebase Admin SDK
 * Je hebt je service account key nodig!
 */

import admin from 'firebase-admin';
import { readFileSync } from 'fs';

// Read service account key
const serviceAccount = JSON.parse(
  readFileSync('./serviceAccountKey.json', 'utf8')
);

// Initialize Firebase Admin
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const db = admin.firestore();
const auth = admin.auth();

// Test data configuratie
const TEST_PASSWORD = 'TestPassword123!'; // Alle test users krijgen dit password

const TEST_PROGRAMMERS = [
  {
    email: 'programmer1@test.com',
    firstName: 'Jan',
    lastName: 'Janssen',
    organizationName: 'EventCo Amsterdam',
    status: 'pro', // Pro user - kan messages sturen
    phone: '+31612345671',
    website: 'https://eventco.nl',
    organizationAbout: 'Wij organiseren culturele evenementen in Amsterdam'
  },
  {
    email: 'programmer2@test.com',
    firstName: 'Marie',
    lastName: 'de Vries',
    organizationName: 'Festival Productions',
    status: 'trial', // Trial user - kan ook messages sturen
    phone: '+31612345672',
    website: 'https://festivalproductions.nl',
    organizationAbout: 'Muziekfestivals door heel Nederland'
  },
  {
    email: 'programmer3@test.com',
    firstName: 'Peter',
    lastName: 'Bakker',
    organizationName: 'Theater de Kleine Komedie',
    status: 'pending', // Pending - kan GEEN messages sturen
    phone: '+31612345673',
    website: 'https://kleinekomedie.nl',
    organizationAbout: 'Intiem theater in hartje Rotterdam'
  },
  {
    email: 'programmer4@test.com',
    firstName: 'Lisa',
    lastName: 'van Dijk',
    organizationName: 'Poetry Night Events',
    status: 'pro',
    phone: '+31612345674',
    website: 'https://poetrynight.nl',
    organizationAbout: 'Spoken word events in Utrecht'
  },
  {
    email: 'programmer5@test.com',
    firstName: 'Ahmed',
    lastName: 'Hassan',
    organizationName: 'Multicultureel Festival Den Haag',
    status: 'trial',
    phone: '+31612345675',
    website: 'https://mcfestival.nl',
    organizationAbout: 'Diverse cultural events in The Hague'
  }
];

const TEST_ARTISTS = [
  {
    email: 'artist1@test.com',
    firstName: 'Emma',
    lastName: 'Peters',
    stageName: 'Emma Speaks',
    phone: '+31687654321',
    dob: '1995-03-15',
    gender: 'f',
    location: 'Amsterdam',
    genres: ['Performance Poetry', 'Slam Poetry'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Performance poet uit Amsterdam met focus op maatschappelijke thema\'s',
    pitch: 'Krachtige spoken word over identiteit en sociale rechtvaardigheid. Perfect voor festivals en culturele evenementen.',
    videoUrl: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
    audioUrl: 'https://soundcloud.com/example',
    textContent: 'Sample poem text here...',
    published: true
  },
  {
    email: 'artist2@test.com',
    firstName: 'Jamal',
    lastName: 'Williams',
    stageName: 'J-Flow',
    phone: '+31687654322',
    dob: '1992-07-22',
    gender: 'm',
    location: 'Rotterdam',
    genres: ['Hip Hop Poetry', 'Rap'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Hip hop poet combining rhythm and storytelling',
    pitch: 'Energieke shows met een mix van rap en poetry. Ideaal voor jongeren events.',
    published: true
  },
  {
    email: 'artist3@test.com',
    firstName: 'Fatima',
    lastName: 'El Amrani',
    stageName: 'Fatima Flames',
    phone: '+31687654323',
    dob: '1998-11-08',
    gender: 'f',
    location: 'Utrecht',
    genres: ['Slam Poetry', 'Performance Poetry'],
    languages: ['nl', 'ar', 'fr'],
    paymentMethods: ['bank'],
    bio: 'Meertalige spoken word artist met Marokkaanse roots',
    pitch: 'Krachtige performances in Nederlands, Arabisch en Frans over identiteit en cultuur.',
    published: true
  },
  {
    email: 'artist4@test.com',
    firstName: 'Sophie',
    lastName: 'van Bergen',
    stageName: 'Sophie Softly',
    phone: '+31687654324',
    dob: '1990-05-30',
    gender: 'f',
    location: 'Den Haag',
    genres: ['Lyrical Poetry', 'Storytelling'],
    languages: ['nl', 'en'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Intieme verhalen verteller met focus op persoonlijke groei',
    pitch: 'Zachte, emotionele poetry voor intieme settings en workshops.',
    published: true
  },
  {
    email: 'artist5@test.com',
    firstName: 'Marcus',
    lastName: 'Johnson',
    stageName: 'MC Truth',
    phone: '+31687654325',
    dob: '1988-01-12',
    gender: 'm',
    location: 'Amsterdam',
    genres: ['Hip Hop Poetry', 'Political Poetry'],
    languages: ['en', 'nl'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Political spoken word artist addressing social issues',
    pitch: 'Thought-provoking performances about equality and justice.',
    published: true
  },
  {
    email: 'artist6@test.com',
    firstName: 'Yuki',
    lastName: 'Tanaka',
    stageName: 'Yuki Words',
    phone: '+31687654326',
    dob: '1996-09-25',
    gender: 'x',
    location: 'Rotterdam',
    genres: ['Experimental Poetry', 'Performance Poetry'],
    languages: ['nl', 'en', 'ja'],
    paymentMethods: ['bank'],
    bio: 'Experimental artist blending Japanese and Dutch poetry traditions',
    pitch: 'Unique multicultural performances exploring identity and belonging.',
    published: true
  },
  {
    email: 'artist7@test.com',
    firstName: 'David',
    lastName: 'Cohen',
    stageName: 'David Verse',
    phone: '+31687654327',
    dob: '1985-12-03',
    gender: 'm',
    location: 'Utrecht',
    genres: ['Lyrical Poetry', 'Slam Poetry'],
    languages: ['nl', 'en', 'he'],
    paymentMethods: ['bank', 'cash'],
    bio: 'Veteran spoken word artist with 10+ years experience',
    pitch: 'Experienced performer for any occasion. Workshop facilitator.',
    published: true
  },
  {
    email: 'artist8@test.com',
    firstName: 'Nina',
    lastName: 'Kowalski',
    stageName: 'Nina Rhythm',
    phone: '+31687654328',
    dob: '1993-04-18',
    gender: 'f',
    location: 'Den Haag',
    genres: ['Performance Poetry', 'Musical Poetry'],
    languages: ['nl', 'pl', 'en'],
    paymentMethods: ['bank'],
    bio: 'Poetry with live music and beatbox elements',
    pitch: 'Dynamic shows combining spoken word with music and rhythm.',
    published: true
  },
  {
    email: 'artist9@test.com',
    firstName: 'Lucas',
    lastName: 'Silva',
    stageName: 'Lucas Flow',
    phone: '+31687654329',
    dob: '1991-08-07',
    gender: 'm',
    location: 'Amsterdam',
    genres: ['Hip Hop Poetry', 'Rap'],
    languages: ['nl', 'pt', 'es'],
    paymentMethods: ['bank', 'paypal'],
    bio: 'Brazilian-Dutch artist blending cultures through rap poetry',
    pitch: 'Energetic multilingual performances celebrating diversity.',
    published: true
  },
  {
    email: 'artist10@test.com',
    firstName: 'Amira',
    lastName: 'Hassan',
    stageName: 'Amira Voice',
    phone: '+31687654330',
    dob: '1997-02-14',
    gender: 'f',
    location: 'Rotterdam',
    genres: ['Political Poetry', 'Slam Poetry'],
    languages: ['nl', 'ar', 'en'],
    paymentMethods: ['bank'],
    bio: 'Activist poet focusing on refugee stories and integration',
    pitch: 'Powerful narratives about migration, belonging and hope.',
    published: true
  }
];

// Helper functions
async function createAuthUser(email, password) {
  try {
    const userRecord = await auth.createUser({
      email: email,
      password: password,
      emailVerified: true // Skip email verification for test accounts
    });
    console.log(`‚úÖ Auth user created: ${email}`);
    return userRecord.uid;
  } catch (error) {
    if (error.code === 'auth/email-already-exists') {
      console.log(`‚ö†Ô∏è  User already exists: ${email}, fetching UID...`);
      const userRecord = await auth.getUserByEmail(email);
      return userRecord.uid;
    }
    throw error;
  }
}

async function createProgrammer(programmerData) {
  try {
    const uid = await createAuthUser(programmerData.email, TEST_PASSWORD);
    
    // Create user role document
    await db.collection('users').doc(uid).set({
      role: 'programmer',
      email: programmerData.email,
      status: programmerData.status
    });
    
    // Create programmer profile
    await db.collection('programmers').doc(uid).set({
      uid: uid,
      email: programmerData.email,
      firstName: programmerData.firstName,
      lastName: programmerData.lastName,
      phone: programmerData.phone,
      organizationName: programmerData.organizationName,
      organizationAbout: programmerData.organizationAbout,
      website: programmerData.website,
      notifyEmail: true,
      createdAt: new Date().toISOString(),
      status: programmerData.status,
      trialStartedAt: new Date().toISOString()
    });
    
    console.log(`‚úÖ Programmer created: ${programmerData.email} (${programmerData.status})`);
    return uid;
  } catch (error) {
    console.error(`‚ùå Error creating programmer ${programmerData.email}:`, error.message);
    return null;
  }
}

async function createArtist(artistData) {
  try {
    const uid = await createAuthUser(artistData.email, TEST_PASSWORD);
    
    // Create user role document
    await db.collection('users').doc(uid).set({
      role: 'artist',
      email: artistData.email,
      status: 'active'
    });
    
    // Create artist profile
    await db.collection('artists').doc(uid).set({
      uid: uid,
      email: artistData.email,
      firstName: artistData.firstName,
      lastName: artistData.lastName,
      stageName: artistData.stageName,
      phone: artistData.phone,
      dob: artistData.dob,
      gender: artistData.gender,
      location: artistData.location,
      genres: artistData.genres,
      languages: artistData.languages,
      paymentMethods: artistData.paymentMethods,
      bio: artistData.bio,
      pitch: artistData.pitch,
      videoUrl: artistData.videoUrl || '',
      audioUrl: artistData.audioUrl || '',
      textContent: artistData.textContent || '',
      notifyEmail: true,
      notifySms: false,
      createdAt: new Date().toISOString(),
      profilePicUrl: '',
      published: artistData.published
    });
    
    console.log(`‚úÖ Artist created: ${artistData.stageName} (${artistData.email})`);
    return uid;
  } catch (error) {
    console.error(`‚ùå Error creating artist ${artistData.email}:`, error.message);
    return null;
  }
}

async function createTestConversation(programmerUid, programmerData, artistUid, artistData, messageCount = 3) {
  try {
    const conversationData = {
      participants: [programmerUid, artistUid],
      participantNames: {
        [programmerUid]: `${programmerData.firstName} ${programmerData.lastName}`,
        [artistUid]: artistData.stageName || `${artistData.firstName} ${artistData.lastName}`
      },
      participantRoles: {
        [programmerUid]: 'programmer',
        [artistUid]: 'artist'
      },
      participantEmails: {
        [programmerUid]: programmerData.email,
        [artistUid]: artistData.email
      },
      subject: `Booking inquiry for ${artistData.stageName}`,
      lastMessage: '',
      lastMessageAt: admin.firestore.FieldValue.serverTimestamp(),
      unreadBy: [artistUid], // Artist has not read yet
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    };
    
    const conversationRef = await db.collection('conversations').add(conversationData);
    console.log(`‚úÖ Conversation created between ${programmerData.firstName} and ${artistData.stageName}`);
    
    // Add test messages
    const messages = [
      {
        senderId: programmerUid,
        senderName: `${programmerData.firstName} ${programmerData.lastName}`,
        senderRole: 'programmer',
        text: `Hi ${artistData.firstName}! I'm organizing an event and would love to have you perform. Are you available in December?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 24 * 2)), // 2 days ago
        read: false
      },
      {
        senderId: artistUid,
        senderName: artistData.stageName,
        senderRole: 'artist',
        text: `Hi ${programmerData.firstName}! Thanks for reaching out. Yes, I have some availability in December. What dates were you thinking?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 24 * 1)), // 1 day ago
        read: false
      },
      {
        senderId: programmerUid,
        senderName: `${programmerData.firstName} ${programmerData.lastName}`,
        senderRole: 'programmer',
        text: `Great! We're looking at December 15th. It's an evening event with about 200 attendees. Would that work for you?`,
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 3600000 * 12)), // 12 hours ago
        read: false
      }
    ];
    
    for (let i = 0; i < Math.min(messageCount, messages.length); i++) {
      await db.collection(`conversations/${conversationRef.id}/messages`).add(messages[i]);
    }
    
    // Update conversation with last message
    await conversationRef.update({
      lastMessage: messages[Math.min(messageCount, messages.length) - 1].text.substring(0, 100),
      lastMessageAt: messages[Math.min(messageCount, messages.length) - 1].createdAt
    });
    
    console.log(`‚úÖ Added ${messageCount} messages to conversation`);
    
    return conversationRef.id;
  } catch (error) {
    console.error(`‚ùå Error creating conversation:`, error.message);
    return null;
  }
}

// Main seeding function
async function seedDatabase() {
  console.log('\nüå± Starting database seeding...\n');
  
  try {
    // Create programmers
    console.log('üë®‚Äçüíª Creating programmers...');
    const programmerUids = [];
    for (const programmer of TEST_PROGRAMMERS) {
      const uid = await createProgrammer(programmer);
      if (uid) {
        programmerUids.push({ uid, data: programmer });
      }
    }
    console.log(`\n‚úÖ Created ${programmerUids.length} programmers\n`);
    
    // Create artists
    console.log('üé§ Creating artists...');
    const artistUids = [];
    for (const artist of TEST_ARTISTS) {
      const uid = await createArtist(artist);
      if (uid) {
        artistUids.push({ uid, data: artist });
      }
    }
    console.log(`\n‚úÖ Created ${artistUids.length} artists\n`);
    
    // Create test conversations
    console.log('üí¨ Creating test conversations...');
    let conversationCount = 0;
    
    // Create conversations between first 2 PRO programmers and various artists
    const proOrTrialProgrammers = programmerUids.filter(p => p.data.status === 'pro' || p.data.status === 'trial');
    
    for (let i = 0; i < Math.min(2, proOrTrialProgrammers.length); i++) {
      for (let j = 0; j < Math.min(3, artistUids.length); j++) {
        await createTestConversation(
          proOrTrialProgrammers[i].uid,
          proOrTrialProgrammers[i].data,
          artistUids[j].uid,
          artistUids[j].data,
          3
        );
        conversationCount++;
      }
    }
    
    console.log(`\n‚úÖ Created ${conversationCount} conversations with messages\n`);
    
    // Summary
    console.log('\nüìä SEEDING COMPLETE!\n');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`‚úÖ ${programmerUids.length} Programmers created`);
    console.log(`‚úÖ ${artistUids.length} Artists created`);
    console.log(`‚úÖ ${conversationCount} Conversations created`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    console.log('üîë TEST LOGIN CREDENTIALS:\n');
    console.log('All users have password: ' + TEST_PASSWORD + '\n');
    
    console.log('üë®‚Äçüíª PROGRAMMERS:');
    programmerUids.forEach(p => {
      console.log(`  - ${p.data.email} (${p.data.status}) - ${p.data.organizationName}`);
    });
    
    console.log('\nüé§ ARTISTS:');
    artistUids.forEach(a => {
      console.log(`  - ${a.data.email} - ${a.data.stageName}`);
    });
    
    console.log('\n‚ú® Ready to test! Log in with any email above.\n');
    
  } catch (error) {
    console.error('‚ùå Fatal error during seeding:', error);
  }
  
  process.exit(0);
}

// Run the seeding
seedDatabase();
</file>

<file path="storage.rules">
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // 1. Artiesten: Media en Portfolio (Publiek leesbaar)
    match /artists/{userId}/{allPaths=**} {
      allow read: if true; 
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024; // Limiet van 10MB
    }
    
    // 2. Programmeurs: Profielfoto's (Alleen voor ingelogde gebruikers)
    match /programmers/{userId}/{allPaths=**} {
      allow read: if request.auth != null; 
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024 // Limiet van 5MB
                   && request.resource.contentType.matches('image/.*');
    }
    
    // 3. Documenten (bijv. technische fiches)
    match /documents/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Default: Alles blokkeren
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
</file>

<file path="src/modules/artist/artist-media.js">
/**
 * artist-media.js
 * Handle photo gallery and YouTube video management for artists
 */

import { getStore, setStore } from '../../utils/store.js';

/**
 * Initialize media gallery management for artist profile edit
 */
export function initArtistMediaGallery() {
  setupPhotoUpload();
  setupYouTubeVideos();
  loadExistingMedia();
}

/**
 * Setup photo upload functionality
 */
function setupPhotoUpload() {
  const uploadBtn = document.getElementById('add-gallery-photo-btn');
  const uploadInput = document.getElementById('gallery-photo-input');

  if (uploadBtn && uploadInput) {
    uploadBtn.addEventListener('click', () => uploadInput.click());

    uploadInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (files.length === 0) return;

      for (const file of files) {
        await uploadGalleryPhoto(file);
      }

      // Clear input
      uploadInput.value = '';
    });
  }
}

/**
 * Upload a photo to Firebase Storage
 */
async function uploadGalleryPhoto(file) {
  const currentUser = getStore('currentUser');
  if (!currentUser) {
    alert('Je moet ingelogd zijn om foto\'s te uploaden.');
    return;
  }

  // Validate file
  if (!file.type.startsWith('image/')) {
    alert('Alleen afbeeldingen zijn toegestaan.');
    return;
  }

  if (file.size > 5 * 1024 * 1024) {
    alert('Afbeelding mag maximaal 5MB zijn.');
    return;
  }

  try {
    showUploadProgress(true);

    const { ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
    const { doc, updateDoc, arrayUnion } = await import('firebase/firestore');
    const { storage, db } = await import('../../services/firebase.js');

    // Generate unique filename
    const timestamp = Date.now();
    const filename = `gallery_${timestamp}_${file.name}`;
    const storageRef = ref(storage, `artists/${currentUser.uid}/gallery/${filename}`);

    // Upload
    const snapshot = await uploadBytes(storageRef, file);
    const downloadURL = await getDownloadURL(snapshot.ref);

    // Update Firestore
    await updateDoc(doc(db, 'artists', currentUser.uid), {
      galleryPhotos: arrayUnion(downloadURL)
    });

    // Update local store
    const userData = getStore('currentUserData');
    const photos = userData.galleryPhotos || [];
    photos.push(downloadURL);
    setStore('currentUserData', { ...userData, galleryPhotos: photos });

    // Refresh UI
    renderGalleryPhotos();

    console.log('[MEDIA] Photo uploaded:', downloadURL);

  } catch (error) {
    console.error('[MEDIA] Upload error:', error);
    alert('Fout bij uploaden. Probeer opnieuw.');
  } finally {
    showUploadProgress(false);
  }
}

/**
 * Delete a gallery photo
 */
export async function deleteGalleryPhoto(photoUrl) {
  const currentUser = getStore('currentUser');
  if (!currentUser) return;

  if (!confirm('Weet je zeker dat je deze foto wilt verwijderen?')) return;

  try {
    const { doc, updateDoc, arrayRemove } = await import('firebase/firestore');
    const { ref, deleteObject } = await import('firebase/storage');
    const { storage, db } = await import('../../services/firebase.js');

    // Remove from Firestore
    await updateDoc(doc(db, 'artists', currentUser.uid), {
      galleryPhotos: arrayRemove(photoUrl)
    });

    // Try to delete from Storage (may fail if URL format differs)
    try {
      const storageRef = ref(storage, photoUrl);
      await deleteObject(storageRef);
    } catch (storageErr) {
      console.warn('[MEDIA] Could not delete from storage:', storageErr);
    }

    // Update local store
    const userData = getStore('currentUserData');
    const photos = (userData.galleryPhotos || []).filter(p => p !== photoUrl);
    setStore('currentUserData', { ...userData, galleryPhotos: photos });

    // Refresh UI
    renderGalleryPhotos();

    console.log('[MEDIA] Photo deleted');

  } catch (error) {
    console.error('[MEDIA] Delete error:', error);
    alert('Fout bij verwijderen. Probeer opnieuw.');
  }
}

/**
 * Setup YouTube video management
 */
function setupYouTubeVideos() {
  const addBtn = document.getElementById('add-youtube-btn');
  const input = document.getElementById('youtube-url-input');

  if (addBtn && input) {
    addBtn.addEventListener('click', async () => {
      const url = input.value.trim();
      if (!url) {
        alert('Voer een YouTube URL in.');
        return;
      }

      const videoId = extractYouTubeId(url);
      if (!videoId) {
        alert('Ongeldige YouTube URL.');
        return;
      }

      await addYouTubeVideo(url, videoId);
      input.value = '';
    });
  }
}

/**
 * Add YouTube video to profile
 */
async function addYouTubeVideo(url, videoId) {
  const currentUser = getStore('currentUser');
  if (!currentUser) return;

  try {
    const { doc, updateDoc, arrayUnion } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');

    const videoData = {
      url: url,
      videoId: videoId,
      addedAt: new Date().toISOString()
    };

    await updateDoc(doc(db, 'artists', currentUser.uid), {
      youtubeVideos: arrayUnion(videoData)
    });

    // Update local store
    const userData = getStore('currentUserData');
    const videos = userData.youtubeVideos || [];
    videos.push(videoData);
    setStore('currentUserData', { ...userData, youtubeVideos: videos });

    // Refresh UI
    renderYouTubeVideos();

    console.log('[MEDIA] YouTube video added:', videoId);

  } catch (error) {
    console.error('[MEDIA] Add video error:', error);
    alert('Fout bij toevoegen video. Probeer opnieuw.');
  }
}

/**
 * Delete YouTube video
 */
export async function deleteYouTubeVideo(videoId) {
  const currentUser = getStore('currentUser');
  if (!currentUser) return;

  if (!confirm('Weet je zeker dat je deze video wilt verwijderen?')) return;

  try {
    const { doc, getDoc, updateDoc } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');

    // Get current videos
    const docRef = doc(db, 'artists', currentUser.uid);
    const docSnap = await getDoc(docRef);
    const data = docSnap.data();

    const updatedVideos = (data.youtubeVideos || []).filter(v => v.videoId !== videoId);

    await updateDoc(docRef, {
      youtubeVideos: updatedVideos
    });

    // Update local store
    const userData = getStore('currentUserData');
    setStore('currentUserData', { ...userData, youtubeVideos: updatedVideos });

    // Refresh UI
    renderYouTubeVideos();

    console.log('[MEDIA] YouTube video deleted:', videoId);

  } catch (error) {
    console.error('[MEDIA] Delete video error:', error);
    alert('Fout bij verwijderen video. Probeer opnieuw.');
  }
}

/**
 * Load and render existing media
 */
function loadExistingMedia() {
  renderGalleryPhotos();
  renderYouTubeVideos();
}

/**
 * Render gallery photos in edit form
 */
function renderGalleryPhotos() {
  const container = document.getElementById('gallery-photos-grid');
  if (!container) return;

  const userData = getStore('currentUserData');
  const photos = userData?.galleryPhotos || [];

  if (photos.length === 0) {
    container.innerHTML = `
      <p style="color: #9ca3af; font-size: 14px; grid-column: span 3;">Geen foto's toegevoegd.</p>
    `;
    return;
  }

  container.innerHTML = photos.map(photo => `
    <div style="position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
      <img src="${photo}" alt="Gallery photo" style="width: 100%; height: 100%; object-fit: cover;">
      <button onclick="window.deleteGalleryPhoto && window.deleteGalleryPhoto('${photo}')"
              style="position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(239,68,68,0.9); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  `).join('');

  // Expose delete function globally for onclick
  window.deleteGalleryPhoto = deleteGalleryPhoto;
}

/**
 * Render YouTube videos in edit form
 */
function renderYouTubeVideos() {
  const container = document.getElementById('youtube-videos-grid');
  if (!container) return;

  const userData = getStore('currentUserData');
  const videos = userData?.youtubeVideos || [];

  if (videos.length === 0) {
    container.innerHTML = `
      <p style="color: #9ca3af; font-size: 14px;">Geen video's toegevoegd.</p>
    `;
    return;
  }

  container.innerHTML = videos.map(video => {
    const videoId = video.videoId || extractYouTubeId(video.url || video);
    return `
      <div style="position: relative; border-radius: 12px; overflow: hidden; background: #f3f4f6;">
        <div style="aspect-ratio: 16/9;">
          <iframe
            src="https://www.youtube.com/embed/${videoId}"
            style="width: 100%; height: 100%; border: none;"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
        <button onclick="window.deleteYouTubeVideo && window.deleteYouTubeVideo('${videoId}')"
                style="position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(239,68,68,0.9); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    `;
  }).join('');

  // Expose delete function globally
  window.deleteYouTubeVideo = deleteYouTubeVideo;
}

function showUploadProgress(show) {
  const indicator = document.getElementById('upload-progress');
  if (indicator) {
    indicator.style.display = show ? 'flex' : 'none';
  }
}

function extractYouTubeId(url) {
  if (!url) return null;
  const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
  return match ? match[1] : null;
}

export { renderGalleryPhotos, renderYouTubeVideos };
</file>

<file path="src/modules/calendar/calendar-controller.js">
/**
 * calendar-controller.js
 * Event handling en initialisatie voor calendar module
 */

import { getStore } from '../../utils/store.js';
import {
  addEvent,
  getArtistEvents,
  updateEvent,
  deleteEvent,
  getEvent,
  getAllUpcomingEvents,
  getEventsForDateRange,
  getEventsGroupedByDate,
  getEventCountsPerDate,
  toggleAttendance
} from './calendar-service.js';
import {
  renderUpcomingGigsWidget,
  renderGigModal,
  renderDeleteConfirmModal,
  renderClusterCard,
  renderSoloGigCard,
  renderAgendaFilters,
  renderAgendaLayout,
  renderMonthCalendar
} from './calendar-ui.js';

let currentEvents = [];
let currentPosterCanvas = null;
let currentPosterTheme = 'indigo';
let currentPosterArtistData = null;
let currentPosterEvents = null;

// Agenda state
let agendaState = {
  selectedDate: new Date(),
  filterMode: 'month', // 'day' of 'month'
  events: [],
  filteredEvents: [],
  filters: {
    types: [], // lege array = alle types
    region: 'all' // 'all', 'nederland', 'vlaanderen', 'brussel'
  },
  viewMode: 'list', // 'list' of 'map'
  isLoading: false
};

// Getter voor externe toegang
export function getAgendaState() {
  return { ...agendaState };
}

/**
 * Initialize calendar module voor artist dashboard
 */
export async function initCalendar() {
  const currentUser = getStore('currentUser');
  const currentUserData = getStore('currentUserData');

  if (!currentUser || currentUserData?.role !== 'artist') {
    console.log('[CALENDAR] Not an artist, skipping calendar init');
    return;
  }

  console.log('[CALENDAR] Initializing calendar module');

  // Load events
  await loadAndRenderEvents();

  // Setup event listeners
  setupCalendarEventListeners();
}

/**
 * Load events en render widget
 */
export async function loadAndRenderEvents() {
  const currentUser = getStore('currentUser');
  if (!currentUser) return;

  try {
    currentEvents = await getArtistEvents(currentUser.uid, { upcomingOnly: true, limitCount: 10 });
    await renderGigsWidget();
  } catch (error) {
    console.error('[CALENDAR] Error loading events:', error);
    currentEvents = [];
    await renderGigsWidget();
  }
}

/**
 * Render de gigs widget in het dashboard
 */
async function renderGigsWidget() {
  const container = document.getElementById('upcoming-gigs-container');
  if (!container) {
    console.warn('[CALENDAR] Gigs container not found');
    return;
  }

  const currentUser = getStore('currentUser');

  // Load and render attendee notifications for artist
  if (currentUser) {
    const { getAttendeeNotifications, getAttendeeProfiles } = await import('./calendar-service.js');
    const notifications = await getAttendeeNotifications(currentUser.uid);

    // Haal profielen op voor elke notificatie
    for (const notification of notifications) {
      notification.profiles = await getAttendeeProfiles(notification.attendees);
    }

    if (notifications.length > 0) {
      const { renderAttendeeNotifications } = await import('./calendar-ui.js');

      // Remove existing notifications first
      const existingNotifications = document.getElementById('attendee-notifications-container');
      if (existingNotifications) {
        existingNotifications.remove();
      }

      const notificationsHtml = renderAttendeeNotifications(notifications);

      // Insert before the gigs container
      container.insertAdjacentHTML('beforebegin', `
        <div id="attendee-notifications-container">
          ${notificationsHtml}
        </div>
      `);
    }
  }

  container.innerHTML = renderUpcomingGigsWidget(currentEvents, true);

  // Render poster button
  const posterContainer = document.getElementById('poster-generator-container');
  if (posterContainer) {
    const { renderPosterButton } = await import('./poster-generator.js');
    posterContainer.innerHTML = renderPosterButton(currentEvents.length);
  }

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }
}

/**
 * Setup event listeners via event delegation
 */
function setupCalendarEventListeners() {
  // Use event delegation on document.body
  document.body.addEventListener('click', handleCalendarClick);
  console.log('[CALENDAR] Event listeners attached');
}

/**
 * Handle all calendar-related clicks
 * @param {Event} e - Click event
 */
async function handleCalendarClick(e) {
  const target = e.target;

  // Add Gig buttons
  if (target.closest('#add-gig-btn') || target.closest('#add-first-gig-btn')) {
    e.preventDefault();
    openGigModal();
    return;
  }

  // Edit Gig button
  if (target.closest('.edit-gig-btn')) {
    e.preventDefault();
    const eventId = target.closest('.edit-gig-btn').dataset.eventId;
    await openEditGigModal(eventId);
    return;
  }

  // Delete Gig button
  if (target.closest('.delete-gig-btn')) {
    e.preventDefault();
    const eventId = target.closest('.delete-gig-btn').dataset.eventId;
    openDeleteConfirmation(eventId);
    return;
  }

  // Close modal
  if (target.closest('#close-gig-modal') || target.closest('#cancel-gig-btn')) {
    e.preventDefault();
    closeGigModal();
    return;
  }

  // Cancel delete
  if (target.closest('#cancel-delete-gig')) {
    e.preventDefault();
    closeDeleteModal();
    return;
  }

  // Confirm delete
  if (target.closest('#confirm-delete-gig')) {
    e.preventDefault();
    const eventId = target.closest('#confirm-delete-gig').dataset.eventId;
    await confirmDeleteGig(eventId);
    return;
  }

  // Close modal on backdrop click
  if (target.id === 'gig-modal' || target.id === 'delete-gig-modal') {
    e.preventDefault();
    closeGigModal();
    closeDeleteModal();
    return;
  }

  // Generate Poster button
  if (target.closest('#generate-poster-btn')) {
    e.preventDefault();
    await openPosterGenerator();
    return;
  }

  // Close poster modal
  if (target.closest('#close-poster-modal') || target.closest('#close-poster-modal-btn')) {
    e.preventDefault();
    closePosterModal();
    return;
  }

  // Download poster
  if (target.closest('#download-poster-btn')) {
    e.preventDefault();
    await downloadCurrentPoster();
    return;
  }

  // Click op backdrop sluit modal
  if (target.id === 'poster-modal') {
    e.preventDefault();
    closePosterModal();
    return;
  }

  // Theme select button
  if (target.closest('.theme-select-btn')) {
    e.preventDefault();
    const btn = target.closest('.theme-select-btn');
    const themeKey = btn.dataset.theme;
    if (themeKey) {
      await switchPosterTheme(themeKey);
    }
    return;
  }

  // Toggle attendees list
  if (target.closest('.toggle-attendees-btn')) {
    e.preventDefault();
    const btn = target.closest('.toggle-attendees-btn');
    const eventId = btn.dataset.eventId;
    const listEl = document.getElementById(`attendees-list-${eventId}`);

    if (listEl) {
      listEl.classList.toggle('hidden');
      btn.textContent = listEl.classList.contains('hidden') ? 'Bekijk namen' : 'Verberg namen';
    }
    return;
  }
}

/**
 * Open modal voor nieuwe gig
 */
function openGigModal() {
  // Remove existing modal if any
  closeGigModal();

  // Add modal to DOM
  const modalHtml = renderGigModal(null);
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // Setup form submit handler
  const form = document.getElementById('gig-form');
  if (form) {
    form.addEventListener('submit', handleGigFormSubmit);
  }

  // Re-init icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }

  console.log('[CALENDAR] Add gig modal opened');
}

/**
 * Open modal voor edit gig
 * @param {string} eventId - Event ID
 */
async function openEditGigModal(eventId) {
  try {
    const event = await getEvent(eventId);
    if (!event) {
      console.error('[CALENDAR] Event not found:', eventId);
      return;
    }

    // Remove existing modal
    closeGigModal();

    // Add modal with event data
    const modalHtml = renderGigModal(event);
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Setup form submit handler
    const form = document.getElementById('gig-form');
    if (form) {
      form.addEventListener('submit', handleGigFormSubmit);
    }

    // Re-init icons
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 50);
    }

    console.log('[CALENDAR] Edit gig modal opened for:', eventId);

  } catch (error) {
    console.error('[CALENDAR] Error opening edit modal:', error);
  }
}

/**
 * Handle form submit (add or edit)
 * @param {Event} e - Submit event
 */
async function handleGigFormSubmit(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  const currentUser = getStore('currentUser');
  const currentUserData = getStore('currentUserData');

  if (!currentUser || !currentUserData) {
    console.error('[CALENDAR] No user data');
    return;
  }

  const eventData = {
    date: formData.get('date'),
    city: formData.get('city'),
    venue: formData.get('venue'),
    type: formData.get('type'),
    link: formData.get('link') || ''
  };

  const eventId = formData.get('eventId');
  const isEdit = !!eventId;

  // Disable submit button
  const submitBtn = form.querySelector('button[type="submit"]');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = isEdit ? 'Opslaan...' : 'Toevoegen...';
  }

  try {
    if (isEdit) {
      // Update existing event
      await updateEvent(eventId, eventData);
      console.log('[CALENDAR] Event updated:', eventId);
    } else {
      // Add new event
      await addEvent({
        ...eventData,
        artistId: currentUser.uid,
        artistName: currentUserData.stageName || `${currentUserData.firstName} ${currentUserData.lastName}`,
        artistProfilePicUrl: currentUserData.profilePicUrl || ''
      });
      console.log('[CALENDAR] Event added');
    }

    // Close modal and refresh list
    closeGigModal();
    await loadAndRenderEvents();

  } catch (error) {
    console.error('[CALENDAR] Error saving event:', error);
    alert('Er ging iets mis bij het opslaan. Probeer het opnieuw.');

    // Re-enable button
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = isEdit ? 'Opslaan' : 'Toevoegen';
    }
  }
}

/**
 * Open delete confirmation modal
 * @param {string} eventId - Event ID
 */
function openDeleteConfirmation(eventId) {
  const event = currentEvents.find(e => e.id === eventId);
  if (!event) return;

  // Remove existing modals
  closeDeleteModal();

  const modalHtml = renderDeleteConfirmModal(eventId, event.venue || 'dit optreden');
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // Re-init icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }
}

/**
 * Confirm and execute delete
 * @param {string} eventId - Event ID
 */
async function confirmDeleteGig(eventId) {
  try {
    await deleteEvent(eventId);
    closeDeleteModal();
    await loadAndRenderEvents();
    console.log('[CALENDAR] Event deleted:', eventId);
  } catch (error) {
    console.error('[CALENDAR] Error deleting event:', error);
    alert('Er ging iets mis bij het verwijderen.');
  }
}

/**
 * Close gig modal
 */
function closeGigModal() {
  const modal = document.getElementById('gig-modal');
  if (modal) {
    modal.remove();
  }
}

/**
 * Close delete modal
 */
function closeDeleteModal() {
  const modal = document.getElementById('delete-gig-modal');
  if (modal) {
    modal.remove();
  }
}

/**
 * Get current events (for external access)
 * @returns {Array} Current events array
 */
export function getCurrentEvents() {
  return currentEvents;
}

/**
 * Load events for a specific artist (for public profile view)
 * @param {string} artistId - Artist UID
 * @returns {Promise<Array>} Events array
 */
export async function loadArtistEventsForProfile(artistId) {
  try {
    return await getArtistEvents(artistId, { upcomingOnly: true, limitCount: 5 });
  } catch (error) {
    console.error('[CALENDAR] Error loading artist events:', error);
    return [];
  }
}

/**
 * Filter events op basis van huidige filters
 */
function applyFilters(events) {
  let filtered = [...events];

  // Filter op type
  if (agendaState.filters.types.length > 0) {
    filtered = filtered.filter(e => agendaState.filters.types.includes(e.type));
  }

  // Filter op regio (simpele string match op city)
  if (agendaState.filters.region !== 'all') {
    const regionCities = {
      'nederland': ['amsterdam', 'rotterdam', 'utrecht', 'den haag', 'eindhoven', 'groningen', 'tilburg', 'almere', 'breda', 'nijmegen'],
      'vlaanderen': ['antwerpen', 'gent', 'brugge', 'leuven', 'mechelen', 'aalst', 'kortrijk', 'hasselt', 'oostende', 'sint-niklaas'],
      'brussel': ['brussel', 'brussels', 'bruxelles']
    };
    const cities = regionCities[agendaState.filters.region] || [];
    filtered = filtered.filter(e => {
      const cityLower = (e.city || '').toLowerCase();
      return cities.some(c => cityLower.includes(c));
    });
  }

  return filtered;
}

/**
 * Filter events voor geselecteerde datum
 */
function getEventsForSelectedDate(events) {
  const selected = agendaState.selectedDate;
  return events.filter(e => {
    if (!e.date) return false;
    const eventDate = new Date(e.date);
    return eventDate.toDateString() === selected.toDateString();
  });
}

/**
 * Filter events op basis van filter mode (dag of maand)
 */
function getFilteredEventsByDateMode(events) {
  const selected = agendaState.selectedDate;

  if (agendaState.filterMode === 'day') {
    // Filter op exacte datum
    return events.filter(e => {
      if (!e.date) return false;
      const eventDate = new Date(e.date);
      return eventDate.toDateString() === selected.toDateString();
    });
  } else {
    // Filter op maand
    return events.filter(e => {
      if (!e.date) return false;
      const eventDate = new Date(e.date);
      return eventDate.getMonth() === selected.getMonth()
        && eventDate.getFullYear() === selected.getFullYear();
    });
  }
}

/**
 * Render mobile calendar days
 */
async function renderMobileCalendarDays() {
  const container = document.getElementById('mobile-calendar-days');
  const monthLabel = document.getElementById('mobile-month-label');

  if (!container) return;

  const selectedDate = agendaState.selectedDate;
  const year = selectedDate.getFullYear();
  const month = selectedDate.getMonth();

  // Update month label
  if (monthLabel) {
    const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                        'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
    monthLabel.textContent = `${monthNames[month]} ${year}`;
  }

  // Get event counts for this month
  const startOfMonth = new Date(year, month, 1);
  const endOfMonth = new Date(year, month + 1, 0);

  let eventCounts = {};
  try {
    eventCounts = await getEventCountsPerDate(startOfMonth, endOfMonth);
  } catch (error) {
    console.warn('[CALENDAR] Could not fetch event counts:', error);
  }

  // Calculate days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();

  let startDay = firstDay.getDay() - 1;
  if (startDay < 0) startDay = 6;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  let html = '';

  // Empty cells for previous month
  for (let i = 0; i < startDay; i++) {
    html += '<div class="w-8 h-8"></div>';
  }

  // Days of current month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isSelected = date.toDateString() === selectedDate.toDateString();
    const isToday = date.toDateString() === today.toDateString();
    const hasEvents = eventCounts[dateStr] > 0;

    let classes = 'w-8 h-8 flex flex-col items-center justify-center text-sm rounded-lg cursor-pointer transition-colors relative';

    if (isSelected) {
      classes += ' bg-indigo-600 text-white font-semibold';
    } else if (isToday) {
      classes += ' bg-indigo-100 text-indigo-700 font-semibold';
    } else {
      classes += ' text-gray-700 hover:bg-gray-100';
    }

    // Event dot
    const dotHtml = hasEvents
      ? `<span class="absolute bottom-0.5 w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-white' : 'bg-indigo-500'}"></span>`
      : '';

    html += `
      <button class="mobile-calendar-day ${classes}" data-date="${dateStr}">
        <span>${day}</span>
        ${dotHtml}
      </button>
    `;
  }

  container.innerHTML = html;
}

/**
 * Setup event listeners voor Agenda pagina
 */
function setupAgendaEventListeners() {
  document.body.addEventListener('click', handleAgendaClick);
  console.log('[CALENDAR] Agenda event listeners attached');
}

/**
 * Handle alle Agenda-gerelateerde clicks
 */
async function handleAgendaClick(e) {
  const target = e.target;

  // Mobile calendar day click
  if (target.closest('.mobile-calendar-day')) {
    e.preventDefault();
    const dayEl = target.closest('.mobile-calendar-day');
    const dateStr = dayEl.dataset.date;
    if (dateStr) {
      // Parse as local date, not UTC
      const [year, month, day] = dateStr.split('-').map(Number);
      await selectDate(new Date(year, month - 1, day));
    }
    return;
  }

  // Mobile month navigation
  if (target.closest('#mobile-month-prev')) {
    e.preventDefault();
    const newDate = new Date(agendaState.selectedDate);
    newDate.setMonth(newDate.getMonth() - 1);
    agendaState.selectedDate = newDate;
    await renderAgendaContent();
    return;
  }

  if (target.closest('#mobile-month-next')) {
    e.preventDefault();
    const newDate = new Date(agendaState.selectedDate);
    newDate.setMonth(newDate.getMonth() + 1);
    agendaState.selectedDate = newDate;
    await renderAgendaContent();
    return;
  }

  // Month calendar day click (desktop)
  if (target.closest('.calendar-day')) {
    e.preventDefault();
    const dayEl = target.closest('.calendar-day');
    const dateStr = dayEl.dataset.date;
    if (dateStr) {
      // Parse as local date, not UTC
      const [year, month, day] = dateStr.split('-').map(Number);
      await selectDate(new Date(year, month - 1, day));
    }
    return;
  }

  // Month navigation
  if (target.closest('#month-prev')) {
    e.preventDefault();
    const newDate = new Date(agendaState.selectedDate);
    newDate.setMonth(newDate.getMonth() - 1);
    agendaState.selectedDate = newDate;
    await renderAgendaContent();
    return;
  }

  if (target.closest('#month-next')) {
    e.preventDefault();
    const newDate = new Date(agendaState.selectedDate);
    newDate.setMonth(newDate.getMonth() + 1);
    agendaState.selectedDate = newDate;
    await renderAgendaContent();
    return;
  }

  // Filter mode toggle
  if (target.closest('#filter-mode-day')) {
    e.preventDefault();
    agendaState.filterMode = 'day';
    await renderAgendaContent();
    return;
  }

  if (target.closest('#filter-mode-month')) {
    e.preventDefault();
    agendaState.filterMode = 'month';
    await renderAgendaContent();
    return;
  }

  // Type filter checkbox
  if (target.name === 'event-type') {
    const type = target.value;
    await toggleTypeFilter(type);
    return;
  }

  // Regio filter dropdown
  if (target.name === 'region-filter') {
    const region = target.value;
    await setRegionFilter(region);
    return;
  }

  // "Ik ga ook" button
  if (target.closest('.attend-event-btn')) {
    e.preventDefault();
    const btn = target.closest('.attend-event-btn');
    const eventId = btn.dataset.eventId;
    await toggleEventAttendance(eventId);
    return;
  }

  // View mode toggle - List
  if (target.closest('#view-mode-list')) {
    e.preventDefault();
    setViewMode('list');
    return;
  }

  // View mode toggle - Map
  if (target.closest('#view-mode-map')) {
    e.preventDefault();
    setViewMode('map');
    return;
  }

  // Event card click (naar detail of artiest profiel)
  if (target.closest('.solo-gig-card')) {
    const card = target.closest('.solo-gig-card');
    const artistId = card.dataset.artistId;
    if (artistId && !target.closest('a') && !target.closest('button')) {
      // Navigeer naar artiest profiel
      window.location.hash = `#artist/${artistId}`;
    }
    return;
  }
}

/**
 * Selecteer een datum en herlaad events
 */
async function selectDate(date) {
  agendaState.selectedDate = date;
  console.log('[CALENDAR] Date selected:', date.toDateString());
  await renderAgendaContent();
}

/**
 * Toggle type filter
 */
async function toggleTypeFilter(type) {
  const types = agendaState.filters.types;
  const index = types.indexOf(type);

  if (index > -1) {
    types.splice(index, 1);
  } else {
    types.push(type);
  }

  console.log('[CALENDAR] Type filters:', types);
  await renderAgendaContent();
}

/**
 * Set regio filter
 */
async function setRegionFilter(region) {
  agendaState.filters.region = region;
  console.log('[CALENDAR] Region filter:', region);
  await renderAgendaContent();
}

/**
 * Toggle attendance voor een event
 */
async function toggleEventAttendance(eventId) {
  const currentUser = getStore('currentUser');

  if (!currentUser) {
    console.warn('[CALENDAR] Must be logged in to attend');
    return;
  }

  try {
    await toggleAttendance(eventId, currentUser.uid);

    // Update lokale state en UI
    const event = agendaState.events.find(e => e.id === eventId);
    if (event) {
      const isAttending = event.attendees?.includes(currentUser.uid);
      if (isAttending) {
        event.attendees = event.attendees.filter(id => id !== currentUser.uid);
        event.attendeeCount = (event.attendeeCount || 1) - 1;
      } else {
        event.attendees = [...(event.attendees || []), currentUser.uid];
        event.attendeeCount = (event.attendeeCount || 0) + 1;
      }
    }

    await renderAgendaContent();
    console.log('[CALENDAR] Attendance toggled for event:', eventId);

  } catch (error) {
    console.error('[CALENDAR] Error toggling attendance:', error);
  }
}

/**
 * Switch tussen lijst en kaart weergave
 * @param {string} mode - 'list' of 'map'
 */
async function setViewMode(mode) {
  agendaState.viewMode = mode;

  const listContainer = document.getElementById('agenda-events-list');
  const mapContainer = document.getElementById('agenda-map-container');
  const listBtn = document.getElementById('view-mode-list');
  const mapBtn = document.getElementById('view-mode-map');

  if (mode === 'list') {
    // Show list, hide map
    if (listContainer) listContainer.classList.remove('hidden');
    if (mapContainer) mapContainer.classList.add('hidden');

    // Update button styles
    if (listBtn) {
      listBtn.classList.remove('bg-gray-100', 'text-gray-700');
      listBtn.classList.add('bg-indigo-600', 'text-white');
    }
    if (mapBtn) {
      mapBtn.classList.remove('bg-indigo-600', 'text-white');
      mapBtn.classList.add('bg-gray-100', 'text-gray-700');
    }

  } else {
    // Show map, hide list
    if (listContainer) listContainer.classList.add('hidden');
    if (mapContainer) mapContainer.classList.remove('hidden');

    // Update button styles
    if (mapBtn) {
      mapBtn.classList.remove('bg-gray-100', 'text-gray-700');
      mapBtn.classList.add('bg-indigo-600', 'text-white');
    }
    if (listBtn) {
      listBtn.classList.remove('bg-indigo-600', 'text-white');
      listBtn.classList.add('bg-gray-100', 'text-gray-700');
    }

    // Initialize map if needed
    const { initMap, updateMapMarkers } = await import('./calendar-map.js');

    if (!document.getElementById('community-map')._leaflet_id) {
      initMap('community-map');
    }

    // Update markers with current filtered events
    const filteredEvents = applyFilters(agendaState.events);
    updateMapMarkers(filteredEvents, (city, cityEvents) => {
      console.log('[MAP] City clicked:', city, cityEvents.length, 'events');
      // Optioneel: filter events op deze stad
    });
  }

  // Re-init Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }

  console.log('[CALENDAR] View mode:', mode);
}

/**
 * Render/update de Agenda content (events lijst)
 */
async function renderAgendaContent() {
  const container = document.getElementById('agenda-events-list');
  if (!container) {
    console.warn('[CALENDAR] agenda-events-list container not found');
    return;
  }

  // Haal event counts voor date tape
  const startDate = new Date(agendaState.selectedDate);
  startDate.setDate(startDate.getDate() - 7);
  const endDate = new Date(agendaState.selectedDate);
  endDate.setDate(endDate.getDate() + 14);

  const eventCounts = await getEventCountsPerDate(startDate, endDate);

  // Filter events
  const filteredEvents = applyFilters(agendaState.events);
  // Apply date/month filtering
  const eventsForDate = getFilteredEventsByDateMode(filteredEvents);

  // Render Filters (desktop) with month calendar
  const filtersContainer = document.getElementById('agenda-filters-container');
  if (filtersContainer) {
    filtersContainer.innerHTML = renderAgendaFilters(agendaState.filters, agendaState.selectedDate, eventCounts);
  }

  // Render Mobile Calendar
  renderMobileCalendarDays();

  // Render Filter Mode Toggle
  const filterModeContainer = document.getElementById('filter-mode-container');
  if (filterModeContainer) {
    filterModeContainer.innerHTML = `
      <div class="flex gap-2">
        <button id="filter-mode-day" class="px-4 py-2 text-sm rounded-lg transition-colors font-medium ${
          agendaState.filterMode === 'day'
            ? 'bg-indigo-600 text-white shadow-sm'
            : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
        }">
          Dag
        </button>
        <button id="filter-mode-month" class="px-4 py-2 text-sm rounded-lg transition-colors font-medium ${
          agendaState.filterMode === 'month'
            ? 'bg-indigo-600 text-white shadow-sm'
            : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
        }">
          Maand
        </button>
      </div>
    `;
  }

  // Render Events
  const eventsContainer = document.getElementById('agenda-events-list');
  if (eventsContainer) {
    if (eventsForDate.length === 0) {
      eventsContainer.innerHTML = `
        <div class="text-center py-12">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="calendar-x" class="w-8 h-8 text-gray-400"></i>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Geen events op deze datum</h3>
          <p class="text-sm text-gray-500">Selecteer een andere datum of pas je filters aan.</p>
        </div>
      `;
    } else {
      const currentUser = getStore('currentUser');
      const currentUserId = currentUser?.uid || null;

      eventsContainer.innerHTML = eventsForDate.map(event => {
        if (event.isClusterEvent && event.participants?.length > 0) {
          return renderClusterCard(event, currentUserId);
        }
        return renderSoloGigCard(event, currentUserId);
      }).join('');
    }
  }

  // Update map markers if map is visible
  if (agendaState.viewMode === 'map') {
    const { updateMapMarkers } = await import('./calendar-map.js');
    updateMapMarkers(eventsForDate);
  }

  // Re-init Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }
}

/**
 * Initialize Agenda view (voor programmeurs)
 */
export async function initAgendaView() {
  console.log('[CALENDAR] Initializing Agenda view');

  agendaState.isLoading = true;
  agendaState.selectedDate = new Date(); // Start met vandaag

  try {
    // Laad alle upcoming events
    agendaState.events = await getAllUpcomingEvents({ limitCount: 100, daysAhead: 90 });

    console.log(`[CALENDAR] Loaded ${agendaState.events.length} events`);

    // Setup event listeners
    setupAgendaEventListeners();

    // Render content
    await renderAgendaContent();

  } catch (error) {
    console.error('[CALENDAR] Error initializing agenda:', error);
  } finally {
    agendaState.isLoading = false;
  }
}

/**
 * Cleanup functie voor wanneer je weg navigeert van Agenda
 */
export function cleanupAgendaView() {
  document.body.removeEventListener('click', handleAgendaClick);

  // Cleanup map
  import('./calendar-map.js').then(({ destroyMap }) => {
    destroyMap();
  });

  agendaState = {
    selectedDate: new Date(),
    filterMode: 'month',
    events: [],
    filteredEvents: [],
    filters: { types: [], region: 'all' },
    viewMode: 'list',
    isLoading: false
  };
  console.log('[CALENDAR] Agenda view cleaned up');
}

/**
 * Open de poster generator
 */
async function openPosterGenerator() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentEvents.length < 3) {
    console.warn('[POSTER] Not enough events or no user data');
    return;
  }

  console.log('[POSTER] Generating poster...');

  try {
    const { generatePosterCanvas, renderPosterModal } = await import('./poster-generator.js');

    // Store data voor regeneratie bij thema wissel
    currentPosterArtistData = currentUserData;
    currentPosterEvents = currentEvents;
    currentPosterTheme = 'indigo';

    // Genereer canvas
    currentPosterCanvas = await generatePosterCanvas(currentUserData, currentEvents, currentPosterTheme);

    // Render modal
    const modalHtml = renderPosterModal(currentPosterCanvas, currentPosterTheme);
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Re-init Lucide icons
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 50);
    }

    console.log('[POSTER] Modal opened');

  } catch (error) {
    console.error('[POSTER] Error generating poster:', error);
    alert('Er ging iets mis bij het genereren van de poster.');
  }
}

/**
 * Wissel poster thema
 */
async function switchPosterTheme(themeKey) {
  if (!currentPosterArtistData || !currentPosterEvents) {
    console.warn('[POSTER] No data to regenerate poster');
    return;
  }

  console.log('[POSTER] Switching theme to:', themeKey);
  currentPosterTheme = themeKey;

  try {
    const { generatePosterCanvas } = await import('./poster-generator.js');

    // Regenereer canvas met nieuw thema
    currentPosterCanvas = await generatePosterCanvas(
      currentPosterArtistData,
      currentPosterEvents,
      themeKey
    );

    // Update preview image
    const previewImg = document.getElementById('poster-preview-img');
    if (previewImg) {
      previewImg.src = currentPosterCanvas.toDataURL('image/png');
    }

    // Update active state op theme buttons
    document.querySelectorAll('.theme-select-btn').forEach(btn => {
      const isActive = btn.dataset.theme === themeKey;
      btn.classList.toggle('border-indigo-600', isActive);
      btn.classList.toggle('ring-2', isActive);
      btn.classList.toggle('ring-indigo-300', isActive);
      btn.classList.toggle('border-gray-200', !isActive);
    });

  } catch (error) {
    console.error('[POSTER] Error switching theme:', error);
  }
}

/**
 * Sluit de poster modal
 */
function closePosterModal() {
  const modal = document.getElementById('poster-modal');
  if (modal) {
    modal.remove();
  }
  currentPosterCanvas = null;
  currentPosterArtistData = null;
  currentPosterEvents = null;
  currentPosterTheme = 'indigo';
}

/**
 * Download de huidige poster
 */
async function downloadCurrentPoster() {
  if (!currentPosterCanvas) {
    console.warn('[POSTER] No canvas to download');
    return;
  }

  const currentUserData = getStore('currentUserData');
  const artistName = currentUserData?.stageName || 'artist';
  const filename = `${artistName.toLowerCase().replace(/\s+/g, '-')}-tour-poster.png`;

  const { downloadPoster } = await import('./poster-generator.js');
  downloadPoster(currentPosterCanvas, filename);

  console.log('[POSTER] Downloaded:', filename);
}
</file>

<file path="src/modules/calendar/calendar-service.js">
/**
 * calendar-service.js
 * Data operations voor artist gigs/events
 * Handles Firestore queries voor events collectie
 */

import { db } from '../../services/firebase.js';
import {
  collection,
  addDoc,
  doc,
  getDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  query,
  where,
  orderBy,
  limit,
  serverTimestamp,
  Timestamp
} from 'firebase/firestore';

/**
 * Event types
 */
export const EVENT_TYPES = {
  GIG: 'gig',
  OPEN_MIC: 'open-mic',
  SLAM: 'slam',
  WORKSHOP: 'workshop',
  FEATURE: 'feature',
  SHOWCASE: 'showcase',
  SLAM_FINALE: 'slam-finale'
};

/**
 * Event type labels (NL)
 */
export const EVENT_TYPE_LABELS = {
  'gig': 'Optreden',
  'open-mic': 'Open Mic',
  'slam': 'Poetry Slam',
  'workshop': 'Workshop',
  'feature': 'Feature',
  'showcase': 'Showcase',
  'slam-finale': 'Slam Finale'
};

/**
 * Voeg een nieuw event toe
 * @param {object} eventData - Event gegevens
 * @param {string} eventData.artistId - UID van de artiest
 * @param {string} eventData.artistName - Stage name van de artiest
 * @param {Date} eventData.date - Datum van het event
 * @param {string} eventData.city - Stad
 * @param {string} eventData.venue - Venue naam
 * @param {string} eventData.type - Event type (gig, open-mic, slam, workshop, feature)
 * @param {string} [eventData.link] - Optionele link naar tickets/info
 * @param {string} [eventData.artistProfilePicUrl] - Profielfoto URL voor snelle weergave
 * @returns {Promise<string>} Event ID
 */
export async function addEvent(eventData) {
  try {
    const { artistId, artistName, date, city, venue, type, link, artistProfilePicUrl } = eventData;

    if (!artistId || !artistName || !date || !city || !venue || !type) {
      throw new Error('Missing required fields: artistId, artistName, date, city, venue, type');
    }

    // Valideer event type
    if (!Object.values(EVENT_TYPES).includes(type)) {
      throw new Error(`Invalid event type: ${type}`);
    }

    const eventDoc = {
      artistId,
      artistName,
      artistProfilePicUrl: artistProfilePicUrl || '',
      date: Timestamp.fromDate(new Date(date)),
      city: city.trim(),
      venue: venue.trim(),
      type,
      link: link?.trim() || '',
      supporters: [],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const docRef = await addDoc(collection(db, 'events'), eventDoc);
    console.log('[CALENDAR] Event added:', docRef.id);
    return docRef.id;

  } catch (error) {
    console.error('[CALENDAR] Error adding event:', error);
    throw error;
  }
}

/**
 * Haal events op voor een specifieke artiest
 * @param {string} artistId - UID van de artiest
 * @param {object} options - Query opties
 * @param {boolean} [options.upcomingOnly=true] - Alleen toekomstige events
 * @param {number} [options.limitCount=10] - Maximum aantal events
 * @returns {Promise<Array>} Array van events
 */
export async function getArtistEvents(artistId, options = {}) {
  try {
    const { upcomingOnly = true, limitCount = 10 } = options;

    const eventsRef = collection(db, 'events');
    let q;

    if (upcomingOnly) {
      const now = Timestamp.fromDate(new Date());
      q = query(
        eventsRef,
        where('artistId', '==', artistId),
        where('date', '>=', now),
        orderBy('date', 'asc'),
        limit(limitCount)
      );
    } else {
      q = query(
        eventsRef,
        where('artistId', '==', artistId),
        orderBy('date', 'desc'),
        limit(limitCount)
      );
    }

    const snapshot = await getDocs(q);
    const events = [];

    snapshot.forEach(doc => {
      events.push({
        id: doc.id,
        ...doc.data(),
        date: doc.data().date?.toDate() || null
      });
    });

    console.log(`[CALENDAR] Fetched ${events.length} events for artist ${artistId}`);
    return events;

  } catch (error) {
    console.error('[CALENDAR] Error fetching artist events:', error);
    return [];
  }
}

/**
 * Haal alle upcoming events op (voor community map)
 * @param {object} options - Query opties
 * @param {number} [options.limitCount=50] - Maximum aantal events
 * @param {number} [options.daysAhead=90] - Hoeveel dagen vooruit
 * @returns {Promise<Array>} Array van events
 */
export async function getAllUpcomingEvents(options = {}) {
  try {
    const { limitCount = 50, daysAhead = 90 } = options;

    // Start van vandaag (00:00:00) om events van vandaag ook op te halen
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + daysAhead);

    const eventsRef = collection(db, 'events');
    const q = query(
      eventsRef,
      where('date', '>=', Timestamp.fromDate(now)),
      where('date', '<=', Timestamp.fromDate(futureDate)),
      orderBy('date', 'asc'),
      limit(limitCount)
    );

    const snapshot = await getDocs(q);
    const events = [];

    snapshot.forEach(doc => {
      events.push({
        id: doc.id,
        ...doc.data(),
        date: doc.data().date?.toDate() || null
      });
    });

    console.log(`[CALENDAR] Fetched ${events.length} upcoming events`);
    return events;

  } catch (error) {
    console.error('[CALENDAR] Error fetching all events:', error);
    return [];
  }
}

/**
 * Haal een specifiek event op
 * @param {string} eventId - Event ID
 * @returns {Promise<object|null>} Event object of null
 */
export async function getEvent(eventId) {
  try {
    const eventRef = doc(db, 'events', eventId);
    const eventSnap = await getDoc(eventRef);

    if (!eventSnap.exists()) {
      return null;
    }

    const data = eventSnap.data();
    return {
      id: eventSnap.id,
      ...data,
      date: data.date?.toDate() || null
    };

  } catch (error) {
    console.error('[CALENDAR] Error fetching event:', error);
    return null;
  }
}

/**
 * Update een event
 * @param {string} eventId - Event ID
 * @param {object} updates - Velden om te updaten
 * @returns {Promise<void>}
 */
export async function updateEvent(eventId, updates) {
  try {
    const eventRef = doc(db, 'events', eventId);

    const updateData = { ...updates, updatedAt: serverTimestamp() };

    // Convert date to Timestamp if provided
    if (updates.date) {
      updateData.date = Timestamp.fromDate(new Date(updates.date));
    }

    await updateDoc(eventRef, updateData);
    console.log('[CALENDAR] Event updated:', eventId);

  } catch (error) {
    console.error('[CALENDAR] Error updating event:', error);
    throw error;
  }
}

/**
 * Verwijder een event
 * @param {string} eventId - Event ID
 * @returns {Promise<void>}
 */
export async function deleteEvent(eventId) {
  try {
    const eventRef = doc(db, 'events', eventId);
    await deleteDoc(eventRef);
    console.log('[CALENDAR] Event deleted:', eventId);

  } catch (error) {
    console.error('[CALENDAR] Error deleting event:', error);
    throw error;
  }
}

/**
 * Voeg supporter toe aan event
 * @param {string} eventId - Event ID
 * @param {string} supporterId - UID van de supporter
 * @returns {Promise<void>}
 */
export async function addSupporter(eventId, supporterId) {
  try {
    const eventRef = doc(db, 'events', eventId);
    const eventSnap = await getDoc(eventRef);

    if (!eventSnap.exists()) {
      throw new Error('Event not found');
    }

    const supporters = eventSnap.data().supporters || [];

    if (!supporters.includes(supporterId)) {
      supporters.push(supporterId);
      await updateDoc(eventRef, {
        supporters,
        updatedAt: serverTimestamp()
      });
      console.log('[CALENDAR] Supporter added to event:', eventId);
    }

  } catch (error) {
    console.error('[CALENDAR] Error adding supporter:', error);
    throw error;
  }
}

/**
 * Verwijder supporter van event
 * @param {string} eventId - Event ID
 * @param {string} supporterId - UID van de supporter
 * @returns {Promise<void>}
 */
export async function removeSupporter(eventId, supporterId) {
  try {
    const eventRef = doc(db, 'events', eventId);
    const eventSnap = await getDoc(eventRef);

    if (!eventSnap.exists()) {
      throw new Error('Event not found');
    }

    const supporters = (eventSnap.data().supporters || []).filter(id => id !== supporterId);

    await updateDoc(eventRef, {
      supporters,
      updatedAt: serverTimestamp()
    });
    console.log('[CALENDAR] Supporter removed from event:', eventId);

  } catch (error) {
    console.error('[CALENDAR] Error removing supporter:', error);
    throw error;
  }
}

/**
 * Check of een artiest events heeft op een specifieke datum
 * Nuttig voor beschikbaarheidscheck
 * @param {string} artistId - UID van de artiest
 * @param {Date} date - Datum om te checken
 * @returns {Promise<boolean>} True als er events zijn op die datum
 */
export async function hasEventOnDate(artistId, date) {
  try {
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);

    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);

    const eventsRef = collection(db, 'events');
    const q = query(
      eventsRef,
      where('artistId', '==', artistId),
      where('date', '>=', Timestamp.fromDate(startOfDay)),
      where('date', '<=', Timestamp.fromDate(endOfDay)),
      limit(1)
    );

    const snapshot = await getDocs(q);
    return !snapshot.empty;

  } catch (error) {
    console.error('[CALENDAR] Error checking date availability:', error);
    return false;
  }
}

/**
 * Format datum voor weergave
 * @param {Date} date - Datum object
 * @returns {string} Geformatteerde datum string
 */
export function formatEventDate(date) {
  if (!date) return '';

  const options = {
    weekday: 'short',
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  };

  return date.toLocaleDateString('nl-BE', options);
}

/**
 * Format korte datum (voor lijsten)
 * @param {Date} date - Datum object
 * @returns {string} Korte datum string
 */
export function formatShortDate(date) {
  if (!date) return '';

  const options = {
    day: 'numeric',
    month: 'short'
  };

  return date.toLocaleDateString('nl-BE', options);
}

/**
 * Haal events op binnen een specifiek datumbereik
 * @param {Date} startDate - Start datum
 * @param {Date} endDate - Eind datum
 * @param {object} options - Query opties
 * @param {number} [options.limitCount=100] - Maximum aantal events
 * @returns {Promise<Array>} Array van events gesorteerd op datum
 */
export async function getEventsForDateRange(startDate, endDate, options = {}) {
  try {
    const { limitCount = 100 } = options;

    const eventsRef = collection(db, 'events');
    const q = query(
      eventsRef,
      where('date', '>=', Timestamp.fromDate(new Date(startDate))),
      where('date', '<=', Timestamp.fromDate(new Date(endDate))),
      orderBy('date', 'asc'),
      limit(limitCount)
    );

    const snapshot = await getDocs(q);
    const events = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      events.push({
        id: doc.id,
        ...data,
        date: data.date?.toDate() || null,
        // Ensure new fields have defaults
        isClusterEvent: data.isClusterEvent || false,
        eventName: data.eventName || null,
        eventTime: data.eventTime || null,
        participants: data.participants || [],
        attendees: data.attendees || [],
        attendeeCount: data.attendeeCount || 0,
        coordinates: data.coordinates || null
      });
    });

    console.log(`[CALENDAR] Fetched ${events.length} events for date range`);
    return events;

  } catch (error) {
    console.error('[CALENDAR] Error fetching events for date range:', error);
    return [];
  }
}

/**
 * Groepeer events per datum
 * @param {Array} events - Array van events
 * @returns {Map<string, Array>} Map met dateString als key en events array als value
 */
export function getEventsGroupedByDate(events) {
  const grouped = new Map();

  events.forEach(event => {
    if (!event.date) return;

    // Format date as YYYY-MM-DD
    const dateString = event.date.toISOString().split('T')[0];

    if (!grouped.has(dateString)) {
      grouped.set(dateString, []);
    }

    grouped.get(dateString).push(event);
  });

  // Sort events within each date by time if available
  grouped.forEach((dayEvents, dateString) => {
    dayEvents.sort((a, b) => {
      // If eventTime is available, sort by that
      if (a.eventTime && b.eventTime) {
        return a.eventTime.localeCompare(b.eventTime);
      }
      // Otherwise keep original order (by date from query)
      return 0;
    });
  });

  console.log(`[CALENDAR] Grouped ${events.length} events into ${grouped.size} dates`);
  return grouped;
}

/**
 * Haal event counts per datum op voor Date Tape heatmap
 * @param {Date} startDate - Start datum
 * @param {Date} endDate - Eind datum
 * @returns {Promise<Object>} Object met dateString als keys en counts als values
 */
export async function getEventCountsPerDate(startDate, endDate) {
  try {
    const events = await getEventsForDateRange(startDate, endDate, { limitCount: 200 });
    const counts = {};

    events.forEach(event => {
      if (!event.date) return;

      // Use local date formatting instead of UTC
      const eventDate = event.date instanceof Date ? event.date : event.date.toDate();
      const year = eventDate.getFullYear();
      const month = String(eventDate.getMonth() + 1).padStart(2, '0');
      const day = String(eventDate.getDate()).padStart(2, '0');
      const dateKey = `${year}-${month}-${day}`;

      counts[dateKey] = (counts[dateKey] || 0) + 1;
    });

    console.log(`[CALENDAR] Event counts calculated for ${Object.keys(counts).length} dates`);
    return counts;

  } catch (error) {
    console.error('[CALENDAR] Error getting event counts:', error);
    return {};
  }
}

/**
 * Toggle "Ik ga ook" attendance voor een event
 * @param {string} eventId - Event ID
 * @param {string} userId - UID van de user
 * @returns {Promise<boolean>} True als user nu attending is, false als removed
 */
export async function toggleAttendance(eventId, userId) {
  try {
    const eventRef = doc(db, 'events', eventId);
    const eventSnap = await getDoc(eventRef);

    if (!eventSnap.exists()) {
      throw new Error('Event not found');
    }

    const data = eventSnap.data();
    const attendees = data.attendees || [];
    const isAttending = attendees.includes(userId);

    let newAttendees;
    let newCount;

    if (isAttending) {
      // Remove user from attendees
      newAttendees = attendees.filter(id => id !== userId);
      newCount = Math.max(0, (data.attendeeCount || 0) - 1);
    } else {
      // Add user to attendees
      newAttendees = [...attendees, userId];
      newCount = (data.attendeeCount || 0) + 1;
    }

    await updateDoc(eventRef, {
      attendees: newAttendees,
      attendeeCount: newCount
    });

    console.log(`[CALENDAR] Attendance toggled for event ${eventId}, user ${userId}: ${!isAttending}`);
    return !isAttending;

  } catch (error) {
    console.error('[CALENDAR] Error toggling attendance:', error);
    throw error;
  }
}

/**
 * Haal alle attendees op voor events van een artiest
 * @param {string} artistId - UID van de artiest
 * @returns {Promise<Array>} Array van {event, attendees} objecten
 */
export async function getAttendeeNotifications(artistId) {
  try {
    const eventsRef = collection(db, 'events');
    const q = query(
      eventsRef,
      where('artistId', '==', artistId),
      orderBy('date', 'asc')
    );

    const snapshot = await getDocs(q);
    const notifications = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      // FIX: Check of attendees bestaat EN niet leeg is EN niet alleen de artiest zelf bevat
      const attendees = data.attendees || [];
      // Filter de artiest zelf eruit
      const otherAttendees = attendees.filter(uid => uid !== artistId);

      if (otherAttendees.length > 0) {
        notifications.push({
          eventId: doc.id,
          venue: data.venue,
          city: data.city,
          date: data.date?.toDate() || null,
          attendees: otherAttendees,
          attendeeCount: otherAttendees.length
        });
      }
    });

    return notifications;
  } catch (error) {
    console.error('[CALENDAR] Error fetching attendee notifications:', error);
    return [];
  }
}

/**
 * Haal profiel info op voor een lijst van user IDs
 * @param {Array} userIds - Array van user UIDs
 * @returns {Promise<Array>} Array van user profiles
 */
export async function getAttendeeProfiles(userIds) {
  if (!userIds || userIds.length === 0) return [];

  try {
    const profiles = [];

    // Haal profielen op (check eerst artists, dan programmers)
    for (const uid of userIds.slice(0, 20)) { // Max 20 om queries te beperken
      // Probeer artist
      let userDoc = await getDoc(doc(db, 'artists', uid));

      if (!userDoc.exists()) {
        // Probeer programmer
        userDoc = await getDoc(doc(db, 'programmers', uid));
      }

      if (userDoc.exists()) {
        const data = userDoc.data();
        profiles.push({
          uid: uid,
          name: data.stageName || `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'Anoniem',
          profilePicUrl: data.profilePicUrl || null,
          role: data.role || 'user'
        });
      } else {
        profiles.push({
          uid: uid,
          name: 'Community lid',
          profilePicUrl: null,
          role: 'user'
        });
      }
    }

    return profiles;
  } catch (error) {
    console.error('[CALENDAR] Error fetching attendee profiles:', error);
    return [];
  }
}

/**
 * Check of een user attending is voor een event
 * @param {string} eventId - Event ID
 * @param {string} userId - UID van de user
 * @returns {Promise<boolean>} True als user attending is
 */
export async function isUserAttending(eventId, userId) {
  try {
    const event = await getEvent(eventId);
    if (!event) return false;

    const attendees = event.attendees || [];
    return attendees.includes(userId);

  } catch (error) {
    console.error('[CALENDAR] Error checking attendance:', error);
    return false;
  }
}
</file>

<file path="src/modules/calendar/calendar-ui.js">
/**
 * calendar-ui.js
 * UI rendering voor artist gigs/events
 * Apple-style widgets en modals
 */

import { EVENT_TYPE_LABELS, formatEventDate, formatShortDate } from './calendar-service.js';

/**
 * Format date as YYYY-MM-DD using local timezone (not UTC)
 * @param {Date} date - Date object
 * @returns {string} Date string in YYYY-MM-DD format
 */
function formatDateKey(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * Render de "Upcoming Gigs" widget voor het artist dashboard
 * @param {Array} events - Array van event objecten
 * @param {boolean} isOwnProfile - Is dit het eigen profiel van de artiest?
 * @returns {string} HTML string
 */
export function renderUpcomingGigsWidget(events = [], isOwnProfile = true) {
  const hasEvents = events && events.length > 0;

  return `
    <div id="upcoming-gigs-widget" class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-900 tracking-tight">Upcoming Gigs</h3>
          <p class="text-sm text-gray-500 mt-1">${hasEvents ? `${events.length} optreden${events.length > 1 ? 's' : ''} gepland` : 'Geen geplande optredens'}</p>
        </div>
        ${isOwnProfile ? `
          <button id="add-gig-btn" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-semibold hover:bg-indigo-700 transition-all shadow-sm hover:shadow flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add Gig</span>
          </button>
        ` : ''}
      </div>

      ${hasEvents ? renderGigsList(events, isOwnProfile) : renderEmptyGigsState(isOwnProfile)}

      <!-- Tour Poster Generator -->
      ${isOwnProfile ? `
        <div id="poster-generator-container" class="mt-6 pt-6 border-t border-gray-100">
          <!-- Poster button renders here -->
        </div>
      ` : ''}
    </div>
  `;
}

/**
 * Render de lijst met gigs
 * @param {Array} events - Array van events
 * @param {boolean} isOwnProfile - Is eigen profiel?
 * @returns {string} HTML string
 */
function renderGigsList(events, isOwnProfile) {
  const gigsHtml = events.slice(0, 5).map(event => renderGigItem(event, isOwnProfile)).join('');

  return `
    <div class="space-y-3">
      ${gigsHtml}
    </div>
    ${events.length > 5 ? `
      <button id="view-all-gigs-btn" class="mt-4 w-full text-center text-indigo-600 font-medium hover:text-indigo-700 py-2">
        Bekijk alle ${events.length} optredens
      </button>
    ` : ''}
  `;
}

/**
 * Render een enkel gig item
 * @param {object} event - Event object
 * @param {boolean} isOwnProfile - Is eigen profiel?
 * @returns {string} HTML string
 */
function renderGigItem(event, isOwnProfile) {
  const date = event.date ? new Date(event.date) : null;
  const dayNum = date ? date.getDate() : '--';
  const monthShort = date ? date.toLocaleDateString('nl-BE', { month: 'short' }).toUpperCase() : '---';
  const typeLabel = EVENT_TYPE_LABELS[event.type] || event.type;
  const typeBadgeColor = getTypeBadgeColor(event.type);

  return `
    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-2xl hover:bg-gray-100 transition-colors group" data-event-id="${event.id}">
      <!-- Date Block -->
      <div class="flex-shrink-0 w-14 h-14 bg-white rounded-xl shadow-sm flex flex-col items-center justify-center border border-gray-100">
        <span class="text-lg font-bold text-gray-900 leading-none">${dayNum}</span>
        <span class="text-xs font-medium text-gray-500 uppercase">${monthShort}</span>
      </div>

      <!-- Event Info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1">
          <h4 class="font-semibold text-gray-900 truncate">${event.venue || 'TBA'}</h4>
          <span class="flex-shrink-0 px-2 py-0.5 text-xs font-medium rounded-full ${typeBadgeColor}">${typeLabel}</span>
        </div>
        <p class="text-sm text-gray-500 flex items-center gap-1">
          <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
          ${event.city || 'Locatie TBA'}
        </p>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
        ${event.link ? `
          <a href="${event.link}" target="_blank" rel="noopener noreferrer" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-white rounded-lg transition-colors" title="Open link">
            <i data-lucide="external-link" class="w-4 h-4"></i>
          </a>
        ` : ''}
        ${isOwnProfile ? `
          <button class="edit-gig-btn p-2 text-gray-400 hover:text-indigo-600 hover:bg-white rounded-lg transition-colors" data-event-id="${event.id}" title="Bewerk">
            <i data-lucide="pencil" class="w-4 h-4"></i>
          </button>
          <button class="delete-gig-btn p-2 text-gray-400 hover:text-red-500 hover:bg-white rounded-lg transition-colors" data-event-id="${event.id}" title="Verwijder">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

/**
 * Render lege staat voor gigs widget
 * @param {boolean} isOwnProfile - Is eigen profiel?
 * @returns {string} HTML string
 */
function renderEmptyGigsState(isOwnProfile) {
  if (isOwnProfile) {
    return `
      <div class="text-center py-8">
        <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="calendar-plus" class="w-8 h-8 text-indigo-400"></i>
        </div>
        <h4 class="font-semibold text-gray-900 mb-2">Nog geen optredens gepland</h4>
        <p class="text-sm text-gray-500 mb-4">Laat de wereld weten waar je te zien bent!</p>
        <button id="add-first-gig-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-all shadow-sm">
          Voeg je eerste gig toe
        </button>
      </div>
    `;
  }

  return `
    <div class="text-center py-8">
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i data-lucide="calendar-x" class="w-8 h-8 text-gray-400"></i>
      </div>
      <p class="text-sm text-gray-500">Geen aankomende optredens</p>
    </div>
  `;
}

/**
 * Render de "See [Artist] Live" sectie voor publieke profielen
 * @param {Array} events - Array van events
 * @param {string} artistName - Naam van de artiest
 * @returns {string} HTML string
 */
export function renderPublicGigsSection(events = [], artistName = 'deze artiest') {
  if (!events || events.length === 0) {
    return '';
  }

  const upcomingEvents = events.slice(0, 3);

  return `
    <div class="mt-8">
      <h3 class="text-lg font-bold text-gray-900 mb-4">See ${artistName} Live</h3>
      <div class="space-y-3">
        ${upcomingEvents.map(event => renderPublicGigItem(event)).join('')}
      </div>
      ${events.length > 3 ? `
        <p class="text-sm text-gray-500 mt-3 text-center">+ ${events.length - 3} meer optredens</p>
      ` : ''}
    </div>
  `;
}

/**
 * Render een gig item voor publieke weergave
 * @param {object} event - Event object
 * @returns {string} HTML string
 */
function renderPublicGigItem(event) {
  const date = event.date ? new Date(event.date) : null;
  const formattedDate = date ? formatEventDate(date) : 'Datum TBA';
  const typeLabel = EVENT_TYPE_LABELS[event.type] || event.type;

  return `
    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
      <div class="flex items-center gap-4">
        <div class="text-center">
          <p class="text-sm font-medium text-gray-900">${formattedDate}</p>
        </div>
        <div>
          <p class="font-medium text-gray-900">${event.venue || 'TBA'}</p>
          <p class="text-sm text-gray-500">${event.city || ''} ‚Ä¢ ${typeLabel}</p>
        </div>
      </div>
      ${event.link ? `
        <a href="${event.link}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors">
          Tickets
        </a>
      ` : ''}
    </div>
  `;
}

/**
 * Render de Add/Edit Gig Modal
 * @param {object|null} event - Bestaand event voor edit, of null voor nieuw
 * @returns {string} HTML string
 */
export function renderGigModal(event = null) {
  const isEdit = event !== null;
  const title = isEdit ? 'Bewerk Optreden' : 'Nieuw Optreden';
  const submitText = isEdit ? 'Opslaan' : 'Toevoegen';

  // Format date for input
  const dateValue = event?.date ? new Date(event.date).toISOString().split('T')[0] : '';

  return `
    <div id="gig-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0,0,0,0.5);">
      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-100">
          <h2 class="text-xl font-bold text-gray-900">${title}</h2>
          <button id="close-gig-modal" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Form -->
        <form id="gig-form" class="p-6 space-y-5">
          ${isEdit ? `<input type="hidden" name="eventId" value="${event.id}">` : ''}

          <!-- Date -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Datum *</label>
            <input type="date" name="date" required value="${dateValue}"
              class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-colors">
          </div>

          <!-- City -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Stad *</label>
            <input type="text" name="city" required value="${event?.city || ''}" placeholder="bijv. Gent, Amsterdam"
              class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-colors">
          </div>

          <!-- Venue -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Venue *</label>
            <input type="text" name="venue" required value="${event?.venue || ''}" placeholder="bijv. De Centrale, Paradiso"
              class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-colors">
          </div>

          <!-- Type -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Type *</label>
            <select name="type" required
              class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-colors">
              <option value="">Selecteer type...</option>
              ${Object.entries(EVENT_TYPE_LABELS).map(([value, label]) => `
                <option value="${value}" ${event?.type === value ? 'selected' : ''}>${label}</option>
              `).join('')}
            </select>
          </div>

          <!-- Link (optional) -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Link (optioneel)</label>
            <input type="url" name="link" value="${event?.link || ''}" placeholder="https://tickets.example.com"
              class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-colors">
          </div>

          <!-- Buttons -->
          <div class="flex gap-3 pt-4">
            <button type="button" id="cancel-gig-btn" class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors">
              Annuleren
            </button>
            <button type="submit" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-sm">
              ${submitText}
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
}

/**
 * Render delete confirmation modal
 * @param {string} eventId - Event ID
 * @param {string} venueName - Venue naam voor bevestiging
 * @returns {string} HTML string
 */
export function renderDeleteConfirmModal(eventId, venueName) {
  return `
    <div id="delete-gig-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0,0,0,0.5);">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Optreden verwijderen?</h3>
        <p class="text-sm text-gray-500 mb-6">Weet je zeker dat je "${venueName}" wilt verwijderen? Dit kan niet ongedaan worden gemaakt.</p>
        <div class="flex gap-3">
          <button id="cancel-delete-gig" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-colors">
            Annuleren
          </button>
          <button id="confirm-delete-gig" data-event-id="${eventId}" class="flex-1 px-4 py-2.5 bg-red-500 text-white font-medium rounded-xl hover:bg-red-600 transition-colors">
            Verwijderen
          </button>
        </div>
      </div>
    </div>
  `;
}

/**
 * Get badge color class based on event type
 * @param {string} type - Event type
 * @param {boolean} darkMode - Use dark mode colors
 * @returns {string} Tailwind classes
 */
function getTypeBadgeColor(type, darkMode = false) {
  if (darkMode) {
    const colors = {
      'slam': 'bg-purple-500 text-white',
      'slam-finale': 'bg-purple-500 text-white',
      'showcase': 'bg-gray-700 text-gray-200',
      'gig': 'bg-gray-600 text-gray-200',
      'open-mic': 'bg-green-600 text-white',
      'workshop': 'bg-blue-600 text-white',
      'feature': 'bg-pink-500 text-white'
    };
    return colors[type] || 'bg-gray-600 text-gray-200';
  }

  const colors = {
    'gig': 'bg-indigo-100 text-indigo-700',
    'open-mic': 'bg-green-100 text-green-700',
    'slam': 'bg-orange-100 text-orange-700',
    'slam-finale': 'bg-purple-100 text-purple-700',
    'showcase': 'bg-gray-100 text-gray-700',
    'workshop': 'bg-blue-100 text-blue-700',
    'feature': 'bg-purple-100 text-purple-700'
  };
  return colors[type] || 'bg-gray-100 text-gray-700';
}

/**
 * a) Render Date Tape - Horizontale datumkiezer
 * @param {Date} selectedDate - Geselecteerde datum
 * @param {Object} eventCounts - Object met dateString keys en count values
 * @param {number} daysToShow - Aantal dagen om te tonen (default 14)
 * @returns {string} HTML string
 */
export function renderDateTape(selectedDate, eventCounts = {}, daysToShow = 14) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const selected = new Date(selectedDate);
  selected.setHours(0, 0, 0, 0);

  // Calculate start date (7 days before selected)
  const startDate = new Date(selected);
  startDate.setDate(startDate.getDate() - Math.floor(daysToShow / 2));

  const days = [];
  for (let i = 0; i < daysToShow; i++) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + i);

    const dateString = formatDateKey(date);
    const isSelected = date.getTime() === selected.getTime();
    const isToday = date.getTime() === today.getTime();
    const eventCount = eventCounts[dateString] || 0;
    const hasEvents = eventCount > 0;

    const dayName = date.toLocaleDateString('nl-BE', { weekday: 'short' });
    const dayNum = date.getDate();

    days.push(`
      <button
        class="date-tape-day flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-xl transition-all ${
          isSelected
            ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30'
            : 'bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200'
        }"
        data-date="${dateString}"
      >
        <span class="text-xs font-medium uppercase mb-1">${dayName}</span>
        <span class="text-xl font-bold">${dayNum}</span>
        ${hasEvents ? `
          <div class="mt-1.5 w-1.5 h-1.5 rounded-full ${isToday ? 'bg-red-500' : 'bg-indigo-400'}"></div>
        ` : isToday ? `
          <div class="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-500"></div>
        ` : '<div class="h-3"></div>'}
      </button>
    `);
  }

  return `
    <div class="date-tape-container sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b border-gray-200 px-4 py-4 shadow-sm">
      <div class="flex gap-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory" id="date-tape-scroll">
        ${days.join('')}
      </div>
    </div>
  `;
}

/**
 * Render alleen de dagen voor de Date Tape
 * @param {Date} selectedDate - Geselecteerde datum
 * @param {Object} eventCounts - Object met datums als keys en counts als values
 * @returns {string} HTML string van dagen
 */
export function renderDateTapeDays(selectedDate, eventCounts = {}) {
  const days = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Genereer 14 dagen: 3 voor, geselecteerd, 10 na
  const startDate = new Date(selectedDate);
  startDate.setDate(startDate.getDate() - 3);

  for (let i = 0; i < 14; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);

    const dateStr = formatDateKey(date);
    const isSelected = date.toDateString() === selectedDate.toDateString();
    const isToday = date.toDateString() === today.toDateString();
    const eventCount = eventCounts[dateStr] || 0;

    const dayName = date.toLocaleDateString('nl-BE', { weekday: 'short' }).substring(0, 2);
    const dayNum = date.getDate();

    days.push(`
      <button
        class="date-tape-day flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all ${
          isSelected
            ? 'bg-indigo-600 text-white shadow-md'
            : 'bg-white border border-gray-200 text-gray-700 hover:border-indigo-300 hover:bg-indigo-50'
        }"
        data-date="${dateStr}"
      >
        <span class="text-xs font-medium uppercase ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">${dayName}</span>
        <span class="text-lg font-bold">${dayNum}</span>
        <div class="flex gap-0.5 mt-0.5">
          ${isToday ? `<span class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-white' : 'bg-red-500'}"></span>` : ''}
          ${eventCount > 0 ? `<span class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-indigo-200' : 'bg-indigo-500'}"></span>` : ''}
        </div>
      </button>
    `);
  }

  return days.join('');
}

/**
 * b) Render Cluster Card - Multi-artiest event
 * @param {object} event - Event object
 * @param {string} currentUserId - UID van de huidige user
 * @returns {string} HTML string
 */
export function renderClusterCard(event, currentUserId = null) {
  const date = event.date ? new Date(event.date) : null;
  const formattedDate = date ? date.toLocaleDateString('nl-BE', {
    weekday: 'long',
    day: 'numeric',
    month: 'long'
  }) : 'Datum TBA';

  const typeLabel = EVENT_TYPE_LABELS[event.type] || event.type;
  const typeBadgeColor = getTypeBadgeColor(event.type, false);

  const eventName = event.eventName || event.venue || 'Event';
  const participants = event.participants || [];
  const visibleParticipants = participants.slice(0, 5);
  const hiddenCount = Math.max(0, participants.length - 5);

  const attendeeCount = event.attendeeCount || 0;
  const isAttending = currentUserId && (event.attendees || []).includes(currentUserId);

  return `
    <div class="cluster-card bg-white border border-gray-200 rounded-3xl p-6 shadow-sm hover:shadow-md transition-all" data-event-id="${event.id}">
      <!-- Header -->
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <h3 class="text-2xl font-bold text-gray-900 mb-2">${eventName}</h3>
          <div class="flex items-center gap-2 text-gray-600 text-sm">
            <i data-lucide="calendar" class="w-4 h-4"></i>
            <span>${formattedDate}</span>
            ${event.eventTime ? `<span>‚Ä¢ ${event.eventTime}</span>` : ''}
          </div>
          <div class="flex items-center gap-2 text-gray-600 text-sm mt-1">
            <i data-lucide="map-pin" class="w-4 h-4"></i>
            <span>${event.city || 'Locatie TBA'}${event.venue ? ` ‚Ä¢ ${event.venue}` : ''}</span>
          </div>
        </div>
        <span class="px-3 py-1.5 text-xs font-bold rounded-full ${typeBadgeColor}">${typeLabel}</span>
      </div>

      <!-- Participants -->
      ${participants.length > 0 ? `
        <div class="mb-6">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Line-up</p>
          <div class="flex items-center gap-2">
            <!-- Avatar Stack -->
            <div class="flex -space-x-3">
              ${visibleParticipants.map((p, idx) => `
                <img
                  src="${p.artistProfilePicUrl || '/default-avatar.png'}"
                  alt="${p.artistName}"
                  class="w-10 h-10 rounded-full border-2 border-white object-cover hover:z-10 hover:scale-110 transition-transform cursor-pointer shadow-sm"
                  title="${p.artistName}"
                  style="z-index: ${10 - idx}"
                >
              `).join('')}
              ${hiddenCount > 0 ? `
                <div class="w-10 h-10 rounded-full border-2 border-white bg-gray-200 flex items-center justify-center shadow-sm">
                  <span class="text-xs font-bold text-gray-600">+${hiddenCount}</span>
                </div>
              ` : ''}
            </div>
            <span class="text-sm text-gray-600">${participants.length} artiest${participants.length > 1 ? 'en' : ''}</span>
          </div>
        </div>
      ` : ''}

      <!-- Actions -->
      <div class="flex gap-3">
        ${event.link ? `
          <a href="${event.link}" target="_blank" rel="noopener noreferrer"
            class="flex-1 px-5 py-3 bg-white border-2 border-indigo-600 text-indigo-600 font-semibold rounded-xl hover:bg-indigo-600 hover:text-white transition-all text-center">
            Tickets
          </a>
        ` : ''}
        <button
          class="attend-event-btn px-5 py-2.5 font-semibold rounded-xl transition-all ${
            isAttending
              ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm'
              : 'bg-indigo-50 border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-600 hover:text-white'
          }"
          data-event-id="${event.id}"
        >
          ${isAttending ? '‚úì ' : ''}Ik ga ook${attendeeCount > 0 ? ` (${attendeeCount})` : ''}
        </button>
      </div>
    </div>
  `;
}

/**
 * c) Render Solo Gig Card - Enkele artiest optreden
 * @param {object} event - Event object
 * @param {string} currentUserId - UID van de huidige user
 * @returns {string} HTML string
 */
export function renderSoloGigCard(event, currentUserId = null) {
  const date = event.date ? new Date(event.date) : null;
  const dayNum = date ? date.getDate() : '--';
  const monthShort = date ? date.toLocaleDateString('nl-BE', { month: 'short' }).toUpperCase() : '';

  const typeLabel = EVENT_TYPE_LABELS[event.type] || event.type;
  const typeBadgeColor = getTypeBadgeColor(event.type, false);

  const attendeeCount = event.attendeeCount || 0;
  const isAttending = currentUserId && (event.attendees || []).includes(currentUserId);

  return `
    <div class="solo-gig-card bg-white border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-all cursor-pointer" data-event-id="${event.id}">
      <div class="flex items-center gap-4">
        <!-- Date Block -->
        <div class="flex-shrink-0 w-14 h-14 bg-indigo-50 border border-indigo-200 rounded-xl flex flex-col items-center justify-center">
          <span class="text-lg font-bold text-indigo-600 leading-none">${dayNum}</span>
          <span class="text-xs font-medium text-indigo-500 uppercase">${monthShort}</span>
        </div>

        <!-- Artist Info -->
        <div class="flex items-center gap-3 flex-1 min-w-0">
          ${event.artistProfilePicUrl ? `
            <img src="${event.artistProfilePicUrl}" alt="${event.artistName}"
              class="w-10 h-10 rounded-full object-cover border-2 border-gray-100 shadow-sm">
          ` : `
            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
              <i data-lucide="user" class="w-5 h-5 text-gray-400"></i>
            </div>
          `}

          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h4 class="font-semibold text-gray-900 truncate">${event.artistName || 'Artiest'}</h4>
              <span class="flex-shrink-0 px-2 py-0.5 text-xs font-medium rounded-full ${typeBadgeColor}">${typeLabel}</span>
            </div>
            <p class="text-sm text-gray-500 truncate">
              ${event.venue || 'Venue TBA'} ‚Ä¢ ${event.city || 'Locatie TBA'}
            </p>
          </div>
        </div>

        <!-- Chevron -->
        <div class="flex-shrink-0">
          <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </div>
      </div>

      <!-- Attend Button -->
      <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end">
        <button
          class="attend-event-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all ${
            isAttending
              ? 'bg-indigo-600 text-white'
              : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'
          }"
          data-event-id="${event.id}"
        >
          ${isAttending ? '‚úì ' : 'üëã '}Ik ga ook${attendeeCount > 0 ? ` (${attendeeCount})` : ''}
        </button>
      </div>
    </div>
  `;
}

/**
 * Render maandkalender grid
 * @param {Date} selectedDate - Geselecteerde datum
 * @param {Object} eventCounts - Object met datums en event counts
 * @returns {string} HTML string
 */
export function renderMonthCalendar(selectedDate, eventCounts = {}) {
  const year = selectedDate.getFullYear();
  const month = selectedDate.getMonth();

  // Maand en jaar header
  const monthName = selectedDate.toLocaleDateString('nl-BE', { month: 'long', year: 'numeric' });
  const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);

  // Eerste dag van de maand en aantal dagen
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();

  // Dag van de week waarop maand begint (0 = zondag, 1 = maandag, etc.)
  // Converteer naar maandag = 0
  let startDay = firstDay.getDay() - 1;
  if (startDay < 0) startDay = 6;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Bouw kalender grid
  let daysHtml = '';

  // Lege cellen voor dagen voor de eerste
  for (let i = 0; i < startDay; i++) {
    daysHtml += '<div class="w-8 h-8"></div>';
  }

  // Dagen van de maand
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = formatDateKey(date);
    const isSelected = date.toDateString() === selectedDate.toDateString();
    const isToday = date.toDateString() === today.toDateString();
    const hasEvents = eventCounts[dateStr] > 0;

    let classes = 'w-8 h-8 flex items-center justify-center text-sm rounded-lg cursor-pointer transition-colors relative';

    if (isSelected) {
      classes += ' bg-indigo-600 text-white font-semibold';
    } else if (isToday) {
      classes += ' bg-indigo-100 text-indigo-700 font-semibold';
    } else {
      classes += ' text-gray-700 hover:bg-gray-100';
    }

    daysHtml += `
      <button class="calendar-day ${classes}" data-date="${dateStr}">
        ${day}
        ${hasEvents ? `<span class="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-indigo-500'}"></span>` : ''}
      </button>
    `;
  }

  return `
    <div class="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm mb-4">
      <!-- Month Navigation -->
      <div class="flex items-center justify-between mb-4">
        <button id="month-prev" class="p-1 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
        </button>
        <span class="font-semibold text-gray-900">${capitalizedMonth}</span>
        <button id="month-next" class="p-1 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
        </button>
      </div>

      <!-- Weekday Headers -->
      <div class="grid grid-cols-7 gap-1 mb-2">
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Ma</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Di</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Wo</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Do</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Vr</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Za</div>
        <div class="w-8 h-6 flex items-center justify-center text-xs font-medium text-gray-500">Zo</div>
      </div>

      <!-- Days Grid -->
      <div class="grid grid-cols-7 gap-1">
        ${daysHtml}
      </div>
    </div>
  `;
}

/**
 * d) Render Agenda Filters (desktop sidebar)
 * @param {Object} activeFilters - Actieve filters { types: [], region: 'all' }
 * @param {Date} selectedDate - Geselecteerde datum voor month calendar
 * @param {Object} eventCounts - Event counts per datum
 * @returns {string} HTML string
 */
export function renderAgendaFilters(activeFilters = { types: [], region: 'all' }, selectedDate = new Date(), eventCounts = {}) {
  // Ensure filters have default values
  const filters = {
    types: activeFilters?.types || [],
    region: activeFilters?.region || 'all'
  };

  const monthCalendarHtml = renderMonthCalendar(selectedDate, eventCounts);

  const eventTypes = [
    { value: 'slam-finale', label: 'Slam Finales' },
    { value: 'slam', label: 'Slams & Battles' },
    { value: 'showcase', label: 'Showcases' },
    { value: 'gig', label: 'Optredens' },
    { value: 'open-mic', label: 'Open Mics' },
    { value: 'workshop', label: 'Workshops' },
    { value: 'feature', label: 'Features' }
  ];

  const regions = [
    { value: 'all', label: 'Alle regio\'s' },
    { value: 'vlaanderen', label: 'Vlaanderen' },
    { value: 'nederland', label: 'Nederland' },
    { value: 'brussel', label: 'Brussel' }
  ];

  return `
    ${monthCalendarHtml}
    <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Filters</h3>

      <!-- Event Type Checkboxes -->
      <div class="mb-6">
        <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Type Event</p>
        <div class="space-y-2">
          ${eventTypes.map(type => `
            <label class="flex items-center gap-3 cursor-pointer group">
              <input
                type="checkbox"
                name="event-type"
                value="${type.value}"
                ${filters.types.includes(type.value) ? 'checked' : ''}
                class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-0"
              >
              <span class="text-sm text-gray-700 group-hover:text-gray-900 transition-colors">${type.label}</span>
            </label>
          `).join('')}
        </div>
      </div>

      <!-- Region Dropdown -->
      <div>
        <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Regio</p>
        <select
          name="region-filter"
          class="w-full bg-gray-50 border border-gray-300 rounded-xl px-4 py-2.5 text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
        >
          ${regions.map(region => `
            <option value="${region.value}" ${filters.region === region.value ? 'selected' : ''}>
              ${region.label}
            </option>
          `).join('')}
        </select>
      </div>

      <!-- Clear Filters -->
      <button id="clear-filters-btn" class="mt-4 w-full px-4 py-2 text-sm text-gray-500 hover:text-gray-900 transition-colors">
        Filters wissen
      </button>
    </div>
  `;
}

/**
 * Render attendee notificaties voor artiest's gigs pagina
 * @param {Array} notifications - Array van event notifications met attendee profiles
 * @returns {string} HTML string
 */
export function renderAttendeeNotifications(notifications = []) {
  if (!notifications || notifications.length === 0) {
    return '';
  }

  const totalAttendees = notifications.reduce((sum, n) => sum + n.attendeeCount, 0);

  return `
    <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4 mb-6">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
          <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">${totalAttendees} ${totalAttendees === 1 ? 'persoon komt' : 'mensen komen'} naar je shows!</h3>
        </div>
      </div>

      <div class="space-y-3">
        ${notifications.map(n => renderNotificationItem(n)).join('')}
      </div>
    </div>
  `;
}

/**
 * Render een enkele notificatie item met expandable attendees
 */
function renderNotificationItem(notification) {
  const dateStr = notification.date
    ? notification.date.toLocaleDateString('nl-BE', { day: 'numeric', month: 'short' })
    : 'TBA';

  const attendeeAvatars = (notification.profiles || []).slice(0, 5).map(profile => {
    if (profile.profilePicUrl) {
      return `<img src="${profile.profilePicUrl}" alt="${profile.name}" class="w-8 h-8 rounded-full border-2 border-white object-cover" title="${profile.name}">`;
    }
    return `<div class="w-8 h-8 rounded-full border-2 border-white bg-gray-200 flex items-center justify-center" title="${profile.name}">
      <span class="text-xs font-medium text-gray-600">${profile.name.charAt(0).toUpperCase()}</span>
    </div>`;
  }).join('');

  const extraCount = notification.attendeeCount - 5;
  const extraBadge = extraCount > 0
    ? `<div class="w-8 h-8 rounded-full border-2 border-white bg-indigo-100 flex items-center justify-center">
        <span class="text-xs font-medium text-indigo-600">+${extraCount}</span>
      </div>`
    : '';

  return `
    <div class="bg-white rounded-xl p-3 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <div>
          <span class="font-medium text-gray-900">${notification.venue}</span>
          <span class="text-sm text-gray-500 ml-2">${dateStr}</span>
        </div>
        <span class="text-sm font-semibold text-indigo-600">${notification.attendeeCount} üëã</span>
      </div>

      <!-- Attendee Avatars -->
      <div class="flex items-center">
        <div class="flex -space-x-2">
          ${attendeeAvatars}
          ${extraBadge}
        </div>
        ${notification.profiles && notification.profiles.length > 0 ? `
          <button class="toggle-attendees-btn ml-3 text-xs text-indigo-600 hover:text-indigo-800 font-medium" data-event-id="${notification.eventId}">
            Bekijk namen
          </button>
        ` : ''}
      </div>

      <!-- Expanded names (hidden by default) -->
      <div id="attendees-list-${notification.eventId}" class="hidden mt-3 pt-3 border-t border-gray-100">
        <p class="text-xs text-gray-500 mb-2">Wie komen er:</p>
        <div class="space-y-1">
          ${(notification.profiles || []).map(p => `
            <div class="flex items-center gap-2">
              ${p.profilePicUrl
                ? `<img src="${p.profilePicUrl}" class="w-6 h-6 rounded-full object-cover">`
                : `<div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center">
                    <span class="text-xs text-gray-600">${p.name.charAt(0)}</span>
                  </div>`
              }
              <span class="text-sm text-gray-700">${p.name}</span>
              <span class="text-xs text-gray-400">${p.role === 'programmer' ? '(Programmeur)' : p.role === 'artist' ? '(Artiest)' : ''}</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

/**
 * e) Render Agenda Layout - Volledige layout container
 * @param {boolean} isMobile - Is mobile viewport
 * @returns {string} HTML string
 */
export function renderAgendaLayout(isMobile = false) {
  if (isMobile) {
    return `
      <div class="agenda-mobile-layout min-h-screen bg-white pb-20">
        <!-- Date Tape wordt hier ge√Ønjecteerd -->
        <div id="agenda-date-tape"></div>

        <!-- Events List -->
        <div id="agenda-events-list" class="p-4 space-y-4">
          <!-- Events worden hier ge√Ønjecteerd -->
          <div class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>
        </div>

        <!-- Map Toggle FAB -->
        <button id="toggle-map-view" class="fixed bottom-24 right-4 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center z-20">
          <i data-lucide="map" class="w-6 h-6"></i>
        </button>
      </div>
    `;
  }

  // Desktop 3-column layout
  return `
    <div class="agenda-desktop-layout min-h-screen bg-white">
      <div class="flex gap-6 p-6 max-w-[1800px] mx-auto">
        <!-- Left Sidebar: Calendar + Filters -->
        <aside class="w-72 flex-shrink-0 space-y-6">
          <!-- Mini Calendar placeholder -->
          <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Kalender</h3>
            <p class="text-sm text-gray-500">Maandkalender komt hier...</p>
          </div>

          <!-- Filters -->
          <div id="agenda-filters"></div>
        </aside>

        <!-- Middle: Date Tape + Events -->
        <main class="flex-1 min-w-0 space-y-6">
          <!-- Date Tape -->
          <div id="agenda-date-tape"></div>

          <!-- Events List -->
          <div id="agenda-events-list" class="space-y-4">
            <div class="flex justify-center py-12">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>
          </div>
        </main>

        <!-- Right Sidebar: Map -->
        <aside class="w-96 flex-shrink-0">
          <div class="sticky top-6 bg-white border border-gray-200 rounded-2xl p-6 h-[calc(100vh-3rem)] shadow-sm">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Kaart</h3>
            <div class="flex items-center justify-center h-full text-gray-400">
              <p class="text-sm">Kaart integratie komt later...</p>
            </div>
          </div>
        </aside>
      </div>
    </div>
  `;
}
</file>

<file path="src/modules/dashboard/dashboard-service.js">
/**
 * dashboard-service.js
 * Data operations for artist dashboard
 * Handles Firestore queries for bookings, statistics, and profile data
 */

import { db } from '../../services/firebase.js';
import { doc, getDoc, updateDoc, collection, query, where, getDocs } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";

/**
 * Calculate age from date of birth
 */
export function calculateAge(dob) {
  if (!dob) return null;

  const birthDate = new Date(dob);
  const today = new Date();

  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }

  return age;
}

/**
 * Fetch artist profile data
 */
export async function fetchArtistProfile(uid) {
  try {
    const artistRef = doc(db, 'artists', uid);
    const artistSnap = await getDoc(artistRef);

    if (!artistSnap.exists()) {
      console.warn("Artist profile not found:", uid);
      return null;
    }

    return { id: artistSnap.id, ...artistSnap.data() };
  } catch (error) {
    console.error("Error fetching artist profile:", error);
    throw error;
  }
}

/**
 * Update artist profile in Firestore
 */
export async function updateArtistProfile(uid, profileData, profilePicFile = null, documentFile = null) {
  try {
    const docRef = doc(db, 'artists', uid);
    const storage = getStorage();
    const dataToUpdate = { ...profileData };

    // Handle profile picture upload
    if (profilePicFile) {
      console.log("Uploading profile picture...");
      const storageRef = ref(storage, `artists/${uid}/profile.jpg`);
      const snapshot = await uploadBytes(storageRef, profilePicFile);
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Profile picture uploaded:", downloadURL);
      dataToUpdate.profilePicUrl = downloadURL;
    }

    // Handle document upload
    if (documentFile) {
      console.log("Uploading document...");
      const fileExtension = documentFile.name.split('.').pop();
      const storageRef = ref(storage, `artists/${uid}/document.${fileExtension}`);
      const snapshot = await uploadBytes(storageRef, documentFile);
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Document uploaded:", downloadURL);
      dataToUpdate.documentUrl = downloadURL;
      dataToUpdate.documentName = documentFile.name;
    }

    // Update Firestore
    await updateDoc(docRef, dataToUpdate);
    console.log("Profile updated successfully");

    return dataToUpdate;
  } catch (error) {
    console.error("Error updating profile:", error);
    throw error;
  }
}

/**
 * Fetch artist bookings/gigs (placeholder for future implementation)
 */
export async function fetchArtistBookings(uid) {
  try {
    // TODO: Implement bookings collection query
    // For now, return empty array
    console.log("Fetching bookings for artist:", uid);
    return [];
  } catch (error) {
    console.error("Error fetching bookings:", error);
    return [];
  }
}

/**
 * Fetch artist statistics (placeholder for future implementation)
 */
export async function fetchArtistStats(uid) {
  try {
    // TODO: Implement stats aggregation
    // For now, return placeholder stats
    console.log("Fetching stats for artist:", uid);

    return {
      profileViews: 0,
      messageCount: 0,
      recommendationCount: 0,
      bookings: 0
    };
  } catch (error) {
    console.error("Error fetching stats:", error);
    return {
      profileViews: 0,
      messageCount: 0,
      recommendationCount: 0,
      bookings: 0
    };
  }
}
</file>

<file path="src/modules/dashboard/media-gallery.js">
/**
 * media-gallery.js
 * Service layer for media gallery management
 */

import { db } from '../../services/firebase.js';
import { doc, updateDoc } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "firebase/storage";

/**
 * Upload image to gallery
 */
export async function uploadGalleryImage(uid, file, currentGallery) {
  try {
    const storage = getStorage();

    // Generate unique filename
    const timestamp = Date.now();
    const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const storagePath = `artists/${uid}/gallery/${filename}`;

    // Upload to Firebase Storage
    const storageRef = ref(storage, storagePath);
    const snapshot = await uploadBytes(storageRef, file);
    const downloadURL = await getDownloadURL(snapshot.ref);

    // Create new gallery item
    const newItem = {
      type: 'image',
      url: downloadURL,
      storagePath: storagePath,
      uploadedAt: new Date(),
      order: currentGallery.length
    };

    // Add to gallery array
    const updatedGallery = [...currentGallery, newItem];

    // Update Firestore
    const docRef = doc(db, 'artists', uid);
    await updateDoc(docRef, { mediaGallery: updatedGallery });

    console.log('Gallery image uploaded:', downloadURL);
    return updatedGallery;

  } catch (error) {
    console.error('Error uploading gallery image:', error);
    throw new Error('Failed to upload image: ' + error.message);
  }
}

/**
 * Add YouTube video to gallery
 */
export async function addYouTubeVideo(uid, youtubeUrl, currentGallery) {
  try {
    const videoId = extractYouTubeId(youtubeUrl);

    if (!videoId) {
      throw new Error('Invalid YouTube URL');
    }

    // Create new gallery item
    const newItem = {
      type: 'video',
      url: youtubeUrl,
      videoId: videoId,
      uploadedAt: new Date(),
      order: currentGallery.length
    };

    // Add to gallery array
    const updatedGallery = [...currentGallery, newItem];

    // Update Firestore
    const docRef = doc(db, 'artists', uid);
    await updateDoc(docRef, { mediaGallery: updatedGallery });

    console.log('YouTube video added:', videoId);
    return updatedGallery;

  } catch (error) {
    console.error('Error adding YouTube video:', error);
    throw new Error('Failed to add video: ' + error.message);
  }
}

/**
 * Remove item from gallery
 */
export async function removeGalleryItem(uid, index, currentGallery) {
  try {
    const item = currentGallery[index];

    if (!item) {
      throw new Error('Item not found');
    }

    // If it's an image, delete from storage
    if (item.type === 'image' && item.storagePath) {
      try {
        const storage = getStorage();
        const storageRef = ref(storage, item.storagePath);
        await deleteObject(storageRef);
        console.log('Storage file deleted:', item.storagePath);
      } catch (storageError) {
        // Log but don't fail - file might already be deleted
        console.warn('Storage deletion failed (file may not exist):', storageError);
      }
    }

    // Remove from gallery array
    const updatedGallery = currentGallery.filter((_, i) => i !== index);

    // Update Firestore
    const docRef = doc(db, 'artists', uid);
    await updateDoc(docRef, { mediaGallery: updatedGallery });

    console.log('Gallery item removed at index:', index);
    return updatedGallery;

  } catch (error) {
    console.error('Error removing gallery item:', error);
    throw new Error('Failed to remove item: ' + error.message);
  }
}

/**
 * Extract YouTube video ID from URL
 * Supports:
 * - https://www.youtube.com/watch?v=VIDEO_ID
 * - https://youtu.be/VIDEO_ID
 * - https://www.youtube.com/embed/VIDEO_ID
 */
export function extractYouTubeId(url) {
  if (!url) return null;

  // Try standard watch URL
  const watchMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
  if (watchMatch) {
    return watchMatch[1];
  }

  // Try embed URL
  const embedMatch = url.match(/youtube\.com\/embed\/([^?&\s]+)/);
  if (embedMatch) {
    return embedMatch[1];
  }

  return null;
}
</file>

<file path="src/modules/recommendations/recommendations.js">
/**
 * recommendations.js
 * Handles recommendation functionality for programmers to recommend artists
 */

import { collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, doc, getDoc, deleteDoc } from "firebase/firestore";
import { db } from '../../services/firebase.js';
import { getStore } from '../../utils/store.js';
import { t } from '../../utils/translations.js';
import { sendRecommendationNotification } from '../messaging/messaging-controller.js';

/**
 * Setup recommendation modal and form
 */
export function setupRecommendations() {
  const modal = document.getElementById('recommendation-modal');
  const closeBtn = document.getElementById('close-recommendation-modal');
  const cancelBtn = document.getElementById('cancel-recommendation-btn');
  const form = document.getElementById('recommendation-form');

  if (!modal || !closeBtn || !form) {
    console.warn("Recommendation elements not found");
    return;
  }

  // Close modal
  closeBtn.addEventListener('click', closeRecommendationModal);

  // Cancel button also closes modal
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeRecommendationModal);
  }

  // Handle form submission
  form.addEventListener('submit', handleRecommendationSubmit);

  console.log("Recommendations setup complete");
}

/**
 * Open recommendation modal for a specific artist
 * @param {string} artistId - The artist's user ID
 * @param {object} artistData - The artist's profile data
 */
export function openRecommendationModal(artistId, artistData) {
  const currentUserData = getStore('currentUserData');

  // Security check: only programmers can write recommendations
  if (!currentUserData || currentUserData.role !== 'programmer') {
    alert(t('error_only_programmers_recommend'));
    return;
  }

  const modal = document.getElementById('recommendation-modal');
  const artistNameSpan = document.getElementById('recommendation-artist-name');
  const form = document.getElementById('recommendation-form');

  if (!modal || !artistNameSpan || !form) return;

  // Set artist name in modal
  artistNameSpan.textContent = artistData.stageName || `${artistData.firstName} ${artistData.lastName}`;

  // Store artist data in modal for later use
  form.dataset.artistId = artistId;
  form.dataset.artistName = artistData.stageName || `${artistData.firstName} ${artistData.lastName}`;
  form.dataset.artistEmail = artistData.email;

  // Reset form
  form.reset();
  document.getElementById('recommendation-error').style.display = 'none';
  document.getElementById('recommendation-success').style.display = 'none';

  // Show modal
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

/**
 * Close recommendation modal
 */
function closeRecommendationModal() {
  const modal = document.getElementById('recommendation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

/**
 * Handle recommendation form submission
 */
async function handleRecommendationSubmit(e) {
  e.preventDefault();

  const errorMsg = document.getElementById('recommendation-error');
  const successMsg = document.getElementById('recommendation-success');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

  // Reset messages
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';

  // Disable button
  submitBtn.disabled = true;
  submitBtn.textContent = t('submitting') || 'Submitting...';

  try {
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser || !currentUserData) {
      throw new Error(t('error_must_be_logged_in'));
    }

    if (currentUserData.role !== 'programmer') {
      throw new Error(t('error_only_programmers_recommend'));
    }

    const artistId = e.target.dataset.artistId;
    const artistName = e.target.dataset.artistName;
    const artistEmail = e.target.dataset.artistEmail;
    const text = document.getElementById('recommendation-text').value.trim();

    if (!text) {
      throw new Error(t('error_recommendation_required'));
    }

    if (text.length < 10) {
      throw new Error(t('error_recommendation_too_short'));
    }

    // Create recommendation document
    const recommendationData = {
      artistId: artistId,
      artistName: artistName,
      artistEmail: artistEmail,
      programmerId: currentUser.uid,
      programmerName: `${currentUserData.firstName} ${currentUserData.lastName}`,
      programmerOrganization: currentUserData.organizationName || '',
      programmerEmail: currentUserData.email || '',
      programmerProfilePic: currentUserData.profilePicUrl || '',
      text: text,
      createdAt: serverTimestamp(),
      isApproved: true // Auto-approve for now
    };

    // Add to Firestore
    const recDoc = await addDoc(collection(db, 'recommendations'), recommendationData);

    console.log("Recommendation submitted successfully:", recDoc.id);

    // Send notification message to artist
    try {
      await sendRecommendationNotification(
        artistId,
        artistEmail,
        artistName,
        currentUser.uid,
        currentUserData,
        text
      );
      console.log("Notification sent to artist");
    } catch (notifError) {
      console.error("Failed to send notification:", notifError);
      // Don't throw - recommendation was saved successfully
    }

    // Show success message
    successMsg.textContent = t('recommendation_success');
    successMsg.style.display = 'block';

    // Clear form
    e.target.reset();

    // ‚úÖ FIX: Close modal immediately after 1 second (faster UX)
    setTimeout(() => {
      closeRecommendationModal();
      // Reload recommendations if on artist detail page
      const currentArtistId = document.getElementById('artist-detail-view')?.dataset?.artistId;
      if (currentArtistId === artistId) {
        loadRecommendations(artistId);
      }
    }, 1000);

  } catch (error) {
    console.error("Error submitting recommendation:", error);
    errorMsg.textContent = error.message;
    errorMsg.style.display = 'block';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = t('submit_recommendation') || 'Submit Recommendation';
  }
}

/**
 * Load recommendations for a specific artist
 * @param {string} artistId - The artist's user ID
 */
export async function loadRecommendations(artistId) {
  const container = document.getElementById('recommendations-list');
  const loadingEl = document.getElementById('recommendations-loading');
  const emptyEl = document.getElementById('recommendations-empty');
  const errorEl = document.getElementById('recommendations-error');

  if (!container) {
    console.warn("Recommendations container not found");
    return;
  }

  // Show loading
  if (loadingEl) loadingEl.style.display = 'block';
  if (emptyEl) emptyEl.style.display = 'none';
  if (errorEl) errorEl.style.display = 'none';
  container.innerHTML = '';
  container.style.display = 'none';

  try {
    console.log("Loading recommendations for artist:", artistId);
    
    const recommendationsRef = collection(db, 'recommendations');
    const q = query(
      recommendationsRef,
      where('artistId', '==', artistId),
      where('isApproved', '==', true),
      orderBy('createdAt', 'desc')
    );

    const querySnapshot = await getDocs(q);

    const recommendations = [];
    querySnapshot.forEach((doc) => {
      recommendations.push({ id: doc.id, ...doc.data() });
    });

    console.log(`Found ${recommendations.length} recommendations`);

    // Hide loading
    if (loadingEl) loadingEl.style.display = 'none';

    if (recommendations.length === 0) {
      if (emptyEl) emptyEl.style.display = 'block';
    } else {
      container.style.display = 'block';
      displayRecommendations(recommendations);
    }

  } catch (error) {
    console.error("Error loading recommendations:", error);
    
    // Hide loading
    if (loadingEl) loadingEl.style.display = 'none';
    
    // Show error message
    if (errorEl) {
      errorEl.textContent = 'Fout bij laden. Probeer het later opnieuw.';
      errorEl.style.display = 'block';
    }
  }
}

/**
 * Display recommendations list
 */
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations-list');
  const currentUser = getStore('currentUser');

  if (!container) return;

  container.innerHTML = '';

  recommendations.forEach(rec => {
    const recDiv = document.createElement('div');
    recDiv.className = 'bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200';

    // Format date
    let dateText = '';
    if (rec.createdAt && rec.createdAt.toDate) {
      const date = rec.createdAt.toDate();
      dateText = date.toLocaleDateString('nl-NL', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Check if current user owns this recommendation (for delete button)
    const canDelete = currentUser && currentUser.uid === rec.programmerId;

    // Programmer name - clickable if viewing as artist or different programmer
    const programmerNameHtml = currentUser && currentUser.uid !== rec.programmerId
      ? `<button onclick="viewProgrammerProfile('${rec.programmerId}')" class="font-semibold text-indigo-600 hover:text-indigo-800 underline">${rec.programmerName}</button>`
      : `<h4 class="font-semibold text-gray-900">${rec.programmerName}</h4>`;

    recDiv.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <div>
          ${programmerNameHtml}
          ${rec.programmerOrganization ? `<p class="text-sm text-gray-600">${rec.programmerOrganization}</p>` : ''}
          <p class="text-xs text-gray-500 mt-1">${dateText}</p>
        </div>
        ${canDelete ? `
          <button onclick="deleteRecommendation('${rec.id}')" class="text-red-600 hover:text-red-800 text-sm">
            <i data-lucide="trash-2" class="h-4 w-4"></i>
          </button>
        ` : ''}
      </div>
      <p class="text-gray-800 italic">"${rec.text}"</p>
    `;

    container.appendChild(recDiv);
  });

  // Activate Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * View programmer profile
 */
window.viewProgrammerProfile = async function(programmerId) {
  try {
    console.log("Viewing programmer profile:", programmerId);
    
    const programmerRef = doc(db, 'programmers', programmerId);
    const programmerSnap = await getDoc(programmerRef);
    
    if (!programmerSnap.exists()) {
      alert('Programmer profile not found');
      return;
    }
    
    const programmer = { id: programmerId, ...programmerSnap.data() };
    
    // Show programmer profile modal
    showProgrammerProfileModal(programmer);
    
  } catch (error) {
    console.error("Error loading programmer profile:", error);
    alert('Failed to load programmer profile');
  }
};

/**
 * Show programmer profile in a modal
 */
function showProgrammerProfileModal(programmer) {
  // Create modal HTML
  const modalHTML = `
    <div id="programmer-profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
      <div class="relative p-8 bg-white w-full max-w-2xl m-auto rounded-lg shadow-xl">
        <!-- Close button -->
        <button onclick="closeProgrammerProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="h-6 w-6"></i>
        </button>
        
        <!-- Profile content -->
        <div class="mt-3">
          <div class="flex items-start gap-6 mb-6">
            <img src="${programmer.profilePicUrl || 'https://placehold.co/100x100/e0e7ff/6366f1?text=' + encodeURIComponent((programmer.firstName || 'P').charAt(0))}" 
                 alt="Profile" 
                 class="h-24 w-24 rounded-full object-cover border-4 border-indigo-100">
            <div class="flex-1">
              <h3 class="text-2xl font-bold text-gray-900">${programmer.firstName} ${programmer.lastName}</h3>
              <p class="text-lg text-indigo-600 font-semibold">${programmer.organizationName || ''}</p>
              ${programmer.website ? `<a href="${programmer.website}" target="_blank" class="text-sm text-blue-600 hover:underline">${programmer.website}</a>` : ''}
            </div>
          </div>
          
          <div class="space-y-4">
            ${programmer.organizationAbout ? `
              <div>
                <h4 class="font-semibold text-gray-700 mb-2">About</h4>
                <p class="text-gray-600">${programmer.organizationAbout}</p>
              </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-4 text-sm">
              ${programmer.phone ? `
                <div>
                  <span class="font-semibold text-gray-700">Phone:</span>
                  <span class="ml-2 text-gray-600">${programmer.phone}</span>
                </div>
              ` : ''}
              ${programmer.email ? `
                <div>
                  <span class="font-semibold text-gray-700">Email:</span>
                  <a href="mailto:${programmer.email}" class="ml-2 text-blue-600 hover:underline">${programmer.email}</a>
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="closeProgrammerProfileModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if present
  const existingModal = document.getElementById('programmer-profile-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Activate Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * Close programmer profile modal
 */
window.closeProgrammerProfileModal = function() {
  const modal = document.getElementById('programmer-profile-modal');
  if (modal) {
    modal.remove();
  }
};

/**
 * Get recommendation count for an artist
 * @param {string} artistId - The artist's user ID
 * @returns {Promise<number>} - Number of recommendations
 */
export async function getRecommendationCount(artistId) {
  try {
    const recommendationsRef = collection(db, 'recommendations');
    const q = query(
      recommendationsRef,
      where('artistId', '==', artistId),
      where('isApproved', '==', true)
    );

    const querySnapshot = await getDocs(q);
    return querySnapshot.size;
  } catch (error) {
    console.error("Error getting recommendation count:", error);
    return 0;
  }
}

/**
 * Delete a recommendation (only owner can delete)
 */
window.deleteRecommendation = async function(recommendationId) {
  if (!confirm(t('confirm_delete_recommendation') || 'Are you sure you want to delete this recommendation?')) {
    return;
  }

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error(t('error_must_be_logged_in'));
    }

    // Get recommendation to verify ownership
    const recRef = doc(db, 'recommendations', recommendationId);
    const recSnap = await getDoc(recRef);

    if (!recSnap.exists()) {
      throw new Error('Recommendation not found');
    }

    const recData = recSnap.data();

    // Verify ownership
    if (recData.programmerId !== currentUser.uid) {
      throw new Error('You can only delete your own recommendations');
    }

    // Delete the recommendation
    await deleteDoc(recRef);

    console.log("Recommendation deleted successfully");

    // Reload recommendations
    const artistId = recData.artistId;
    loadRecommendations(artistId);

  } catch (error) {
    console.error("Error deleting recommendation:", error);
    alert(error.message);
  }
};
</file>

<file path="src/modules/search/search-lightbox.js">
/**
 * search-lightbox.js
 * Lightbox functionality for media gallery viewing
 */

let currentGallery = [];
let currentIndex = 0;

/**
 * Open lightbox with media gallery
 */
export function openLightbox(mediaGallery, startIndex = 0) {
  currentGallery = mediaGallery;
  currentIndex = startIndex;

  const modal = document.getElementById('media-lightbox-modal');
  const content = document.getElementById('lightbox-content');

  if (!modal || !content) return;

  // Render current item
  renderLightboxItem();

  // Show/hide navigation arrows
  updateNavigationVisibility();

  // Show modal
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Initialize Lucide icons
  if (window.lucide) {
    lucide.createIcons();
  }
}

/**
 * Close lightbox
 */
export function closeLightbox() {
  const modal = document.getElementById('media-lightbox-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  currentGallery = [];
  currentIndex = 0;
}

/**
 * Navigate to previous item
 */
function navigatePrev() {
  if (currentIndex > 0) {
    currentIndex--;
    renderLightboxItem();
    updateNavigationVisibility();
  }
}

/**
 * Navigate to next item
 */
function navigateNext() {
  if (currentIndex < currentGallery.length - 1) {
    currentIndex++;
    renderLightboxItem();
    updateNavigationVisibility();
  }
}

/**
 * Render current lightbox item
 */
function renderLightboxItem() {
  const content = document.getElementById('lightbox-content');
  if (!content) return;

  const item = currentGallery[currentIndex];

  if (item.type === 'image') {
    content.innerHTML = `
      <img src="${item.url}" alt="Gallery image" style="max-height: 80vh; width: 100%; object-fit: contain;">
    `;
  } else {
    content.innerHTML = `
      <div style="position: relative; padding-bottom: 56.25%; height: 0;">
        <iframe
          src="https://www.youtube.com/embed/${item.videoId}?autoplay=1"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    `;
  }
}

/**
 * Update navigation button visibility
 */
function updateNavigationVisibility() {
  const prevBtn = document.getElementById('lightbox-prev');
  const nextBtn = document.getElementById('lightbox-next');

  if (prevBtn) {
    prevBtn.classList.toggle('hidden', currentIndex === 0 || currentGallery.length <= 1);
  }

  if (nextBtn) {
    nextBtn.classList.toggle('hidden', currentIndex === currentGallery.length - 1 || currentGallery.length <= 1);
  }
}

/**
 * Initialize lightbox event listeners (call from main.js or ui.js)
 */
export function initializeLightbox() {
  const modal = document.getElementById('media-lightbox-modal');
  const closeBtn = document.getElementById('close-lightbox');
  const prevBtn = document.getElementById('lightbox-prev');
  const nextBtn = document.getElementById('lightbox-next');

  if (closeBtn) {
    closeBtn.addEventListener('click', closeLightbox);
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', navigatePrev);
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', navigateNext);
  }

  // Close on outside click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeLightbox();
      }
    });
  }

  // Close on ESC key, navigate with arrow keys
  document.addEventListener('keydown', (e) => {
    if (!modal || modal.classList.contains('hidden')) return;

    if (e.key === 'Escape') {
      closeLightbox();
    }
    if (e.key === 'ArrowLeft') {
      navigatePrev();
    }
    if (e.key === 'ArrowRight') {
      navigateNext();
    }
  });
}
</file>

<file path="src/modules/search/search-visibility-fix.js">
/**
 * search-visibility-fix.js
 * üî• NUCLEAR VISIBILITY FIX
 * Forces ALL parent containers to be visible when showing artist search results
 */

/**
 * Force visibility on an element with ALL CSS properties
 * @param {HTMLElement} element - The element to show
 * @param {string} displayType - The display type to use (default: 'block')
 */
function forceVisible(element, displayType = 'block') {
  if (!element) return false;

  element.style.display = displayType;
  element.style.opacity = '1';
  element.style.visibility = 'visible';
  element.style.zIndex = '1';
  element.classList.remove('hidden');

  return true;
}

/**
 * Debug: Log the visibility status of an element
 * @param {string} elementId - The ID of the element to check
 */
function debugElementVisibility(elementId) {
  const element = document.getElementById(elementId);
  if (!element) {
    console.log(`[DEBUG] ‚ùå Element #${elementId} NOT FOUND`);
    return;
  }

  const computed = window.getComputedStyle(element);
  console.log(`[DEBUG] üëÄ #${elementId}:`);
  console.log(`  - exists: YES`);
  console.log(`  - display: ${computed.display}`);
  console.log(`  - opacity: ${computed.opacity}`);
  console.log(`  - visibility: ${computed.visibility}`);
  console.log(`  - classes: ${element.className}`);
}

/**
 * üîç Debug: Check entire parent hierarchy for visibility blockers
 * @param {string} elementId - The ID of the element to start from
 */
function debugParentHierarchy(elementId) {
  console.log(`[DEBUG HIERARCHY] üîç Checking parent chain for #${elementId}:`);

  let element = document.getElementById(elementId);
  if (!element) {
    console.log(`[DEBUG HIERARCHY] ‚ùå Element #${elementId} NOT FOUND`);
    return;
  }

  let level = 0;
  while (element && level < 10) {
    const computed = window.getComputedStyle(element);
    const tag = element.tagName.toLowerCase();
    const id = element.id ? `#${element.id}` : '';
    const classes = element.className ? `.${element.className.split(' ').join('.')}` : '';

    console.log(`[DEBUG HIERARCHY] Level ${level}: <${tag}${id}${classes}>`);
    console.log(`  - display: ${computed.display}`);
    console.log(`  - opacity: ${computed.opacity}`);
    console.log(`  - visibility: ${computed.visibility}`);

    // Check for visibility blockers
    if (computed.display === 'none') {
      console.log(`  ‚ö†Ô∏è  BLOCKER: display: none`);
    }
    if (computed.opacity === '0') {
      console.log(`  ‚ö†Ô∏è  BLOCKER: opacity: 0`);
    }
    if (computed.visibility === 'hidden') {
      console.log(`  ‚ö†Ô∏è  BLOCKER: visibility: hidden`);
    }

    element = element.parentElement;
    level++;
  }

  console.log(`[DEBUG HIERARCHY] ‚úÖ Checked ${level} levels`);
}

/**
 * üî• NUCLEAR OPTION: Force visibility on ALL parent containers
 * Call this after rendering artists to ensure everything is visible
 */
export function forceSearchResultsVisible() {
  console.log('[VISIBILITY FIX] üî• FORCING VISIBILITY ON ALL CONTAINERS');

  // 1. Force visibility on the results container (grid)
  const resultsContainer = document.getElementById('artist-list-container');
  if (forceVisible(resultsContainer, 'grid')) {
    console.log('[VISIBILITY FIX] ‚úÖ artist-list-container forced visible (grid)');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå artist-list-container NOT FOUND!');
  }

  // 1.5. Force visibility on the PARENT <main> element (CRITICAL!)
  const resultsMain = document.getElementById('artist-results-main');
  if (forceVisible(resultsMain, 'block')) {
    console.log('[VISIBILITY FIX] ‚úÖ artist-results-main forced visible');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå artist-results-main NOT FOUND!');
  }

  // 2. Force visibility on artist search section
  const artistSearchSection = document.getElementById('artist-search-section');
  if (forceVisible(artistSearchSection, 'block')) {
    console.log('[VISIBILITY FIX] ‚úÖ artist-search-section forced visible');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå artist-search-section NOT FOUND!');
  }

  // 3. Force visibility on programmer dashboard
  const programmerDashboard = document.getElementById('programmer-dashboard');
  if (forceVisible(programmerDashboard, 'block')) {
    console.log('[VISIBILITY FIX] ‚úÖ programmer-dashboard forced visible');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå programmer-dashboard NOT FOUND!');
  }

  // 4. Force visibility on dashboard view
  const dashboardView = document.getElementById('dashboard-view');
  if (forceVisible(dashboardView, 'block')) {
    console.log('[VISIBILITY FIX] ‚úÖ dashboard-view forced visible');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå dashboard-view NOT FOUND!');
  }

  // 5. Force visibility on app-content (root container)
  const appContent = document.getElementById('app-content');
  if (forceVisible(appContent, 'block')) {
    console.log('[VISIBILITY FIX] ‚úÖ app-content forced visible');
  } else {
    console.error('[VISIBILITY FIX] ‚ùå app-content NOT FOUND!');
  }

  // 6. Debug: Log computed styles after forcing
  console.log('[VISIBILITY FIX] üîç DEBUG: Checking computed styles...');
  debugElementVisibility('artist-list-container');
  debugElementVisibility('artist-results-main');
  debugElementVisibility('artist-search-section');
  debugElementVisibility('programmer-dashboard');
  debugElementVisibility('dashboard-view');

  // 7. üîç DEBUG HIERARCHY: Check entire parent chain for hidden blockers
  console.log('[VISIBILITY FIX] üîç DEBUG: Checking parent hierarchy...');
  debugParentHierarchy('artist-list-container');

  console.log('[VISIBILITY FIX] ‚úÖ ALL CONTAINERS FORCED VISIBLE');
}

/**
 * üî• NUCLEAR OPTION 2: Hide profile sections when showing search
 * Call this to ensure profile sections don't overlap with search results
 */
export function hideProfileSectionsForSearch() {
  console.log('[VISIBILITY FIX] üßπ Hiding profile sections for search view');

  const profileOverview = document.getElementById('programmer-profile-overview');
  const publicPreview = document.getElementById('programmer-public-preview');
  const profileEditor = document.getElementById('programmer-profile-editor');

  [profileOverview, publicPreview, profileEditor].forEach(element => {
    if (element) {
      element.style.display = 'none';
      element.classList.add('hidden');
    }
  });

  console.log('[VISIBILITY FIX] ‚úÖ Profile sections hidden');
}
</file>

<file path="src/modules/settings/user-settings.js">
/**
 * user-settings.js
 * Handles user account settings: language, email, and password changes
 */

import { auth, db } from '../../services/firebase.js';
import {
  updateEmail,
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential
} from 'firebase/auth';
import { doc, updateDoc } from 'firebase/firestore';
import { getStore } from '../../utils/store.js';
import { getCurrentLanguage, setLanguage, t, applyTranslations } from '../../utils/translations.js';

/**
 * Setup user settings functionality
 */
export function setupUserSettings() {
  const modal = document.getElementById('user-settings-modal');
  const closeBtn = document.getElementById('close-settings-modal');
  const userEmail = document.getElementById('user-email');
  const languageSelect = document.getElementById('settings-language-select');
  const updateEmailBtn = document.getElementById('settings-update-email-btn');
  const updatePasswordBtn = document.getElementById('settings-update-password-btn');

  if (!modal || !closeBtn || !userEmail) {
    console.warn("User settings elements not found");
    return;
  }

  // Make user email clickable
  userEmail.style.cursor = 'pointer';
  userEmail.classList.add('hover:text-indigo-600', 'hover:underline');

  userEmail.addEventListener('click', () => {
    openSettingsModal();
  });

  // Close modal handlers
  closeBtn.addEventListener('click', closeSettingsModal);

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeSettingsModal();
    }
  });

  // Language change handler
  if (languageSelect) {
    languageSelect.addEventListener('change', handleLanguageChange);
  }

  // Email update handler
  if (updateEmailBtn) {
    updateEmailBtn.addEventListener('click', handleEmailUpdate);
  }

  // Password update handler
  if (updatePasswordBtn) {
    updatePasswordBtn.addEventListener('click', handlePasswordUpdate);
  }

  console.log("User settings setup complete");
}

/**
 * Open settings modal
 */
function openSettingsModal() {
  const modal = document.getElementById('user-settings-modal');
  const languageSelect = document.getElementById('settings-language-select');

  if (!modal) return;

  // Set current language in dropdown
  if (languageSelect) {
    languageSelect.value = getCurrentLanguage();
  }

  // Clear all fields
  clearAllFields();

  // Show modal
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

/**
 * Close settings modal
 */
function closeSettingsModal() {
  const modal = document.getElementById('user-settings-modal');

  if (!modal) return;

  modal.classList.add('hidden');
  modal.classList.remove('flex');

  // Clear all fields
  clearAllFields();
}

/**
 * Clear all input fields and messages
 */
function clearAllFields() {
  // Clear email change fields
  document.getElementById('settings-current-password-email').value = '';
  document.getElementById('settings-new-email').value = '';
  document.getElementById('settings-email-error').classList.add('hidden');
  document.getElementById('settings-email-success').classList.add('hidden');

  // Clear password change fields
  document.getElementById('settings-current-password-pw').value = '';
  document.getElementById('settings-new-password').value = '';
  document.getElementById('settings-confirm-password').value = '';
  document.getElementById('settings-password-error').classList.add('hidden');
  document.getElementById('settings-password-success').classList.add('hidden');
}

/**
 * Handle language change
 */
async function handleLanguageChange(e) {
  const newLanguage = e.target.value;

  // Update UI immediately
  setLanguage(newLanguage);

  console.log(`Language changed to: ${newLanguage}`);

  // Save language preference to database
  try {
    const user = auth.currentUser;
    if (!user) {
      console.warn('No user logged in, language preference not saved to database');
      return;
    }

    // Update language in Firestore users collection
    const userDocRef = doc(db, 'users', user.uid);
    await updateDoc(userDocRef, {
      language: newLanguage
    });

    // Update language in role-specific collection (artists or programmers)
    const currentUserData = getStore('currentUserData');
    if (currentUserData && currentUserData.role) {
      const roleCollection = currentUserData.role === 'artist' ? 'artists' : 'programmers';
      const roleDocRef = doc(db, roleCollection, user.uid);
      await updateDoc(roleDocRef, {
        language: newLanguage
      });
    }

    console.log('Language preference saved to database');
  } catch (error) {
    console.error('Error saving language preference:', error);
    // Don't show error to user as the UI already changed
  }
}

/**
 * Handle email update
 */
async function handleEmailUpdate() {
  const currentPasswordInput = document.getElementById('settings-current-password-email');
  const newEmailInput = document.getElementById('settings-new-email');
  const errorMsg = document.getElementById('settings-email-error');
  const successMsg = document.getElementById('settings-email-success');
  const updateBtn = document.getElementById('settings-update-email-btn');

  // Reset messages
  errorMsg.classList.add('hidden');
  successMsg.classList.add('hidden');
  errorMsg.textContent = '';
  successMsg.textContent = '';

  const currentPassword = currentPasswordInput.value.trim();
  const newEmail = newEmailInput.value.trim();

  // Validation
  if (!currentPassword) {
    errorMsg.textContent = t('settings_reauth_required');
    errorMsg.classList.remove('hidden');
    return;
  }

  if (!newEmail) {
    errorMsg.textContent = t('settings_invalid_email');
    errorMsg.classList.remove('hidden');
    return;
  }

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(newEmail)) {
    errorMsg.textContent = t('settings_invalid_email');
    errorMsg.classList.remove('hidden');
    return;
  }

  // Disable button during update
  updateBtn.disabled = true;
  updateBtn.textContent = t('loading');

  try {
    const user = auth.currentUser;

    if (!user) {
      throw new Error('No user logged in');
    }

    // Re-authenticate user
    const credential = EmailAuthProvider.credential(user.email, currentPassword);
    await reauthenticateWithCredential(user, credential);

    // Update email in Firebase Auth
    await updateEmail(user, newEmail);

    // Update email in Firestore users collection
    const userDocRef = doc(db, 'users', user.uid);
    await updateDoc(userDocRef, {
      email: newEmail
    });

    // Update email in role-specific collection (artists or programmers)
    const currentUserData = getStore('currentUserData');
    if (currentUserData && currentUserData.role) {
      const roleCollection = currentUserData.role === 'artist' ? 'artists' : 'programmers';
      const roleDocRef = doc(db, roleCollection, user.uid);
      await updateDoc(roleDocRef, {
        email: newEmail
      });
    }

    // Show success message
    successMsg.textContent = t('settings_email_updated');
    successMsg.classList.remove('hidden');

    // Update displayed email in UI
    const userEmailSpan = document.getElementById('user-email');
    if (userEmailSpan) {
      userEmailSpan.textContent = newEmail;
    }

    // Clear fields
    currentPasswordInput.value = '';
    newEmailInput.value = '';

    console.log('Email updated successfully');

  } catch (error) {
    console.error('Error updating email:', error);

    let errorMessage = error.message;

    // Handle specific Firebase errors
    if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password';
    } else if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'This email address is already in use';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = t('settings_invalid_email');
    } else if (error.code === 'auth/requires-recent-login') {
      errorMessage = 'Please log out and log back in before changing your email';
    }

    errorMsg.textContent = errorMessage;
    errorMsg.classList.remove('hidden');
  } finally {
    updateBtn.disabled = false;
    updateBtn.textContent = t('settings_update_email');
  }
}

/**
 * Handle password update
 */
async function handlePasswordUpdate() {
  const currentPasswordInput = document.getElementById('settings-current-password-pw');
  const newPasswordInput = document.getElementById('settings-new-password');
  const confirmPasswordInput = document.getElementById('settings-confirm-password');
  const errorMsg = document.getElementById('settings-password-error');
  const successMsg = document.getElementById('settings-password-success');
  const updateBtn = document.getElementById('settings-update-password-btn');

  // Reset messages
  errorMsg.classList.add('hidden');
  successMsg.classList.add('hidden');
  errorMsg.textContent = '';
  successMsg.textContent = '';

  const currentPassword = currentPasswordInput.value.trim();
  const newPassword = newPasswordInput.value.trim();
  const confirmPassword = confirmPasswordInput.value.trim();

  // Validation
  if (!currentPassword) {
    errorMsg.textContent = t('settings_reauth_required');
    errorMsg.classList.remove('hidden');
    return;
  }

  if (!newPassword) {
    errorMsg.textContent = t('settings_password_too_short');
    errorMsg.classList.remove('hidden');
    return;
  }

  if (newPassword.length < 6) {
    errorMsg.textContent = t('settings_password_too_short');
    errorMsg.classList.remove('hidden');
    return;
  }

  if (newPassword !== confirmPassword) {
    errorMsg.textContent = t('settings_password_mismatch');
    errorMsg.classList.remove('hidden');
    return;
  }

  // Disable button during update
  updateBtn.disabled = true;
  updateBtn.textContent = t('loading');

  try {
    const user = auth.currentUser;

    if (!user) {
      throw new Error('No user logged in');
    }

    // Re-authenticate user
    const credential = EmailAuthProvider.credential(user.email, currentPassword);
    await reauthenticateWithCredential(user, credential);

    // Update password in Firebase Auth
    await updatePassword(user, newPassword);

    // Show success message
    successMsg.textContent = t('settings_password_updated');
    successMsg.classList.remove('hidden');

    // Clear fields
    currentPasswordInput.value = '';
    newPasswordInput.value = '';
    confirmPasswordInput.value = '';

    console.log('Password updated successfully');

  } catch (error) {
    console.error('Error updating password:', error);

    let errorMessage = error.message;

    // Handle specific Firebase errors
    if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect current password';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = t('settings_password_too_short');
    } else if (error.code === 'auth/requires-recent-login') {
      errorMessage = 'Please log out and log back in before changing your password';
    }

    errorMsg.textContent = errorMessage;
    errorMsg.classList.remove('hidden');
  } finally {
    updateBtn.disabled = false;
    updateBtn.textContent = t('settings_update_password');
  }
}
</file>

<file path="src/services/data.js">
// BELANGRIJKE FIX: 'getDoc' hier ge√Ømporteerd
import { doc, getDoc } from "firebase/firestore";
import { db } from './firebase.js';
import { setStore } from '../utils/store.js';
import { setLanguage } from '../utils/translations.js';

/**
 * Haalt de profielgegevens van de gebruiker op uit Firestore
 * en slaat deze op in de global store.
 * 
 * FIX: Deze functie voegt nu de 'role', 'uid' en 'email' velden toe
 * aan het currentUserData object zodat messaging.js toegang heeft tot senderRole.
 */
export async function fetchUserData(uid) {
  if (!uid) return null;

  try {
    // 1. Haal eerst de 'role' op uit de 'users' collectie
    const userRoleRef = doc(db, 'users', uid);
    const userRoleSnap = await getDoc(userRoleRef);

    if (!userRoleSnap.exists()) {
      throw new Error("Gebruikersrol niet gevonden in /users/" + uid);
    }
    
    const userData = userRoleSnap.data();
    // FIX 1: Handle role as both string and object (data.role.name)
    const role = typeof userData.role === 'object' && userData.role?.name
      ? userData.role.name
      : userData.role;
    const email = userData.email;
    
    setStore('userRole', role); // Sla de rol op

    // 2. Haal het volledige profiel op uit de specifieke collectie (artists/programmers)
    let userProfile = null;
    let userProfileSnap = null;

    if (role === 'artist') {
      const artistRef = doc(db, 'artists', uid);
      userProfileSnap = await getDoc(artistRef);
      userProfile = userProfileSnap.data();
    } else if (role === 'programmer') {
      const programmerRef = doc(db, 'programmers', uid);
      userProfileSnap = await getDoc(programmerRef);
      userProfile = userProfileSnap.data();
    } else {
      throw new Error(`Onbekende rol: ${role}`);
    }

    if (!userProfile) {
      // Probeer de snapshot data te gebruiken als userProfile leeg is
      if (userProfileSnap && userProfileSnap.exists()) {
        userProfile = userProfileSnap.data();
      } else {
        throw new Error(`Profiel niet gevonden in /${role}s/` + uid);
      }
    }

    // ‚≠ê FIX: Voeg role, uid, en email toe aan userProfile
    // Dit zorgt ervoor dat messaging.js toegang heeft tot senderRole
    const completeUserData = {
      ...userProfile,
      role: role,      // ‚≠ê Voeg role toe
      uid: uid,        // ‚≠ê Voeg uid toe
      email: email     // ‚≠ê Voeg email toe (als backup)
    };

    // 3. Sla de volledige profielgegevens op in de store
    setStore('currentUserData', completeUserData);
    console.log("Gebruikersprofiel geladen met role:", { uid, email, role, status: completeUserData.status });

    // 4. Set user's language preference (defaults to 'nl' if not set)
    const userLanguage = userProfile.language || 'nl';
    setLanguage(userLanguage);

    return completeUserData;

  } catch (error) {
    console.error("Fout bij ophalen gebruikersgegevens:", error);
    setStore('currentUserData', null);
    setStore('userRole', null);
    throw error; // Gooi de fout door zodat auth.js het kan opvangen
  }
}
</file>

<file path="src/services/firebase.js">
// Import Firebase modules
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getStorage } from "firebase/storage";

// Firebase configuration via Vite environment variables
// Build command determines which .env file is loaded:
// - "vite build --mode staging" loads .env.staging (ddd-spark)
// - "vite build --mode production" loads .env.production (dans-dichter-db)
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID
};

// Critical: Validate and log Firebase config
console.log('üî• Vite Mode:', import.meta.env.MODE);
console.log('üî• Firebase Project:', firebaseConfig.projectId);
console.log('üî• Firebase Config Check:', {
  apiKey: firebaseConfig.apiKey ? '‚úì Set' : '‚ùå MISSING',
  authDomain: firebaseConfig.authDomain ? '‚úì Set' : '‚ùå MISSING',
  projectId: firebaseConfig.projectId ? '‚úì Set' : '‚ùå MISSING'
});

// RUNTIME ENVIRONMENT GUARD: Comprehensive validation
const requiredKeys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
const missing = requiredKeys.filter(k => !firebaseConfig[k] || firebaseConfig[k] === '‚ùå MISSING' || firebaseConfig[k].length < 5);

if (missing.length > 0) {
  const errorMsg = `FATAL: Environment variables missing or invalid (${missing.join(', ')}).`;
  console.error('‚ùå', errorMsg);
  console.error('Current config:', firebaseConfig);
  console.error('Mode:', import.meta.env.MODE);

  // Show user-friendly error page
  document.body.innerHTML = `
    <div style="
      color: #dc2626;
      padding: 40px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 100px auto;
      background: #fef2f2;
      border: 2px solid #dc2626;
      border-radius: 8px;
    ">
      <h1 style="margin-top: 0;">‚ö†Ô∏è Configuration Error</h1>
      <p><strong>${errorMsg}</strong></p>
      <p style="font-size: 14px; color: #991b1b;">
        The application cannot start because required environment variables are not configured correctly.
      </p>
      <details style="margin-top: 20px; font-size: 12px; color: #7f1d1d;">
        <summary style="cursor: pointer; font-weight: bold;">Technical Details</summary>
        <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px; overflow-x: auto;">Mode: ${import.meta.env.MODE}
Missing: ${missing.join(', ')}
Project ID: ${firebaseConfig.projectId || 'NOT SET'}</pre>
      </details>
    </div>
  `;

  throw new Error(errorMsg);
}

// FIX 4: Environment guard - Staging warning for ddd-spark
// Show badge only when hostname contains 'ddd-spark'
if (window.location.hostname.includes('ddd-spark')) {
  console.warn(
    '%c‚ö†Ô∏è STAGING - DB: DDD-SPARK ‚ö†Ô∏è',
    'background: #ff9800; color: #000; font-size: 20px; font-weight: bold; padding: 10px;'
  );
  console.warn('This is NOT production. Project:', firebaseConfig.projectId);

  // Add visual badge to page
  window.addEventListener('DOMContentLoaded', () => {
    const badge = document.createElement('div');
    badge.id = 'staging-badge';
    badge.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
      color: white;
      padding: 8px 20px;
      font-weight: bold;
      font-size: 14px;
      z-index: 999999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border-radius: 0 0 8px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    `;
    badge.textContent = '‚ö†Ô∏è STAGING - DB: DDD-SPARK';
    document.body.appendChild(badge);
  });
}

// Initialize Firebase
console.log('üî• Initializing Firebase with projectId:', firebaseConfig.projectId);
const app = initializeApp(firebaseConfig);
console.log('‚úÖ Firebase initialized successfully');

// Initialize Firebase services
export const auth = getAuth(app);
export const db = getFirestore(app);
export const storage = getStorage(app);

// Export the app instance as well (if needed elsewhere)
export default app;
</file>

<file path="src/ui/toast.js">
/**
 * toast.js
 * Reusable Toast Notification System
 * Provides elegant, Apple-style notifications for errors, success, and info messages
 */

/**
 * Show a toast notification
 * @param {string} message - The message to display
 * @param {string} type - Type of toast: 'error', 'success', 'info', 'warning'
 * @param {number} duration - Duration in ms (default: 4000, set to 0 for permanent)
 */
export function showToast(message, type = 'info', duration = 4000) {
  // Get or create toast container
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    `;
    document.body.appendChild(container);
  }

  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';

  // Define colors based on type
  const colors = {
    error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: '‚ùå' },
    success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: '‚úÖ' },
    warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: '‚ö†Ô∏è' },
    info: { bg: '#DBEAFE', border: '#3B82F6', text: '#1E40AF', icon: '‚ÑπÔ∏è' }
  };

  const color = colors[type] || colors.info;

  toast.style.cssText = `
    background: ${color.bg};
    border-left: 4px solid ${color.border};
    color: ${color.text};
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-size: 14px;
    font-weight: 500;
    max-width: 350px;
    pointer-events: auto;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 10px;
  `;

  toast.innerHTML = `
    <span style="font-size: 18px;">${color.icon}</span>
    <span style="flex: 1;">${message}</span>
    <button onclick="this.parentElement.remove()" style="
      background: none;
      border: none;
      color: ${color.text};
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      opacity: 0.7;
    ">&times;</button>
  `;

  container.appendChild(toast);

  // Animate in
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(0)';
  }, 10);

  // Auto-remove after duration (if not permanent)
  if (duration > 0) {
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
}

/**
 * Convenience methods for specific toast types
 */
export function showErrorToast(message, duration = 5000) {
  showToast(message, 'error', duration);
}

export function showSuccessToast(message, duration = 3000) {
  showToast(message, 'success', duration);
}

export function showInfoToast(message, duration = 3000) {
  showToast(message, 'info', duration);
}

export function showWarningToast(message, duration = 4000) {
  showToast(message, 'warning', duration);
}
</file>

<file path="src/utils/checkbox-helpers.js">
/**
 * checkbox-helpers.js
 * Helper functies voor het werken met checkbox groepen in plaats van multi-select
 */

/**
 * Haalt geselecteerde waarden op uit een checkbox groep
 * @param {string} name - De name attribute van de checkboxes
 * @returns {Array<string>} Array met geselecteerde waarden
 */
export function getCheckboxValues(name) {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

/**
 * Zet checkboxes op basis van een array van waarden
 * @param {string} name - De name attribute van de checkboxes
 * @param {Array<string>} values - Array met te selecteren waarden
 */
export function setCheckboxValues(name, values = []) {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
  checkboxes.forEach(checkbox => {
    checkbox.checked = values.includes(checkbox.value);
  });
}

/**
 * Valideert of er minimaal √©√©n checkbox geselecteerd is
 * @param {string} name - De name attribute van de checkboxes
 * @returns {boolean} True als er minimaal √©√©n checkbox geselecteerd is
 */
export function validateCheckboxGroup(name) {
  const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
  return checked.length > 0;
}

/**
 * Voegt validatie toe aan een checkbox groep
 * @param {string} name - De name attribute van de checkboxes
 * @param {string} errorMessage - Foutmelding die getoond moet worden
 */
export function addCheckboxValidation(name, errorMessage = "Please select at least one option") {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      const isValid = validateCheckboxGroup(name);
      
      // Vind of maak error message element
      const container = checkbox.closest('.mb-4') || checkbox.closest('div');
      let errorElement = container.querySelector('.checkbox-error');
      
      if (!isValid && !errorElement) {
        errorElement = document.createElement('p');
        errorElement.className = 'checkbox-error text-red-500 text-sm mt-1';
        errorElement.textContent = errorMessage;
        container.appendChild(errorElement);
      } else if (isValid && errorElement) {
        errorElement.remove();
      }
    });
  });
}
</file>

<file path="src/utils/store.js">
// Dit is een simpele "global store" om data tussen modules te delen
// (bijv. de ingelogde gebruiker, hun rol, en hun profiel)

// Sla de data op in een privaat object
const state = {
  currentUser: null,     // Het 'auth' object van Firebase
  userRole: null,        // 'artist' of 'programmer'
  currentUserData: null, // Het volledige profiel-object uit Firestore
};

/**
 * Haalt een waarde op uit de global state.
 * @param {string} key - De sleutel (currentUser, userRole, currentUserData)
 * @returns {*} De opgeslagen waarde
 */
export function getStore(key) {
  return state[key];
}

/**
 * Slaat een waarde op in de global state.
 * @param {string} key - De sleutel (currentUser, userRole, currentUserData)
 * @param {*} value - De waarde om op te slaan
 */
export function setStore(key, value) {
  state[key] = value;
}
</file>

<file path="src/utils/translations.js">
/**
 * translations.js
 * Multi-language support for the SpokenWord platform
 */

import { getStore, setStore } from './store.js';

export const translations = {
  nl: {
    // Navigation
    nav_home: 'Home',
    nav_search: 'Zoeken',
    nav_messages: 'Berichten',
    nav_profile: 'Profiel',
    nav_logout: 'Uitloggen',
    nav_login: 'Inloggen',
    nav_signup: 'Aanmelden',
    nav_dashboard: 'Dashboard',

    // Dashboard
    dashboard_welcome: 'Welkom op je Dashboard',
    programmer_dashboard: 'Programmeur Dashboard',
    search_for_artists: 'Zoek naar Artiesten',
    loading_artists: 'Artiesten laden...',
    no_artists_found: 'Geen artiesten gevonden. Klik op \'Zoeken\' om alle artiesten te laden of verfijn je filters.',

    // Filters
    filter_name: 'Naam...',
    filter_location: 'Locatie...',
    filter_all_genders: 'Alle Geslachten',
    filter_female: 'Vrouw',
    filter_male: 'Man',
    filter_other: 'Anders',
    filter_age_range: 'Leeftijdsbereik:',
    filter_age_min: 'Min',
    filter_age_max: 'Max',
    filter_genres: 'Genres:',
    filter_languages: 'Talen:',
    filter_payment_methods: 'Betaalmethoden:',
    search_artists_btn: 'Zoek Artiesten',

    // Genres
    genre_performance_poetry: 'Performance Poetry',
    genre_poetry_slam: 'Poetry Slam',
    genre_jazz_poetry: 'Jazz Poetry',
    genre_rap: 'Rap',
    genre_storytelling: 'Storytelling',
    genre_comedy: 'Comedy',
    genre_one_on_one: '1-op-1 Sessies',

    // Languages
    lang_dutch: 'Nederlands (NL)',
    lang_english: 'Engels (EN)',
    lang_french: 'Frans (FR)',

    // Payment Methods
    payment_invoice: 'Factuur',
    payment_payrolling: 'Payrolling',
    payment_sbk: 'Anders (SBK)',
    payment_volunteer_fee: 'Vrijwilligersvergoeding',
    payment_other: 'Anders',

    // Profile/Settings
    settings_title: 'Bewerk je Profiel',
    settings_subtitle: 'Update je profielinformatie en profielfoto hieronder. Vergeet niet je wijzigingen op te slaan.',
    profile_picture: 'Profielfoto',
    upload_new_photo: 'Upload Nieuwe Foto',
    photo_requirements: 'JPG, PNG of GIF. Max 5MB.',
    first_name: 'Voornaam',
    last_name: 'Achternaam',
    phone: 'Telefoon',
    organization_name: 'Organisatienaam',
    about_organization: 'Over je Organisatie',
    about_organization_placeholder: 'Vertel artiesten over je organisatie en welke evenementen je organiseert...',
    website: 'Website',
    language_preference: 'Taalvoorkeur',
    language_preference_help: 'Kies je voorkeurstaal voor de website-interface',
    save_profile_changes: 'Profiel Wijzigingen Opslaan',

    // Messages
    messages_title: 'Berichten',
    loading_conversations: 'Gesprekken laden...',
    no_conversations: 'Nog geen gesprekken. Stuur een bericht naar een artiest om een gesprek te starten!',
    select_conversation: 'Selecteer een gesprek om te beginnen met berichten',
    send: 'Verzenden',
    send_message: 'Verstuur Bericht',
    type_message: 'Typ je bericht...',
    no_messages_yet: 'Nog geen berichten.',
    message_subject: 'Onderwerp',
    message_text: 'Bericht',

    // Artist Cards
    view_profile: 'Bekijk Profiel',
    location_not_specified: 'Locatie niet opgegeven',
    age_not_specified: 'Leeftijd niet opgegeven',
    years_old: 'jaar oud',
    no_genres: 'Geen genres',

    // Status Messages
    pending_approval: 'Je account wacht op goedkeuring van de beheerder. Je ontvangt een e-mail zodra het is gepubliceerd.',
    trial_account: 'Je hebt momenteel een <strong>7-daagse Gratis Proefperiode</strong>.',
    pro_account: 'Je hebt een <strong>PRO Account</strong>. Geniet van volledige toegang tot de database.',
    upgrade_to_pro: 'Upgrade naar PRO (Binnenkort beschikbaar)',

    // Errors
    error_loading: 'Fout bij laden. Probeer het later opnieuw.',
    auth_required: 'Je moet ingelogd zijn als een programmeur om deze pagina te bekijken.',

    // Recommendations
    recommendations: 'Aanbevelingen',
    write_recommendation: 'Schrijf Aanbeveling',
    write_recommendation_for: 'Schrijf Aanbeveling voor',
    your_recommendation: 'Jouw Aanbeveling',
    recommendation_placeholder: 'Deel je positieve ervaring met deze artiest...',
    recommendation_help: 'Minimaal 10 karakters. Wees specifiek en positief!',
    submit_recommendation: 'Verstuur Aanbeveling',
    submitting: 'Versturen...',
    recommendation_success: '‚úì Aanbeveling succesvol verstuurd!',
    no_recommendations_yet: 'Nog geen aanbevelingen. Wees de eerste om deze artiest aan te bevelen!',
    confirm_delete_recommendation: 'Weet je zeker dat je deze aanbeveling wilt verwijderen?',
    error_only_programmers_recommend: 'Alleen programmeurs kunnen aanbevelingen schrijven.',
    error_recommendation_required: 'Vul alsjeblieft een aanbeveling in.',
    error_recommendation_too_short: 'Aanbeveling moet minimaal 10 karakters bevatten.',
    error_must_be_logged_in: 'Je moet ingelogd zijn om deze actie uit te voeren.',
    cancel: 'Annuleren',

    // User Settings
    user_settings_title: 'Account Instellingen',
    settings_language: 'Taal',
    settings_language_help: 'Kies je voorkeurstaal voor de interface',
    settings_change_email: 'Email Adres Wijzigen',
    settings_change_password: 'Wachtwoord Wijzigen',
    settings_current_password: 'Huidig Wachtwoord',
    settings_new_email: 'Nieuw Email Adres',
    settings_new_password: 'Nieuw Wachtwoord',
    settings_confirm_password: 'Bevestig Nieuw Wachtwoord',
    settings_update_email: 'Email Bijwerken',
    settings_update_password: 'Wachtwoord Bijwerken',
    settings_email_updated: 'Email adres succesvol bijgewerkt! Check je nieuwe inbox voor een verificatie email.',
    settings_password_updated: 'Wachtwoord succesvol bijgewerkt!',
    settings_password_mismatch: 'Wachtwoorden komen niet overeen',
    settings_password_too_short: 'Nieuw wachtwoord moet minimaal 6 karakters bevatten',
    settings_invalid_email: 'Voer een geldig email adres in',
    settings_reauth_required: 'Voor deze wijziging moet je je huidige wachtwoord invoeren',

    // Common
    required: '*',
    loading: 'Laden...',
    error: 'Fout',
    success: 'Succes',
    login_title: 'Inloggen',
    profile: 'Profiel',
    edit_profile: 'Bewerk Profiel',
    upload_document: 'Upload Document (PDF, DOC, DOCX)',
    current_document: 'Huidig document:',
    view: 'Bekijken',
    welcome_dashboard: 'Welkom op je Dashboard',
    edit_your_profile: 'Bewerk je Profiel',
    update_info_below: 'Update je informatie hieronder. Velden gemarkeerd met * zijn verplicht.'
  },
  en: {
    // Navigation
    nav_home: 'Home',
    nav_search: 'Search',
    nav_messages: 'Messages',
    nav_profile: 'Profile',
    nav_logout: 'Logout',
    nav_login: 'Login',
    nav_signup: 'Sign Up',
    nav_dashboard: 'Dashboard',

    // Dashboard
    dashboard_welcome: 'Welcome to your Dashboard',
    programmer_dashboard: 'Programmer Dashboard',
    search_for_artists: 'Search for Artists',
    loading_artists: 'Loading artists...',
    no_artists_found: 'No artists found. Click \'Search\' to load all artists or refine your filters.',

    // Filters
    filter_name: 'Name...',
    filter_location: 'Location...',
    filter_all_genders: 'All Genders',
    filter_female: 'Female',
    filter_male: 'Male',
    filter_other: 'Other',
    filter_age_range: 'Age Range:',
    filter_age_min: 'Min',
    filter_age_max: 'Max',
    filter_genres: 'Genres:',
    filter_languages: 'Languages:',
    filter_payment_methods: 'Payment Methods:',
    search_artists_btn: 'Search Artists',

    // Genres
    genre_performance_poetry: 'Performance Poetry',
    genre_poetry_slam: 'Poetry Slam',
    genre_jazz_poetry: 'Jazz Poetry',
    genre_rap: 'Rap',
    genre_storytelling: 'Storytelling',
    genre_comedy: 'Comedy',
    genre_one_on_one: '1-on-1 Sessions',

    // Languages
    lang_dutch: 'Dutch (NL)',
    lang_english: 'English (EN)',
    lang_french: 'French (FR)',

    // Payment Methods
    payment_invoice: 'Invoice',
    payment_payrolling: 'Payrolling',
    payment_sbk: 'Other (SBK)',
    payment_volunteer_fee: 'Volunteer Fee',
    payment_other: 'Other',

    // Profile/Settings
    settings_title: 'Edit Your Profile',
    settings_subtitle: 'Update your profile information and profile picture below. Remember to save your changes.',
    profile_picture: 'Profile Picture',
    upload_new_photo: 'Upload New Photo',
    photo_requirements: 'JPG, PNG or GIF. Max 5MB.',
    first_name: 'First Name',
    last_name: 'Last Name',
    phone: 'Phone',
    organization_name: 'Organization Name',
    about_organization: 'About Your Organization',
    about_organization_placeholder: 'Tell artists about your organization and what events you organize...',
    website: 'Website',
    language_preference: 'Language Preference',
    language_preference_help: 'Choose your preferred language for the website interface',
    save_profile_changes: 'Save Profile Changes',

    // Messages
    messages_title: 'Messages',
    loading_conversations: 'Loading conversations...',
    no_conversations: 'No conversations yet. Send a message to an artist to start a conversation!',
    select_conversation: 'Select a conversation to start messaging',
    send: 'Send',
    send_message: 'Send Message',
    type_message: 'Type your message...',
    no_messages_yet: 'No messages yet.',
    message_subject: 'Subject',
    message_text: 'Message',

    // Artist Cards
    view_profile: 'View Profile',
    location_not_specified: 'Location not specified',
    age_not_specified: 'Age not specified',
    years_old: 'years old',
    no_genres: 'No genres',

    // Status Messages
    pending_approval: 'Your account is <strong>pending admin approval</strong>. You will be notified by email once it\'s published.',
    trial_account: 'You are currently on your <strong>7-Day Free Trial</strong>.',
    pro_account: 'You have a <strong>PRO Account</strong>. Enjoy full access to the database.',
    upgrade_to_pro: 'Upgrade to PRO (Coming Soon)',

    // Errors
    error_loading: 'Error loading. Please try again later.',
    auth_required: 'You must be logged in as a programmer to access this page.',

    // Recommendations
    recommendations: 'Recommendations',
    write_recommendation: 'Write Recommendation',
    write_recommendation_for: 'Write Recommendation for',
    your_recommendation: 'Your Recommendation',
    recommendation_placeholder: 'Share your positive experience working with this artist...',
    recommendation_help: 'Minimum 10 characters. Be specific and positive!',
    submit_recommendation: 'Submit Recommendation',
    submitting: 'Submitting...',
    recommendation_success: '‚úì Recommendation submitted successfully!',
    no_recommendations_yet: 'No recommendations yet. Be the first to recommend this artist!',
    confirm_delete_recommendation: 'Are you sure you want to delete this recommendation?',
    error_only_programmers_recommend: 'Only programmers can write recommendations.',
    error_recommendation_required: 'Please provide a recommendation.',
    error_recommendation_too_short: 'Recommendation must be at least 10 characters long.',
    error_must_be_logged_in: 'You must be logged in to perform this action.',
    cancel: 'Cancel',

    // User Settings
    user_settings_title: 'Account Settings',
    settings_language: 'Language',
    settings_language_help: 'Choose your preferred language for the interface',
    settings_change_email: 'Change Email Address',
    settings_change_password: 'Change Password',
    settings_current_password: 'Current Password',
    settings_new_email: 'New Email Address',
    settings_new_password: 'New Password',
    settings_confirm_password: 'Confirm New Password',
    settings_update_email: 'Update Email',
    settings_update_password: 'Update Password',
    settings_email_updated: 'Email address successfully updated! Check your new inbox for a verification email.',
    settings_password_updated: 'Password successfully updated!',
    settings_password_mismatch: 'Passwords do not match',
    settings_password_too_short: 'New password must be at least 6 characters',
    settings_invalid_email: 'Please enter a valid email address',
    settings_reauth_required: 'You must enter your current password to make this change',

    // Common
    required: '*',
    loading: 'Loading...',
    error: 'Error',
    success: 'Success',
    login_title: 'Login',
    profile: 'Profile',
    edit_profile: 'Edit Profile',
    upload_document: 'Upload Document (PDF, DOC, DOCX)',
    current_document: 'Current document:',
    view: 'View',
    welcome_dashboard: 'Welcome to your Dashboard',
    edit_your_profile: 'Edit Your Profile',
    update_info_below: 'Update your information below. Fields marked with * are required.'
  }
};

/**
 * Get current language preference
 */
export function getCurrentLanguage() {
  return getStore('language') || 'nl'; // Default to Dutch
}

/**
 * Set language preference
 */
export function setLanguage(lang) {
  if (!translations[lang]) {
    console.warn(`Language '${lang}' not supported, falling back to 'nl'`);
    lang = 'nl';
  }
  setStore('language', lang);
  applyTranslations();
}

/**
 * Get translated string
 */
export function t(key) {
  const lang = getCurrentLanguage();
  return translations[lang][key] || translations['nl'][key] || key;
}

/**
 * Apply translations to all elements with data-i18n attribute
 */
export function applyTranslations() {
  const lang = getCurrentLanguage();
  const elements = document.querySelectorAll('[data-i18n]');

  elements.forEach(element => {
    const key = element.getAttribute('data-i18n');
    const translation = t(key);

    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
      if (element.hasAttribute('placeholder')) {
        element.setAttribute('placeholder', translation);
      } else {
        element.value = translation;
      }
    } else {
      element.innerHTML = translation;
    }
  });

  console.log(`Translations applied for language: ${lang}`);
}

/**
 * Initialize translations on page load
 */
export function initTranslations() {
  // Set default language if not set
  if (!getStore('language')) {
    setStore('language', 'nl'); // Default to Dutch
  }

  // Apply translations
  applyTranslations();
}
</file>

<file path="Development_Notes.md">

</file>

<file path="firestore.rules">
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. Gebruikersprofielen (basisbeveiliging)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. Programmeurs (Data voor dashboards)
    match /programmers/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 3. Artiesten (Profielen voor de zoekfunctie)
    match /artists/{userId} {
      // FIXED: Alleen ingelogde users kunnen artists zien
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 4. Conversations (Chat-functionaliteit)
    match /conversations/{conversationId} {
      // Lezen: alleen als je een participant bent
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participants;
      
      // Aanmaken: alleen als je jezelf toevoegt als participant
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.participants;
      
      // Bijwerken: alleen participants (voor lastMessage updates)
      allow update: if request.auth != null && 
                       request.auth.uid in resource.data.participants;
      
      // Messages subcollectie
      match /messages/{messageId} {
        // Lezen: alleen als je participant bent van de parent conversation
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Aanmaken: alleen als je participant bent EN de sender
        allow create: if request.auth != null && 
                         request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
                         request.auth.uid == request.resource.data.senderId;
      }
    }

    // 5. Aanbevelingen (Recommendations)
    match /recommendations/{recommendationId} {
      // Iedereen die ingelogd is mag aanbevelingen lezen
      allow read: if request.auth != null;

      // Alleen programmers mogen aanbevelingen aanmaken
      allow create: if request.auth != null
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'programmer'
                    && request.resource.data.programmerId == request.auth.uid
                    && request.resource.data.isApproved == true;

      // Alleen de auteur mag zijn aanbeveling verwijderen
      allow delete: if request.auth != null
                    && resource.data.programmerId == request.auth.uid;

      // Bewerken is niet toegestaan
      allow update: if false;
    }

    // 6. Events/Gigs collectie
    match /events/{eventId} {
      // Iedereen die ingelogd is kan events lezen
      allow read: if request.auth != null;

      // Alleen de eigenaar (artiest) kan events aanmaken
      allow create: if request.auth != null
        && request.resource.data.artistId == request.auth.uid;

      // Eigenaar mag alles updaten, anderen alleen attendees
      allow update: if request.auth != null
        && (resource.data.artistId == request.auth.uid
            || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees', 'attendeeCount'])));

      // Alleen eigenaar mag verwijderen
      allow delete: if request.auth != null
        && resource.data.artistId == request.auth.uid;
    }

    // 7. Mail collectie (voor email triggers) - blokkeren
    match /mail/{docId} {
      allow read, write: if false;
    }
    
    // 8. Templates collectie - blokkeren
    match /templates/{docId} {
      allow read, write: if false;
    }

    // Blokkeer alle andere toegang
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
</file>

<file path="MOBILE-UI-IMPROVEMENTS.md">
# Mobile UI Verbeteringen - Implementatie Overzicht

## ‚úÖ Ge√Ømplementeerde Features

### 1. Checkmark Buttons Rechtsboven
Alle mobile filter panels hebben nu een checkmark button rechtsboven:
- **Locatie**: `src/modules/search/search-ui.js:116-172`
- Panels: Genre, Locatie, Naam, Andere filters
- Absolute positionering: `top: 12px, right: 12px`
- Button style: 36x36px cirkel met checkmark (‚úì)

### 2. Nieuwe "Andere filters" Panel
Vervangen met uitgebreide sub-filters structuur:
- **Locatie**: `src/modules/search/search-ui.js:135-172`
- **3 Sub-filter Knoppen**:
  - Leeftijd (Van/Tot inputs)
  - Energy level (Intiem, Interactief, High energy)
  - Keywords (Dynamisch geladen uit database)

### 3. Click Handler Updates
Nieuwe interacties toegevoegd aan `setupSearchInteractionsInternal()`:
- **Locatie**: `src/modules/search/search-ui.js:266-315`
- **Handlers**:
  - Sub-filter toggle (Leeftijd/Energy/Keywords)
  - Energy level selectie
  - Keyword selectie
  - Bestaande handlers blijven werken

### 4. populateKeywords() Functie
Dynamisch laden van keywords uit Firestore:
- **Locatie**: `src/modules/search/search-ui.js:230-258`
- Haalt alle unieke keywords op uit artists collection
- Rendert als klikbare buttons
- Wordt aangeroepen bij renderArtistSearch()

### 5. Filter Logic Updates
`loadArtistsInternal()` verzamelt nu alle nieuwe filters:
- **Locatie**: `src/modules/search/search-ui.js:380-422`
- **Nieuwe filters**:
  - `mobileAgeMin` / `mobileAgeMax` - Leeftijd range
  - `energyFilters` - Array van geselecteerde energy levels
  - `keywordFilters` - Array van geselecteerde keywords

### 6. search-data.js Updates
`loadArtistsData()` ondersteunt nu nieuwe filters:
- **Locatie**: `src/modules/search/search-data.js:161-347`
- **Nieuwe parameters**:
  - `energyFilters` - Filters op artist.energyLevel
  - `keywordFilters` - Filters op artist.keywords (any match)
- **Filter implementatie**:
  - Energy: Exact match op lowercase waarde
  - Keywords: Array intersection check

## üìÅ Aangepaste Bestanden

### src/modules/search/search-ui.js
- ‚úÖ renderMobileLayout() - Panel structuur met checkmark buttons
- ‚úÖ populateKeywords() - Nieuwe functie toegevoegd
- ‚úÖ setupSearchInteractionsInternal() - Click handlers uitgebreid
- ‚úÖ loadArtistsInternal() - Filter collection uitgebreid

### src/modules/search/search-data.js
- ‚úÖ loadArtistsData() - Parameters en filter logic uitgebreid

### seed-energy-keywords.js (nieuw)
- ‚úÖ Script om test data toe te voegen aan artists

## üóÑÔ∏è Database Schema Updates

Nieuwe velden in `artists` collection:

```javascript
{
  // Bestaande velden...

  // Nieuwe velden:
  energyLevel: "intiem" | "interactief" | "high energy",
  keywords: ["maatschappelijk", "liefde", "humor", ...]
}
```

## üß™ Test Data Seeden

### Optie 1: Via Script
```bash
# Update Firebase config in seed-energy-keywords.js eerst
node seed-energy-keywords.js
```

### Optie 2: Handmatig in Firebase Console
1. Ga naar Firestore > `artists` collection
2. Voor elk artist document:
   - Voeg veld toe: `energyLevel` (string)
     - Waarde: "intiem", "interactief", of "high energy"
   - Voeg veld toe: `keywords` (array)
     - Waarde: ["maatschappelijk", "liefde", "humor", ...]

### Voorbeeld Keywords
- maatschappelijk
- liefde
- protest
- humor
- persoonlijk
- politiek
- natuur
- urban
- storytelling
- experimenteel

## ‚úÖ Test Checklist

- [ ] Checkmark staat rechtsboven in alle mobile panels
- [ ] "Andere filters" toont 3 knoppen (Leeftijd, Energy, Keywords)
- [ ] Klik op Leeftijd toont van/tot inputs
- [ ] Klik op Energy level toont 3 opties (intiem, interactief, high energy)
- [ ] Klik op Keywords toont beschikbare keywords uit database
- [ ] Selecteren van energy level highlight button in geel (#fbbf24)
- [ ] Selecteren van keyword highlight button in geel (#fbbf24)
- [ ] Leeftijd filter werkt correct (van/tot inputs)
- [ ] Energy filter werkt correct (alleen artists met geselecteerde energy level)
- [ ] Keyword filter werkt correct (artists met ANY van de geselecteerde keywords)
- [ ] Filters werken correct bij Apply (checkmark button)
- [ ] Alle panels sluiten correct na Apply
- [ ] Filters combineren correct (genre + energy + keywords + leeftijd)

## üîç Belangrijke Implementatie Details

### Filter Flow
1. **User selecteert filters** ‚Üí Click handlers in setupSearchInteractionsInternal()
2. **User klikt Apply** ‚Üí loadArtistsInternal() wordt aangeroepen
3. **Filters worden verzameld** ‚Üí Van DOM elementen (inputs, buttons)
4. **Data wordt opgehaald** ‚Üí loadArtistsData() in search-data.js
5. **Client-side filtering** ‚Üí Energy en keywords filters toegepast
6. **Results worden gerenderd** ‚Üí Grid update met gefilterde artists

### Styling Consistentie
- **Active state**: `background: #fbbf24` (geel)
- **Inactive state**: `background: #f3f4f6` of `#e5e7eb` (grijs)
- **Border radius**: `20px` voor pills, `50%` voor checkmark buttons
- **Spacing**: `gap: 8px` voor button grids
- **Padding**: `padding-right: 50px` om overlap met checkmark te voorkomen

### Performance
- Keywords worden 1x geladen bij render
- Filters worden client-side toegepast (snel, geen extra Firestore queries)
- Debouncing niet nodig voor button clicks (alleen voor text inputs)

## üöÄ Deployment

Na testen:
```bash
npm run build:staging
firebase deploy --only hosting:staging
```

Of voor productie:
```bash
npm run build:prod
firebase deploy --only hosting:production
```

## üìù Notities

- De implementatie gebruikt inline styles voor consistentie met bestaande code
- Alle filter state wordt opgeslagen in DOM (via inline styles, niet in state)
- Mobile-first approach: panels zijn mobile-only, desktop gebruikt sidebar
- Keywords en energy levels zijn dynamisch (geen hardcoded lijsten in UI code)
</file>

<file path="normalize-genres-admin.js">
/**
 * normalize-genres-admin.js
 *
 * One-time script to normalize all genre values in the database using Firebase Admin SDK
 * Converts: "performance poetry", "Performance-Poetry", "PERFORMANCE_POETRY"
 * All to: "Performance Poetry"
 *
 * Usage:
 *   node normalize-genres-admin.js staging
 *   node normalize-genres-admin.js production
 *
 * Requirements:
 *   - Service account key file (see instructions below if not present)
 */

import admin from 'firebase-admin';
import { readFileSync, existsSync } from 'fs';

// Determine which environment to use
const environment = process.argv[2] || 'staging';

// Service account key file paths
const serviceAccountPaths = {
  staging: './serviceAccountKey-staging.json',
  production: './serviceAccountKey-production.json'
};

const serviceAccountPath = serviceAccountPaths[environment];

// Check if service account key exists
if (!existsSync(serviceAccountPath)) {
  console.error(`‚ùå Service account key not found: ${serviceAccountPath}\n`);
  console.log('üìã To download the service account key:\n');
  console.log('1. Go to Firebase Console: https://console.firebase.google.com/');
  console.log(`2. Select project: ${environment === 'production' ? 'dans-dichter-db' : 'ddd-spark'}`);
  console.log('3. Click gear icon ‚öôÔ∏è  ‚Üí Project settings');
  console.log('4. Go to "Service accounts" tab');
  console.log('5. Click "Generate new private key"');
  console.log('6. Save the downloaded JSON file as:', serviceAccountPath);
  console.log('\n7. Run this script again: node normalize-genres-admin.js', environment);
  console.log('\n‚ö†Ô∏è  IMPORTANT: Add the service account key to .gitignore to keep it private!\n');
  process.exit(1);
}

// Load service account key
let serviceAccount;
try {
  serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf-8'));
  console.log(`üìù Loaded service account from: ${serviceAccountPath}`);
  console.log(`üî• Project ID: ${serviceAccount.project_id}\n`);
} catch (error) {
  console.error(`‚ùå Error loading service account key:`, error.message);
  process.exit(1);
}

// Initialize Firebase Admin
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const db = admin.firestore();

function normalizeGenre(genre) {
  return genre
    .trim()
    .toLowerCase()
    .replace(/[-_]+/g, ' ')
    .replace(/\s+/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

async function normalizeAllGenres() {
  try {
    console.log('üîÑ Starting genre normalization...\n');

    const snapshot = await db.collection('artists').get();
    console.log(`üìä Found ${snapshot.size} artist documents\n`);

    let updatedCount = 0;
    let unchangedCount = 0;

    for (const artistDoc of snapshot.docs) {
      const data = artistDoc.data();
      const originalGenres = data.genres || [];

      // Skip if no genres
      if (originalGenres.length === 0) {
        unchangedCount++;
        continue;
      }

      // Normaliseer alle genres en verwijder duplicaten
      const normalizedGenres = [...new Set(
        originalGenres.map(g => normalizeGenre(g))
      )];

      // Check of er iets veranderd is
      const changed = JSON.stringify(originalGenres.sort()) !== JSON.stringify(normalizedGenres.sort());

      if (changed) {
        await artistDoc.ref.update({
          genres: normalizedGenres
        });

        updatedCount++;
        console.log(`‚úÖ Updated ${artistDoc.id} (${data.stageName || data.firstName || 'Unknown'}):`);
        console.log(`   Before: ${originalGenres.join(', ')}`);
        console.log(`   After:  ${normalizedGenres.join(', ')}\n`);
      } else {
        unchangedCount++;
      }
    }

    console.log('\n‚ú® Genre normalization complete!');
    console.log(`   Updated: ${updatedCount} artists`);
    console.log(`   Unchanged: ${unchangedCount} artists`);
    console.log(`   Total: ${snapshot.size} artists`);

  } catch (error) {
    console.error('‚ùå Error normalizing genres:', error);
    throw error;
  }
}

// Run the normalization
normalizeAllGenres()
  .then(() => {
    console.log('\n‚úÖ Script completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\n‚ùå Script failed:', error);
    process.exit(1);
  });
</file>

<file path="normalize-genres-auto.sh">
#!/bin/bash

# normalize-genres-auto.sh
# Automated script to normalize genres with temporary Firestore rules
#
# This script will:
# 1. Backup current Firestore rules
# 2. Deploy temporary rules that allow the normalization
# 3. Run the normalization script
# 4. Restore original rules
#
# Usage:
#   ./normalize-genres-auto.sh          # Uses current Firebase project
#   ./normalize-genres-auto.sh staging  # Uses staging (ddd-spark)
#   ./normalize-genres-auto.sh production # Uses production (dans-dichter-db)

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Determine environment
if [ -n "$1" ]; then
  if [ "$1" = "production" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Switching to PRODUCTION${NC}"
    firebase use dans-dichter-db
  elif [ "$1" = "staging" ]; then
    echo -e "${BLUE}üìù Switching to STAGING${NC}"
    firebase use ddd-spark
  else
    echo -e "${RED}‚ùå Invalid environment: $1${NC}"
    echo "   Use: staging or production"
    exit 1
  fi
fi

# Get current project
CURRENT_PROJECT=$(firebase use | grep "Active Project:" | awk '{print $3}')
echo -e "${BLUE}üî• Current Firebase project: $CURRENT_PROJECT${NC}\n"

# Confirm if production
if [ "$CURRENT_PROJECT" = "dans-dichter-db" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING: You are about to modify PRODUCTION database${NC}"
  read -p "Are you sure you want to continue? (yes/NO): " -r
  if [ "$REPLY" != "yes" ]; then
    echo "Aborted."
    exit 0
  fi
fi

# Step 1: Backup current rules
echo -e "${BLUE}üì¶ Step 1: Backing up current Firestore rules...${NC}"
cp firestore.rules firestore.rules.backup
echo -e "${GREEN}‚úÖ Backup created: firestore.rules.backup${NC}\n"

# Step 2: Create temporary rules
echo -e "${BLUE}üìù Step 2: Creating temporary Firestore rules...${NC}"
cat > firestore.rules.temp << 'EOF'
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // TEMPORARY: Allow all access for genre normalization script
    // This file should NEVER be committed or left deployed
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
EOF

echo -e "${YELLOW}‚ö†Ô∏è  Temporary rules created (allows all access)${NC}\n"

# Step 3: Deploy temporary rules
echo -e "${BLUE}üöÄ Step 3: Deploying temporary Firestore rules...${NC}"
cp firestore.rules.temp firestore.rules
firebase deploy --only firestore:rules

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå Failed to deploy temporary rules${NC}"
  echo -e "${BLUE}üì¶ Restoring original rules...${NC}"
  cp firestore.rules.backup firestore.rules
  rm -f firestore.rules.temp
  exit 1
fi

echo -e "${GREEN}‚úÖ Temporary rules deployed${NC}\n"

# Step 4: Run normalization script
echo -e "${BLUE}üîÑ Step 4: Running genre normalization...${NC}\n"
sleep 2  # Wait for rules to propagate

node normalize-genres-cli.js

NORMALIZATION_EXIT_CODE=$?

# Step 5: Restore original rules (even if normalization failed)
echo -e "\n${BLUE}üì¶ Step 5: Restoring original Firestore rules...${NC}"
cp firestore.rules.backup firestore.rules
firebase deploy --only firestore:rules

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå CRITICAL: Failed to restore original rules!${NC}"
  echo -e "${YELLOW}‚ö†Ô∏è  Manual intervention required:${NC}"
  echo -e "   1. The backup is in: firestore.rules.backup"
  echo -e "   2. Copy it back: cp firestore.rules.backup firestore.rules"
  echo -e "   3. Deploy: firebase deploy --only firestore:rules"
  exit 1
fi

echo -e "${GREEN}‚úÖ Original rules restored${NC}\n"

# Step 6: Cleanup
echo -e "${BLUE}üßπ Step 6: Cleaning up temporary files...${NC}"
rm -f firestore.rules.temp
echo -e "${GREEN}‚úÖ Cleanup complete${NC}\n"

# Final status
if [ $NORMALIZATION_EXIT_CODE -eq 0 ]; then
  echo -e "${GREEN}‚ú® Genre normalization completed successfully!${NC}"
  echo -e "${GREEN}‚úÖ Original security rules are restored${NC}"
  exit 0
else
  echo -e "${YELLOW}‚ö†Ô∏è  Genre normalization had errors (see above)${NC}"
  echo -e "${GREEN}‚úÖ Original security rules are restored${NC}"
  exit $NORMALIZATION_EXIT_CODE
fi
</file>

<file path="normalize-genres-cli.js">
/**
 * normalize-genres-cli.js
 *
 * One-time script to normalize all genre values in the database
 * Uses Firebase CLI authentication (no service account key needed)
 *
 * Usage:
 *   firebase use staging && node normalize-genres-cli.js
 *   firebase use production && node normalize-genres-cli.js
 *
 * Make sure you're logged in: firebase login
 */

import { execSync } from 'child_process';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, doc, updateDoc } from 'firebase/firestore';
import { getAuth, signInWithCustomToken } from 'firebase/auth';
import { readFileSync } from 'fs';

// Get current Firebase project from CLI
let currentProject;
try {
  const result = execSync('firebase use', { encoding: 'utf-8' });
  const match = result.match(/Active Project: (.+?) \(/);
  if (match) {
    currentProject = match[1];
  } else {
    throw new Error('Could not determine current project');
  }
} catch (error) {
  console.error('‚ùå Error: Could not get current Firebase project');
  console.error('   Make sure you run: firebase use <project-name>');
  console.error('   Available: staging (ddd-spark) or production (dans-dichter-db)');
  process.exit(1);
}

console.log(`üìù Current Firebase project: ${currentProject}\n`);

// Load environment config based on project
const envFile = currentProject === 'dans-dichter-db' ? '.env.production' : '.env.staging';
console.log(`üìù Loading environment from: ${envFile}\n`);

// Load environment variables
const envConfig = {};
try {
  const envContent = readFileSync(envFile, 'utf-8');
  envContent.split('\n').forEach(line => {
    const [key, ...valueParts] = line.split('=');
    if (key && valueParts.length > 0) {
      const value = valueParts.join('=').trim();
      envConfig[key.trim()] = value;
    }
  });
} catch (error) {
  console.error(`‚ùå Error loading ${envFile}:`, error.message);
  process.exit(1);
}

// Initialize Firebase with config
const firebaseConfig = {
  apiKey: envConfig.VITE_FIREBASE_API_KEY,
  authDomain: envConfig.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: envConfig.VITE_FIREBASE_PROJECT_ID,
  storageBucket: envConfig.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: envConfig.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: envConfig.VITE_FIREBASE_APP_ID
};

console.log(`üî• Connecting to Firebase project: ${firebaseConfig.projectId}\n`);

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function normalizeGenre(genre) {
  return genre
    .trim()
    .toLowerCase()
    .replace(/[-_]+/g, ' ')
    .replace(/\s+/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

async function normalizeAllGenres() {
  try {
    console.log('üîÑ Starting genre normalization...');
    console.log('‚ö†Ô∏è  Note: This requires appropriate Firestore permissions\n');

    const snapshot = await getDocs(collection(db, 'artists'));
    console.log(`üìä Found ${snapshot.size} artist documents\n`);

    let updatedCount = 0;
    let unchangedCount = 0;
    let errorCount = 0;

    for (const artistDoc of snapshot.docs) {
      const data = artistDoc.data();
      const originalGenres = data.genres || [];

      // Skip if no genres
      if (originalGenres.length === 0) {
        unchangedCount++;
        continue;
      }

      // Normaliseer alle genres en verwijder duplicaten
      const normalizedGenres = [...new Set(
        originalGenres.map(g => normalizeGenre(g))
      )];

      // Check of er iets veranderd is
      const changed = JSON.stringify(originalGenres.sort()) !== JSON.stringify(normalizedGenres.sort());

      if (changed) {
        try {
          await updateDoc(doc(db, 'artists', artistDoc.id), {
            genres: normalizedGenres
          });

          updatedCount++;
          console.log(`‚úÖ Updated ${artistDoc.id} (${data.stageName || data.firstName || 'Unknown'}):`);
          console.log(`   Before: ${originalGenres.join(', ')}`);
          console.log(`   After:  ${normalizedGenres.join(', ')}\n`);
        } catch (updateError) {
          errorCount++;
          console.error(`‚ùå Failed to update ${artistDoc.id}:`, updateError.message);
        }
      } else {
        unchangedCount++;
      }
    }

    console.log('\n‚ú® Genre normalization complete!');
    console.log(`   Updated: ${updatedCount} artists`);
    console.log(`   Unchanged: ${unchangedCount} artists`);
    if (errorCount > 0) {
      console.log(`   Errors: ${errorCount} artists`);
    }
    console.log(`   Total: ${snapshot.size} artists`);

  } catch (error) {
    console.error('‚ùå Error normalizing genres:', error);

    if (error.code === 'permission-denied') {
      console.error('\nüîí Permission denied. Options:');
      console.error('   1. Use the Admin SDK version: node normalize-genres-admin.js');
      console.error('   2. Temporarily adjust Firestore security rules');
      console.error('   3. Make sure you have the right permissions in Firebase Console');
    }

    throw error;
  }
}

// Run the normalization
normalizeAllGenres()
  .then(() => {
    console.log('\n‚úÖ Script completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\n‚ùå Script failed:', error.message);
    process.exit(1);
  });
</file>

<file path="package.json">
{
  "name": "spoken-word-database",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:staging": "node scripts/validate-env.cjs staging && vite build --mode staging",
    "build:prod": "node scripts/validate-env.cjs production && vite build --mode production",
    "preview": "vite preview",
    "deploy": "npm run build && node deploy.js",
    
    "// --- NIEUWE VEILIGHEIDS SCRIPTS ---": "",
    "check:staging": "if grep -q 'VITE_APP_ENV=staging' .env.staging; then echo '‚úÖ Environment is Staging'; else echo '‚ùå FOUT: Verkeerde env file!'; exit 1; fi",
    "check:prod": "if grep -q 'VITE_APP_ENV=production' .env.production; then echo '‚úÖ Environment is Production'; else echo '‚ùå FOUT: Verkeerde env file!'; exit 1; fi",
    
    "// --- AUTOMATED DEPLOYMENT (Bespaart AI Tokens) ---": "",
    "release:staging": "npm run check:staging && npm run build:staging && firebase deploy --only hosting --project ddd-spark",
    "release:prod": "npm run check:prod && npm run build:prod && firebase deploy --only hosting --project dans-dichter-db"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.19",
    "ftp": "^0.3.10",
    "ftp-deploy": "^2.4.7",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "vite": "^5.0.0"
  },
  "dependencies": {
    "firebase": "^10.7.0",
    "firebase-admin": "^13.5.0"
  }
}
</file>

<file path="REFACTOR_SUMMARY.md">
# Dashboard Modularization & Apple Styling - Refactor Summary

## üìÖ Date: 2025-12-23
## üéØ Objective: Dashboard Modularisatie & Apple Styling

---

## ‚úÖ COMPLETED TASKS

### 1. **Dashboard Refactor (src/modules/dashboard/)**
The Artist Dashboard has been successfully refactored into a clean, modular architecture:

#### **New Modular Structure:**
```
src/modules/dashboard/
‚îú‚îÄ‚îÄ dashboard-service.js   - Data operations (Firestore queries, profile updates)
‚îú‚îÄ‚îÄ dashboard-ui.js        - Apple-style UI rendering (clean, minimal widgets)
‚îî‚îÄ‚îÄ dashboard-controller.js - Event handling & initialization
```

#### **Key Features:**
- ‚úÖ **Apple-esque Design**: White cards, rounded-2xl corners, subtle shadows
- ‚úÖ **Clean Separation**: Service layer, UI layer, Controller layer
- ‚úÖ **Event Delegation**: Robust event handling that works with dynamic content
- ‚úÖ **Premium Styling**: `bg-white`, `p-6`, `rounded-2xl`, `border border-gray-100`

#### **Old Files Removed:**
- ‚ùå `artist-dashboard.js` (deleted - refactored into modular structure)

---

### 2. **Programmer Dashboard - Apple Styling Update**
The Programmer Dashboard received a complete visual overhaul:

#### **Before ‚Üí After:**
- ‚ùå `rounded-lg shadow-xl` ‚Üí ‚úÖ `rounded-2xl shadow-sm border border-gray-100`
- ‚ùå Standard borders ‚Üí ‚úÖ Subtle `border-gray-100` accents
- ‚ùå Heavy shadows ‚Üí ‚úÖ Light `shadow-sm` for depth
- ‚ùå Sharp corners ‚Üí ‚úÖ `rounded-2xl` for premium feel

#### **Updated Components:**
- ‚úÖ Profile Overview Card - Apple styling
- ‚úÖ Public Profile Preview - Refined borders & rounded corners
- ‚úÖ Pending Account View - Yellow accent card with icon
- ‚úÖ Version badge updated to "v2.1 (Modular Dashboard)"

---

### 3. **Programmer Profile Editor - Apple Styling**
Complete redesign of the profile editing form:

#### **Visual Improvements:**
- ‚úÖ **Form Inputs**: `bg-gray-50`, `border-0`, `rounded-xl`, `focus:ring-2`
- ‚úÖ **Section Headers**: Bold, tracking-tight typography
- ‚úÖ **Upload Buttons**: Premium `bg-gray-900` with `rounded-xl`
- ‚úÖ **Submit Button**: Full-width, bold, `rounded-xl` with shadow
- ‚úÖ **Cancel Button**: Subtle gray with hover effect

#### **UX Enhancements:**
- ‚úÖ Cancel button functionality added
- ‚úÖ Better spacing with `space-y-8`
- ‚úÖ Subtle borders with `border-gray-100`
- ‚úÖ Consistent with Artist Dashboard styling

---

### 4. **Trial/Proefperiode Messages - Cleanup**
All "Trial" and "Proefperiode" messages have been removed from dashboard code:

#### **Scanned Files:**
- ‚úÖ `src/modules/dashboard/*` - No trial messages found
- ‚úÖ `programmer-dashboard.js` - No trial messages found
- ‚úÖ `ui.js` - No trial messages found

#### **Preserved (Intentional):**
- ‚ö†Ô∏è Search UI trial message (for access control - user wants to keep)
- ‚ö†Ô∏è Messaging badges (status indicators - functional requirement)
- ‚ö†Ô∏è Backend trial logic (Firebase functions - not dashboard code)

---

## üìÅ MODULAR ARCHITECTURE

### **Complete Module Structure:**
```
src/modules/
‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ dashboard-controller.js  - Event handling
‚îÇ   ‚îú‚îÄ‚îÄ dashboard-service.js     - Data operations
‚îÇ   ‚îî‚îÄ‚îÄ dashboard-ui.js          - Apple-style rendering
‚îú‚îÄ‚îÄ messaging/
‚îÇ   ‚îú‚îÄ‚îÄ messaging-controller.js  - Event handling
‚îÇ   ‚îú‚îÄ‚îÄ messaging-service.js     - Data operations
‚îÇ   ‚îî‚îÄ‚îÄ messaging-ui.js          - UI rendering
‚îî‚îÄ‚îÄ search/
    ‚îú‚îÄ‚îÄ search-controller.js     - Event handling
    ‚îú‚îÄ‚îÄ search-data.js           - Data operations
    ‚îî‚îÄ‚îÄ search-ui.js             - Apple-style rendering
```

---

## üé® VISUAL CONSISTENCY

### **Apple Design Language Applied:**
1. **Cards**: `bg-white p-8 rounded-2xl shadow-sm border border-gray-100`
2. **Inputs**: `bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-500`
3. **Buttons**: `rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-sm`
4. **Typography**: Bold headings with `tracking-tight`, subtle labels with `text-xs font-semibold text-gray-500`
5. **Spacing**: Generous whitespace with `space-y-8`, `gap-6`, `p-8`

---

## üîß TECHNICAL IMPROVEMENTS

### **Event Delegation:**
- ‚úÖ Global event delegation on `document.body` for dynamically rendered elements
- ‚úÖ Robust click handlers that work across view changes
- ‚úÖ No more "broken" buttons after re-renders

### **Code Organization:**
- ‚úÖ Separation of concerns (Service, UI, Controller)
- ‚úÖ Reusable helper functions
- ‚úÖ Clean imports and exports
- ‚úÖ Consistent naming conventions

### **Performance:**
- ‚úÖ Dynamic imports where appropriate
- ‚úÖ Efficient event delegation (fewer listeners)
- ‚úÖ Optimized re-renders

---

## üöÄ BUILD VERIFICATION

### **Build Status:**
```bash
‚úì Built successfully in 3.86s
‚úì No critical errors
‚úì All modules loaded correctly
‚ö†Ô∏è Minor warnings about dynamic imports (expected behavior)
```

---

## üì¶ FILES MODIFIED

### **Modified:**
- `ui.js` - Updated dashboard integration
- `main.js` - Updated imports for modular dashboard
- `programmer-dashboard.js` - Apple styling update
- `programmer-profile.js` - Apple styling & cancel button

### **Created:**
- `src/modules/dashboard/dashboard-service.js`
- `src/modules/dashboard/dashboard-ui.js`
- `src/modules/dashboard/dashboard-controller.js`

### **Deleted:**
- `artist-dashboard.js` (refactored into modules)
- `artist-search.js` (refactored into modules)
- `artist-dashboard.js.backup` (cleanup)

---

## üéØ NEXT STEPS (Future Considerations)

### **Potential Enhancements:**
1. **Programmer Dashboard Modularization**: Consider moving `programmer-dashboard.js` into `src/modules/dashboard/programmer/`
2. **Profile Module**: Extract profile editing into `src/modules/profile/`
3. **Shared UI Components**: Create `src/components/` for reusable UI elements
4. **TypeScript Migration**: Add type safety for better developer experience

---

## üìù NOTES

- All dashboard code now follows the Apple design language
- No "Trial" or "Proefperiode" messages in dashboard code
- Event delegation ensures robust UI interactions
- Modular architecture makes future maintenance easier
- Build passes with no critical errors

---

## ‚ú® SUMMARY

**The dashboard refactor is complete!** We've achieved:
1. ‚úÖ Clean modular architecture for Artist Dashboard
2. ‚úÖ Premium Apple-style UI across all dashboards
3. ‚úÖ Robust event handling with delegation
4. ‚úÖ Removed trial messages from dashboard code
5. ‚úÖ Consistent visual language across the app

**The codebase is now more maintainable, scalable, and visually cohesive.**

---

**Refactor completed by:** Claude Sonnet 4.5
**Date:** 2025-12-23
**Version:** Staging v2.1 (Modular Dashboard)
</file>

<file path="run-once-normalize-genres.js">
/**
 * run-once-normalize-genres.js
 *
 * One-time script to normalize all genre values in the database
 * Converts: "performance poetry", "Performance-Poetry", "PERFORMANCE_POETRY"
 * All to: "Performance Poetry"
 *
 * Usage:
 *   node run-once-normalize-genres.js           (uses staging by default)
 *   node run-once-normalize-genres.js staging   (uses .env.staging)
 *   node run-once-normalize-genres.js production (uses .env.production)
 */

import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, updateDoc, doc } from 'firebase/firestore';
import { readFileSync } from 'fs';

// Determine which environment to use
const environment = process.argv[2] || 'staging';
const envFile = environment === 'production' ? '.env.production' : '.env.staging';

console.log(`üìù Loading environment from: ${envFile}\n`);

// Load environment variables from the specified file
const envConfig = {};
try {
  const envContent = readFileSync(envFile, 'utf-8');
  envContent.split('\n').forEach(line => {
    const [key, ...valueParts] = line.split('=');
    if (key && valueParts.length > 0) {
      const value = valueParts.join('=').trim();
      envConfig[key.trim()] = value;
    }
  });
} catch (error) {
  console.error(`‚ùå Error loading ${envFile}:`, error.message);
  process.exit(1);
}

// Initialize Firebase with the loaded config
const firebaseConfig = {
  apiKey: envConfig.VITE_FIREBASE_API_KEY,
  authDomain: envConfig.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: envConfig.VITE_FIREBASE_PROJECT_ID,
  storageBucket: envConfig.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: envConfig.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: envConfig.VITE_FIREBASE_APP_ID
};

console.log(`üî• Connecting to Firebase project: ${firebaseConfig.projectId}\n`);

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function normalizeGenre(genre) {
  return genre
    .trim()
    .toLowerCase()
    .replace(/[-_]+/g, ' ')
    .replace(/\s+/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

async function normalizeAllGenres() {
  try {
    console.log('üîÑ Starting genre normalization...\n');

    const snapshot = await getDocs(collection(db, 'artists'));
    console.log(`üìä Found ${snapshot.size} artist documents\n`);

    let updatedCount = 0;
    let unchangedCount = 0;

    for (const artistDoc of snapshot.docs) {
      const data = artistDoc.data();
      const originalGenres = data.genres || [];

      // Normaliseer alle genres en verwijder duplicaten
      const normalizedGenres = [...new Set(
        originalGenres.map(g => normalizeGenre(g))
      )];

      // Check of er iets veranderd is
      const changed = JSON.stringify(originalGenres.sort()) !== JSON.stringify(normalizedGenres.sort());

      if (changed) {
        await updateDoc(doc(db, 'artists', artistDoc.id), {
          genres: normalizedGenres
        });

        updatedCount++;
        console.log(`‚úÖ Updated ${artistDoc.id} (${data.stageName || data.firstName || 'Unknown'}):`);
        console.log(`   Before: ${originalGenres.join(', ')}`);
        console.log(`   After:  ${normalizedGenres.join(', ')}\n`);
      } else {
        unchangedCount++;
      }
    }

    console.log('\n‚ú® Genre normalization complete!');
    console.log(`   Updated: ${updatedCount} artists`);
    console.log(`   Unchanged: ${unchangedCount} artists`);
    console.log(`   Total: ${snapshot.size} artists`);

  } catch (error) {
    console.error('‚ùå Error normalizing genres:', error);
    throw error;
  }
}

// Run the normalization
normalizeAllGenres()
  .then(() => {
    console.log('\n‚úÖ Script completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\n‚ùå Script failed:', error);
    process.exit(1);
  });
</file>

<file path="seed-energy-keywords.js">
/**
 * Seed script to add energyLevel and keywords to existing artists
 *
 * Usage:
 * 1. Ensure Firebase is configured in your environment
 * 2. Run: node seed-energy-keywords.js
 *
 * Or run directly in Firebase Console:
 * - Go to Firestore > artists collection
 * - Add these fields manually to each document:
 *   - energyLevel: "intiem" | "interactief" | "high energy"
 *   - keywords: ["maatschappelijk", "liefde", "humor", ...]
 */

import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, updateDoc, doc } from 'firebase/firestore';

// Firebase config - Replace with your actual config or import from firebase.js
const firebaseConfig = {
  // Add your Firebase config here
  // Or import from: import { db } from './src/services/firebase.js';
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Test data options
const energyLevels = ['intiem', 'interactief', 'high energy'];
const keywordOptions = [
  'maatschappelijk',
  'liefde',
  'protest',
  'humor',
  'persoonlijk',
  'politiek',
  'natuur',
  'urban',
  'storytelling',
  'experimenteel'
];

/**
 * Get random item from array
 */
function getRandomItem(array) {
  return array[Math.floor(Math.random() * array.length)];
}

/**
 * Get random subset of array
 */
function getRandomSubset(array, minCount = 1, maxCount = 4) {
  const count = Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount;
  const shuffled = [...array].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

/**
 * Seed artist data with energyLevel and keywords
 */
async function seedArtistData() {
  try {
    console.log('üå± Starting seed process...');

    const snapshot = await getDocs(collection(db, 'artists'));
    console.log(`üìä Found ${snapshot.size} artists to update`);

    let updateCount = 0;

    for (const artistDoc of snapshot.docs) {
      const artistData = artistDoc.data();

      // Skip if already has energyLevel and keywords
      if (artistData.energyLevel && artistData.keywords) {
        console.log(`‚è≠Ô∏è  Skipping ${artistDoc.id} - already has data`);
        continue;
      }

      // Generate random data
      const randomEnergy = getRandomItem(energyLevels);
      const randomKeywords = getRandomSubset(keywordOptions, 1, 4);

      // Update document
      await updateDoc(doc(db, 'artists', artistDoc.id), {
        energyLevel: randomEnergy,
        keywords: randomKeywords
      });

      updateCount++;
      console.log(`‚úÖ Updated ${artistDoc.id}:`);
      console.log(`   - Energy: ${randomEnergy}`);
      console.log(`   - Keywords: [${randomKeywords.join(', ')}]`);
    }

    console.log(`\nüéâ Done! Updated ${updateCount} artists`);

  } catch (error) {
    console.error('‚ùå Error seeding data:', error);
    throw error;
  }
}

// Run the seed function
seedArtistData()
  .then(() => {
    console.log('‚ú® Seed completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('üí• Seed failed:', error);
    process.exit(1);
  });
</file>

<file path="setup-service-account.sh">
#!/bin/bash

# setup-service-account.sh
# Helper script to guide through service account key setup

ENV=${1:-staging}

if [ "$ENV" = "production" ]; then
  PROJECT_ID="dans-dichter-db"
  KEY_FILE="serviceAccountKey-production.json"
else
  PROJECT_ID="ddd-spark"
  KEY_FILE="serviceAccountKey-staging.json"
fi

echo "üîë Setting up service account key for $ENV environment"
echo "   Project: $PROJECT_ID"
echo ""

# Check if key already exists
if [ -f "$KEY_FILE" ]; then
  echo "‚úÖ Service account key already exists: $KEY_FILE"
  echo ""
  read -p "Do you want to replace it? (y/N): " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Keeping existing key. Exiting."
    exit 0
  fi
fi

echo "üìã Instructions:"
echo ""
echo "1. Opening Firebase Console in your browser..."
echo "2. Go to: Project Settings ‚Üí Service Accounts"
echo "3. Click 'Generate new private key'"
echo "4. Save the downloaded file as: $KEY_FILE"
echo ""

# Open Firebase Console in browser
URL="https://console.firebase.google.com/project/$PROJECT_ID/settings/serviceaccounts/adminsdk"
if command -v open &> /dev/null; then
  open "$URL"
elif command -v xdg-open &> /dev/null; then
  xdg-open "$URL"
else
  echo "Open this URL manually: $URL"
fi

echo ""
echo "‚è≥ Waiting for you to download and save the file..."
echo "   Expected location: $(pwd)/$KEY_FILE"
echo ""
read -p "Press Enter when you've saved the file as $KEY_FILE..."

# Verify the file exists
if [ -f "$KEY_FILE" ]; then
  echo ""
  echo "‚úÖ Service account key found!"
  echo "üîí Verifying the key is valid JSON..."

  if command -v jq &> /dev/null; then
    PROJECT_FROM_KEY=$(jq -r '.project_id' "$KEY_FILE")
    if [ "$PROJECT_FROM_KEY" = "$PROJECT_ID" ]; then
      echo "‚úÖ Key is valid and matches project: $PROJECT_ID"
    else
      echo "‚ö†Ô∏è  Warning: Key project_id ($PROJECT_FROM_KEY) doesn't match expected ($PROJECT_ID)"
    fi
  else
    # Basic JSON validation without jq
    if grep -q '"project_id"' "$KEY_FILE"; then
      echo "‚úÖ Key appears to be valid"
    else
      echo "‚ùå Error: File doesn't appear to be a valid service account key"
      exit 1
    fi
  fi

  echo ""
  echo "‚ú® Setup complete! You can now run:"
  echo "   node normalize-genres-admin.js $ENV"
  echo ""
else
  echo ""
  echo "‚ùå Error: File not found: $KEY_FILE"
  echo "   Please save the downloaded key with this exact filename"
  exit 1
fi
</file>

<file path="src/modules/dashboard/dashboard-controller.js">
/**
 * dashboard-controller.js
 * Event handling and initialization for artist dashboard
 * Uses robust event delegation for dynamic content
 */

import { getStore, setStore } from '../../utils/store.js';
import { updateArtistProfile } from './dashboard-service.js';
import {
  renderArtistDashboard,
  renderProfileEditor,
  displayProfileOverview,
  populateProfileEditor,
  getCheckboxValues
} from './dashboard-ui.js';
import { loadRecommendations } from '../recommendations/recommendations.js';

/**
 * Setup artist dashboard
 * Main entry point called from ui.js
 */
export function setupArtistDashboard() {
  console.log("[DASHBOARD] Setting up artist dashboard...");

  // Render the dashboard HTML
  renderArtistDashboard();

  // Display profile overview
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    displayProfileOverview(currentUserData);
  }

  // Setup event listeners with delegation
  setupEventListeners();

  // Load recommendations
  loadArtistRecommendations();

  console.log("[DASHBOARD] ‚úÖ Artist dashboard setup complete");
}

/**
 * Setup all event listeners using delegation
 * Robust approach that works even when DOM is re-rendered
 */
function setupEventListeners() {
  const dashboard = document.getElementById('artist-dashboard');

  if (!dashboard) {
    console.warn("[DASHBOARD] Dashboard container not found");
    return;
  }

  // Check if listeners already attached
  if (dashboard.dataset.listenersAttached === 'true') {
    console.log("[DASHBOARD] Event listeners already attached, skipping");
    return;
  }

  // Event delegation on dashboard container
  dashboard.addEventListener('click', handleDashboardClick);

  // Mark as attached
  dashboard.dataset.listenersAttached = 'true';

  console.log("[DASHBOARD] Event listeners attached via delegation");
}

/**
 * Handle all clicks on dashboard using event delegation
 */
function handleDashboardClick(e) {
  // Edit Profile Button
  if (e.target.closest('#edit-artist-profile-btn')) {
    e.preventDefault();
    showProfileEditor();
    return;
  }

  // Cancel Edit Button
  if (e.target.closest('#cancel-edit-profile-btn')) {
    e.preventDefault();
    hideProfileEditor();
    return;
  }

  // Profile Picture Upload
  if (e.target.id === 'artist-edit-profile-pic') {
    setupProfilePicPreview();
    return;
  }

  // Document Upload
  if (e.target.id === 'artist-edit-document') {
    setupDocumentInput();
    return;
  }

  // Profile Form Submit (handled separately via form event)
  const form = e.target.closest('#artist-profile-form');
  if (form && e.target.type === 'submit') {
    // Let the form submit event handle this
    return;
  }
}

/**
 * Show profile editor
 */
function showProfileEditor() {
  console.log("[DASHBOARD] Showing profile editor");

  const editor = document.getElementById('artist-profile-editor');
  const overview = document.getElementById('artist-profile-overview');

  if (!editor || !overview) {
    console.warn("[DASHBOARD] Editor or overview not found");
    return;
  }

  // Render the editor HTML
  renderProfileEditor();

  // Show editor, hide overview
  editor.classList.remove('hidden');
  overview.classList.add('hidden');

  // Populate with current data
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    populateProfileEditor(currentUserData);
  }

  // Setup form submission handler
  const form = document.getElementById('artist-profile-form');
  if (form) {
    form.addEventListener('submit', handleProfileSubmit);
  }

  // Setup file input handlers
  setupProfilePicPreview();
  setupDocumentInput();

  // Setup media gallery
  import('../artist/artist-media.js').then(module => {
    if (module.initArtistMediaGallery) {
      module.initArtistMediaGallery();
    }
  }).catch(err => {
    console.warn('[DASHBOARD] Media gallery module not loaded:', err);
  });

  // Re-initialize Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * Hide profile editor and show overview
 */
function hideProfileEditor() {
  console.log("[DASHBOARD] Hiding profile editor");

  const editor = document.getElementById('artist-profile-editor');
  const overview = document.getElementById('artist-profile-overview');

  if (!editor || !overview) {
    console.warn("[DASHBOARD] Editor or overview not found");
    return;
  }

  // Hide editor, show overview
  editor.classList.add('hidden');
  overview.classList.remove('hidden');

  // Refresh overview data
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    displayProfileOverview(currentUserData);
  }
}

/**
 * Setup profile picture preview
 */
function setupProfilePicPreview() {
  const fileInput = document.getElementById('artist-edit-profile-pic');
  const previewImg = document.getElementById('artist-profile-pic-preview');

  if (!fileInput || !previewImg) return;

  // Remove existing listener if any
  const newFileInput = fileInput.cloneNode(true);
  fileInput.parentNode.replaceChild(newFileInput, fileInput);

  newFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        newFileInput.value = '';
        return;
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        newFileInput.value = '';
        return;
      }

      // Show preview
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

/**
 * Setup document input
 */
function setupDocumentInput() {
  const fileInput = document.getElementById('artist-edit-document');
  const filenameSpan = document.getElementById('artist-document-filename');

  if (!fileInput || !filenameSpan) return;

  // Remove existing listener if any
  const newFileInput = fileInput.cloneNode(true);
  fileInput.parentNode.replaceChild(newFileInput, fileInput);

  newFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        newFileInput.value = '';
        filenameSpan.textContent = 'No file chosen';
        return;
      }

      // Validate file type
      const validTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      ];

      if (!validTypes.includes(file.type)) {
        alert('Please select a PDF, DOC, or DOCX file');
        newFileInput.value = '';
        filenameSpan.textContent = 'No file chosen';
        return;
      }

      filenameSpan.textContent = file.name;
    } else {
      filenameSpan.textContent = 'No file chosen';
    }
  });
}

/**
 * Handle profile form submission
 */
async function handleProfileSubmit(e) {
  e.preventDefault();

  const successMsg = document.getElementById('artist-profile-success');
  const errorMsg = document.getElementById('artist-profile-error');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

  // Reset messages
  successMsg.textContent = '';
  errorMsg.textContent = '';

  // Disable button
  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }

    const uid = currentUser.uid;

    // Collect checkbox values
    const genres = getCheckboxValues('artist-edit-genres');
    const languages = getCheckboxValues('artist-edit-languages');
    const paymentMethods = getCheckboxValues('artist-edit-payment');

    // Validate checkbox groups
    if (genres.length === 0) {
      throw new Error("Please select at least one genre");
    }
    if (languages.length === 0) {
      throw new Error("Please select at least one language");
    }
    if (paymentMethods.length === 0) {
      throw new Error("Please select at least one payment method");
    }

    // Collect all form data
    const profileData = {
      // Personal Details
      firstName: document.getElementById('artist-edit-firstname').value.trim(),
      lastName: document.getElementById('artist-edit-lastname').value.trim(),
      stageName: document.getElementById('artist-edit-stagename').value.trim(),
      phone: document.getElementById('artist-edit-phone').value.trim(),
      dob: document.getElementById('artist-edit-dob').value,
      gender: document.getElementById('artist-edit-gender').value,
      location: document.getElementById('artist-edit-location').value.trim(),

      // Professional Details
      genres: genres,
      languages: languages,
      paymentMethods: paymentMethods,
      bio: document.getElementById('artist-edit-bio').value.trim(),
      pitch: document.getElementById('artist-edit-pitch').value.trim(),

      // Media
      videoUrl: document.getElementById('artist-edit-video').value.trim(),
      audioUrl: document.getElementById('artist-edit-audio').value.trim(),
      textContent: document.getElementById('artist-edit-text').value.trim(),

      // Notification Settings
      notifyEmail: document.getElementById('artist-edit-notify-email').checked,
      notifySms: document.getElementById('artist-edit-notify-sms').checked
    };

    // Validate required fields
    if (!profileData.firstName || !profileData.lastName || !profileData.phone ||
      !profileData.dob || !profileData.gender || !profileData.location ||
      !profileData.bio || !profileData.pitch) {
      throw new Error("Please fill in all required fields (marked with *)");
    }

    // Get file inputs
    const profilePicInput = document.getElementById('artist-edit-profile-pic');
    const documentInput = document.getElementById('artist-edit-document');
    const profilePicFile = profilePicInput?.files[0];
    const documentFile = documentInput?.files[0];

    // Update profile
    const updatedData = await updateArtistProfile(uid, profileData, profilePicFile, documentFile);

    // Update local store
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...updatedData });

    // Show success message
    successMsg.textContent = '‚úì Profile updated successfully!';

    // Clear file inputs
    if (profilePicFile && profilePicInput) {
      profilePicInput.value = '';
    }
    if (documentFile && documentInput) {
      documentInput.value = '';
      const filenameSpan = document.getElementById('artist-document-filename');
      if (filenameSpan) filenameSpan.textContent = 'No file chosen';
    }

    // Wait a moment, then hide editor
    setTimeout(() => {
      hideProfileEditor();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 1000);

  } catch (error) {
    console.error("[DASHBOARD] Error saving profile:", error);
    errorMsg.textContent = 'Error: ' + error.message;
    errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Save All Changes';
  }
}

/**
 * Load artist's own recommendations
 */
function loadArtistRecommendations() {
  const currentUser = getStore('currentUser');

  if (!currentUser) {
    console.warn("[DASHBOARD] No user logged in, cannot load recommendations");
    return;
  }

  const recommendationsSection = document.getElementById('artist-recommendations-section');
  if (!recommendationsSection) {
    console.log("[DASHBOARD] Recommendations section not found, skipping");
    return;
  }

  // Show the recommendations section
  recommendationsSection.classList.remove('hidden');
  recommendationsSection.style.display = 'block';

  // Load recommendations
  loadRecommendations(currentUser.uid);
}

/**
 * Exported function to populate editor (called from ui.js for backwards compatibility)
 */
export function populateArtistEditor() {
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    populateProfileEditor(currentUserData);
  }
}
</file>

<file path="src/modules/messaging/messaging-service.js">
/**
 * messaging-service.js
 * Firebase/Data Layer for Messaging
 * Handles all Firebase Firestore interactions for conversations and messages
 */

import { collection, addDoc, doc, setDoc, getDoc, serverTimestamp, query, where, getDocs, orderBy, onSnapshot } from "firebase/firestore";
import { db } from '../../services/firebase.js';

/**
 * Zoekt naar een bestaande conversatie tussen twee users
 * @param {string} userId1 - First user ID
 * @param {string} userId2 - Second user ID
 * @returns {Promise<object|null>} Conversation object or null
 */
export async function findExistingConversation(userId1, userId2) {
  try {
    const conversationsRef = collection(db, 'conversations');

    // Query voor conversaties waar beide users participants zijn
    const q = query(
      conversationsRef,
      where('participants', 'array-contains', userId1)
    );

    const querySnapshot = await getDocs(q);

    // Filter client-side voor de tweede participant
    let existingConv = null;
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      if (data.participants.includes(userId2)) {
        existingConv = { id: doc.id, ...data };
      }
    });

    return existingConv;
  } catch (error) {
    console.error("Error finding existing conversation:", error);
    return null;
  }
}

/**
 * Maakt een nieuwe conversatie aan
 * @param {string} programmerId - Programmer user ID
 * @param {object} programmerData - Programmer data object
 * @param {object} artist - Artist object
 * @param {string} subject - Conversation subject
 * @returns {Promise<string>} Conversation ID
 */
export async function createConversation(programmerId, programmerData, artist, subject) {
  try {
    const artistId = artist.uid || artist.id;

    const conversationData = {
      participants: [programmerId, artistId],
      participantNames: {
        [programmerId]: `${programmerData.firstName} ${programmerData.lastName}`,
        [artistId]: artist.stageName || `${artist.firstName} ${artist.lastName}`
      },
      participantRoles: {
        [programmerId]: 'programmer',
        [artistId]: 'artist'
      },
      participantEmails: {
        [programmerId]: programmerData.email,
        [artistId]: artist.email
      },
      participantProfilePics: {
        [programmerId]: programmerData.profilePicUrl || '',
        [artistId]: artist.profilePicUrl || ''
      },
      subject: subject,
      lastMessage: '',
      lastMessageAt: serverTimestamp(),
      unreadBy: [artistId],
      createdAt: serverTimestamp()
    };

    const docRef = await addDoc(collection(db, 'conversations'), conversationData);
    return docRef.id;
  } catch (error) {
    console.error("Error creating conversation:", error);
    throw new Error("Failed to create conversation. Please try again.");
  }
}

/**
 * Voegt een bericht toe aan een conversatie
 * @param {string} conversationId - Conversation ID
 * @param {string} senderId - Sender user ID
 * @param {object} senderData - Sender data object
 * @param {string} messageText - Message text
 * @returns {Promise<void>}
 */
export async function addMessage(conversationId, senderId, senderData, messageText) {
  try {
    // 1. Voeg bericht toe aan messages subcollection
    const messageData = {
      senderId: senderId,
      senderName: `${senderData.firstName} ${senderData.lastName}`,
      senderRole: senderData.role,
      senderProfilePic: senderData.profilePicUrl || '',
      text: messageText,
      createdAt: serverTimestamp(),
      read: false
    };

    await addDoc(collection(db, `conversations/${conversationId}/messages`), messageData);

    // 2. Update de conversatie met laatste bericht info
    const conversationRef = doc(db, 'conversations', conversationId);
    const conversationSnap = await getDoc(conversationRef);
    const conversationData = conversationSnap.data();

    // Bepaal wie de ontvanger is (de andere participant)
    const receiverId = conversationData.participants.find(id => id !== senderId);

    await setDoc(conversationRef, {
      lastMessage: messageText.substring(0, 100),
      lastMessageAt: serverTimestamp(),
      unreadBy: [receiverId]
    }, { merge: true });
  } catch (error) {
    console.error("Error adding message:", error);
    throw new Error("Failed to send message. Please try again.");
  }
}

/**
 * Haalt alle conversaties op voor een specifieke gebruiker
 * @param {string} userId - User ID
 * @returns {Promise<Array>} Array of conversation objects
 */
export async function fetchConversations(userId) {
  try {
    const conversationsRef = collection(db, 'conversations');
    const q = query(
      conversationsRef,
      where('participants', 'array-contains', userId),
      orderBy('lastMessageAt', 'desc')
    );

    const querySnapshot = await getDocs(q);

    const conversations = [];
    querySnapshot.forEach((doc) => {
      conversations.push({ id: doc.id, ...doc.data() });
    });

    return conversations;
  } catch (error) {
    console.error("Error fetching conversations:", error);
    throw new Error("Failed to load conversations. Please refresh the page.");
  }
}

/**
 * Haalt alle berichten op van een conversatie
 * @param {string} conversationId - Conversation ID
 * @returns {Promise<Array>} Array of message objects
 */
export async function fetchMessages(conversationId) {
  try {
    const messagesRef = collection(db, `conversations/${conversationId}/messages`);
    const q = query(messagesRef, orderBy('createdAt', 'asc'));

    const querySnapshot = await getDocs(q);

    const messages = [];
    querySnapshot.forEach((doc) => {
      messages.push({ id: doc.id, ...doc.data() });
    });

    return messages;
  } catch (error) {
    console.error("Error fetching messages:", error);
    throw new Error("Failed to load messages. Please refresh the page.");
  }
}

/**
 * Haalt een specifieke conversatie op
 * @param {string} conversationId - Conversation ID
 * @returns {Promise<object|null>} Conversation object or null
 */
export async function fetchConversation(conversationId) {
  try {
    const conversationRef = doc(db, 'conversations', conversationId);
    const conversationSnap = await getDoc(conversationRef);

    if (!conversationSnap.exists()) {
      return null;
    }

    return { id: conversationSnap.id, ...conversationSnap.data() };
  } catch (error) {
    console.error("Error fetching conversation:", error);
    throw new Error("Failed to load conversation. Please refresh the page.");
  }
}

/**
 * Markeer conversatie als gelezen voor de huidige gebruiker
 * @param {string} conversationId - Conversation ID
 * @param {string} userId - User ID
 * @returns {Promise<void>}
 */
export async function markConversationAsRead(conversationId, userId) {
  try {
    const conversationRef = doc(db, 'conversations', conversationId);
    const conversationSnap = await getDoc(conversationRef);

    if (!conversationSnap.exists()) return;

    const conversationData = conversationSnap.data();
    const unreadBy = conversationData.unreadBy || [];

    // Als de gebruiker in de unreadBy lijst staat, verwijder hem
    if (unreadBy.includes(userId)) {
      const newUnreadBy = unreadBy.filter(id => id !== userId);

      await setDoc(conversationRef, {
        unreadBy: newUnreadBy
      }, { merge: true });
    }

  } catch (error) {
    console.error("Error marking conversation as read:", error);
  }
}

/**
 * Setup real-time listener voor conversations
 * @param {string} userId - User ID
 * @param {Function} callback - Callback function to call when conversations update
 * @returns {Function} Unsubscribe function
 */
export function setupConversationsListener(userId, callback) {
  const conversationsRef = collection(db, 'conversations');
  const q = query(
    conversationsRef,
    where('participants', 'array-contains', userId)
  );

  // Setup real-time listener
  const unsubscribe = onSnapshot(q, (querySnapshot) => {
    const conversations = [];
    querySnapshot.forEach((doc) => {
      conversations.push({ id: doc.id, ...doc.data() });
    });

    callback(conversations);
  }, (error) => {
    console.error("Error in conversations listener:", error);
  });

  return unsubscribe;
}

/**
 * Haalt user data op (programmer of artist)
 * @param {string} userId - User ID
 * @param {string} role - User role ('programmer' or 'artist')
 * @returns {Promise<object|null>} User data or null
 */
export async function fetchUserProfile(userId, role) {
  try {
    const collectionName = role === 'artist' ? 'artists' : 'programmers';
    const userDocRef = doc(db, collectionName, userId);
    const userDocSnap = await getDoc(userDocRef);

    if (!userDocSnap.exists()) {
      return null;
    }

    return { id: userDocSnap.id, ...userDocSnap.data() };
  } catch (error) {
    console.error("Error fetching user profile:", error);
    return null;
  }
}

/**
 * Send recommendation notification to artist
 * @param {string} artistId - Artist user ID
 * @param {string} artistEmail - Artist email
 * @param {string} artistName - Artist name
 * @param {string} programmerId - Programmer user ID
 * @param {object} programmerData - Programmer data
 * @param {string} recommendationText - The recommendation text
 * @returns {Promise<void>}
 */
export async function sendRecommendationNotification(artistId, artistEmail, artistName, programmerId, programmerData, recommendationText) {
  try {
    // Check if conversation exists
    const existingConversation = await findExistingConversation(programmerId, artistId);

    let conversationId;

    if (existingConversation) {
      conversationId = existingConversation.id;
    } else {
      // Create new conversation
      const conversationData = {
        participants: [programmerId, artistId],
        participantNames: {
          [programmerId]: `${programmerData.firstName} ${programmerData.lastName}`,
          [artistId]: artistName
        },
        participantRoles: {
          [programmerId]: 'programmer',
          [artistId]: 'artist'
        },
        participantEmails: {
          [programmerId]: programmerData.email,
          [artistId]: artistEmail
        },
        participantProfilePics: {
          [programmerId]: programmerData.profilePicUrl || '',
          [artistId]: ''
        },
        subject: 'üåü New Recommendation',
        lastMessage: '',
        lastMessageAt: serverTimestamp(),
        unreadBy: [artistId],
        createdAt: serverTimestamp()
      };

      const convRef = await addDoc(collection(db, 'conversations'), conversationData);
      conversationId = convRef.id;
    }

    // Send notification message
    const notificationText = `I've written a recommendation for you! Here's what I said:\n\n"${recommendationText}"\n\nYou can view all your recommendations in your artist dashboard.`;

    await addMessage(conversationId, programmerId, programmerData, notificationText);

  } catch (error) {
    console.error("Error sending recommendation notification:", error);
    throw error;
  }
}
</file>

<file path="src/modules/programmer/programmer-profile.js">
/**
 * programmer-profile.js
 * Handles profile editing functionality for programmers
 */

import { getStore, setStore } from '../../utils/store.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { doc, updateDoc } from "firebase/firestore";
import { db } from '../../services/firebase.js';
import { setLanguage } from '../../utils/translations.js';
import { displayProgrammerProfileOverview } from './programmer-dashboard.js';

/**
 * Renders the programmer profile editor HTML
 */
export function renderProgrammerProfileEditor() {
  const container = document.getElementById('programmer-profile-editor');

  if (!container) {
    console.warn("Programmer profile editor container not found");
    return;
  }

  container.innerHTML = `
    <div class="bg-white p-10 rounded-3xl shadow-lg border border-gray-100">
      <div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-100">
        <div>
          <h3 class="text-3xl font-bold text-gray-900 tracking-tight">Edit Your Profile</h3>
          <p class="text-sm text-gray-500 mt-2">Update your information below. Fields marked with * are required.</p>
        </div>
        <button id="cancel-edit-profile-btn" type="button" class="text-gray-600 hover:text-gray-900 font-semibold transition-colors px-4 py-2 rounded-xl hover:bg-gray-50">
          Cancel
        </button>
      </div>

      <form id="programmer-profile-form" class="space-y-10">
        <!-- Profile Picture (Apple Style) -->
        <div class="border-b border-gray-100 pb-8">
          <h5 class="text-xl font-bold text-gray-900 mb-6">Profile Picture</h5>
          <div class="flex items-center gap-8">
            <img id="programmer-profile-pic-preview"
                 src="https://placehold.co/100x100/e0e7ff/6366f1?text=P"
                 alt="Profile Preview"
                 class="w-28 h-28 rounded-3xl object-cover shadow-md border border-gray-100">
            <div class="flex flex-col gap-3">
              <label for="programmer-edit-profile-pic" class="cursor-pointer bg-gray-900 text-white py-3 px-6 rounded-2xl text-sm font-semibold hover:bg-gray-800 transition-all inline-block text-center shadow-sm hover:shadow">
                Upload New Photo
                <input id="programmer-edit-profile-pic" type="file" accept="image/*" class="sr-only">
              </label>
              <p class="text-xs text-gray-500 leading-relaxed">JPG, PNG or GIF. Max 5MB.</p>
            </div>
          </div>
        </div>

        <!-- Personal Details (Apple Style) -->
        <div class="border-b border-gray-100 pb-6">
          <h5 class="text-lg font-bold text-gray-900 mb-4">Personal Details</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="programmer-edit-firstname" class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
              <input id="programmer-edit-firstname" type="text" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div>
              <label for="programmer-edit-lastname" class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
              <input id="programmer-edit-lastname" type="text" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div>
              <label for="programmer-edit-phone" class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
              <input id="programmer-edit-phone" type="tel"
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
          </div>
        </div>

        <!-- Organization Details (Apple Style) -->
        <div class="border-b border-gray-100 pb-6">
          <h5 class="text-lg font-bold text-gray-900 mb-4">Organization Details</h5>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="programmer-edit-org-name" class="block text-sm font-semibold text-gray-700 mb-2">Organization Name *</label>
              <input id="programmer-edit-org-name" type="text" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div>
              <label for="programmer-edit-website" class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
              <input id="programmer-edit-website" type="url" placeholder="https://..."
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div>
              <label for="programmer-edit-org-about" class="block text-sm font-semibold text-gray-700 mb-2">About Organization</label>
              <textarea id="programmer-edit-org-about" rows="4"
                        class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"></textarea>
            </div>
          </div>
        </div>

        <!-- Preferences (Apple Style) -->
        <div class="border-b border-gray-100 pb-6">
          <h5 class="text-lg font-bold text-gray-900 mb-4">Preferences</h5>
          <div>
            <label for="programmer-edit-language" class="block text-sm font-semibold text-gray-700 mb-2">Language</label>
            <select id="programmer-edit-language"
                    class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
              <option value="nl">Nederlands</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        <!-- Submit Button (Apple Style) -->
        <div class="space-y-4 pt-4">
          <button type="submit"
                  class="w-full bg-indigo-600 text-white px-6 py-5 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg">
            Save All Changes
          </button>
          <p id="programmer-profile-success" class="text-green-600 text-sm text-center"></p>
          <p id="programmer-profile-error" class="text-red-600 text-sm text-center"></p>
        </div>
      </form>
    </div>
  `;

  console.log("Programmer profile editor HTML rendered");
}

/**
 * Sets up the programmer profile editor
 */
export function setupProgrammerProfile() {
  const editBtn = document.getElementById('edit-programmer-profile-btn');
  const editor = document.getElementById('programmer-profile-editor');

  if (!editBtn || !editor) {
    console.warn("Programmer profile elements not found");
    return;
  }

  // Render the profile editor HTML first
  renderProgrammerProfileEditor();

  // Now get the form element after rendering
  const form = document.getElementById('programmer-profile-form');

  if (!form) {
    console.warn("Programmer profile form not found after rendering");
    return;
  }

  // Toggle editor visibility
  editBtn.addEventListener('click', () => {
    const isHidden = editor.style.display === 'none' || editor.style.display === '';
    editor.style.display = isHidden ? 'block' : 'none';

    // Populate form when opening
    if (isHidden) {
      populateProgrammerEditor();
    }
  });

  // Setup profile picture preview
  setupProfilePicPreview();

  // Handle form submission
  form.addEventListener('submit', handleProgrammerProfileSubmit);

  console.log("Programmer profile editor setup complete");
}

/**
 * Setup profile form handlers (called after rendering HTML)
 * Exported for use in ui.js when showing settings view
 */
export function setupProfileFormHandlers() {
  const form = document.getElementById('programmer-profile-form');
  const editor = document.getElementById('programmer-profile-editor');
  const cancelBtn = document.getElementById('cancel-edit-profile-btn');

  if (!form || !editor) {
    console.warn("Programmer profile form or editor not found for handler setup");
    return;
  }

  // Remove any existing listeners by cloning the form
  const newForm = form.cloneNode(true);
  form.parentNode.replaceChild(newForm, form);

  // Setup cancel button
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      console.log("[PROFILE] Cancel button clicked - hiding editor");
      editor.classList.add('hidden');
      editor.style.display = 'none';

      // Refresh the profile overview
      displayProgrammerProfileOverview();
    });
  }

  // Setup profile picture preview
  setupProfilePicPreview();

  // Handle form submission
  newForm.addEventListener('submit', handleProgrammerProfileSubmit);

  console.log("Programmer profile form handlers attached");
}

/**
 * Setup profile picture preview on file selection
 */
function setupProfilePicPreview() {
  const fileInput = document.getElementById('programmer-edit-profile-pic');
  const previewImg = document.getElementById('programmer-profile-pic-preview');

  if (!fileInput || !previewImg) return;

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        fileInput.value = '';
        return;
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        fileInput.value = '';
        return;
      }

      // Show preview
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

/**
 * Populates the editor with current user data
 */
export function populateProgrammerEditor() {
  const currentUserData = getStore('currentUserData');
  
  if (!currentUserData) {
    console.warn("No programmer data found to populate editor");
    return;
  }
  
  console.log("Populating programmer editor with:", currentUserData);
  
  // Populate form fields
  document.getElementById('programmer-edit-firstname').value = currentUserData.firstName || '';
  document.getElementById('programmer-edit-lastname').value = currentUserData.lastName || '';
  document.getElementById('programmer-edit-phone').value = currentUserData.phone || '';
  document.getElementById('programmer-edit-org-name').value = currentUserData.organizationName || '';
  document.getElementById('programmer-edit-org-about').value = currentUserData.organizationAbout || '';
  document.getElementById('programmer-edit-website').value = currentUserData.website || '';
  document.getElementById('programmer-edit-language').value = currentUserData.language || 'nl';

  // Show current profile picture
  const previewImg = document.getElementById('programmer-profile-pic-preview');
  if (currentUserData.profilePicUrl) {
    previewImg.src = currentUserData.profilePicUrl;
  } else {
    previewImg.src = "https://placehold.co/100x100/e0e7ff/6366f1?text=" + 
                     encodeURIComponent(currentUserData.firstName?.charAt(0) || 'P');
  }
}

/**
 * Handles form submission to save profile changes
 */
async function handleProgrammerProfileSubmit(e) {
  e.preventDefault();
  
  const successMsg = document.getElementById('programmer-profile-success');
  const errorMsg = document.getElementById('programmer-profile-error');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');
  
  // Reset messages
  successMsg.textContent = '';
  errorMsg.textContent = '';
  
  // Disable button
  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';
  
  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }
    
    const uid = currentUser.uid;
    const docRef = doc(db, 'programmers', uid);
    
    // Collect form data
    const dataToUpdate = {
      firstName: document.getElementById('programmer-edit-firstname').value.trim(),
      lastName: document.getElementById('programmer-edit-lastname').value.trim(),
      phone: document.getElementById('programmer-edit-phone').value.trim(),
      organizationName: document.getElementById('programmer-edit-org-name').value.trim(),
      organizationAbout: document.getElementById('programmer-edit-org-about').value.trim(),
      website: document.getElementById('programmer-edit-website').value.trim(),
      language: document.getElementById('programmer-edit-language').value
    };
    
    // Validate required fields
    if (!dataToUpdate.firstName || !dataToUpdate.lastName || !dataToUpdate.organizationName) {
      throw new Error("Please fill in all required fields (marked with *)");
    }
    
    // Handle profile picture upload
    const fileInput = document.getElementById('programmer-edit-profile-pic');
    const file = fileInput.files[0];
    
    if (file) {
      console.log("Uploading profile picture...");
      const storage = getStorage();
      const storageRef = ref(storage, `programmers/${uid}/profile.jpg`);
      
      // Upload file
      const snapshot = await uploadBytes(storageRef, file);
      
      // Get download URL
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Profile picture uploaded:", downloadURL);
      
      // Add URL to data
      dataToUpdate.profilePicUrl = downloadURL;
      
      // Update preview
      document.getElementById('programmer-profile-pic-preview').src = downloadURL;
    }
    
    // Update Firestore
    await updateDoc(docRef, dataToUpdate);
    console.log("Profile updated successfully");
    
    // Update local store
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...dataToUpdate });

    // Apply language change immediately
    setLanguage(dataToUpdate.language);

    // Refresh the profile overview display
    displayProgrammerProfileOverview();

    // Show success message
    successMsg.textContent = '‚úì Profile updated successfully!';
    
    // Clear file input
    if (file) {
      fileInput.value = '';
    }
    
  } catch (error) {
    console.error("Error saving profile:", error);
    errorMsg.textContent = 'Error: ' + error.message;
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Save Profile Changes';
  }
}
</file>

<file path="firestore.indexes.json">
{
  "indexes": [
    {
      "collectionGroup": "conversations",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "participants",
          "arrayConfig": "CONTAINS"
        },
        {
          "fieldPath": "lastMessageAt",
          "order": "DESCENDING"
        },
        {
          "fieldPath": "__name__",
          "order": "DESCENDING"
        }
      ],
      "density": "SPARSE_ALL"
    },
    {
      "collectionGroup": "recommendations",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "artistId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "isApproved",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        },
        {
          "fieldPath": "__name__",
          "order": "DESCENDING"
        }
      ],
      "density": "SPARSE_ALL"
    },
    {
      "collectionGroup": "events",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "artistId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "date",
          "order": "ASCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./*.js",
    "./src/**/*.js"
  ],
  safelist: [
    // Purple colors (design system)
    'bg-purple-50',
    'bg-purple-100',
    'bg-purple-200',
    'bg-purple-300',
    'bg-purple-400',
    'bg-purple-500',
    'bg-purple-600',
    'bg-purple-700',
    'bg-purple-800',
    'text-purple-300',
    'text-purple-400',
    'text-purple-500',
    'text-purple-600',
    'text-purple-700',
    'text-purple-800',
    'border-purple-200',
    'border-purple-500',
    'border-purple-700',
    'hover:bg-purple-50',
    'hover:bg-purple-500',
    'hover:bg-purple-700',
    'hover:bg-purple-800',
    'hover:text-purple-600',
    'hover:text-purple-800',
    'hover:text-white',
    // Green colors (badges)
    'bg-green-50',
    'bg-green-100',
    'bg-green-600',
    'text-green-700',
    'border-green-200',
    // Pink colors
    'bg-pink-500',
    // Gray dark mode colors
    'bg-gray-50',
    'bg-gray-100',
    'bg-gray-200',
    'bg-gray-600',
    'bg-gray-700',
    'bg-gray-800',
    'bg-gray-900',
    'bg-gray-950',
    'text-gray-200',
    'text-gray-300',
    'text-gray-400',
    'text-gray-500',
    'border-gray-700',
    'border-gray-800',
    'hover:bg-gray-700',
    'hover:bg-gray-800',
    // Blue colors
    'bg-blue-600',
  ],
  theme: {
    extend: {
      backdropBlur: {
        xs: '2px',
      },
    },
  },
  plugins: [
    function ({ addUtilities }) {
      addUtilities({
        '.scrollbar-hide': {
          /* Firefox */
          'scrollbar-width': 'none',
          /* Safari and Chrome */
          '&::-webkit-scrollbar': {
            display: 'none'
          }
        },
        '.snap-x': {
          'scroll-snap-type': 'x mandatory',
        },
        '.snap-mandatory': {
          'scroll-snap-type': 'x mandatory',
        },
        '.snap-start': {
          'scroll-snap-align': 'start',
        }
      })
    }
  ],
}
</file>

<file path="src/services/auth.js">
/**
 * auth.js
 * Beheert alle authenticatie-logica: inloggen, registreren,
 * uitloggen, en het controleren van de auth-status.
 */

// Importeer de Firebase-services die we nodig hebben
import {
  getAuth,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateEmail,
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "firebase/auth";
import { doc, setDoc, updateDoc } from "firebase/firestore";
import { auth, db } from './firebase.js'; // Haal de ge√Ønitialiseerde 'auth' en 'db' op

// Importeer de UI-functies en de "store" (globale state)
import { showPage, updateNav, showDashboard } from '../ui/ui.js';
import { setStore, getStore } from '../utils/store.js';
import { fetchUserData } from './data.js';
import { setupBadgeListener, stopBadgeListener } from '../modules/messaging/messaging-controller.js';
import { getCheckboxValues } from '../utils/checkbox-helpers.js';

// --- HULPFUNCTIES ---

/**
 * Toont een foutmelding op een specifiek formulier.
 * @param {string} formId - De ID van het formulier (bv. 'login-form').
 * @param {string} message - De foutmelding die getoond moet worden.
 */
function showAuthError(formId, message) {
  const errorEl = document.getElementById(`${formId}-error`);
  if (errorEl) {
    errorEl.textContent = message;
  } else {
    console.error(`Fout-element niet gevonden voor formulier: ${formId}`, message);
  }
}

// ‚≠ê REMOVED: getSelectValues() is no longer needed, we use getCheckboxValues() from checkbox-helpers.js

// --- FORMULIER-HANDLERS ---

/**
 * Verwerkt de inlog-poging.
 */
export async function handleLogin(e) {
  e.preventDefault();

  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  errorEl.textContent = '';

  console.log("[LOGIN] Attempting login for:", email);

  try {
    await signInWithEmailAndPassword(auth, email, password);
    // De onAuthStateChanged-listener (in monitorAuthState)
    // zal de rest afhandelen (data ophalen, dashboard tonen).
  } catch (error) {
    console.error("Login mislukt:", error);
    errorEl.textContent = error.message;
  }
}

/**
 * Verwerkt de registratie van een nieuwe artiest.
 */
export async function handleArtistSignup(e) {
  e.preventDefault();
  const errorEl = document.getElementById('artist-signup-error');
  errorEl.textContent = '';
  
  // Haal formulierwaarden op
  const email = document.getElementById('artist-email').value;
  const password = document.getElementById('artist-password').value;

  try {
    // 1. Maak de gebruiker aan in Firebase Authentication
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // 2. Maak het profiel aan in Firestore
    // (a) Maak het 'users' document (voor snelle rol-check)
    const userDocRef = doc(db, `users/${user.uid}`);
    await setDoc(userDocRef, {
        role: 'artist',
        email: email,
        status: 'active' // Artiesten zijn direct actief
    });

    // (b) Maak het 'artists' document (het volledige profiel)
    const artistDocRef = doc(db, `artists/${user.uid}`);
    const artistData = {
        uid: user.uid,
        email: email,
        firstName: document.getElementById('artist-firstname').value,
        lastName: document.getElementById('artist-lastname').value,
        stageName: document.getElementById('artist-stagename').value,
        phone: document.getElementById('artist-phone').value,
        dob: document.getElementById('artist-dob').value,
        gender: document.getElementById('artist-gender').value,
        location: document.getElementById('artist-location').value,
        genres: getCheckboxValues('artist-genres'),
        languages: getCheckboxValues('artist-languages'),
        paymentMethods: getCheckboxValues('artist-payment'),
        bio: document.getElementById('artist-bio').value,
        pitch: document.getElementById('artist-pitch').value,
        notifyEmail: document.getElementById('artist-notify-email').checked,
        notifySms: document.getElementById('artist-notify-sms').checked,
        createdAt: new Date().toISOString(),
        profilePicUrl: '', // Wordt later toegevoegd
        videoUrl: '',
        audioUrl: '',
        textContent: '',
        published: true // Artiesten zijn standaard gepubliceerd
    };
    await setDoc(artistDocRef, artistData);
    
    // De onAuthStateChanged-listener zal de rest afhandelen.

  } catch (error) {
    console.error("Registratie artiest mislukt:", error);
    errorEl.textContent = error.message;
  }
}

/**
 * Verwerkt de registratie van een nieuwe programmeur.
 */
export async function handleProgrammerSignup(e) {
  e.preventDefault();
  const errorEl = document.getElementById('programmer-signup-error');
  errorEl.textContent = '';
  
  const email = document.getElementById('prog-email').value;
  const password = document.getElementById('prog-password').value;

  try {
    // 1. Maak de gebruiker aan in Firebase Authentication
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // 2. Maak de profielen aan in Firestore
    // (a) Maak het 'users' document (voor snelle rol-check)
    const userDocRef = doc(db, `users/${user.uid}`);
    await setDoc(userDocRef, {
        role: 'programmer',
        email: email,
        status: 'pending' // Programmeurs moeten worden goedgekeurd
    });
    
    // (b) Maak het 'programmers' document (het volledige profiel)
    const programmerDocRef = doc(db, `programmers/${user.uid}`);
    const programmerData = {
        uid: user.uid,
        email: email,
        firstName: document.getElementById('prog-firstname').value,
        lastName: document.getElementById('prog-lastname').value,
        phone: document.getElementById('prog-phone').value,
        organizationName: document.getElementById('prog-org-name').value,
        organizationAbout: document.getElementById('prog-org-about').value,
        website: document.getElementById('prog-website').value,
        notifyEmail: document.getElementById('prog-notify-email').checked,
        createdAt: new Date().toISOString(),
        status: 'pending', // Needs admin approval per MVP doc
        trialStartedAt: new Date().toISOString()
    };
    await setDoc(programmerDocRef, programmerData);

    // De onAuthStateChanged-listener zal de rest afhandelen.

  } catch (error) {
    console.error("Registratie programmeur mislukt:", error);
    errorEl.textContent = error.message;
  }
}

/**
 * Verwerkt het uitloggen.
 * DIT IS DE FIX: 'export' toegevoegd
 */
export function handleLogout() {
  // Stop badge listener
  stopBadgeListener();
  // Logout
  signOut(auth).catch(error => console.error("Logout mislukt:", error));
}


// --- HOOFDFUNCTIES (te importeren in main.js) ---

/**
 * Luistert naar de algemene inlogstatus van Firebase.
 * Dit is de "hoofdschakelaar" van de app.
 */
export function monitorAuthState() {
  const loadingView = document.getElementById('loading-view');

  console.log('[AUTH] Setting up onAuthStateChanged listener...');

  // Add a timeout to prevent infinite loading
  const loadingTimeout = setTimeout(() => {
    console.error('[AUTH] ‚ö†Ô∏è Auth state listener did not fire within 10 seconds!');
    console.error('[AUTH] This usually means Firebase is not initialized correctly.');
    if (loadingView) {
      loadingView.innerHTML = `
        <div class="text-center p-8 max-w-lg mx-auto bg-white shadow-lg rounded-lg">
          <h1 class="text-2xl font-bold mb-4 text-red-600">Initialization Error</h1>
          <p class="mb-4">Firebase authentication failed to initialize.</p>
          <p class="text-sm text-gray-600">Please check the browser console for details.</p>
          <button onclick="location.reload()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">
            Retry
          </button>
        </div>
      `;
    }
  }, 10000); // 10 second timeout

  onAuthStateChanged(auth, async (user) => {
    // Clear the timeout since auth state changed
    clearTimeout(loadingTimeout);
    if (user) {
      // Gebruiker is ingelogd
      console.log("Auth state change: User logged in:", user.uid);
      // Sla het Firebase user object op in de store
      setStore('currentUser', user);
      // Haal de profielgegevens van de gebruiker op (uit 'users' en 'artists'/'programmers')
      try {
        await fetchUserData(user.uid);
        // Werk de navigatiebalk bij
        updateNav(user);
        // Setup real-time badge listener (Fase 2.5)
        setupBadgeListener();
        // Toon search als default homepage
        const { showSearch } = await import('../ui/ui.js');
        showSearch();
      } catch (error) {
        console.error("Fout bij ophalen van gebruikersdata na inloggen:", error);
        // Als het ophalen van data mislukt, log de gebruiker uit voor de veiligheid
        handleLogout();
        showPage('login-view');
        showAuthError('login-form', `Kon profiel niet laden: ${error.message}`);
      }
      
    } else {
      // Gebruiker is uitgelogd
      console.log("Auth state change: User logged out");
      // Stop badge listener
      stopBadgeListener();
      setStore('currentUser', null);
      setStore('currentUserData', null);
      setStore('userRole', null);
      updateNav(null);
      // Toon de homepagina en verberg de lader
      showPage('home-view');
    }
    // Verberg de lader (pas nadat alles klaar is)
    // FIX 3: Null-safe style guard
    if (loadingView) loadingView.style.display = 'none';
  });
}

/**
 * Updates user email address
 * @param {string} newEmail - New email address
 * @param {string} currentPassword - Current password for reauthentication
 * @returns {Promise<void>}
 */
export async function updateUserEmail(newEmail, currentPassword) {
  const user = auth.currentUser;

  if (!user) {
    throw new Error("No user logged in");
  }

  // Reauthenticate user before email change (Firebase requirement)
  const credential = EmailAuthProvider.credential(user.email, currentPassword);
  await reauthenticateWithCredential(user, credential);

  // Update email in Firebase Auth
  await updateEmail(user, newEmail);

  // Update email in Firestore users collection
  const userDocRef = doc(db, `users/${user.uid}`);
  await updateDoc(userDocRef, { email: newEmail });

  // Update email in role-specific collection (artists or programmers)
  const currentUserData = getStore('currentUserData');
  if (currentUserData?.role === 'artist') {
    const artistDocRef = doc(db, `artists/${user.uid}`);
    await updateDoc(artistDocRef, { email: newEmail });
  } else if (currentUserData?.role === 'programmer') {
    const programmerDocRef = doc(db, `programmers/${user.uid}`);
    await updateDoc(programmerDocRef, { email: newEmail });
  }

  console.log('[AUTH] Email updated successfully');
}

/**
 * Updates user password
 * @param {string} currentPassword - Current password for reauthentication
 * @param {string} newPassword - New password
 * @returns {Promise<void>}
 */
export async function updateUserPassword(currentPassword, newPassword) {
  const user = auth.currentUser;

  if (!user) {
    throw new Error("No user logged in");
  }

  // Reauthenticate user before password change (Firebase requirement)
  const credential = EmailAuthProvider.credential(user.email, currentPassword);
  await reauthenticateWithCredential(user, credential);

  // Update password in Firebase Auth
  await updatePassword(user, newPassword);

  console.log('[AUTH] Password updated successfully');
}

// ‚≠ê REMOVED: initAuth() - all form handling is now done via global event delegation in ui.js
</file>

<file path="src/modules/search/profile-chat.js">
/**
 * profile-chat.js
 * Chat functionaliteit voor artist detail page
 */

import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  getDocs
} from 'firebase/firestore';
import { db } from '../../services/firebase.js';
import { getStore } from '../../utils/store.js';
import {
  findExistingConversation,
  createConversation,
  addMessage
} from '../messaging/messaging-service.js';

// Store voor huidige chat state
let currentConversationId = null;
let messagesUnsubscribe = null;
let currentArtistId = null;

/**
 * Initialiseer chat voor een artist
 */
export async function initProfileChat(artist) {
  const currentUser = getStore('currentUser');
  const currentUserData = getStore('currentUserData');

  if (!currentUser || !currentUserData) {
    showChatError('Je moet ingelogd zijn om te chatten');
    return;
  }

  currentArtistId = artist.id || artist.uid;

  console.log('[PROFILE CHAT] Initializing chat with:', artist.stageName || artist.id);

  // Setup form submit handler
  const form = document.getElementById('profile-chat-form');
  if (form) {
    // Remove old listener
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    newForm.addEventListener('submit', handleChatSubmit);
  }

  // Setup input enter key
  const input = document.getElementById('profile-chat-input');
  if (input) {
    input.addEventListener('keypress', handleInputKeypress);
  }

  try {
    // Check voor bestaande conversatie
    const existingConv = await findExistingConversation(currentUser.uid, currentArtistId);

    if (existingConv) {
      currentConversationId = existingConv.id;
      console.log('[PROFILE CHAT] Found existing conversation:', currentConversationId);
      // Start realtime listener
      startMessagesListener(existingConv.id);
    } else {
      // Geen bestaande conversatie
      console.log('[PROFILE CHAT] No existing conversation found');
      currentConversationId = null;
      showChatEmpty();
    }

  } catch (err) {
    console.error('[PROFILE CHAT] Error initializing:', err);
    showChatError('Kon chat niet laden');
  }
}

function handleInputKeypress(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const form = document.getElementById('profile-chat-form');
    if (form) form.dispatchEvent(new Event('submit'));
  }
}

async function handleChatSubmit(e) {
  e.preventDefault();

  const input = document.getElementById('profile-chat-input');
  if (!input) return;

  const messageText = input.value.trim();
  if (!messageText) return;

  // Clear input immediately
  input.value = '';

  try {
    await sendProfileChatMessage(messageText);
  } catch (error) {
    console.error('[PROFILE CHAT] Error sending message:', error);
    // Restore input on error
    input.value = messageText;
    alert('Kon bericht niet versturen. Probeer opnieuw.');
  }
}

/**
 * Start realtime messages listener
 */
function startMessagesListener(conversationId) {
  // Stop bestaande listener
  if (messagesUnsubscribe) {
    messagesUnsubscribe();
  }

  const messagesRef = collection(db, `conversations/${conversationId}/messages`);
  const q = query(messagesRef, orderBy('createdAt', 'asc'));

  messagesUnsubscribe = onSnapshot(q, (snapshot) => {
    const messages = [];
    snapshot.forEach(doc => {
      messages.push({ id: doc.id, ...doc.data() });
    });

    if (messages.length === 0) {
      showChatEmpty();
    } else {
      renderMessages(messages);
    }
  }, (error) => {
    console.error('[PROFILE CHAT] Messages listener error:', error);
    showChatError('Kon berichten niet laden');
  });
}

/**
 * Render messages in de chat
 */
function renderMessages(messages) {
  const container = document.getElementById('profile-chat-messages');
  const emptyState = document.getElementById('chat-empty-state');

  if (!container) {
    console.error('[CHAT] Messages container not found');
    return;
  }

  // Hide empty state if we have messages
  if (emptyState) {
    emptyState.style.display = messages.length === 0 ? 'flex' : 'none';
  }

  if (messages.length === 0) return;

  const currentUser = getStore('currentUser');
  const currentUserId = currentUser?.uid;

  // Remove old message elements (but keep empty state)
  container.querySelectorAll('.chat-message').forEach(el => el.remove());

  // Add messages
  messages.forEach(msg => {
    const isOwn = msg.senderId === currentUserId;
    const messageEl = document.createElement('div');
    messageEl.className = 'chat-message';
    messageEl.style.cssText = `display: flex; flex-direction: column; align-items: ${isOwn ? 'flex-end' : 'flex-start'};`;

    const timestamp = msg.createdAt?.toDate?.() || new Date();
    const dateStr = timestamp.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
    const senderName = isOwn ? 'Jij' : (msg.senderName || currentArtist?.stageName || 'Artist');

    messageEl.innerHTML = `
      <div style="max-width: 85%; padding: 10px 14px; border-radius: ${isOwn ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; background: ${isOwn ? 'linear-gradient(135deg, #805ad5 0%, #6b46c1 100%)' : '#f3f4f6'}; color: ${isOwn ? 'white' : '#1a1a2e'};">
        <p style="font-size: 14px; line-height: 1.5; margin: 0; word-wrap: break-word;">${escapeHtml(msg.text || msg.content || '')}</p>
      </div>
      <span style="font-size: 10px; color: #9ca3af; margin-top: 4px; padding: 0 4px;">${senderName} ‚Ä¢ ${dateStr}</span>
    `;

    container.appendChild(messageEl);
  });

  // Scroll to bottom
  container.scrollTop = container.scrollHeight;

  console.log('[CHAT] Rendered', messages.length, 'messages, scrolled to bottom');
}

/**
 * Verstuur een bericht
 */
export async function sendProfileChatMessage(messageText) {
  if (!messageText || !messageText.trim()) return;

  const currentUser = getStore('currentUser');
  const currentUserData = getStore('currentUserData');

  if (!currentUser || !currentUserData) {
    showChatError('Je moet ingelogd zijn');
    return;
  }

  if (!currentArtistId) {
    showChatError('Geen artiest geselecteerd');
    return;
  }

  try {
    // Als er nog geen conversatie is, maak er een aan
    if (!currentConversationId) {
      // Haal artist data op
      const { fetchArtistById } = await import('./search-data.js');
      const artist = await fetchArtistById(currentArtistId);

      if (!artist) {
        throw new Error('Artist not found');
      }

      // Maak nieuwe conversatie
      currentConversationId = await createConversation(
        currentUser.uid,
        currentUserData,
        artist,
        'Chat via profiel'
      );

      // Start listener voor de nieuwe conversatie
      startMessagesListener(currentConversationId);
    }

    // Verstuur bericht
    await addMessage(currentConversationId, currentUser.uid, currentUserData, messageText.trim());

    console.log('[PROFILE CHAT] Message sent to conversation:', currentConversationId);

  } catch (err) {
    console.error('[PROFILE CHAT] Error sending message:', err);
    throw err; // Re-throw to be handled by handleChatSubmit
  }
}

/**
 * Cleanup functie - roep aan bij verlaten van detail page
 */
export function cleanupProfileChat() {
  if (messagesUnsubscribe) {
    messagesUnsubscribe();
    messagesUnsubscribe = null;
  }
  currentConversationId = null;
  currentArtistId = null;
}

// === Helper functies ===

function showChatEmpty() {
  const emptyState = document.getElementById('chat-empty-state');
  if (emptyState) {
    emptyState.style.display = 'flex';
  }
}

function showChatError(message) {
  const emptyState = document.getElementById('chat-empty-state');
  if (emptyState) {
    emptyState.style.display = 'flex';
    emptyState.innerHTML = `
      <div style="width: 64px; height: 64px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
        <svg width="28" height="28" fill="none" stroke="#ef4444" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
      </div>
      <p style="color: #ef4444; font-weight: 600;">${message}</p>
    `;
  }
}

function formatTime(date) {
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);

  if (mins < 1) return 'Nu';
  if (mins < 60) return `${mins}m`;
  if (hours < 24) return `${hours}u`;

  return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</file>

<file path="style.css">
/* DEZE 3 REGELS ZIJN NIEUW
  Zij importeren de Tailwind stijlen in uw project.
*/
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Hieronder staan uw bestaande stijlen */

body {
    font-family: 'Inter', sans-serif;
}

/* Aangepaste stijlen voor multi-select in de formulieren */
select[multiple] {
    height: 120px;
}

/* Simpele laad-spinner */
.loader {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    position: absolute;
    top: 50%;
    left: 50%;
    margin-left: -20px;
    margin-top: -20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Verberg alle pagina-secties standaard */
.page-section { 
    display: none; 
}

/* Toon het laadscherm standaard */
#loading-view { 
    display: flex; 
}

/* Stijl voor de profielfoto preview */
#profile-pic-preview {
    display: none; /* Standaard verborgen, JS toont het */
    border: 2px solid #e2e8f0; /* Lichte rand */
}

/* Search Pattern Background */
.search-pattern {
  min-height: 100vh;
  padding: 24px;
  position: relative;
  background: linear-gradient(180deg, #F8F9FA 0%, #F3EFFF 100%);
}

.search-pattern::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  opacity: 0.08;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Cg fill='none' stroke='%23A78BFA' stroke-width='0.5'%3E%3Cpath d='M0 0 L100 50 L0 100'/%3E%3Cpath d='M100 50 L200 0 L200 100 L100 50'/%3E%3Cpath d='M200 0 L300 50 L200 100'/%3E%3Cpath d='M300 50 L400 0 L400 100 L300 50'/%3E%3Cpath d='M0 100 L100 50 L100 150 L0 100'/%3E%3Cpath d='M100 150 L200 100 L200 200 L100 150'/%3E%3Cpath d='M200 100 L300 50 L300 150 L200 100'/%3E%3Cpath d='M300 150 L400 100 L400 200 L300 150'/%3E%3Cpath d='M0 200 L100 150 L100 250 L0 200'/%3E%3Cpath d='M100 250 L200 200 L200 300 L100 250'/%3E%3Cpath d='M200 200 L300 150 L300 250 L200 200'/%3E%3Cpath d='M300 250 L400 200 L400 300 L300 250'/%3E%3Cpath d='M0 300 L100 250 L100 350 L0 300'/%3E%3Cpath d='M100 350 L200 300 L200 400 L100 350'/%3E%3Cpath d='M200 300 L300 250 L300 350 L200 300'/%3E%3Cpath d='M300 350 L400 300 L400 400 L300 350'/%3E%3Cline x1='0' y1='0' x2='400' y2='400'/%3E%3Cline x1='400' y1='0' x2='0' y2='400'/%3E%3Cline x1='200' y1='0' x2='200' y2='400'/%3E%3Cline x1='0' y1='200' x2='400' y2='200'/%3E%3C/g%3E%3C/svg%3E");
  background-size: 400px 400px;
  z-index: 0;
}

.search-pattern > * {
  position: relative;
  z-index: 1;
}

/* Hide scrollbar for filter pills */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Artist Detail Pattern Background */
.artist-detail-pattern {
  position: relative;
  background: linear-gradient(180deg, #F8F9FA 0%, #F3EFFF 100%);
}

.artist-detail-pattern::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  opacity: 0.08;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Cg fill='none' stroke='%23A78BFA' stroke-width='0.5'%3E%3Cpath d='M0 0 L100 50 L0 100'/%3E%3Cpath d='M100 50 L200 0 L200 100 L100 50'/%3E%3Cpath d='M200 0 L300 50 L200 100'/%3E%3Cpath d='M300 50 L400 0 L400 100 L300 50'/%3E%3Cpath d='M0 100 L100 50 L100 150 L0 100'/%3E%3Cpath d='M100 150 L200 100 L200 200 L100 150'/%3E%3Cpath d='M200 100 L300 50 L300 150 L200 100'/%3E%3Cpath d='M300 150 L400 100 L400 200 L300 150'/%3E%3Cpath d='M0 200 L100 150 L100 250 L0 200'/%3E%3Cpath d='M100 250 L200 200 L200 300 L100 250'/%3E%3Cpath d='M200 200 L300 150 L300 250 L200 200'/%3E%3Cpath d='M300 250 L400 200 L400 300 L300 250'/%3E%3Cpath d='M0 300 L100 250 L100 350 L0 300'/%3E%3Cpath d='M100 350 L200 300 L200 400 L100 350'/%3E%3Cpath d='M200 300 L300 250 L300 350 L200 300'/%3E%3Cpath d='M300 350 L400 300 L400 400 L300 350'/%3E%3Cline x1='0' y1='0' x2='400' y2='400'/%3E%3Cline x1='400' y1='0' x2='0' y2='400'/%3E%3Cline x1='200' y1='0' x2='200' y2='400'/%3E%3Cline x1='0' y1='200' x2='400' y2='200'/%3E%3C/g%3E%3C/svg%3E");
  background-size: 400px 400px;
  z-index: 0;
}

.artist-detail-pattern > * {
  position: relative;
  z-index: 1;
}

/* Chat message bubbles */
.chat-message-own {
  align-self: flex-end;
  background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
  color: white;
  padding: 12px 16px;
  border-radius: 16px 16px 4px 16px;
  max-width: 80%;
}

.chat-message-other {
  align-self: flex-start;
  background: #f3f4f6;
  color: #1a1a2e;
  padding: 12px 16px;
  border-radius: 16px 16px 16px 4px;
  max-width: 80%;
}

.chat-message-name {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 4px;
  opacity: 0.7;
}

.chat-message-text {
  font-size: 14px;
  line-height: 1.5;
}

/* Screen reader only - hides elements visually but keeps them accessible */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Custom Map Markers */
.custom-map-marker {
  background: transparent;
  border: none;
  pointer-events: auto !important;
  cursor: pointer;
}

.custom-map-marker > div {
  pointer-events: auto;
}

.custom-map-popup .leaflet-popup-content-wrapper {
  border-radius: 12px;
  padding: 0;
}

.custom-map-popup .leaflet-popup-content {
  margin: 12px;
}

.custom-map-popup .leaflet-popup-tip {
  background: white;
}

/* Map container */
#community-map {
  border-radius: 16px;
  overflow: hidden;
}
</file>

<file path="src/modules/artist/artist-own-profile.js">
/**
 * artist-own-profile.js
 * Renders the artist's own profile in the same style as programmer's view
 * but with edit capabilities instead of chat/message
 */

import { calculateAge } from '../dashboard/dashboard-service.js';
import { getStore } from '../../utils/store.js';

/**
 * Render artist own profile view with edit button
 * Reuses the artist-detail-view design from search-ui.js
 */
export function renderArtistOwnProfile(artistData) {
  const container = document.getElementById('artist-dashboard');

  if (!container) {
    console.error('[ARTIST OWN PROFILE] Container not found');
    return;
  }

  console.log('[ARTIST OWN PROFILE] Rendering artist own profile view');

  const artistName = artistData.stageName || `${artistData.firstName || ''} ${artistData.lastName || ''}`.trim() || 'Unknown Artist';
  const profilePicUrl = artistData.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(artistName)}&background=f3f4f6&color=1a1a2e&size=140`;
  const age = artistData.dob ? calculateAge(artistData.dob) : null;
  const genderMap = { 'f': 'Female', 'm': 'Male', 'x': 'Other' };
  const genderText = genderMap[artistData.gender] || artistData.gender || 'Not specified';

  // Apply pattern background
  container.style.cssText = 'display: block; min-height: 100vh; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%); padding: 24px;';

  container.innerHTML = `
    <div style="max-width: 1400px; margin: 0 auto;">

      <!-- ==================== MOBILE LAYOUT ==================== -->
      <div id="mobile-artist-own-profile" class="lg:hidden" style="padding: 0 0 100px;">

        <!-- Profile Photo -->
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
          <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; border: 3px solid #1a1a2e;">
            <img src="${profilePicUrl}" alt="${artistName}" style="width: 100%; height: 100%; object-fit: cover; background: #f3f4f6;">
          </div>
        </div>

        <!-- Name -->
        <h1 style="font-size: 28px; font-weight: 700; color: #1a1a2e; text-align: center; margin-bottom: 16px;">${artistName}</h1>

        <!-- Meta Info -->
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span>${age ? `${age} years old` : 'Age unknown'}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span>${genderText}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>${artistData.location || 'Location unknown'}</span>
          </div>
        </div>

        <!-- Genres -->
        <div style="margin-bottom: 20px;">
          <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Genres</p>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${renderGenreBadges(artistData.genres || [])}
          </div>
        </div>

        <!-- Languages -->
        <div style="margin-bottom: 24px;">
          <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Languages</p>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${renderLanguageBadges(artistData.languages || [])}
          </div>
        </div>

        <!-- Edit Profile Button (replaces Send Message) -->
        <button id="mobile-edit-own-profile-btn"
                style="width: 100%; padding: 14px; background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
          Bewerk Profiel
        </button>

        <!-- Biography -->
        <div style="margin-bottom: 20px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Biography</h2>
          <p style="font-size: 15px; color: #4a4a68; line-height: 1.6;">${artistData.bio || 'No biography available.'}</p>
        </div>

        <!-- Pitch -->
        <div style="margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Pitch</h2>
          <p style="font-size: 15px; color: #4a4a68; line-height: 1.6;">${artistData.pitch || 'No pitch available.'}</p>
        </div>

        <!-- Recommendations (Read-only) -->
        <div>
          <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Recommendations</h2>
          <div id="mobile-own-profile-recommendations" style="display: flex; flex-direction: column; gap: 12px;">
            <p style="color: #9ca3af; font-size: 14px;">Loading recommendations...</p>
          </div>
        </div>

      </div>

      <!-- ==================== DESKTOP 3-COLUMN LAYOUT ==================== -->
      <div id="desktop-artist-own-profile" class="hidden lg:grid" style="grid-template-columns: 280px 1fr 320px; gap: 24px; align-items: start;">

        <!-- LEFT COLUMN: Media Gallery -->
        <aside style="background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1);">
          <h2 style="font-size: 20px; font-weight: 700; color: #1a1a2e; margin-bottom: 20px;">Media Gallery</h2>
          <div id="own-profile-media-gallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            ${renderMediaGallery(artistData)}
          </div>
        </aside>

        <!-- MIDDLE COLUMN: Artist Profile -->
        <main style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1);">

          <!-- Profile Header -->
          <div style="display: flex; gap: 24px; margin-bottom: 24px;">
            <div style="flex-shrink: 0;">
              <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; border: 4px solid #805ad5;">
                <img src="${profilePicUrl}" alt="${artistName}" style="width: 100%; height: 100%; object-fit: cover;">
              </div>
            </div>
            <div style="flex: 1;">
              <h1 style="font-size: 32px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px;">${artistName}</h1>
              <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  <span>${age ? `${age} years old` : 'Age unknown'}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  <span>${genderText}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span>${artistData.location || 'Location unknown'}</span>
                </div>
              </div>
              <div style="margin-bottom: 12px;">
                <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Genres</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${renderGenreBadges(artistData.genres || [])}
                </div>
              </div>
              <div>
                <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Languages</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${renderLanguageBadges(artistData.languages || [])}
                </div>
              </div>
            </div>
          </div>

          <!-- Biography Section -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e9e3f5;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px;">Biography</h3>
            <p style="font-size: 14px; color: #4a4a68; line-height: 1.7;">${artistData.bio || 'No biography available.'}</p>
            <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin: 20px 0 12px;">Pitch</h3>
            <p style="font-size: 14px; color: #4a4a68; line-height: 1.7;">${artistData.pitch || 'No pitch available.'}</p>
          </div>

          <!-- Recommendations Section (Read-only) -->
          <div>
            <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Recommendations</h3>
            <div id="desktop-own-profile-recommendations" style="display: flex; flex-direction: column; gap: 12px;">
              <p style="color: #9ca3af; font-size: 14px;">Loading recommendations...</p>
            </div>
          </div>

        </main>

        <!-- RIGHT COLUMN: Profile Management (replaces Chat Panel) -->
        <aside style="background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1);">
          <h2 style="font-size: 20px; font-weight: 700; color: #1a1a2e; margin-bottom: 20px;">Profiel Beheren</h2>
          <button id="artist-edit-own-profile-btn" style="width: 100%; padding: 16px; background: #805ad5; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
            Bewerk Profiel
          </button>
        </aside>

      </div>
    </div>
  `;

  // Setup event handlers
  setupEditButtonHandlers();

  // Load recommendations (read-only)
  loadOwnRecommendations(artistData);

  // Force responsive layout
  handleResponsiveLayout();
  window.removeEventListener('resize', handleResponsiveLayout);
  window.addEventListener('resize', handleResponsiveLayout);

  console.log('[ARTIST OWN PROFILE] Artist own profile rendered successfully');
}

/**
 * Render genre badges
 */
function renderGenreBadges(genres) {
  if (!genres || genres.length === 0) {
    return '<span style="color: #9ca3af; font-size: 13px;">No genres specified</span>';
  }
  return genres.map(g =>
    `<span style="padding: 6px 14px; background: #f3e8ff; color: #805ad5; border-radius: 20px; font-size: 13px; font-weight: 500;">${g}</span>`
  ).join('');
}

/**
 * Render language badges
 */
function renderLanguageBadges(languages) {
  if (!languages || languages.length === 0) {
    return '<span style="color: #9ca3af; font-size: 13px;">No languages specified</span>';
  }
  return languages.map(l =>
    `<span style="padding: 6px 12px; background: #805ad5; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${(l || '').substring(0,2).toUpperCase()}</span>`
  ).join('');
}

/**
 * Render media gallery
 */
function renderMediaGallery(artist) {
  const mediaItems = [];

  // Add photos from gallery
  if (artist.galleryPhotos && artist.galleryPhotos.length > 0) {
    artist.galleryPhotos.forEach((photo) => {
      mediaItems.push(`
        <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
          <img src="${photo}" alt="Gallery photo" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      `);
    });
  }

  // Add profile pic if no gallery photos
  if (mediaItems.length === 0 && artist.profilePicUrl) {
    mediaItems.push(`
      <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
        <img src="${artist.profilePicUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    `);
  }

  // Add YouTube videos
  if (artist.youtubeVideos && artist.youtubeVideos.length > 0) {
    artist.youtubeVideos.forEach((video) => {
      const videoId = video.videoId || (video.url ? video.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/)?.[1] : null);
      if (videoId) {
        mediaItems.push(`
          <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative;">
            <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="Video" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3);">
              <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="#805ad5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>
          </div>
        `);
      }
    });
  }

  if (mediaItems.length > 0) {
    return mediaItems.join('');
  } else {
    return '<div style="grid-column: span 2; aspect-ratio: 16/9; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><span style="color: #9ca3af; font-size: 14px;">Geen media beschikbaar</span></div>';
  }
}

/**
 * Setup edit button handlers
 */
function setupEditButtonHandlers() {
  // Desktop edit button
  const desktopEditBtn = document.getElementById('artist-edit-own-profile-btn');
  if (desktopEditBtn && !desktopEditBtn.dataset.listenerAttached) {
    desktopEditBtn.addEventListener('click', async () => {
      console.log('[ARTIST OWN PROFILE] Desktop edit button clicked');
      // Update URL first
      window.history.pushState({ view: 'artist-edit-profile' }, '', '#edit-profile');
      await showProfileEditorView();
    });
    desktopEditBtn.dataset.listenerAttached = 'true';
  }

  // Mobile edit button
  const mobileEditBtn = document.getElementById('mobile-edit-own-profile-btn');
  if (mobileEditBtn && !mobileEditBtn.dataset.listenerAttached) {
    mobileEditBtn.addEventListener('click', async () => {
      console.log('[ARTIST OWN PROFILE] Mobile edit button clicked');
      // Update URL first
      window.history.pushState({ view: 'artist-edit-profile' }, '', '#edit-profile');
      await showProfileEditorView();
    });
    mobileEditBtn.dataset.listenerAttached = 'true';
  }
}

/**
 * Show profile editor view (exportable for routing)
 */
export async function showProfileEditorView() {
  const currentUserData = getStore('currentUserData');

  // Import dashboard modules
  const dashboardUI = await import('../dashboard/dashboard-ui.js');

  // Hide profile overview
  const mobileProfile = document.getElementById('mobile-artist-own-profile');
  const desktopProfile = document.getElementById('desktop-artist-own-profile');

  if (mobileProfile) mobileProfile.style.display = 'none';
  if (desktopProfile) desktopProfile.style.display = 'none';

  // Get/create editor container
  let editorContainer = document.getElementById('artist-profile-editor');
  if (!editorContainer) {
    const artistDashboard = document.getElementById('artist-dashboard');
    editorContainer = document.createElement('div');
    editorContainer.id = 'artist-profile-editor';
    artistDashboard.appendChild(editorContainer);
  }

  // Render editor
  dashboardUI.renderProfileEditor();

  // Show editor
  editorContainer.classList.remove('hidden');
  editorContainer.style.display = 'block';

  // Populate with current data
  if (currentUserData) {
    dashboardUI.populateProfileEditor(currentUserData);
  }

  // Setup form handlers
  setupEditorFormHandlers();

  // Re-initialize Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * Setup form handlers for editor
 */
function setupEditorFormHandlers() {
  // Form submission
  const form = document.getElementById('artist-profile-form');
  if (form && !form.dataset.listenerAttached) {
    form.addEventListener('submit', async (e) => {
      await handleOwnProfileSubmit(e);
    });
    form.dataset.listenerAttached = 'true';
  }

  // Cancel button - navigate back to profile with correct URL
  const cancelBtn = document.getElementById('cancel-edit-profile-btn');
  if (cancelBtn && !cancelBtn.dataset.listenerAttached) {
    cancelBtn.addEventListener('click', async () => {
      // Update URL and show profile
      window.history.pushState({ view: 'artist-profile' }, '', '#profile');
      hideProfileEditor();
    });
    cancelBtn.dataset.listenerAttached = 'true';
  }

  // File input handlers
  setupProfilePicPreview();
  setupDocumentInput();

  // Setup media gallery
  import('./artist-media.js').then(module => {
    if (module.initArtistMediaGallery) {
      module.initArtistMediaGallery();
    }
  }).catch(err => {
    console.warn('[ARTIST OWN PROFILE] Media gallery module not loaded:', err);
  });
}

/**
 * Hide profile editor and show own profile view
 */
function hideProfileEditor() {
  console.log('[ARTIST OWN PROFILE] Hiding profile editor');

  const editorContainer = document.getElementById('artist-profile-editor');
  const mobileProfile = document.getElementById('mobile-artist-own-profile');
  const desktopProfile = document.getElementById('desktop-artist-own-profile');

  // Hide editor
  if (editorContainer) {
    editorContainer.classList.add('hidden');
    editorContainer.style.display = 'none';
  }

  // Show profile again
  if (mobileProfile) mobileProfile.style.display = 'block';
  if (desktopProfile) {
    desktopProfile.classList.remove('hidden');
    desktopProfile.style.display = 'grid';
  }

  // Refresh profile data
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    renderArtistOwnProfile(currentUserData);
  }
}

/**
 * Handle profile form submission for own profile view
 */
async function handleOwnProfileSubmit(e) {
  e.preventDefault();

  const successMsg = document.getElementById('artist-profile-success');
  const errorMsg = document.getElementById('artist-profile-error');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

  // Reset messages
  successMsg.textContent = '';
  errorMsg.textContent = '';

  // Disable button
  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }

    const uid = currentUser.uid;

    // Import getCheckboxValues from dashboard-ui
    const { getCheckboxValues } = await import('../dashboard/dashboard-ui.js');

    // Collect checkbox values
    const genres = getCheckboxValues('artist-edit-genres');
    const languages = getCheckboxValues('artist-edit-languages');
    const paymentMethods = getCheckboxValues('artist-edit-payment');

    // Validate checkbox groups
    if (genres.length === 0) {
      throw new Error("Please select at least one genre");
    }
    if (languages.length === 0) {
      throw new Error("Please select at least one language");
    }
    if (paymentMethods.length === 0) {
      throw new Error("Please select at least one payment method");
    }

    // Collect all form data
    const profileData = {
      // Personal Details
      firstName: document.getElementById('artist-edit-firstname').value.trim(),
      lastName: document.getElementById('artist-edit-lastname').value.trim(),
      stageName: document.getElementById('artist-edit-stagename').value.trim(),
      phone: document.getElementById('artist-edit-phone').value.trim(),
      dob: document.getElementById('artist-edit-dob').value,
      gender: document.getElementById('artist-edit-gender').value,
      location: document.getElementById('artist-edit-location').value.trim(),

      // Professional Details
      genres: genres,
      languages: languages,
      themes: getCheckboxValues('theme'),
      energyLevels: getCheckboxValues('energy'),
      formats: getCheckboxValues('format'),
      paymentMethods: paymentMethods,
      bio: document.getElementById('artist-edit-bio').value.trim(),
      pitch: document.getElementById('artist-edit-pitch').value.trim(),

      // Media
      videoUrl: document.getElementById('artist-edit-video').value.trim(),
      audioUrl: document.getElementById('artist-edit-audio').value.trim(),
      textContent: document.getElementById('artist-edit-text').value.trim(),

      // Notification Settings
      notifyEmail: document.getElementById('artist-edit-notify-email').checked,
      notifySms: document.getElementById('artist-edit-notify-sms').checked
    };

    // Validate required fields
    if (!profileData.firstName || !profileData.lastName || !profileData.phone ||
      !profileData.dob || !profileData.gender || !profileData.location ||
      !profileData.bio || !profileData.pitch) {
      throw new Error("Please fill in all required fields (marked with *)");
    }

    // Get file inputs
    const profilePicInput = document.getElementById('artist-edit-profile-pic');
    const documentInput = document.getElementById('artist-edit-document');
    const profilePicFile = profilePicInput?.files[0];
    const documentFile = documentInput?.files[0];

    // Import updateArtistProfile
    const { updateArtistProfile } = await import('../dashboard/dashboard-service.js');

    // Update profile
    const updatedData = await updateArtistProfile(uid, profileData, profilePicFile, documentFile);

    // Update local store
    const currentUserData = getStore('currentUserData');
    const { setStore } = await import('../../utils/store.js');
    setStore('currentUserData', { ...currentUserData, ...updatedData });

    // Show success message
    successMsg.textContent = '‚úì Profile updated successfully!';

    // Clear file inputs
    if (profilePicFile && profilePicInput) {
      profilePicInput.value = '';
    }
    if (documentFile && documentInput) {
      documentInput.value = '';
      const filenameSpan = document.getElementById('artist-document-filename');
      if (filenameSpan) filenameSpan.textContent = 'No file chosen';
    }

    // Wait a moment, then return to own profile view
    setTimeout(async () => {
      // Hide editor
      const editor = document.getElementById('artist-profile-editor');
      if (editor) editor.classList.add('hidden');

      // Update URL
      window.history.pushState({ view: 'artist-profile' }, '', '#profile');

      // Restore navigation FIRST
      const navModule = await import('../navigation/navigation.js');
      navModule.setNavigationVisibility(true);
      navModule.renderDesktopNav();
      navModule.renderMobileNav();

      // Then show profile
      const { showArtistOwnProfile } = await import('../../ui/ui.js');
      if (showArtistOwnProfile) {
        showArtistOwnProfile();
      }

      // Re-initialize icons
      if (window.lucide) {
        setTimeout(() => lucide.createIcons(), 100);
      }

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 1000);

  } catch (error) {
    console.error("[ARTIST OWN PROFILE] Error saving profile:", error);
    errorMsg.textContent = 'Error: ' + error.message;
    errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Save All Changes';
  }
}

/**
 * Setup profile picture preview
 */
function setupProfilePicPreview() {
  const fileInput = document.getElementById('artist-edit-profile-pic');
  const previewImg = document.getElementById('artist-profile-pic-preview');

  if (!fileInput || !previewImg) return;

  // Remove existing listener if any
  const newFileInput = fileInput.cloneNode(true);
  fileInput.parentNode.replaceChild(newFileInput, fileInput);

  newFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        newFileInput.value = '';
        return;
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        newFileInput.value = '';
        return;
      }

      // Show preview
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

/**
 * Setup document input
 */
function setupDocumentInput() {
  const fileInput = document.getElementById('artist-edit-document');
  const filenameSpan = document.getElementById('artist-document-filename');

  if (!fileInput || !filenameSpan) return;

  // Remove existing listener if any
  const newFileInput = fileInput.cloneNode(true);
  fileInput.parentNode.replaceChild(newFileInput, fileInput);

  newFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        newFileInput.value = '';
        filenameSpan.textContent = 'No file chosen';
        return;
      }

      // Validate file type
      const validTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      ];

      if (!validTypes.includes(file.type)) {
        alert('Please select a PDF, DOC, or DOCX file');
        newFileInput.value = '';
        filenameSpan.textContent = 'No file chosen';
        return;
      }

      filenameSpan.textContent = file.name;
    } else {
      filenameSpan.textContent = 'No file chosen';
    }
  });
}

/**
 * Load recommendations for this artist (read-only)
 */
async function loadOwnRecommendations(artist) {
  const mobileContainer = document.getElementById('mobile-own-profile-recommendations');
  const desktopContainer = document.getElementById('desktop-own-profile-recommendations');

  if (!mobileContainer && !desktopContainer) return;

  try {
    const { collection, query, where, orderBy, getDocs } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');

    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error('No current user');
    }

    const recsRef = collection(db, 'recommendations');
    const q = query(
      recsRef,
      where('artistId', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    );

    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      const emptyHTML = '<p style="color: #9ca3af; font-size: 14px;">Nog geen recommendations.</p>';
      if (mobileContainer) mobileContainer.innerHTML = emptyHTML;
      if (desktopContainer) desktopContainer.innerHTML = emptyHTML;
      return;
    }

    let recsHTML = '';
    snapshot.forEach(doc => {
      const rec = doc.data();
      const date = rec.createdAt?.toDate?.() || new Date();
      const formattedDate = date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });

      recsHTML += `
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;">
          <div style="margin-bottom: 8px;">
            <p style="font-size: 15px; font-weight: 600; color: #1a1a2e;">${rec.authorName || 'Anonymous'}</p>
            <p style="font-size: 13px; color: #9ca3af;">${formattedDate}</p>
          </div>
          <p style="font-size: 14px; color: #4a4a68; line-height: 1.6;">"${rec.text || rec.content || ''}"</p>
        </div>
      `;
    });

    if (mobileContainer) mobileContainer.innerHTML = recsHTML;
    if (desktopContainer) desktopContainer.innerHTML = recsHTML;

  } catch (error) {
    console.error('[RECOMMENDATIONS] Error loading:', error);
    const errorHTML = '<p style="color: #9ca3af; font-size: 14px;">Kon recommendations niet laden.</p>';
    if (mobileContainer) mobileContainer.innerHTML = errorHTML;
    if (desktopContainer) desktopContainer.innerHTML = errorHTML;
  }
}

/**
 * Handle responsive layout
 */
function handleResponsiveLayout() {
  const isDesktop = window.innerWidth >= 1024;
  const mobileLayout = document.getElementById('mobile-artist-own-profile');
  const desktopLayout = document.getElementById('desktop-artist-own-profile');

  if (mobileLayout) {
    mobileLayout.style.display = isDesktop ? 'none' : 'block';
  }

  if (desktopLayout) {
    desktopLayout.classList.remove('hidden');
    desktopLayout.style.display = isDesktop ? 'grid' : 'none';
  }
}
</file>

<file path="src/modules/messaging/messaging-controller.js">
/**
 * messaging-controller.js
 * Controller/Event Handler Layer for Messaging
 * Handles all user interactions, event listeners, and orchestrates service + UI layers
 */

import {
  findExistingConversation,
  createConversation,
  addMessage,
  fetchConversations,
  fetchMessages,
  fetchConversation,
  fetchUserProfile,
  markConversationAsRead,
  setupConversationsListener
} from './messaging-service.js';

import {
  displayConversations,
  displayMessages,
  appendMessageToUI,
  updateUnreadBadge,
  scrollToBottom,
  showProgrammerProfileModal
} from './messaging-ui.js';

import { getStore } from '../../utils/store.js';
import { showErrorToast, showSuccessToast } from '../../ui/toast.js';

// Globale variabele om de huidige artiest bij te houden
let currentArtistForMessage = null;

// Global variable to store the unsubscribe function for badge listener
let badgeListenerUnsubscribe = null;

/**
 * Opent de message modal voor een specifieke artiest
 * @param {object} artist - Het artiest object
 */
export function openMessageModal(artist) {
  const modal = document.getElementById('message-modal');
  const artistNameSpan = document.getElementById('message-artist-name');
  const messageError = document.getElementById('message-error');
  const messageSuccess = document.getElementById('message-success');

  // Sla de artiest op voor later gebruik
  currentArtistForMessage = artist;

  // Update de modal
  artistNameSpan.textContent = artist.stageName || `${artist.firstName} ${artist.lastName}`;

  // Reset form en messages
  document.getElementById('send-message-form').reset();
  messageError.style.display = 'none';
  messageSuccess.style.display = 'none';

  // Toon modal
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Activeer Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

/**
 * Sluit de message modal
 */
function closeMessageModal() {
  const modal = document.getElementById('message-modal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  currentArtistForMessage = null;
}

/**
 * Verwerkt het versturen van een bericht
 */
async function handleSendMessage(e) {
  e.preventDefault();

  const messageError = document.getElementById('message-error');
  const messageSuccess = document.getElementById('message-success');
  const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

  // Reset messages
  messageError.style.display = 'none';
  messageSuccess.style.display = 'none';

  // Disable button
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i data-lucide="loader" class="h-4 w-4 mr-2 animate-spin"></i>Sending...';

  try {
    // Haal gegevens op
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser || !currentUserData) {
      throw new Error('User not logged in');
    }

    if (!currentArtistForMessage) {
      throw new Error('No artist selected');
    }

    const subject = document.getElementById('message-subject').value.trim();
    const messageText = document.getElementById('message-text').value.trim();

    if (!subject || !messageText) {
      throw new Error('Please fill in all fields');
    }

    // Check of er al een conversatie bestaat tussen deze twee users
    const existingConversation = await findExistingConversation(
      currentUser.uid,
      currentArtistForMessage.uid || currentArtistForMessage.id
    );

    let conversationId;

    if (existingConversation) {
      // Gebruik bestaande conversatie
      conversationId = existingConversation.id;
    } else {
      // Maak nieuwe conversatie aan
      conversationId = await createConversation(
        currentUser.uid,
        currentUserData,
        currentArtistForMessage,
        subject
      );
    }

    // Voeg bericht toe aan conversatie
    await addMessage(conversationId, currentUser.uid, currentUserData, messageText);

    // Toon success bericht
    messageSuccess.textContent = 'Message sent successfully!';
    messageSuccess.style.display = 'block';

    // Sluit modal na 2 seconden
    setTimeout(() => {
      closeMessageModal();
    }, 2000);

  } catch (error) {
    console.error("Error sending message:", error);
    const errorMessage = error.message || 'Failed to send message. Please try again.';
    messageError.textContent = errorMessage;
    messageError.style.display = 'block';

    // Show toast notification
    showErrorToast(errorMessage);

    // Re-enable button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4 mr-2"></i>Send Message';
    if (window.lucide) {
      window.lucide.createIcons();
    }
  }
}

/**
 * Laadt alle conversaties voor de ingelogde gebruiker
 */
export async function loadConversations() {
  const currentUser = getStore('currentUser');

  if (!currentUser) {
    console.error("No user logged in");
    return;
  }

  const loadingEl = document.getElementById('conversations-loading');
  const emptyEl = document.getElementById('conversations-empty');
  const listEl = document.getElementById('conversations-list');

  // Mobile elements
  const mobileLoadingEl = document.getElementById('mobile-conversations-loading');
  const mobileEmptyEl = document.getElementById('mobile-conversations-empty');
  const mobileListEl = document.getElementById('mobile-conversations-list');

  // Show loading skeleton for desktop
  if (loadingEl) {
    loadingEl.innerHTML = `
      <div class="space-y-3 animate-pulse">
        ${Array(4).fill(0).map(() => `
          <div class="bg-white rounded-xl p-4 border border-gray-100">
            <div class="flex items-center gap-3">
              <div class="h-12 w-12 bg-gray-200 rounded-full"></div>
              <div class="flex-1 space-y-2">
                <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                <div class="h-2 bg-gray-200 rounded w-1/2"></div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    loadingEl.style.display = 'block';
  }
  if (emptyEl) emptyEl.style.display = 'none';
  if (listEl) {
    listEl.style.display = 'none';
    listEl.innerHTML = '';
  }

  // Show loading skeleton for mobile
  if (mobileLoadingEl) {
    mobileLoadingEl.innerHTML = `
      <div class="space-y-3 animate-pulse">
        ${Array(3).fill(0).map(() => `
          <div class="bg-white rounded-xl p-4 border border-gray-100">
            <div class="flex items-center gap-3">
              <div class="h-12 w-12 bg-gray-200 rounded-full"></div>
              <div class="flex-1 space-y-2">
                <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                <div class="h-2 bg-gray-200 rounded w-1/2"></div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    mobileLoadingEl.style.display = 'block';
  }
  if (mobileEmptyEl) mobileEmptyEl.classList.add('hidden');
  if (mobileListEl) {
    mobileListEl.classList.add('hidden');
    mobileListEl.innerHTML = '';
  }

  try {
    const conversations = await fetchConversations(currentUser.uid);

    // Verberg loading
    if (loadingEl) loadingEl.style.display = 'none';
    if (mobileLoadingEl) mobileLoadingEl.style.display = 'none';

    if (conversations.length === 0) {
      // Toon empty state
      if (emptyEl) emptyEl.style.display = 'block';
      if (mobileEmptyEl) mobileEmptyEl.classList.remove('hidden');
    } else {
      // Toon conversaties (desktop en mobile)
      await displayConversations(
        conversations,
        currentUser.uid
      );

      // Setup click handlers via event delegation
      setupConversationClickHandlers();
    }

    // Update unread badge
    updateUnreadBadge(conversations, currentUser.uid);

  } catch (error) {
    console.error("Error loading conversations:", error);
    const errorMessage = error.message || 'Error loading conversations. Please refresh the page.';

    if (loadingEl) {
      loadingEl.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-500">Error loading conversations. Please refresh the page.</p>
          <p class="text-sm text-gray-500 mt-2">${error.message}</p>
        </div>
      `;
    }

    // Show toast notification
    showErrorToast(errorMessage);
  }
}

/**
 * Setup click handlers for conversation cards using event delegation
 * This avoids callback issues in minified builds
 */
function setupConversationClickHandlers() {
  const desktopListEl = document.getElementById('conversations-list');
  const mobileListEl = document.getElementById('mobile-conversations-list');

  // Setup desktop click handler
  if (desktopListEl) {
    // Remove existing listener to prevent duplicates
    desktopListEl.removeEventListener('click', handleDesktopConversationClick);
    desktopListEl.addEventListener('click', handleDesktopConversationClick);
    console.log('[MESSAGING] Desktop conversation click handlers attached');
  }

  // Setup mobile click handler
  if (mobileListEl) {
    // Remove existing listener to prevent duplicates
    mobileListEl.removeEventListener('click', handleMobileConversationClick);
    mobileListEl.addEventListener('click', handleMobileConversationClick);
    console.log('[MESSAGING] Mobile conversation click handlers attached');
  }
}

/**
 * Handle clicks on desktop conversation cards
 * @param {Event} e - Click event
 */
async function handleDesktopConversationClick(e) {
  const card = e.target.closest('.conversation-card');
  if (!card) return;

  e.preventDefault();
  e.stopPropagation();

  const conversationId = card.dataset.conversationId;
  const otherName = card.dataset.otherName;
  const otherRole = card.dataset.otherRole;
  const profilePic = card.dataset.profilePic;

  console.log('[MESSAGING] Desktop: Opening conversation:', conversationId);

  // Update chat header
  const chatAvatar = document.getElementById('chat-avatar');
  const chatName = document.getElementById('chat-name');
  const chatRole = document.getElementById('chat-role');

  if (chatAvatar) chatAvatar.innerHTML = '<img src="' + profilePic + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  if (chatName) chatName.textContent = otherName;
  if (chatRole) chatRole.textContent = otherRole;

  // Show chat container, hide placeholder
  const chatPlaceholder = document.getElementById('chat-placeholder');
  const chatContainer = document.getElementById('chat-container');

  if (chatPlaceholder) chatPlaceholder.style.display = 'none';
  if (chatContainer) {
    chatContainer.style.display = 'flex';
    chatContainer.dataset.conversationId = conversationId;
  }

  // Highlight selected conversation
  const desktopList = document.getElementById('conversations-list');
  if (desktopList) {
    desktopList.querySelectorAll('.conversation-card').forEach(c => {
      c.style.background = 'white';
      c.style.borderColor = 'rgba(128, 90, 213, 0.08)';
    });
    card.style.background = '#faf5ff';
    card.style.borderColor = 'rgba(128, 90, 213, 0.25)';
  }

  // Load messages
  try {
    const currentUser = getStore('currentUser');
    if (currentUser) {
      await markConversationAsRead(conversationId, currentUser.uid);
    }
    await loadMessages(conversationId);
  } catch (err) {
    console.error('[MESSAGING] Error loading conversation:', err);
  }
}

/**
 * Handle clicks on mobile conversation cards
 * @param {Event} e - Click event
 */
async function handleMobileConversationClick(e) {
  const card = e.target.closest('.conversation-card');
  if (!card) return;

  e.preventDefault();
  e.stopPropagation();

  const conversationId = card.dataset.conversationId;
  const otherName = card.dataset.otherName;
  const otherRole = card.dataset.otherRole;
  const profilePic = card.dataset.profilePic;

  console.log('[MESSAGING] Mobile: Opening conversation:', conversationId);

  // Show mobile chat view
  const listView = document.getElementById('mobile-conversations-view');
  const chatView = document.getElementById('mobile-chat-view');
  if (listView) listView.style.display = 'none';
  if (chatView) chatView.style.display = 'flex';

  // Update mobile header
  const avatar = document.getElementById('mobile-chat-avatar');
  const name = document.getElementById('mobile-chat-name');
  const role = document.getElementById('mobile-chat-role');
  if (avatar) avatar.innerHTML = `<img src="${profilePic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
  if (name) name.textContent = otherName;
  if (role) role.textContent = otherRole;

  // Open conversation
  await openConversation(conversationId);
}

/**
 * Opent de conversation detail view voor een specifieke conversatie
 * @param {string} conversationId - Conversation ID
 */
export async function openConversation(conversationId) {
  try {
    const currentUser = getStore('currentUser');

    if (!currentUser) {
      console.error("No user logged in");
      return;
    }

    // Haal conversatie data op
    const conversation = await fetchConversation(conversationId);

    if (!conversation) {
      console.error("Conversation not found:", conversationId);
      alert("Conversation not found.");
      return;
    }

    // Bepaal de andere participant
    const otherParticipantId = conversation.participants.find(id => id !== currentUser.uid);
    const otherParticipantName = conversation.participantNames[otherParticipantId] || 'Unknown';
    const otherParticipantRole = conversation.participantRoles[otherParticipantId] || '';

    // Fetch profile picture
    const profilePicUrl = conversation.participantProfilePics?.[otherParticipantId] ||
      `https://placehold.co/48x48/e9d5ff/805ad5?text=${encodeURIComponent(otherParticipantName.charAt(0))}`;

    // Update desktop chat header
    const chatAvatar = document.getElementById('chat-avatar');
    const chatName = document.getElementById('chat-name');
    const chatRole = document.getElementById('chat-role');

    if (chatAvatar) chatAvatar.innerHTML = `<img src="${profilePicUrl}" style="width:100%;height:100%;object-fit:cover;">`;
    if (chatName) chatName.textContent = otherParticipantName;
    if (chatRole) chatRole.textContent = otherParticipantRole;

    // Show chat container, hide placeholder
    const chatPlaceholder = document.getElementById('chat-placeholder');
    const chatContainer = document.getElementById('chat-container');

    if (chatPlaceholder) chatPlaceholder.style.display = 'none';
    if (chatContainer) {
      chatContainer.style.display = 'flex';
      chatContainer.dataset.conversationId = conversationId;
    }

    // Mobile: Show mobile chat view
    const mobileChatView = document.getElementById('mobile-chat-view');

    if (mobileChatView) {
      mobileChatView.style.display = 'flex';
      mobileChatView.dataset.conversationId = conversationId;
    }

    // Update mobile chat header
    const mobileChatAvatar = document.getElementById('mobile-chat-avatar');
    const mobileChatName = document.getElementById('mobile-chat-name');
    const mobileChatRole = document.getElementById('mobile-chat-role');

    if (mobileChatAvatar) {
      mobileChatAvatar.innerHTML = `<img src="${profilePicUrl}" alt="${otherParticipantName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`;
    }
    if (mobileChatName) mobileChatName.textContent = otherParticipantName;
    if (mobileChatRole) mobileChatRole.textContent = otherParticipantRole;

    // Markeer conversatie als gelezen
    await markConversationAsRead(conversationId, currentUser.uid);

    // Laad berichten
    await loadMessages(conversationId);

    // Activeer Lucide icons
    if (window.lucide) {
      window.lucide.createIcons();
    }

  } catch (error) {
    console.error("Error opening conversation:", error);
    alert("Could not open conversation: " + error.message);
  }
}

/**
 * Laadt alle berichten van een conversatie
 * @param {string} conversationId - Conversation ID
 */
export async function loadMessages(conversationId) {
  const messagesContainer = document.getElementById('messages-container');

  if (!messagesContainer) {
    console.error("Messages container not found");
    return;
  }

  // Show loading state
  messagesContainer.innerHTML = '<p class="text-center text-gray-500">Loading messages...</p>';

  try {
    const messages = await fetchMessages(conversationId);
    const currentUser = getStore('currentUser');

    if (!currentUser) {
      throw new Error('No user logged in');
    }

    // Display messages
    displayMessages(messages, currentUser.uid);

  } catch (error) {
    console.error("Error loading messages:", error);
    messagesContainer.innerHTML = `
      <div class="text-center py-8">
        <p class="text-red-500">Error loading messages. Please refresh the page.</p>
        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
      </div>
    `;
  }
}

/**
 * Handle inline message form submit (for replying in existing conversations)
 * This is now called from global event delegation in ui.js
 * @param {Event} e - Form submit event
 */
async function handleInlineMessageSubmit(e) {
  e.preventDefault();

  const messageInput = document.getElementById('message-input');
  const messageText = messageInput.value.trim();

  if (!messageText) return;

  const chatContainer = document.getElementById('chat-container');
  const conversationId = chatContainer.dataset.conversationId;

  if (!conversationId) {
    console.error("No conversation ID found");
    return;
  }

  try {
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser || !currentUserData) {
      throw new Error('User not logged in');
    }

    // Send message
    await addMessage(conversationId, currentUser.uid, currentUserData, messageText);

    // Clear input
    messageInput.value = '';

    // Reload messages
    await loadMessages(conversationId);

    // Scroll to bottom
    scrollToBottom();

  } catch (error) {
    console.error("Error sending message:", error);
    alert("Failed to send message. Please try again.");
  }
}

/**
 * Bekijk het profiel van een gebruiker (programmer of artist)
 * @param {string} userId - User ID
 * @param {string} role - User role ('programmer' or 'artist')
 */
async function viewUserProfile(userId, role) {
  console.log("Viewing profile:", userId, role);

  try {
    if (role === 'programmer') {
      // Fetch programmer data
      const programmer = await fetchUserProfile(userId, 'programmer');

      if (!programmer) {
        alert('Programmer profile not found.');
        return;
      }

      // Display programmer profile modal
      showProgrammerProfileModal(programmer);

    } else if (role === 'artist') {
      // For artists, we can reuse the existing artist detail view
      const currentUserData = getStore('currentUserData');

      if (currentUserData && currentUserData.role === 'programmer') {
        // We're a programmer viewing an artist
        const artist = await fetchUserProfile(userId, 'artist');

        if (!artist) {
          alert('Artist profile not found.');
          return;
        }

        alert(`Artist Profile:\n\nName: ${artist.stageName || artist.firstName + ' ' + artist.lastName}\nLocation: ${artist.location}\nGenres: ${artist.genres?.join(', ')}\n\nClick on the artist in the search to see full profile.`);
      }
    }

  } catch (error) {
    console.error("Error viewing profile:", error);
    alert('Could not load profile: ' + error.message);
  }
}

/**
 * Setup real-time badge listener voor unread conversations
 * Deze functie moet worden aangeroepen na login
 */
export function setupBadgeListener() {
  const currentUser = getStore('currentUser');

  if (!currentUser) {
    console.log("No user logged in, skipping badge listener setup");
    return;
  }

  console.log("Setting up real-time badge listener for:", currentUser.uid);

  // Setup real-time listener
  badgeListenerUnsubscribe = setupConversationsListener(currentUser.uid, (conversations) => {
    // Update badge met unread count
    updateUnreadBadge(conversations, currentUser.uid);

    console.log(`Badge updated: ${conversations.filter(c => c.unreadBy && c.unreadBy.includes(currentUser.uid)).length} unread`);
  });

  return badgeListenerUnsubscribe;
}

/**
 * Stop de badge listener (bij logout)
 */
export function stopBadgeListener() {
  if (badgeListenerUnsubscribe) {
    badgeListenerUnsubscribe();
    badgeListenerUnsubscribe = null;
    console.log("Badge listener stopped");
  }
}

/**
 * Handle mobile message form submit
 * @param {Event} e - Form submit event
 */
async function handleMobileMessageSubmit(e) {
  e.preventDefault();

  const input = document.getElementById('mobile-message-input');
  const messageText = input?.value.trim();

  if (!messageText) return;

  const mobileChatView = document.getElementById('mobile-chat-view');
  const conversationId = mobileChatView?.dataset.conversationId;

  if (!conversationId) {
    console.error("No conversation ID found");
    return;
  }

  try {
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser || !currentUserData) {
      throw new Error('User not logged in');
    }

    // Send message
    await addMessage(conversationId, currentUser.uid, currentUserData, messageText);

    // Clear input
    input.value = '';

    // Reload messages
    await loadMessages(conversationId);

  } catch (error) {
    console.error("Error sending mobile message:", error);
    showErrorToast("Failed to send message. Please try again.");
  }
}

/**
 * Initialiseert de messaging event listeners
 */
export function setupMessaging() {
  // Close modal buttons
  const closeBtn = document.getElementById('close-message-modal');
  const cancelBtn = document.getElementById('cancel-message-btn');

  if (closeBtn) {
    closeBtn.addEventListener('click', closeMessageModal);
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeMessageModal);
  }

  // Form submit
  const messageForm = document.getElementById('send-message-form');
  if (messageForm) {
    messageForm.addEventListener('submit', handleSendMessage);
  }

  // Note: Inline message form (message-form) is handled by global event delegation in ui.js
  // to avoid conflicts and duplicate listeners

  // Close modal when clicking outside
  const modal = document.getElementById('message-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeMessageModal();
      }
    });
  }

  // Mobile back button handler
  document.addEventListener('click', (e) => {
    if (e.target.closest('#mobile-back-btn')) {
      const listView = document.getElementById('mobile-conversations-view');
      const chatView = document.getElementById('mobile-chat-view');
      if (chatView) chatView.style.display = 'none';
      if (listView) listView.style.display = 'block';
    }
  });

  // Mobile message form
  const mobileMessageForm = document.getElementById('mobile-message-form');
  if (mobileMessageForm) {
    mobileMessageForm.addEventListener('submit', handleMobileMessageSubmit);
  }

  // FAB new message button
  const fabNewMessage = document.getElementById('mobile-new-message-fab');
  if (fabNewMessage) {
    fabNewMessage.addEventListener('click', () => {
      console.log('FAB new message clicked');
      showSuccessToast('New message feature coming soon!');
    });
  }

  // Fallback event listener for conversation clicks (minified build safety)
  window.addEventListener('openConversation', async (e) => {
    const { conversationId } = e.detail;
    if (conversationId) {
      console.log('[MESSAGING] Fallback: Opening conversation via event:', conversationId);
      await openConversation(conversationId);
    }
  });

  console.log("Messaging listeners ingesteld.");
}

// Export the addMessage function for use in other modules (like recommendations.js)
export { addMessage } from './messaging-service.js';
export { appendMessageToUI } from './messaging-ui.js';

// Export sendRecommendationNotification for use in recommendations.js
export { sendRecommendationNotification } from './messaging-service.js';
</file>

<file path="src/modules/messaging/messaging-ui.js">
/**
 * messaging-ui.js
 * UI/Rendering Layer for Messaging
 * Handles all HTML generation and DOM manipulation for messaging views
 */

import { fetchUserProfile } from './messaging-service.js';

/**
 * Format timestamp naar "time ago" formaat
 * @param {Date} date - Date object
 * @returns {string} Formatted time ago string
 */
export function formatTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;

  // Format as date if older than a week
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

/**
 * Toont de lijst met conversaties
 * @param {Array} conversations - Array of conversation objects
 * @param {string} currentUserId - Current user ID
 * @returns {Promise<void>}
 */
export async function displayConversations(conversations, currentUserId) {
  // Get all list containers
  const desktopList = document.getElementById('conversations-list');
  const mobileList = document.getElementById('mobile-conversations-list');
  const loadingEl = document.getElementById('conversations-loading');
  const emptyEl = document.getElementById('conversations-empty');
  const mobileEmptyEl = document.getElementById('mobile-conversations-empty');

  // Hide loading
  if (loadingEl) loadingEl.style.display = 'none';

  // Handle empty state
  if (!conversations || conversations.length === 0) {
    if (emptyEl) emptyEl.style.display = 'block';
    if (mobileEmptyEl) mobileEmptyEl.style.display = 'block';
    if (desktopList) desktopList.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';
    return;
  }

  // Hide empty states
  if (emptyEl) emptyEl.style.display = 'none';
  if (mobileEmptyEl) mobileEmptyEl.style.display = 'none';

  // Fetch profile pics
  const conversationsWithPics = await Promise.all(conversations.map(async (conv) => {
    const otherParticipantId = conv.participants.find(id => id !== currentUserId);
    const otherParticipantRole = conv.participantRoles?.[otherParticipantId] || '';

    let profilePic = conv.participantProfilePics?.[otherParticipantId];
    if (!profilePic) {
      try {
        const profile = await fetchUserProfile(otherParticipantId, otherParticipantRole);
        profilePic = profile?.profilePicUrl;
      } catch (e) { /* ignore */ }
    }

    return { ...conv, otherParticipantId, otherParticipantRole, profilePic };
  }));

  // Generate card HTML
  const generateCard = (conv) => {
    const otherName = conv.participantNames?.[conv.otherParticipantId] || 'Unknown';
    const lastMsg = conv.lastMessage || 'Geen berichten';
    const isUnread = conv.unreadBy?.includes(currentUserId);

    let timeStr = '';
    if (conv.lastMessageAt?.toDate) {
      const d = conv.lastMessageAt.toDate();
      const now = new Date();
      const diffH = Math.floor((now - d) / 3600000);
      timeStr = diffH < 24
        ? d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })
        : d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
    }

    const picUrl = conv.profilePic || `https://placehold.co/48x48/e9d5ff/805ad5?text=${encodeURIComponent(otherName.charAt(0))}`;

    return `
      <div class="conversation-card" data-conversation-id="${conv.id}" data-other-id="${conv.otherParticipantId}" data-other-name="${otherName}" data-other-role="${conv.otherParticipantRole}" data-profile-pic="${picUrl}"
        style="display: flex; align-items: center; gap: 12px; padding: 14px 12px; background: ${isUnread ? '#faf5ff' : 'white'}; border-radius: 12px; margin-bottom: 6px; cursor: pointer; border: 1px solid ${isUnread ? 'rgba(128, 90, 213, 0.25)' : 'rgba(128, 90, 213, 0.08)'}; transition: all 0.15s;">

        <div style="position: relative; flex-shrink: 0;">
          <img src="${picUrl}" alt="${otherName}" style="width: 52px; height: 52px; border-radius: 50%; object-fit: cover;">
          ${isUnread ? '<div style="position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: #805ad5; border-radius: 50%; border: 2px solid white;"></div>' : ''}
        </div>

        <div style="flex: 1; min-width: 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
            <span style="font-size: 15px; font-weight: ${isUnread ? '700' : '600'}; color: #1f2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${otherName}</span>
            <span style="font-size: 12px; color: ${isUnread ? '#805ad5' : '#9ca3af'}; flex-shrink: 0; margin-left: 8px;">${timeStr}</span>
          </div>
          <p style="font-size: 13px; color: ${isUnread ? '#4b5563' : '#9ca3af'}; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: ${isUnread ? '500' : '400'};">${lastMsg}</p>
        </div>
      </div>
    `;
  };

  const cardsHTML = conversationsWithPics.map(c => generateCard(c)).join('');

  // Render desktop (no inline event listeners - handled by event delegation)
  if (desktopList) {
    desktopList.innerHTML = cardsHTML;
    desktopList.style.display = 'block';
  }

  // Render mobile (no inline event listeners - handled by event delegation)
  if (mobileList) {
    mobileList.innerHTML = cardsHTML;
  }
}

/**
 * Toont de lijst met berichten
 * @param {Array} messages - Array of message objects
 * @param {string} currentUserId - Current user ID
 * @returns {void}
 */
export function displayMessages(messages, currentUserId) {
  const desktopContainer = document.getElementById('messages-container');
  const mobileContainer = document.getElementById('mobile-messages-container');

  const renderToContainer = (container) => {
    if (!container) return;
    container.innerHTML = '';

    if (!messages || messages.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
          <p>Nog geen berichten. Start het gesprek!</p>
        </div>
      `;
      return;
    }

    messages.forEach(msg => {
      const isOwn = msg.senderId === currentUserId;

      let timeStr = 'Zojuist';
      if (msg.createdAt?.toDate) {
        timeStr = formatTimeAgo(msg.createdAt.toDate());
      }

      const pic = msg.senderProfilePic || `https://placehold.co/36x36/e9d5ff/805ad5?text=${encodeURIComponent(msg.senderName?.charAt(0) || '?')}`;

      const div = document.createElement('div');
      div.style.cssText = `display: flex; align-items: flex-end; gap: 8px; margin-bottom: 12px; ${isOwn ? 'flex-direction: row-reverse;' : ''}`;

      div.innerHTML = `
        <img src="${pic}" alt="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
        <div style="max-width: 75%;">
          <div style="padding: 10px 14px; background: ${isOwn ? '#e9d5ff' : 'white'}; border-radius: 14px; ${isOwn ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'} ${!isOwn ? 'border: 1px solid rgba(128,90,213,0.1);' : ''}">
            <p style="font-size: 14px; color: #1f2937; margin: 0; white-space: pre-wrap; word-break: break-word;">${msg.text}</p>
          </div>
          <p style="font-size: 11px; color: #9ca3af; margin: 3px 4px 0; ${isOwn ? 'text-align: right;' : ''}">${timeStr}</p>
        </div>
      `;

      container.appendChild(div);
    });

    // Scroll to bottom
    requestAnimationFrame(() => {
      container.scrollTop = container.scrollHeight;
    });
  };

  renderToContainer(desktopContainer);
  renderToContainer(mobileContainer);
}

/**
 * Append a single message to the UI immediately (optimistic UI)
 * @param {object} message - Message object
 * @param {string} currentUserId - Current user ID
 * @returns {void}
 */
export function appendMessageToUI(message, currentUserId) {
  const messagesContainer = document.getElementById('messages-container');
  const mobileMessagesContainer = document.getElementById('mobile-messages-container');

  if (!messagesContainer && !mobileMessagesContainer) return;

  // Remove "no messages" placeholder if it exists
  if (messagesContainer) {
    const placeholder = messagesContainer.querySelector('p.text-gray-500');
    if (placeholder) placeholder.remove();
  }
  if (mobileMessagesContainer) {
    const mobilePlaceholder = mobileMessagesContainer.querySelector('p.text-gray-500');
    if (mobilePlaceholder) mobilePlaceholder.remove();
  }

  const isOwnMessage = message.senderId === currentUserId;

  // Format timestamp
  let timeAgo = 'Just now';
  if (message.createdAt && message.createdAt.toDate) {
    const date = message.createdAt.toDate();
    timeAgo = formatTimeAgo(date);
  }

  // Get profile picture with proper fallback
  const profilePic = message.senderProfilePic ||
                    'https://placehold.co/48x48/e0e7ff/6366f1?text=' +
                    encodeURIComponent(message.senderName?.charAt(0) || '?');

  // Create message bubble
  const messageDiv = document.createElement('div');
  messageDiv.className = `flex items-start space-x-3 mb-4 ${isOwnMessage ? 'flex-row-reverse space-x-reverse' : ''}`;

  messageDiv.innerHTML = `
    <div class="flex-shrink-0">
      <img src="${profilePic}"
           alt="${message.senderName}"
           class="h-10 w-10 rounded-full object-cover">
    </div>

    <div class="max-w-xl ${isOwnMessage ? 'bg-indigo-100' : 'bg-white border border-gray-100'} rounded-2xl p-4">
      <p class="text-gray-800 whitespace-pre-wrap text-sm">${message.text}</p>
      <p class="text-xs text-gray-400 mt-2">${timeAgo}</p>
    </div>
  `;

  // Append message to both containers
  if (messagesContainer) messagesContainer.appendChild(messageDiv);
  if (mobileMessagesContainer) {
    const mobileClone = messageDiv.cloneNode(true);
    mobileMessagesContainer.appendChild(mobileClone);
  }

  // Smooth scroll to the new message (keep focus on message + input field)
  // Use requestAnimationFrame for better scroll performance
  requestAnimationFrame(() => {
    if (messagesContainer) {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }
    if (mobileMessagesContainer) {
      mobileMessagesContainer.scrollTo({
        top: mobileMessagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }

    // Keep focus on input field after sending (both desktop and mobile)
    const messageInput = document.getElementById('message-input');
    const mobileMessageInput = document.getElementById('mobile-message-input');
    if (messageInput) messageInput.focus();
    if (mobileMessageInput) mobileMessageInput.focus();
  });
}

/**
 * Update all unread badges in navigation (desktop, mobile, legacy)
 * @param {Array} conversations - Array of conversation objects
 * @param {string} currentUserId - Current user ID
 * @returns {void}
 */
export function updateUnreadBadge(conversations, currentUserId) {
  // Get all badge elements
  const badgeDesktop = document.getElementById('messages-badge-desktop');
  const badgeMobile = document.getElementById('messages-badge-mobile');
  const badgeLegacy = document.getElementById('messages-badge'); // Legacy badge

  // Tel unread conversaties
  const unreadCount = conversations.filter(conv =>
    conv.unreadBy && conv.unreadBy.includes(currentUserId)
  ).length;

  console.log(`[MESSAGING] Updating badges: ${unreadCount} unread conversations`);

  // Update desktop badge
  if (badgeDesktop) {
    if (unreadCount > 0) {
      badgeDesktop.textContent = unreadCount;
      badgeDesktop.classList.remove('hidden');
    } else {
      badgeDesktop.classList.add('hidden');
    }
  }

  // Update mobile badge
  if (badgeMobile) {
    if (unreadCount > 0) {
      badgeMobile.textContent = unreadCount;
      badgeMobile.classList.remove('hidden');
    } else {
      badgeMobile.classList.add('hidden');
    }
  }

  // Update legacy badge (if it exists)
  if (badgeLegacy) {
    if (unreadCount > 0) {
      badgeLegacy.textContent = unreadCount;
      badgeLegacy.classList.remove('hidden');
    } else {
      badgeLegacy.classList.add('hidden');
    }
  }
}

/**
 * Scroll to bottom of messages container
 * @returns {void}
 */
export function scrollToBottom() {
  const messagesContainer = document.getElementById('messages-container');
  if (messagesContainer) {
    setTimeout(() => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }, 100);
  }
}

/**
 * Toon programmer profiel in een modal
 * @param {object} programmer - Programmer data object
 * @returns {void}
 */
export function showProgrammerProfileModal(programmer) {
  // Create modal element
  const modal = document.createElement('div');
  modal.id = 'programmer-profile-modal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

  const profilePic = programmer.profilePicUrl ||
                     'https://placehold.co/200x200/e0e7ff/6366f1?text=' +
                     encodeURIComponent((programmer.firstName || 'P').charAt(0));

  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <!-- Header -->
        <div class="flex items-start justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Programmer Profile</h2>
          <button id="close-programmer-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Profile Content -->
        <div class="space-y-6">
          <!-- Profile Picture & Basic Info -->
          <div class="flex items-start space-x-6">
            <img src="${profilePic}"
                 alt="${programmer.firstName}"
                 class="h-32 w-32 rounded-full object-cover flex-shrink-0">
            <div class="flex-1">
              <h3 class="text-xl font-semibold text-gray-900 mb-1">
                ${programmer.firstName} ${programmer.lastName}
              </h3>
              <p class="text-indigo-600 font-medium mb-2">${programmer.organizationName || 'Organization'}</p>
              <div class="space-y-1 text-sm text-gray-600">
                <div class="flex items-center">
                  <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                  ${programmer.email || 'No email'}
                </div>
                ${programmer.phone ? `
                  <div class="flex items-center">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    ${programmer.phone}
                  </div>
                ` : ''}
                ${programmer.website ? `
                  <div class="flex items-center">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                    <a href="${programmer.website}" target="_blank" class="text-indigo-600 hover:text-indigo-800">
                      ${programmer.website}
                    </a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>

          <!-- About Organization -->
          ${programmer.organizationAbout ? `
            <div>
              <h4 class="text-lg font-semibold text-gray-900 mb-2">About the Organization</h4>
              <p class="text-gray-700 whitespace-pre-wrap">${programmer.organizationAbout}</p>
            </div>
          ` : ''}

          <!-- Status Badge -->
          <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
            programmer.status === 'pro' ? 'bg-green-100 text-green-800' :
            programmer.status === 'trial' ? 'bg-yellow-100 text-yellow-800' :
            'bg-gray-100 text-gray-800'
          }">
            ${programmer.status === 'pro' ? '‚úì Pro Member' :
              programmer.status === 'trial' ? 'Trial Member' :
              'Pending Approval'}
          </div>
        </div>
      </div>
    </div>
  `;

  // Add to page
  document.body.appendChild(modal);

  // DOM race condition guard - check element exists before adding listener
  const closeBtn = document.getElementById('close-programmer-modal');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      modal.remove();
    });
  } else {
    console.warn('[MESSAGING] close-programmer-modal element not found in modal');
  }

  // Click outside to close
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}
</file>

<file path="src/modules/search/search-controller.js">
/**
 * search-controller.js
 * Controller that connects data and UI layers
 * Manages event listeners, user interactions, and browser history
 */

import { loadArtistsData, fetchArtistById, requireAuth, isAuthenticatedUser } from './search-data.js';
import { renderArtistSearch, renderArtists, populateArtistDetail } from './search-ui.js';
import { loadRecommendations, openRecommendationModal } from '../recommendations/recommendations.js';
import { getStore } from '../../utils/store.js';
import { showErrorToast } from '../../ui/toast.js';
import { forceSearchResultsVisible, hideProfileSectionsForSearch } from './search-visibility-fix.js';
import { loadArtistEventsForProfile } from '../calendar/calendar-controller.js';
import { renderPublicGigsSection } from '../calendar/calendar-ui.js';

/**
 * Setup artist search functionality (SECURED)
 * Sets up search button, back button, and browser history
 */
export function setupArtistSearch() {
  console.log("[SETUP ARTIST SEARCH] Starting artist search setup...");

  // ‚úÖ GUARD: Prevent duplicate setup
  const artistSearchSection = document.getElementById('artist-search-section');
  if (artistSearchSection && artistSearchSection.dataset.setupComplete === 'true') {
    console.log("[SETUP ARTIST SEARCH] Already set up, skipping");
    return;
  }

  // Desktop genre collapse/expand toggle
  const genreToggle = document.getElementById('desktop-genre-toggle');
  const genreCheckboxes = document.getElementById('desktop-genre-checkboxes');
  const genreChevron = document.getElementById('desktop-genre-chevron');

  if (genreToggle && genreCheckboxes && genreChevron) {
    genreToggle.addEventListener('click', () => {
      const isHidden = genreCheckboxes.style.display === 'none';
      genreCheckboxes.style.display = isHidden ? 'flex' : 'none';
      genreChevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    });
  }

  // Setup mobile pill filters
  setupMobileFilterPills();

  // Setup Clear Filters button
  const clearFiltersBtn = document.getElementById('clear-filters-btn');
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    console.log("[SETUP] Clear filters button listener added");
  }

  // Setup search button
  const searchButton = document.getElementById('search-artists-btn');
  if (searchButton) {
    searchButton.addEventListener('click', loadArtists);
    console.log("[SETUP] Search button listener added");
  } else {
    console.warn("[SETUP] ‚ö†Ô∏è Search button not found in DOM");
  }

  // Setup real-time filtering on filter inputs
  setupFilterListeners();

  // Setup back button for detail view
  const backToSearchBtn = document.getElementById('back-to-search-btn');
  if (backToSearchBtn) {
    backToSearchBtn.addEventListener('click', (e) => {
      e.preventDefault();

      // Security check before navigation
      if (!requireAuth()) return;

      showSearchView();
      // Update browser history
      window.history.pushState({ view: 'search' }, '', '#search');
    });
    console.log("[SETUP] Back button listener added");
  }

  // Setup browser back/forward buttons (SECURED)
  setupBrowserHistory();

  // ‚úÖ Mark setup as complete
  if (artistSearchSection) {
    artistSearchSection.dataset.setupComplete = 'true';
  }

  console.log("[SETUP ARTIST SEARCH] ‚úÖ Artist search setup complete");
}

/**
 * Setup filter change listeners for real-time filtering
 * ‚úÖ FIX: Uses event delegation to handle dynamic filter elements
 */
function setupFilterListeners() {
  const filtersSidebar = document.getElementById('filters-sidebar');
  if (!filtersSidebar) {
    console.warn("[SETUP] Filters sidebar not found");
    return;
  }

  // Check if listener already attached
  if (filtersSidebar.dataset.filtersAttached === 'true') {
    console.log("[SETUP] Filter listeners already attached");
    return;
  }

  // Debounce timer for text inputs
  let debounceTimer;
  const debouncedSearch = () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      loadArtists();
    }, 500); // Wait 500ms after user stops typing
  };

  // ‚úÖ EVENT DELEGATION: Listen on the sidebar container
  filtersSidebar.addEventListener('input', (e) => {
    const target = e.target;

    // Text inputs: name, location, age
    if (target.id === 'filter-name' ||
        target.id === 'filter-location' ||
        target.id === 'filter-age-min' ||
        target.id === 'filter-age-max') {
      debouncedSearch();
    }
  });

  filtersSidebar.addEventListener('change', (e) => {
    const target = e.target;

    // 'Alle Genres' checkbox
    if (target.id === 'genre-all') {
      if (target.checked) {
        // Uncheck all individual genre checkboxes
        const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]');
        genreCheckboxes.forEach(cb => cb.checked = false);
      }
      loadArtists();
      return;
    }

    // Individual genre checkbox
    if (target.name === 'genre-filter') {
      // Uncheck 'Alle Genres' when selecting specific genre
      const allGenresCheckbox = document.getElementById('genre-all');
      if (allGenresCheckbox && target.checked) {
        allGenresCheckbox.checked = false;
      }
      loadArtists();
      return;
    }

    // Gender select
    if (target.id === 'filter-gender') {
      loadArtists();
    }

    // Checkboxes: languages, payment methods
    if (target.name === 'language-filter' ||
        target.name === 'payment-filter') {
      loadArtists();
    }
  });

  // Mark as attached
  filtersSidebar.dataset.filtersAttached = 'true';
  console.log("[SETUP] Filter listeners added via event delegation");

  // Listen for quick genre filter event from cards
  document.addEventListener('quick-genre-filter', () => {
    loadArtists();
  });
  console.log("[SETUP] Quick genre filter listener added");
}

/**
 * Setup mobile filter pill click handlers
 * Opens horizontal sliding bar instead of bottom sheet
 */
function setupMobileFilterPills() {
  const pillGenre = document.getElementById('pill-genre');
  const pillLocation = document.getElementById('pill-location');
  const pillName = document.getElementById('pill-name');
  const pillOther = document.getElementById('pill-other');

  if (pillGenre) {
    pillGenre.addEventListener('click', () => showMobileFilterBar('genre'));
  }

  if (pillLocation) {
    pillLocation.addEventListener('click', () => showMobileFilterBar('location'));
  }

  if (pillName) {
    pillName.addEventListener('click', () => showMobileFilterBar('name'));
  }

  if (pillOther) {
    pillOther.addEventListener('click', () => showMobileFilterBar('other'));
  }

  console.log("[SETUP] Mobile filter pill listeners added (horizontal bar mode)");
}

/**
 * Show horizontal sliding filter bar for mobile
 */
function showMobileFilterBar(type) {
  const filterBar = document.getElementById('mobile-filter-bar');
  const filterBarContent = document.getElementById('mobile-filter-bar-content');

  if (!filterBar || !filterBarContent) return;

  let contentHTML = '';

  switch(type) {
    case 'genre':
      // Get current selected genres from desktop sidebar
      const selectedGenres = Array.from(document.querySelectorAll('input[name="genre-filter"]:checked'))
        .map(cb => cb.value);

      contentHTML = `
        <div class="flex flex-wrap gap-2">
          ${['performance-poetry', 'poetry-slam', 'jazz-poetry', 'rap', 'storytelling', 'comedy', '1-on-1']
            .map(genre => {
              const isSelected = selectedGenres.includes(genre);
              const displayName = getGenreDisplayName(genre);
              return `
                <button class="mobile-genre-pill px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                  isSelected
                    ? 'bg-indigo-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }" data-genre="${genre}">
                  ${displayName}
                </button>
              `;
            }).join('')}
        </div>
      `;
      break;

    case 'location':
      const currentLocation = document.getElementById('filter-location')?.value || '';
      contentHTML = `
        <input id="mobile-filter-location-input"
               type="text"
               placeholder="Bijv. Brussel, Antwerpen..."
               value="${currentLocation}"
               class="w-full px-4 py-2 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-indigo-500">
      `;
      break;

    case 'name':
      const currentName = document.getElementById('filter-name')?.value || '';
      contentHTML = `
        <input id="mobile-filter-name-input"
               type="text"
               placeholder="Naam van artiest..."
               value="${currentName}"
               class="w-full px-4 py-2 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-indigo-500">
      `;
      break;

    case 'other':
      contentHTML = `
        <select id="mobile-other-filter-select" class="w-full px-4 py-2 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <option value="">Kies filter...</option>
          <option value="gender">Geslacht</option>
          <option value="age">Leeftijd</option>
          <option value="languages">Talen</option>
          <option value="payment">Betaalmethoden</option>
        </select>
      `;
      break;
  }

  filterBarContent.innerHTML = contentHTML;
  filterBarContent.dataset.filterType = type;

  // Show bar with slide-down animation
  filterBar.classList.remove('hidden');
  setTimeout(() => {
    filterBar.style.transform = 'translateY(0)';
    filterBar.style.opacity = '1';
  }, 10);

  // Re-initialize Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }

  // Setup genre pill toggle for genre filter
  if (type === 'genre') {
    const genrePills = filterBarContent.querySelectorAll('.mobile-genre-pill');
    genrePills.forEach(pill => {
      pill.addEventListener('click', () => {
        pill.classList.toggle('bg-indigo-600');
        pill.classList.toggle('text-white');
        pill.classList.toggle('bg-gray-100');
        pill.classList.toggle('text-gray-700');
      });
    });
  }

  // Setup close button
  const closeBtn = document.getElementById('mobile-filter-bar-close');
  if (closeBtn) {
    closeBtn.onclick = () => {
      applyMobileFilterBar(type);
      hideMobileFilterBar();
    };
  }

  console.log(`[MOBILE] Filter bar opened: ${type}`);
}

/**
 * Hide horizontal filter bar
 */
function hideMobileFilterBar() {
  const filterBar = document.getElementById('mobile-filter-bar');
  if (!filterBar) return;

  filterBar.style.transform = 'translateY(-10px)';
  filterBar.style.opacity = '0';

  setTimeout(() => {
    filterBar.classList.add('hidden');
  }, 300);

  console.log("[MOBILE] Filter bar closed");
}

/**
 * Apply filters from mobile bar to desktop sidebar and reload
 */
function applyMobileFilterBar(type) {
  const filterBarContent = document.getElementById('mobile-filter-bar-content');
  if (!filterBarContent) return;

  switch(type) {
    case 'genre':
      // Get selected genres from pills
      const selectedPills = filterBarContent.querySelectorAll('.mobile-genre-pill.bg-indigo-600');
      const selectedGenres = Array.from(selectedPills).map(pill => pill.dataset.genre);

      // Sync to desktop sidebar
      const desktopGenreCheckboxes = document.querySelectorAll('input[name="genre-filter"]');
      desktopGenreCheckboxes.forEach(cb => {
        cb.checked = selectedGenres.includes(cb.value);
      });

      // Uncheck "Alle Genres"
      const allGenresCheckbox = document.getElementById('genre-all');
      if (allGenresCheckbox) allGenresCheckbox.checked = false;
      break;

    case 'location':
      const locationInput = document.getElementById('mobile-filter-location-input');
      const desktopLocation = document.getElementById('filter-location');
      if (locationInput && desktopLocation) {
        desktopLocation.value = locationInput.value;
      }
      break;

    case 'name':
      const nameInput = document.getElementById('mobile-filter-name-input');
      const desktopName = document.getElementById('filter-name');
      if (nameInput && desktopName) {
        desktopName.value = nameInput.value;
      }
      break;

    case 'other':
      // Handle "other" filters based on selection
      const selectedType = document.getElementById('mobile-other-filter-select')?.value;
      if (selectedType) {
        // Show expanded options for the selected filter type
        // This could be implemented as a second-level interaction
        console.log('Other filter selected:', selectedType);
      }
      break;
  }

  // Reload artists with new filters
  loadArtists();
  console.log(`[MOBILE] Filter bar applied: ${type}`);
}

/**
 * Helper: Get display name for genre
 */
function getGenreDisplayName(genre) {
  const map = {
    'performance-poetry': 'Performance Poetry',
    'poetry-slam': 'Poetry Slam',
    'jazz-poetry': 'Jazz Poetry',
    'rap': 'Rap',
    'storytelling': 'Storytelling',
    'comedy': 'Comedy',
    '1-on-1': '1-op-1'
  };
  return map[genre] || genre;
}

/**
 * Setup browser history management (SECURED)
 */
function setupBrowserHistory() {
  // Handle browser back/forward buttons with security
  window.addEventListener('popstate', (event) => {
    console.log("Popstate event:", event.state);

    // Security check: Block if not authenticated
    if (!isAuthenticatedUser()) {
      console.error("Popstate blocked: User not authenticated");

      // Redirect to login
      const loginView = document.getElementById('login-view');
      if (loginView) {
        loginView.style.display = 'block';
      }

      // Hide programmer views
      document.getElementById('programmer-dashboard')?.classList.add('hidden');
      document.getElementById('artist-detail-view')?.classList.add('hidden');

      return;
    }

    // Handle hash-based navigation
    const hash = window.location.hash.replace('#', '');

    switch(hash) {
      case 'search':
        // Import and call showSearch
        import('../../ui/ui.js').then(module => module.showSearch());
        break;
      case 'profile':
        import('../../ui/ui.js').then(module => module.showProfile());
        break;
      case 'messages':
        import('../../ui/ui.js').then(module => module.showMessages());
        break;
      default:
        // Handle state-based navigation (for backward compatibility)
        if (event.state) {
          if (event.state.view === 'search') {
            showSearchView();
          } else if (event.state.view === 'artist-detail' && event.state.artistId) {
            showArtistDetail(event.state.artistId, false); // false = don't push to history again
          }
        } else {
          // No state, probably initial page load or back to main
          showSearchView();
        }
    }
  });

  // Set initial state
  if (!window.history.state) {
    window.history.replaceState({ view: 'search' }, '', '#search');
  }
}

/**
 * Load artists with filters (SECURED)
 * Wrapper function that collects filter values, calls data layer, and updates UI
 */
export async function loadArtists() {
  const resultsContainer = document.getElementById('artist-list-container');
  const noResultsDiv = document.getElementById('artist-list-empty');

  if (!resultsContainer) {
    console.error("Artist list container not found!");
    return;
  }

  // Show loading skeleton
  resultsContainer.innerHTML = `
    ${Array(6).fill(0).map(() => `
      <div class="bg-white rounded-2xl shadow-sm overflow-hidden animate-pulse h-full">
        <!-- Skeleton image -->
        <div class="w-24 h-24 md:w-full md:h-64 bg-gray-200"></div>
        <!-- Skeleton content -->
        <div class="p-4 space-y-3">
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
          <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          <div class="h-3 bg-gray-200 rounded w-2/3"></div>
        </div>
      </div>
    `).join('')}
  `;
  if (noResultsDiv) noResultsDiv.classList.add('hidden');

  // Helper function to normalize values (trim, lowercase, replace spaces with dashes)
  const normalize = (value) => {
    if (!value || typeof value !== 'string') return '';
    return value.trim().toLowerCase().replace(/\s+/g, '-');
  };

  try {
    // Collect filter values from UI
    const nameFilter = document.getElementById('filter-name')?.value.toLowerCase().trim() || '';
    const locationFilter = document.getElementById('filter-location')?.value.toLowerCase().trim() || '';
    const genderFilter = document.getElementById('filter-gender')?.value || '';

    // Payment filter (using checkboxes)
    const paymentCheckboxes = document.querySelectorAll('input[name="payment-filter"]:checked');
    const paymentFilters = Array.from(paymentCheckboxes).map(cb => normalize(cb.value));

    // Genre filter (using checkboxes)
    // Check if 'Alle Genres' is selected (bypass genre filtering)
    const genreAllCheckbox = document.getElementById('genre-all');
    let genreFilters = [];
    if (genreAllCheckbox && genreAllCheckbox.checked) {
      // 'Alle Genres' is checked - bypass genre filtering
      genreFilters = null;
    } else {
      const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]:checked');
      genreFilters = Array.from(genreCheckboxes).map(cb => normalize(cb.value));
    }

    // Language filter (using checkboxes)
    const languageCheckboxes = document.querySelectorAll('input[name="language-filter"]:checked');
    const languageFilters = Array.from(languageCheckboxes).map(cb => cb.value.toLowerCase().trim());

    // Age range filter
    const ageMinInput = document.getElementById('filter-age-min')?.value;
    const ageMaxInput = document.getElementById('filter-age-max')?.value;
    const ageMin = ageMinInput ? parseInt(ageMinInput) : null;
    const ageMax = ageMaxInput ? parseInt(ageMaxInput) : null;

    // Call data layer with filters
    const artists = await loadArtistsData({
      nameFilter,
      locationFilter,
      genderFilter,
      paymentFilters,
      genreFilters,
      languageFilters,
      ageMin,
      ageMax
    });

    // Update UI with results
    if (artists.length === 0) {
      resultsContainer.innerHTML = '';
      if (noResultsDiv) noResultsDiv.classList.remove('hidden');
    } else {
      if (noResultsDiv) noResultsDiv.classList.add('hidden');

      // üî• NUCLEAR OPTION 1: Force visibility BEFORE rendering
      console.log('[LOAD ARTISTS] üî• STEP 1: FORCE VISIBILITY ON CONTAINERS BEFORE RENDER');

      // Force container visibility
      resultsContainer.classList.remove('hidden');
      resultsContainer.style.display = 'grid';
      resultsContainer.style.opacity = '1';
      resultsContainer.style.visibility = 'visible';
      resultsContainer.style.zIndex = '1';
      resultsContainer.style.minHeight = '200px';
      console.log('[LOAD ARTISTS] ‚úÖ Container forced visible:', resultsContainer);

      // Force parent <main> visibility
      const resultsMain = document.getElementById('artist-results-main');
      if (resultsMain) {
        resultsMain.classList.remove('hidden');
        resultsMain.style.display = 'block';
        resultsMain.style.opacity = '1';
        resultsMain.style.visibility = 'visible';
        resultsMain.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Parent <main> forced visible:', resultsMain);
      } else {
        console.error('[LOAD ARTISTS] ‚ùå Parent <main> NOT FOUND!');
      }

      // Force artist search section visibility
      const artistSearchSection = document.getElementById('artist-search-section');
      if (artistSearchSection) {
        artistSearchSection.classList.remove('hidden');
        artistSearchSection.style.display = 'block';
        artistSearchSection.style.opacity = '1';
        artistSearchSection.style.visibility = 'visible';
        artistSearchSection.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Search section forced visible:', artistSearchSection);
      }

      // Force programmer dashboard visibility
      const programmerDashboard = document.getElementById('programmer-dashboard');
      if (programmerDashboard) {
        programmerDashboard.classList.remove('hidden');
        programmerDashboard.style.display = 'block';
        programmerDashboard.style.opacity = '1';
        programmerDashboard.style.visibility = 'visible';
        programmerDashboard.style.zIndex = '1';
        console.log('[LOAD ARTISTS] ‚úÖ Programmer dashboard forced visible:', programmerDashboard);
      }

      console.log('[LOAD ARTISTS] üî• STEP 2: RENDER ARTISTS');
      renderArtists(artists);

      // üî• NUCLEAR OPTION 2: Force visibility AFTER rendering (double-check)
      console.log('[LOAD ARTISTS] üî• STEP 3: FORCE VISIBILITY AFTER RENDER (DOUBLE-CHECK)');
      forceSearchResultsVisible();

      // Setup event delegation for artist card clicks (only once)
      setupArtistCardClickHandlers();

      console.log('[LOAD ARTISTS] ‚úÖ Rendered and forced visibility on', artists.length, 'artist cards');
    }

  } catch (error) {
    console.error("‚ùå Error loading artists:", error);

    // Check if it's a Firestore index error
    if (error.message && error.message.includes('index')) {
      console.error("üîó FIRESTORE INDEX REQUIRED!");
      console.error("Click this link to create the index:", error.message.match(/https:\/\/[^\s]+/)?.[0]);
    }

    const errorMessage = error.message || 'Error loading artists. Please try again.';

    resultsContainer.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-800 font-semibold">Error loading artists</p>
        <p class="text-red-600 text-sm mt-2">${error.message}</p>
        ${error.message.includes('index') ?
          `<p class="text-red-600 text-sm mt-2">Please check the console for a link to create the required Firestore index.</p>` :
          ''}
      </div>
    `;

    // Show toast notification
    showErrorToast(errorMessage);
  }
}

/**
 * Setup event delegation for artist card clicks
 * ‚úÖ FIX: Uses event delegation on container to handle dynamic cards
 */
function setupArtistCardClickHandlers() {
  const resultsContainer = document.getElementById('artist-list-container');
  if (!resultsContainer) {
    console.warn('[ARTIST CARDS] Results container not found');
    return;
  }

  // Check if listener already attached
  if (resultsContainer.dataset.clickHandlerAttached === 'true') {
    console.log('[ARTIST CARDS] Click handler already attached');
    return;
  }

  // Use event delegation on the container
  resultsContainer.addEventListener('click', (e) => {
    // Find the closest artist card
    const card = e.target.closest('.artist-card');
    if (card && card.dataset.artistId) {
      const artistId = card.dataset.artistId;
      console.log('[ARTIST CARDS] Card clicked, artist ID:', artistId);
      showArtistDetail(artistId);
    }
  });

  // Mark as attached
  resultsContainer.dataset.clickHandlerAttached = 'true';
  console.log('[ARTIST CARDS] Click handler attached via event delegation');
}

/**
 * Show artist detail view (SECURED)
 */
export async function showArtistDetail(artistId, pushHistory = true) {
  // Security check: Only allow authenticated programmers
  if (!requireAuth()) {
    console.error("Show artist detail blocked: Authentication required");
    return;
  }

  try {
    console.log("Loading artist detail:", artistId);

    // Fetch artist data from data layer
    const artist = await fetchArtistById(artistId);

    if (!artist) {
      alert("Artist not found");
      return;
    }

    // Vul de detail view met de data (UI layer)
    populateArtistDetail(artist);

    // Initialize chat
    import('./profile-chat.js').then(chatModule => {
      chatModule.initProfileChat(artist);
    }).catch(err => {
      console.warn('[CHAT] Profile chat module not loaded:', err);
    });

    // Toon de detail view en verberg de search results
    document.getElementById('programmer-dashboard').style.display = 'none';
    const detailView = document.getElementById('artist-detail-view');
    detailView.style.display = 'block';

    // Store artistId in detail view for later use
    detailView.dataset.artistId = artistId;

    // Load recommendations for this artist
    loadRecommendations(artistId);

    // Load and render artist gigs
    loadAndRenderArtistGigs(artistId, artist.stageName || artist.firstName);

    // Setup "Write Recommendation" button (only for programmers)
    const writeRecommendationBtn = document.getElementById('write-recommendation-btn');
    if (writeRecommendationBtn) {
      const currentUserData = getStore('currentUserData');
      if (currentUserData && currentUserData.role === 'programmer') {
        writeRecommendationBtn.classList.remove('hidden');
        writeRecommendationBtn.onclick = () => openRecommendationModal(artistId, artist);
      } else {
        writeRecommendationBtn.classList.add('hidden');
      }
    }

    // Setup "View Recommendations" button
    const viewRecommendationsBtn = document.getElementById('view-recommendations-btn');
    if (viewRecommendationsBtn) {
      viewRecommendationsBtn.onclick = () => {
        // Scroll to recommendations section smoothly
        const recommendationsSection = document.getElementById('detail-recommendations');
        if (recommendationsSection) {
          recommendationsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };
    }

    // Push to browser history
    if (pushHistory) {
      window.history.pushState(
        { view: 'artist-detail', artistId: artistId },
        '',
        `#artist/${artistId}`
      );
    }

    // Scroll naar boven
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Activeer Lucide icons
    if (window.lucide) {
      window.lucide.createIcons();
    }

  } catch (error) {
    console.error("Error loading artist detail:", error);
    const errorMessage = error.message || 'Could not load artist details. Please try again.';
    showErrorToast(errorMessage);
  }
}

/**
 * Gaat terug naar de search results view (SECURED)
 */
function showSearchView() {
  // Security check
  if (!requireAuth()) {
    return;
  }

  document.getElementById('artist-detail-view').style.display = 'none';
  document.getElementById('programmer-dashboard').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Load and render artist gigs in the public profile view
 * @param {string} artistId - Artist UID
 * @param {string} artistName - Artist name for display
 */
async function loadAndRenderArtistGigs(artistId, artistName) {
  try {
    // Remove existing gigs sections before loading new ones
    document.querySelectorAll('#artist-gigs-section, #artist-gigs-section-mobile').forEach(el => el.remove());

    // Load artist events
    const events = await loadArtistEventsForProfile(artistId);

    if (!events || events.length === 0) {
      console.log('[GIGS] No events found for artist:', artistId);
      return;
    }

    // Find a good place to inject the gigs section (after bio/pitch or recommendations)
    const detailPitch = document.getElementById('detail-pitch');
    const mobilePitch = document.getElementById('mobile-detail-pitch');
    const recommendationsSection = document.getElementById('detail-recommendations');

    const gigsHtml = renderPublicGigsSection(events, artistName);

    // Inject into desktop view (after pitch, before recommendations)
    if (detailPitch && detailPitch.parentElement) {
      const gigsContainer = document.createElement('div');
      gigsContainer.id = 'artist-gigs-section';
      gigsContainer.className = 'mt-8';
      gigsContainer.innerHTML = gigsHtml;

      // Insert after the pitch parent container
      if (recommendationsSection) {
        recommendationsSection.parentElement.insertBefore(gigsContainer, recommendationsSection);
      } else {
        detailPitch.parentElement.appendChild(gigsContainer);
      }
    }

    // Inject into mobile view if it exists
    if (mobilePitch && mobilePitch.parentElement) {
      const mobileGigsContainer = document.createElement('div');
      mobileGigsContainer.id = 'mobile-artist-gigs-section';
      mobileGigsContainer.className = 'mt-8';
      mobileGigsContainer.innerHTML = gigsHtml;
      mobilePitch.parentElement.appendChild(mobileGigsContainer);
    }

    console.log('[GIGS] Rendered', events.length, 'events for artist:', artistId);

    // Re-init Lucide icons
    if (window.lucide) {
      setTimeout(() => window.lucide.createIcons(), 100);
    }

  } catch (error) {
    console.error('[GIGS] Error loading/rendering artist gigs:', error);
  }
}

/**
 * Clear all filter inputs and checkboxes
 * Then reload artists with no filters
 */
function clearAllFilters() {
  console.log("[CLEAR FILTERS] Clearing all filters...");

  // Clear text inputs
  const filterName = document.getElementById('filter-name');
  const filterLocation = document.getElementById('filter-location');
  const filterAgeMin = document.getElementById('filter-age-min');
  const filterAgeMax = document.getElementById('filter-age-max');

  if (filterName) filterName.value = '';
  if (filterLocation) filterLocation.value = '';
  if (filterAgeMin) filterAgeMin.value = '';
  if (filterAgeMax) filterAgeMax.value = '';

  // Reset gender select
  const filterGender = document.getElementById('filter-gender');
  if (filterGender) filterGender.value = '';

  // Uncheck 'Alle Genres' checkbox
  const genreAllCheckbox = document.getElementById('genre-all');
  if (genreAllCheckbox) genreAllCheckbox.checked = false;

  // Uncheck all genre checkboxes
  const genreCheckboxes = document.querySelectorAll('input[name="genre-filter"]');
  genreCheckboxes.forEach(cb => cb.checked = false);

  // Uncheck all language checkboxes
  const languageCheckboxes = document.querySelectorAll('input[name="language-filter"]');
  languageCheckboxes.forEach(cb => cb.checked = false);

  // Uncheck all payment checkboxes
  const paymentCheckboxes = document.querySelectorAll('input[name="payment-filter"]');
  paymentCheckboxes.forEach(cb => cb.checked = false);

  console.log("[CLEAR FILTERS] ‚úÖ All filters cleared");

  // Reload artists with no filters
  loadArtists();
}
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spoken Word Platform</title>

    <!-- Apple-inspired System Font Stack -->
    <style>
        :root {
            --app-max-width: 1280px; /* Responsive: was 480px */
            --primary-color: #6366f1; /* Indigo */
            --bg-color: #F2F2F7; /* iOS Gray */
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --nav-height: 72px;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Mobile Container */
        #app-container {
            max-width: var(--app-max-width);
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            position: relative;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.08);
            overflow-x: hidden;
        }

        @media (min-width: 481px) {
            body {
                background: var(--bg-color);
                padding: 20px 0;
            }
        }

        /* Desktop Container Padding */
        @media (min-width: 768px) {
            #app-container {
                padding: 0 2rem;
            }
        }

        /* Glassmorphism Bottom Nav (Mobile Only) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: var(--app-max-width);
            width: 100%;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        /* Hide bottom nav on desktop (>= 768px) */
        @media (min-width: 768px) {
            .bottom-nav {
                display: none !important;
            }
        }

        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
            background: rgba(0, 0, 0, 0.05);
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }

        .bottom-nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .bottom-nav-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: -0.2px;
        }

        /* Content padding for bottom nav */
        .content-wrapper {
            padding-bottom: calc(var(--nav-height) + 20px);
        }

        /* Button Press Effect */
        .btn-press {
            transition: transform 0.1s ease;
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        /* Badge for notifications - positioned at top-right of icon */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #FF3B30;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Hide default scrollbar but keep functionality */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }

        *::-webkit-scrollbar {
            width: 4px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        /* Responsive Modal Behavior */
        /* Mobile (< 768px): Bottom Sheet */
        @media (max-width: 767px) {
            .profile-modal {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 90vh;
                border-radius: 1.5rem 1.5rem 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease-out;
                overflow-y: auto;
            }

            .profile-modal.active {
                transform: translateY(0);
            }
        }

        /* Desktop (>= 768px): Centered Modal */
        @media (min-width: 768px) {
            .profile-modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 800px;
                width: 90%;
                max-height: 90vh;
                border-radius: 1rem;
                overflow-y: auto;
            }

            .profile-modal.active {
                /* No animation needed on desktop */
                display: block;
            }
        }

        /* Search Module - Pill Filters (Mobile) */
        .pill {
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            color: #374151;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }

        .pill:hover {
            background-color: #e5e7eb;
        }

        .pill-active {
            padding: 0.5rem 1rem;
            background-color: #e0e7ff;
            color: #4f46e5;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            border: none;
            cursor: pointer;
        }

        /* Mobile Filter Menu Slide-in */
        .mobile-filter-menu-open {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 50;
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Hide scrollbar for mobile pills container */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Mobile Filter Bar - Horizontal Slide */
        #mobile-filter-bar {
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        #mobile-filter-bar:not(.hidden) {
            transform: translateY(0);
            opacity: 1;
        }

        /* SAFETY: Prevent any profile image from becoming too large */
        #desktop-profile-pic,
        #programmer-overview-pic-desktop,
        #programmer-overview-pic-mobile,
        img[id*="profile-pic"] {
            max-width: 200px !important;
            max-height: 200px !important;
        }

        #desktop-profile-pic {
            max-width: 32px !important;
            max-height: 32px !important;
        }

        /* Selectable Chips */
        .chip-label {
            user-select: none;
        }

        .chip-input:checked + .chip-text {
            color: white;
        }

        .chip-input:checked ~ .chip-text {
            color: white;
        }

        .chip-label:has(.chip-input:checked) {
            background-color: #7c3aed;
            border-color: #7c3aed;
            color: white;
        }

        .chip-label:has(.chip-input:checked):hover {
            background-color: #6d28d9;
            border-color: #6d28d9;
        }

        .chip-label:has(.chip-input:checked) .chip-text {
            color: white;
        }

        /* Fallback voor browsers zonder :has() support */
        .chip-selected {
            background-color: #7c3aed !important;
            border-color: #7c3aed !important;
        }

        .chip-selected .chip-text {
            color: white !important;
        }
    </style>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/style.css">
</head>

<body class="bg-gray-50 text-gray-900 antialiased overflow-x-hidden">

    <!-- Main App Container -->
    <div id="app-container">

        <!-- Desktop Navigation Container (rendered by navigation.js) -->
        <div id="desktop-nav-container" class="hidden md:block"></div>

        <!-- App Header (only shown when logged in on mobile) -->
        <header id="app-header" class="md:hidden bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-40">
            <div class="flex items-center justify-between">
                <h1 class="text-lg font-bold text-gray-900 tracking-tight">SPOKEN WORD PLATFORM</h1>
                <button id="nav-logout-mobile" class="text-red-500 text-sm font-semibold px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
                    Logout
                </button>
            </div>
        </header>

        <!-- Content Wrapper -->
        <div class="content-wrapper">

            <!-- Loading View (shown during initial app load) -->
            <div id="loading-view" class="fixed inset-0 bg-white flex justify-center items-center z-50">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600 font-medium">Loading...</p>
                </div>
            </div>

            <!-- Main App Content Container - all views rendered here dynamically -->
            <main id="app-content" class="min-h-screen"></main>

        </div>

        <!-- Mobile Navigation Container (rendered by navigation.js) -->
        <div id="mobile-nav-container" class="hidden"></div>

    </div>

    <!-- Modals (keep existing modals) -->

    <!-- Recommendation Modal -->
    <div id="recommendation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Schrijf Aanbeveling</h3>
                    <button id="close-recommendation-modal" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <p id="recommendation-artist-name" class="text-base text-indigo-600 font-semibold mt-2">Artist Name</p>
            </div>

            <form id="recommendation-form" class="p-6 space-y-4">
                <div>
                    <label for="recommendation-text" class="block text-sm font-semibold text-gray-700 mb-2">Je Aanbeveling</label>
                    <textarea
                        id="recommendation-text"
                        rows="6"
                        required
                        minlength="10"
                        class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="Deel je positieve ervaring met deze artiest..."></textarea>
                    <p class="mt-1 text-xs text-gray-500">Minimum 10 karakters.</p>
                </div>

                <div id="recommendation-error" class="hidden p-3 bg-red-100 text-red-700 rounded-xl text-sm"></div>
                <div id="recommendation-success" class="hidden p-3 bg-green-100 text-green-700 rounded-xl text-sm"></div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-recommendation-btn" class="btn-press px-4 py-2 bg-gray-100 rounded-xl text-gray-700 hover:bg-gray-200 font-medium">
                        Annuleren
                    </button>
                    <button type="submit" class="btn-press px-6 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">
                        Versturen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Verstuur Bericht</h3>
                    <button id="close-message-modal" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <p class="text-base text-gray-700 mt-2">Verstuur een bericht naar <strong id="message-artist-name"></strong></p>
            </div>
            <div class="p-6">
                <form id="send-message-form" class="space-y-4">
                    <div>
                        <label for="message-subject" class="block text-sm font-semibold text-gray-700 mb-2">Onderwerp</label>
                        <input id="message-subject" type="text" required
                            class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="message-text" class="block text-sm font-semibold text-gray-700 mb-2">Bericht</label>
                        <textarea id="message-text" rows="4" required
                            class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>

                    <div id="message-error" class="hidden p-3 bg-red-100 text-red-700 rounded-xl text-sm"></div>
                    <div id="message-success" class="hidden p-3 bg-green-100 text-green-700 rounded-xl text-sm"></div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-message-btn"
                            class="btn-press px-4 py-2 bg-gray-100 rounded-xl text-gray-700 hover:bg-gray-200 font-medium">
                            Annuleren
                        </button>
                        <button type="submit"
                            class="btn-press px-6 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">
                            <i data-lucide="send" class="h-4 w-4 inline mr-2"></i>
                            Versturen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div id="profile-view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full my-8">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold">Profiel</h3>
                <button id="close-profile-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="profile-modal-content" class="p-6">
                <!-- Profile content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- User Settings Modal -->
    <div id="user-settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full my-8">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold">Account Instellingen</h3>
                <button id="close-settings-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Language Selection -->
                <div class="border-b border-gray-200 pb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Taal</label>
                    <select id="settings-language-select" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="nl">Nederlands</option>
                        <option value="en">English</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Kies je voorkeurstaal voor de interface</p>
                </div>

                <!-- Change Email -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Email Wijzigen</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="settings-current-password-email" class="block text-xs text-gray-600 mb-1">Huidig Wachtwoord</label>
                            <input id="settings-current-password-email" type="password" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="settings-new-email" class="block text-xs text-gray-600 mb-1">Nieuw Email Adres</label>
                            <input id="settings-new-email" type="email" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button id="settings-update-email-btn" class="btn-press w-full bg-indigo-600 text-white px-4 py-3 rounded-xl hover:bg-indigo-700 font-semibold">Email Bijwerken</button>
                        <p id="settings-email-error" class="text-red-500 text-sm hidden"></p>
                        <p id="settings-email-success" class="text-green-600 text-sm hidden"></p>
                    </div>
                </div>

                <!-- Change Password -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Wachtwoord Wijzigen</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="settings-current-password-pw" class="block text-xs text-gray-600 mb-1">Huidig Wachtwoord</label>
                            <input id="settings-current-password-pw" type="password" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="settings-new-password" class="block text-xs text-gray-600 mb-1">Nieuw Wachtwoord</label>
                            <input id="settings-new-password" type="password" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="settings-confirm-password" class="block text-xs text-gray-600 mb-1">Bevestig Nieuw Wachtwoord</label>
                            <input id="settings-confirm-password" type="password" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button id="settings-update-password-btn" class="btn-press w-full bg-indigo-600 text-white px-4 py-3 rounded-xl hover:bg-indigo-700 font-semibold">Wachtwoord Bijwerken</button>
                        <p id="settings-password-error" class="text-red-500 text-sm hidden"></p>
                        <p id="settings-password-success" class="text-green-600 text-sm hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="/main.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Initialize Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>

</body>
</html>
</file>

<file path="main.js">
/**
 * main.js
 * Dit is het HOOFD startpunt van de applicatie.
 * Het importeert alle modules en start de app.
 */

// Global error handler for uncaught errors
window.addEventListener('error', (event) => {
  console.error('‚ùå GLOBAL ERROR:', event.error);
  const loadingView = document.getElementById('loading-view');
  if (loadingView && loadingView.style.display !== 'none') {
    loadingView.innerHTML = `
      <div class="text-center text-red-500 p-8 max-w-lg mx-auto bg-white shadow-lg rounded-lg">
        <h1 class="text-2xl font-bold mb-4">Application Error</h1>
        <p class="mb-4">Er is een fout opgetreden bij het laden van de applicatie.</p>
        <p class="text-sm font-mono bg-red-100 p-3 rounded break-all mb-4">${event.error?.message || event.message}</p>
        <button onclick="location.reload()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
          Probeer opnieuw
        </button>
      </div>
    `;
    loadingView.style.display = 'block';
  }
});

// Global promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
  console.error('‚ùå UNHANDLED PROMISE REJECTION:', event.reason);
});

// Importeer de initialisatie-functies van onze modules
import { monitorAuthState } from './src/services/auth.js';
import { initNavigation, setupGlobalFormHandlers, showPage, showDashboard, showMessages, showAccountSettings, showProgrammerSettings } from './src/ui/ui.js';
import { getStore } from './src/utils/store.js';
import { setupProgrammerProfile } from './src/modules/programmer/programmer-profile.js';
// ‚úÖ setupArtistSearch moved to ui.js (imported there)
import { setupMessaging } from './src/modules/messaging/messaging-controller.js';
import { initTranslations } from './src/utils/translations.js';
import { setupRecommendations } from './src/modules/recommendations/recommendations.js';
import { setupUserSettings } from './src/modules/settings/user-settings.js';
import { renderDesktopNav, renderMobileNav } from './src/modules/navigation/navigation.js';

/**
 * initApp
 * De hoofdfunctie die de hele applicatie initialiseert.
 */
function initApp() {
  try {
    console.log("=".repeat(60));
    console.log("üöÄ Starting application initialization...");
    console.log("=".repeat(60));

    // Setup global form handlers first (before any UI rendering)
    // This ensures login/signup forms work regardless of when they're rendered
    setupGlobalFormHandlers();

    // Initialize translations (default to Dutch)
    initTranslations();

    // Render navigation components (will be hidden until user logs in)
    renderDesktopNav();
    renderMobileNav();

    // Stel de navigatieknoppen in (Login, Home, etc.)
    initNavigation();

    // Stel de listener in die kijkt of we in- of uitgelogd zijn
    // Deze verbergt ook de lader en toont de homepagina
    monitorAuthState();

    // Stel de listeners in voor het programmeurs-profiel (edit profile)
    setupProgrammerProfile();

    // ‚úÖ FIX: setupArtistSearch() moved to ui.js after renderArtistSearch()
    // This ensures event listeners attach after HTML is rendered

    // Stel de messaging listeners in (send message button, modal)
    setupMessaging();

    // Stel de recommendations listeners in (modal, form)
    setupRecommendations();

    // Stel de user settings listeners in (modal, language, email, password)
    setupUserSettings();

    // Setup browser back/forward button handler
    setupBrowserNavigation();

    console.log("=".repeat(60));
    console.log("‚úÖ Application initialization complete!");
    console.log("=".repeat(60));

  } catch (error) {
    console.error("Fout bij initialiseren van de app:", error);
    // Toon een fatale foutmelding aan de gebruiker
    const loadingView = document.getElementById('loading-view');
    if (loadingView) {
      loadingView.style.display = 'block'; // Zorg dat de lader zichtbaar is
      loadingView.innerHTML = `
        <div class="text-center text-red-500 p-8 max-w-lg mx-auto bg-white shadow-lg rounded-lg">
            <h1 class="text-2xl font-bold mb-4">Fatale Fout</h1>
            <p>Kon de applicatie niet laden. Probeer het later opnieuw.</p>
            <p class="mt-4 text-sm font-mono bg-red-100 p-2 rounded break-all">${error.message}</p>
        </div>
      `;
    }
  }
}

/**
 * Setup browser navigation (back/forward buttons)
 * Handles URL hash changes and browser history
 */
function setupBrowserNavigation() {
  // Handle browser back/forward buttons
  window.addEventListener('popstate', async (event) => {
    console.log('[BROWSER NAV] Popstate event triggered:', event.state);

    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');
    const hash = window.location.hash.replace('#', '');

    // Auth guard: redirect to login if not authenticated
    const protectedRoutes = ['profile', 'edit-profile', 'messages', 'account-settings', 'profile-settings', 'dashboard', 'search'];
    if (protectedRoutes.includes(hash) && !currentUser) {
      console.warn('[BROWSER NAV] Protected route accessed without auth, redirecting to home');
      showPage('home-view', false);
      return;
    }

    // Route based on hash
    switch(hash) {
      case 'profile':
        if (currentUserData?.role === 'artist') {
          const uiModule = await import('./src/ui/ui.js');
          uiModule.showArtistOwnProfile();
        } else if (currentUserData?.role === 'programmer') {
          const uiModule = await import('./src/ui/ui.js');
          uiModule.showProgrammerProfile();
        } else {
          showDashboard();
        }
        break;

      case 'edit-profile':
        if (currentUserData?.role === 'artist') {
          const uiModule = await import('./src/ui/ui.js');
          uiModule.showArtistEditProfile();
        } else if (currentUserData?.role === 'programmer') {
          const uiModule = await import('./src/ui/ui.js');
          uiModule.showEditProfile();
        }
        break;

      case 'search':
        if (currentUserData?.role === 'programmer') {
          const uiModule = await import('./src/ui/ui.js');
          uiModule.showSearch();
        } else {
          console.warn('[BROWSER NAV] Only programmers can access search');
          showDashboard();
        }
        break;

      case 'messages':
        showMessages();
        break;

      case 'account-settings':
        showAccountSettings();
        break;

      case 'dashboard':
        showDashboard();
        break;

      case 'login':
        showPage('login-view', false);
        break;

      case 'signup':
        showPage('signup-view', false);
        break;

      case 'home':
      case '':
        showPage('home-view', false);
        break;

      default:
        console.warn('[BROWSER NAV] Unknown route:', hash);
        showPage('home-view', false);
    }

    // CRITICAL: Always restore navigation after any route change
    if (currentUser && currentUserData) {
      await restoreNavigation();
    }
  });

  // Handle initial hash on page load
  const initialHash = window.location.hash.replace('#', '');
  if (initialHash) {
    console.log('[BROWSER NAV] Initial hash detected:', initialHash);
    // Let monitorAuthState handle the initial routing
  }

  console.log('[BROWSER NAV] Browser navigation setup complete');
}

/**
 * Restore navigation bars after browser navigation
 */
async function restoreNavigation() {
  try {
    const navModule = await import('./src/modules/navigation/navigation.js');

    // Ensure containers are visible
    navModule.setNavigationVisibility(true);

    // Re-render navigation
    navModule.renderDesktopNav();
    navModule.renderMobileNav();

    // Re-initialize icons
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 100);
    }

    console.log('[BROWSER NAV] Navigation restored');
  } catch (err) {
    console.error('[BROWSER NAV] Failed to restore navigation:', err);
  }
}

// Start de applicatie zodra de HTML-pagina is geladen
document.addEventListener('DOMContentLoaded', initApp);
</file>

<file path="src/modules/search/search-data.js">
/**
 * search-data.js
 * Handles all Firebase queries and data fetching for artist search
 * No DOM manipulation - pure data operations
 */

import { collection, getDocs, query, where, doc, getDoc } from "firebase/firestore";
import { db } from '../../services/firebase.js';
import { getStore } from '../../utils/store.js';

/**
 * Security: Check if user is authenticated (programmer OR artist)
 * @returns {boolean} True if authenticated, false otherwise
 */
export function isAuthenticatedUser() {
  const currentUser = getStore('currentUser');
  const currentUserData = getStore('currentUserData');
  const userRole = currentUserData?.role;

  console.log('[AUTH CHECK] currentUser:', currentUser ? 'EXISTS (uid: ' + currentUser.uid + ')' : 'NULL');
  console.log('[AUTH CHECK] userRole:', userRole);

  if (!currentUser) {
    console.warn("[AUTH CHECK] ‚ùå Access denied: No currentUser in store");
    return false;
  }

  if (userRole !== 'programmer' && userRole !== 'artist') {
    console.warn("[AUTH CHECK] ‚ùå Access denied: userRole is not 'programmer' or 'artist', got:", userRole);
    return false;
  }

  console.log("[AUTH CHECK] ‚úÖ Authentication passed - User is authenticated " + userRole);
  return true;
}

/**
 * Check if current user is a programmer (for privileged actions)
 * @returns {boolean} True if programmer, false otherwise
 */
export function isProgrammer() {
  const currentUserData = getStore('currentUserData');
  return currentUserData?.role === 'programmer';
}

/**
 * Security: Check if user is authenticated as a programmer
 * @deprecated Use isAuthenticatedUser() and isProgrammer() instead
 * @returns {boolean} True if authenticated programmer, false otherwise
 */
export function isAuthenticatedProgrammer() {
  return isAuthenticatedUser() && isProgrammer();
}

/**
 * Security: Require authentication for search operations
 * Redirects to login if not authenticated
 */
export function requireAuth() {
  console.log("[REQUIRE AUTH] Checking authentication...");

  if (!isAuthenticatedUser()) {
    console.error("[REQUIRE AUTH] ‚ùå Access denied: Redirecting to login");
    alert("You must be logged in to access this page.");

    import('../../ui/ui.js').then(module => {
      module.showPage('login-view');
    });
    return false;
  }
  return true;
}

/**
 * Calculate age from date of birth
 */
export function calculateAge(dob) {
  if (!dob) return null;

  const birthDate = new Date(dob);
  const today = new Date();

  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }

  return age;
}

/**
 * Load all available genres from published artists
 * @returns {Promise<Array<string>>} Sorted array of unique genres
 */
export async function loadAvailableGenres() {
  try {
    const snapshot = await getDocs(query(collection(db, 'artists'), where('published', '==', true)));
    const genreSet = new Set();

    snapshot.forEach((docSnap) => {
      const genres = docSnap.data().genres || [];
      genres.forEach(g => {
        if (g && typeof g === 'string') {
          genreSet.add(g.trim());
        }
      });
    });

    const genreArray = Array.from(genreSet).sort();
    console.log(`üìã Loaded ${genreArray.length} unique genres:`, genreArray);
    return genreArray;
  } catch (error) {
    console.error('‚ùå Error loading genres:', error);
    return [];
  }
}

/**
 * Fetch a single artist by ID
 * @param {string} artistId - The artist's document ID
 * @returns {Promise<object|null>} Artist data or null if not found
 */
export async function fetchArtistById(artistId) {
  try {
    console.log("Fetching artist data:", artistId);

    const artistRef = doc(db, 'artists', artistId);
    const artistSnap = await getDoc(artistRef);

    if (!artistSnap.exists()) {
      console.warn("Artist not found:", artistId);
      return null;
    }

    return { id: artistSnap.id, ...artistSnap.data() };
  } catch (error) {
    console.error("Error fetching artist:", error);
    throw error;
  }
}

/**
 * Load artists with filters (SECURED + FIXED v2 - Normalize spaces/dashes)
 * @param {object} filters - Filter values from UI
 * @returns {Promise<Array>} Filtered artists array
 */
export async function loadArtistsData(filters = {}) {
  // Security check: Only allow authenticated programmers
  if (!requireAuth()) {
    throw new Error("Authentication required");
  }

  // Helper function to normalize values (trim, lowercase, replace spaces with dashes)
  const normalize = (value) => {
    if (!value || typeof value !== 'string') return '';
    return value.trim().toLowerCase().replace(/\s+/g, '-');
  };

  try {
    const {
      nameFilter = '',
      locationFilter = '',
      genderFilter = '',
      paymentFilters = [],
      genreFilters = [],
      ageMin = null,
      ageMax = null,
      themeFilters = [],
      energyFilters = [],
      formatFilters = [],
      languageFilters = [],
      keywordsFilter = ''
    } = filters;

    console.log("üîç Filter values:", {
      nameFilter,
      locationFilter,
      genderFilter,
      paymentFilters,
      genreFilters,
      ageRange: ageMin !== null || ageMax !== null ? `${ageMin || 'any'}-${ageMax || 'any'}` : 'not set',
      themeFilters,
      energyFilters,
      formatFilters,
      languageFilters,
      keywordsFilter
    });

    // Build Firestore query
    let q = query(collection(db, 'artists'), where('published', '==', true));

    // Add gender filter if selected
    if (genderFilter) {
      q = query(q, where('gender', '==', genderFilter));
    }

    // Fetch all artists
    const snapshot = await getDocs(q);
    console.log(`üìä Found ${snapshot.size} artists before client-side filtering`);

    let artists = [];
    snapshot.forEach((doc) => {
      artists.push({ id: doc.id, ...doc.data() });
    });

    // Exclude current user if they are also an artist (prevents showing own profile)
    const currentUser = getStore('currentUser');
    if (currentUser) {
      const beforeCount = artists.length;
      artists = artists.filter(artist => artist.id !== currentUser.uid);
      if (beforeCount > artists.length) {
        console.log(`üö´ Filtered out current user's own profile`);
      }
    }

    // DEBUG: Log first artist's data structure
    if (artists.length > 0) {
      console.log("üìã Sample artist data:", {
        id: artists[0].id,
        stageName: artists[0].stageName,
        genres: artists[0].genres,
        genresNormalized: artists[0].genres?.map(g => normalize(g)),
        paymentMethods: artists[0].paymentMethods,
        paymentsNormalized: artists[0].paymentMethods?.map(p => normalize(p)),
        languages: artists[0].languages
      });
    }

    // Client-side filtering

    // Filter by name (stage name or full name)
    if (nameFilter) {
      artists = artists.filter(artist => {
        const stageName = (artist.stageName || '').toLowerCase();
        const fullName = `${artist.firstName || ''} ${artist.lastName || ''}`.toLowerCase();
        return stageName.includes(nameFilter) || fullName.includes(nameFilter);
      });
      console.log(`üîç After name filter: ${artists.length} artists`);
    }

    // Filter by location
    if (locationFilter) {
      artists = artists.filter(artist => {
        const location = (artist.location || '').toLowerCase();
        return location.includes(locationFilter);
      });
      console.log(`üìç After location filter: ${artists.length} artists`);
    }

    // Filter by payment methods (checkboxes - any match)
    if (paymentFilters.length > 0) {
      console.log(`üí≥ Filtering by payment methods:`, paymentFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistPayments = (artist.paymentMethods || []).map(p => normalize(p));

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log(`  Sample artist payment methods (normalized):`, artistPayments);
          console.log(`  Filter payment methods (normalized):`, paymentFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected payment methods
        const hasMatch = paymentFilters.some(payment => artistPayments.includes(payment));
        return hasMatch;
      });

      console.log(`üí≥ After payment filter: ${artists.length} artists`);
    }

    // Filter by genres (checkboxes - any match)
    if (genreFilters.length > 0) {
      console.log(`üé≠ Filtering by genres:`, genreFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistGenres = (artist.genres || []).map(g => normalize(g));

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log(`  Sample artist genres (normalized):`, artistGenres);
          console.log(`  Filter genres (normalized):`, genreFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected genres
        const hasMatch = genreFilters.some(genre => artistGenres.includes(genre));
        return hasMatch;
      });

      console.log(`üé≠ After genre filter: ${artists.length} artists`);
    }

    // Filter by languages (checkboxes - any match)
    if (languageFilters && languageFilters.length > 0) {
      console.log(`üó£Ô∏è Filtering by languages:`, languageFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistLanguages = (artist.languages || [])
          .filter(l => l && typeof l === 'string')
          .map(l => l.toLowerCase().trim());

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log(`  Sample artist languages (lowercase):`, artistLanguages);
          console.log(`  Filter languages (lowercase):`, languageFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected languages
        const hasMatch = languageFilters.some(lang => artistLanguages.includes(lang));
        return hasMatch;
      });

      console.log(`üó£Ô∏è After language filter: ${artists.length} artists`);
      console.log('[FILTER] After languages:', artists.length);
    }

    // Filter by age (only if age filters are set)
    if (ageMin !== null || ageMax !== null) {
      artists = artists.filter(artist => {
        if (!artist.dob) return false; // Exclude artists without birthdate when age filter is active

        const age = calculateAge(artist.dob);
        const meetsMin = ageMin === null || age >= ageMin;
        const meetsMax = ageMax === null || age <= ageMax;
        return meetsMin && meetsMax;
      });
      console.log(`üéÇ After age filter: ${artists.length} artists`);
    }

    // Filter by themes (any match)
    if (themeFilters.length > 0) {
      console.log(`üé® Filtering by themes:`, themeFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistThemes = (artist.themes || [])
          .filter(t => t && typeof t === 'string')
          .map(t => normalize(t));

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log(`  Sample artist themes (normalized):`, artistThemes);
          console.log(`  Filter themes (normalized):`, themeFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected themes
        const hasMatch = themeFilters.some(theme => artistThemes.includes(theme));
        return hasMatch;
      });

      console.log(`üé® After themes filter: ${artists.length} artists`);
    }

    // Filter by energy levels (any match)
    if (energyFilters.length > 0) {
      console.log(`‚ö° Filtering by energy:`, energyFilters);
      console.log('[DEBUG] Energy filters:', energyFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistEnergy = (artist.energyLevels || [])
          .filter(e => e && typeof e === 'string')
          .map(e => e.toLowerCase().trim());

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log('[DEBUG] First artist:', artist.stageName, 'energyLevels:', artist.energyLevels, 'normalized:', artistEnergy);
          console.log(`  Sample artist energy (lowercase):`, artistEnergy);
          console.log(`  Filter energy (lowercase):`, energyFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected energy levels
        const hasMatch = energyFilters.some(energy => artistEnergy.includes(energy));

        if (!debugLogged) {
          console.log('[DEBUG] Match:', hasMatch);
        }

        return hasMatch;
      });

      console.log(`‚ö° After energy filter: ${artists.length} artists`);
      console.log('[FILTER] After energy:', artists.length);
    }

    // Filter by formats (any match)
    if (formatFilters.length > 0) {
      console.log(`üé≠ Filtering by formats:`, formatFilters);

      let debugLogged = false;
      artists = artists.filter(artist => {
        const artistFormats = (artist.formats || [])
          .filter(f => f && typeof f === 'string')
          .map(f => normalize(f));

        // DEBUG: Log comparison for first artist only once
        if (!debugLogged) {
          console.log(`  Sample artist formats (normalized):`, artistFormats);
          console.log(`  Filter formats (normalized):`, formatFilters);
          debugLogged = true;
        }

        // Artist must have at least one of the selected formats
        const hasMatch = formatFilters.some(format => artistFormats.includes(format));
        return hasMatch;
      });

      console.log(`üé≠ After formats filter: ${artists.length} artists`);
    }

    // Filter by keywords (search in bio, pitch, genres, stageName)
    if (keywordsFilter) {
      const keywords = keywordsFilter.split(/[,\s]+/).filter(k => k.length > 0);

      artists = artists.filter(artist => {
        const searchText = [
          artist.stageName || '',
          artist.bio || '',
          artist.pitch || '',
          ...(artist.genres || []),
          ...(artist.keywords || [])
        ].join(' ').toLowerCase();

        // Artist must match ALL keywords
        return keywords.every(keyword => searchText.includes(keyword));
      });

      console.log(`üîë After keywords filter: ${artists.length} artists`);
    }

    console.log(`‚úÖ ${artists.length} artists after all filtering`);

    return artists;

  } catch (error) {
    console.error("‚ùå Error loading artists:", error);
    console.error("Full error details:", error);

    // Check if it's a Firestore index error
    if (error.message && error.message.includes('index')) {
      console.error("üîó FIRESTORE INDEX REQUIRED!");
      console.error("Click this link to create the index:", error.message.match(/https:\/\/[^\s]+/)?.[0]);
    }

    throw error;
  }
}
</file>

<file path="src/modules/navigation/navigation.js">
/**
 * navigation.js
 * Centralized navigation component that renders both desktop and mobile navigation.
 * This ensures consistent navigation state across all views.
 */

import { getStore } from '../../utils/store.js';

/**
 * Renders the desktop top navigation bar
 */
export function renderDesktopNav() {
  const container = document.getElementById('desktop-nav-container');
  if (!container) {
    console.warn('Desktop nav container not found');
    return;
  }

  const currentUserData = getStore('currentUserData');

  // Get profile picture URL or generate placeholder
  let profilePicUrl = 'https://placehold.co/40x40';
  if (currentUserData?.profilePicUrl) {
    profilePicUrl = currentUserData.profilePicUrl;
  } else if (currentUserData) {
    const initial = currentUserData.firstName?.charAt(0) || currentUserData.stageName?.charAt(0) || 'U';
    profilePicUrl = `https://placehold.co/40x40/e0e7ff/6366f1?text=${encodeURIComponent(initial)}`;
  }

  // Only show search for programmers
  const isProgrammer = currentUserData?.role === 'programmer';
  const isArtist = currentUserData?.role === 'artist';

  container.innerHTML = `
    <nav id="desktop-top-nav" class="hidden md:block bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-8">
            <h1 class="text-xl font-bold text-gray-900 tracking-tight">
              SPOKEN WORD PLATFORM
            </h1>
          </div>

          <!-- Menu Items -->
          <div class="flex items-center space-x-8">
            ${isProgrammer ? `<button id="desktop-nav-search" class="text-gray-700 hover:text-purple-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Zoeken
            </button>` : ''}
            ${isProgrammer ? `<button id="desktop-nav-agenda" class="text-gray-700 hover:text-purple-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Agenda
            </button>` : ''}
            <button id="desktop-nav-profile" class="text-gray-700 hover:text-purple-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Profiel
            </button>
            ${isArtist ? `<button id="desktop-nav-gigs" class="text-gray-700 hover:text-purple-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Gigs
            </button>` : ''}
            ${isArtist ? `<button id="desktop-nav-events" class="text-gray-700 hover:text-purple-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Evenementen
            </button>` : ''}
            <button id="desktop-nav-messages" class="relative text-gray-700 hover:text-indigo-600 font-medium px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
              Berichten
              <span id="messages-badge-desktop" class="notification-badge hidden">0</span>
            </button>

            <!-- Profile Menu Dropdown -->
            <div class="relative">
              <button id="desktop-profile-btn" class="flex items-center space-x-2 text-gray-700 hover:text-indigo-600">
                <img id="desktop-profile-pic" src="${profilePicUrl}" class="h-8 w-8 rounded-full object-cover" style="max-width: 32px; max-height: 32px;" alt="Profile">
                <i data-lucide="chevron-down" class="h-4 w-4"></i>
              </button>

              <!-- Dropdown Menu (hidden by default) -->
              <div id="desktop-profile-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg py-2 z-50 border border-gray-200">
                <button id="desktop-account-settings" class="block w-full text-left px-4 py-2.5 text-gray-700 hover:bg-gray-100 font-medium">
                  Account Instellingen
                </button>
                <hr class="my-1 border-gray-200">
                <button id="desktop-logout" class="block w-full text-left px-4 py-2.5 text-red-600 hover:bg-red-50 font-medium">
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  `;

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }
}

/**
 * Renders the mobile bottom navigation bar
 */
export function renderMobileNav() {
  const container = document.getElementById('mobile-nav-container');
  if (!container) {
    console.warn('Mobile nav container not found');
    return;
  }

  const currentUserData = getStore('currentUserData');

  // Only show search for programmers
  const isProgrammer = currentUserData?.role === 'programmer';
  const isArtist = currentUserData?.role === 'artist';

  container.innerHTML = `
    <nav id="bottom-nav" class="bottom-nav">
      ${isProgrammer ? `<button class="bottom-nav-item active" data-nav="search">
        <i data-lucide="search" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Zoeken</span>
      </button>` : ''}
      ${isProgrammer ? `<button class="bottom-nav-item" data-nav="agenda">
        <i data-lucide="calendar-days" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Agenda</span>
      </button>` : ''}
      ${isArtist ? `<button class="bottom-nav-item" data-nav="gigs">
        <i data-lucide="calendar" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Gigs</span>
      </button>` : ''}
      ${isArtist ? `<button class="bottom-nav-item" data-nav="events">
        <i data-lucide="calendar-days" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Events</span>
      </button>` : ''}
      <button class="bottom-nav-item" data-nav="messages">
        <i data-lucide="message-circle" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Berichten</span>
      </button>
      <button class="bottom-nav-item" data-nav="profile">
        <i data-lucide="user" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Profiel</span>
      </button>
      <button class="bottom-nav-item" data-nav="settings">
        <i data-lucide="settings" class="bottom-nav-icon"></i>
        <span class="bottom-nav-label">Instellingen</span>
      </button>
    </nav>
  `;

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 50);
  }
}

/**
 * Updates the active state of mobile bottom navigation
 * @param {string} activeNav - The navigation item to mark as active ('search', 'messages', 'profile')
 */
export function updateMobileNavActive(activeNav) {
  const bottomNav = document.getElementById('bottom-nav');
  if (!bottomNav) return;

  const allItems = bottomNav.querySelectorAll('.bottom-nav-item');
  allItems.forEach(item => {
    if (item.dataset.nav === activeNav) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
}

/**
 * Updates the desktop navigation based on current user state
 * Refreshes profile picture
 */
export function updateDesktopNav() {
  const currentUserData = getStore('currentUserData');
  if (!currentUserData) return;

  // Update profile picture
  const profilePic = document.getElementById('desktop-profile-pic');
  if (profilePic) {
    if (currentUserData.profilePicUrl) {
      profilePic.src = currentUserData.profilePicUrl;
    } else {
      const initial = currentUserData.firstName?.charAt(0) || currentUserData.stageName?.charAt(0) || 'U';
      profilePic.src = `https://placehold.co/40x40/e0e7ff/6366f1?text=${encodeURIComponent(initial)}`;
    }
  }
}

/**
 * Shows or hides navigation based on authentication state
 * @param {boolean} isAuthenticated - Whether the user is logged in
 */
export function setNavigationVisibility(isAuthenticated) {
  const desktopContainer = document.getElementById('desktop-nav-container');
  const mobileContainer = document.getElementById('mobile-nav-container');

  if (isAuthenticated) {
    // Show navigation
    if (desktopContainer) desktopContainer.classList.remove('hidden');
    if (mobileContainer) mobileContainer.classList.remove('hidden');
  } else {
    // Hide navigation AND clear contents
    if (desktopContainer) {
      desktopContainer.classList.add('hidden');
      desktopContainer.innerHTML = ''; // Clear nav HTML
    }
    if (mobileContainer) {
      mobileContainer.classList.add('hidden');
      mobileContainer.innerHTML = ''; // Clear nav HTML
    }
  }
}
</file>

<file path="src/modules/programmer/programmer-dashboard.js">
/**
 * programmer-dashboard.js
 * Manages the programmer's profile with separate views:
 * - Profile overview (read-only display)
 * - Edit profile (form)
 * - Public profile preview
 *
 * Artist search is handled by artist-search.js
 */

import { getStore, setStore } from '../../utils/store.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { doc, updateDoc } from "firebase/firestore";
import { db } from '../../services/firebase.js';
import { setLanguage } from '../../utils/translations.js';

/**
 * Renders the programmer dashboard HTML structure
 * DESKTOP: New compact card layout matching mockup
 * MOBILE: Original layout preserved (unchanged)
 */
export function renderProgrammerDashboard() {
  const container = document.getElementById('programmer-dashboard');

  if (!container) {
    console.warn("Programmer dashboard container not found");
    return;
  }

  container.innerHTML = `
    <!-- View voor "Pending" -->
    <div id="programmer-pending-view" class="hidden bg-yellow-50 border border-yellow-200 p-8 rounded-2xl shadow-sm mb-6">
        <div class="flex items-start space-x-4">
            <i data-lucide="clock" class="h-8 w-8 text-yellow-600 flex-shrink-0 mt-1"></i>
            <div>
                <h3 class="text-xl font-bold text-yellow-900 mb-2">Account Pending Approval</h3>
                <p class="text-yellow-800 leading-relaxed">
                    Your account is <strong>pending admin approval</strong>. You will be notified by email once it's published.
                </p>
            </div>
        </div>
    </div>

    <!-- ========== PROGRAMMER PROFILE OVERVIEW ========== -->
    <div id="programmer-profile-overview" class="mb-6">

        <!-- ===== MOBILE VIEW (< md) - ORIGINAL UNCHANGED ===== -->
        <div class="block md:hidden bg-white p-10 rounded-3xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-100">
                <h3 class="text-3xl font-bold text-gray-900 tracking-tight">Your Profile</h3>
                <button id="edit-programmer-profile-btn-mobile" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-indigo-700 transition-all shadow-sm hover:shadow">
                    Edit Profile
                </button>
            </div>
            <div class="grid grid-cols-1 gap-10">
                <div class="flex justify-center">
                    <img id="programmer-overview-pic-mobile" src="https://placehold.co/200x200/e0e7ff/6366f1?text=P" alt="Profile" class="w-52 h-52 object-cover rounded-3xl shadow-lg border border-gray-100">
                </div>
                <div class="space-y-5">
                    <div class="pb-5 border-b border-gray-50 text-center">
                        <h4 id="programmer-overview-name-mobile" class="text-4xl font-bold text-gray-900 tracking-tight mb-2">Programmer Name</h4>
                        <p id="programmer-overview-org-mobile" class="text-2xl text-indigo-600 font-semibold">Organization Name</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-3 rounded-xl">
                            <span class="block text-xs font-semibold text-gray-500 mb-1">EMAIL</span>
                            <span id="programmer-overview-email-mobile" class="font-medium text-gray-900">email@example.com</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl">
                            <span class="block text-xs font-semibold text-gray-500 mb-1">PHONE</span>
                            <span id="programmer-overview-phone-mobile" class="font-medium text-gray-900">Phone</span>
                        </div>
                        <div class="col-span-2 bg-gray-50 p-3 rounded-xl">
                            <span class="block text-xs font-semibold text-gray-500 mb-1">WEBSITE</span>
                            <a id="programmer-overview-website-mobile" href="#" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800 transition-colors">Website</a>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="text-xs font-semibold text-gray-500 mb-2">ABOUT ORGANIZATION</p>
                        <p id="programmer-overview-about-mobile" class="text-gray-700 leading-relaxed">Organization description here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== DESKTOP VIEW (>= md) - MOCKUP MATCHED ===== -->
        <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-gray-100">
            <div class="p-8">
                <div class="flex items-start gap-8">

                    <!-- Left: Avatar (square with rounded corners) -->
                    <div class="flex-shrink-0">
                        <div id="programmer-avatar-placeholder" class="w-32 h-32 rounded-2xl flex items-center justify-center border-2"
                             style="background-color: #c4b5fd; border-color: #a78bfa;">
                            <span id="programmer-avatar-initial" class="text-5xl font-bold" style="color: #7c3aed;">P</span>
                        </div>
                        <img id="programmer-overview-pic-desktop"
                             src=""
                             alt="Profile"
                             class="hidden w-32 h-32 rounded-2xl object-cover border-2"
                             style="border-color: #a78bfa; max-width: 128px; max-height: 128px;">
                    </div>

                    <!-- Right: Info -->
                    <div class="flex-grow">
                        <!-- Row 1: Name + Badge -->
                        <div class="flex items-start justify-between mb-1">
                            <div>
                                <h2 id="programmer-overview-name-desktop" class="text-3xl font-bold" style="color: #7c3aed;">Tim Thomaesz</h2>
                                <p id="programmer-overview-org-desktop" class="text-lg text-gray-600">Dans Dichter Dans</p>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium border"
                                 style="background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0;">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span>Verified Programmer</span>
                            </div>
                        </div>

                        <!-- Row 2: Contact Info (single line with icons) -->
                        <div class="flex items-center gap-6 text-sm text-gray-600 mt-4 mb-6">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span id="programmer-overview-email-desktop">programmer1@test.com</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                <span id="programmer-overview-phone-desktop">+31612345671</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                </svg>
                                <a id="programmer-overview-website-desktop" href="#" target="_blank" style="color: #7c3aed;">eventco.nl</a>
                            </div>
                        </div>

                        <!-- Row 3: Action Buttons (dark filled) -->
                        <div class="flex items-center gap-3">
                            <button id="edit-programmer-profile-btn"
                                    class="px-6 py-2.5 rounded-lg font-semibold text-sm transition-all"
                                    style="background-color: #1f2937; color: white;">
                                Edit Profile
                            </button>
                            <button id="view-public-profile-btn"
                                    class="px-6 py-2.5 rounded-lg font-semibold text-sm transition-all"
                                    style="background-color: #1f2937; color: white;">
                                View Public Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Organization Card (Desktop only) -->
    <div id="programmer-about-card" class="hidden md:block bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-3">About Organization</h3>
        <p id="programmer-overview-about-desktop" class="text-gray-600 leading-relaxed">Organization description here</p>
    </div>

    <!-- Programmer Profile Editor -->
    <div id="programmer-profile-editor" class="hidden"></div>

    <!-- Search Section -->
    <div id="artist-search-section" class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100" style="min-height: 400px;"></div>

    <div class="text-center py-4 text-xs text-gray-400">v2.3 [29-12-2025]</div>
  `;

  console.log("Programmer dashboard HTML rendered");
}

/**
 * Toon profile overview (main view)
 */
export function showProgrammerProfileView() {
  const profileView = document.getElementById('programmer-profile-view');
  const editView = document.getElementById('programmer-edit-view');
  const publicView = document.getElementById('programmer-public-view');

  if (profileView) profileView.style.display = 'block';
  if (editView) editView.style.display = 'none';
  if (publicView) publicView.style.display = 'none';

  // Refresh data
  displayProgrammerProfileOverview();

  window.scrollTo({ top: 0, behavior: 'smooth' });

  console.log("[NAVIGATION] Switched to profile overview");
}

/**
 * Toon edit profile view
 */
export function showProgrammerEditView() {
  const profileView = document.getElementById('programmer-profile-view');
  const editView = document.getElementById('programmer-edit-view');
  const publicView = document.getElementById('programmer-public-view');

  if (profileView) profileView.style.display = 'none';
  if (editView) editView.style.display = 'block';
  if (publicView) publicView.style.display = 'none';

  // Populate form with current data
  populateProgrammerEditor();

  window.scrollTo({ top: 0, behavior: 'smooth' });

  console.log("[NAVIGATION] Switched to edit view");
}

/**
 * Toon public profile view
 */
export function showProgrammerPublicView() {
  const profileView = document.getElementById('programmer-profile-view');
  const editView = document.getElementById('programmer-edit-view');
  const publicView = document.getElementById('programmer-public-view');

  if (profileView) profileView.style.display = 'none';
  if (editView) editView.style.display = 'none';
  if (publicView) publicView.style.display = 'block';

  // Render public preview
  renderPublicPreviewCard();

  window.scrollTo({ top: 0, behavior: 'smooth' });

  console.log("[NAVIGATION] Switched to public view");
}

/**
 * Show only search section (hide profile sections)
 */
export function showSearchOnlyView() {
  console.log('[PROGRAMMER DASHBOARD] Showing search-only view');

  // Hide ALL profile sections (use correct IDs from actual HTML)
  const sectionsToHide = [
    'programmer-profile-overview',
    'programmer-public-preview',
    'programmer-about-card',
    'programmer-profile-editor',
    'programmer-pending-view'
  ];

  sectionsToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'none';
      el.classList.add('hidden');
    }
  });

  // SHOW search section
  const searchSection = document.getElementById('artist-search-section');
  if (searchSection) {
    searchSection.style.display = 'block';
    searchSection.style.opacity = '1';
    searchSection.style.visibility = 'visible';
    searchSection.classList.remove('hidden');
    console.log('[PROGRAMMER DASHBOARD] artist-search-section now visible');
  } else {
    console.error('[PROGRAMMER DASHBOARD] artist-search-section NOT FOUND');
  }
}

/**
 * Show only profile section (hide search section)
 */
export function showProfileOnlyView() {
  console.log('[PROGRAMMER DASHBOARD] Showing profile-only view');

  // SHOW profile sections (use correct IDs from actual HTML)
  const sectionsToShow = [
    'programmer-profile-overview',
    'programmer-public-preview',
    'programmer-about-card'
  ];

  sectionsToShow.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'block';
      el.classList.remove('hidden');
    }
  });

  // HIDE editor
  const editor = document.getElementById('programmer-profile-editor');
  if (editor) {
    editor.style.display = 'none';
    editor.classList.add('hidden');
  }

  // HIDE search section
  const searchSection = document.getElementById('artist-search-section');
  if (searchSection) {
    searchSection.style.display = 'none';
    searchSection.classList.add('hidden');
  }

  // Refresh profile data
  displayProgrammerProfileOverview();

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Render public preview in de card (voor de separate public view page)
 */
function renderPublicPreviewCard() {
  const container = document.getElementById('programmer-public-preview-card');
  const currentUserData = getStore('currentUserData');
  const currentUser = getStore('currentUser');

  if (!container || !currentUserData) return;

  const firstName = currentUserData.firstName || '';
  const lastName = currentUserData.lastName || '';
  const fullName = `${firstName} ${lastName}`.trim() || 'Programmer';
  const orgName = currentUserData.organizationName || 'Organization';
  const email = currentUser?.email || '';
  const phone = currentUserData.phone || '';
  const website = currentUserData.website || '';
  const about = currentUserData.organizationAbout || 'No description available.';
  const profilePic = currentUserData.profilePicUrl;
  const initial = (firstName || 'P').charAt(0).toUpperCase();

  container.innerHTML = `
    <div style="display: flex; gap: 28px; align-items: flex-start; margin-bottom: 24px;">

      <!-- Profile Picture -->
      <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #e9e3f5 0%, #d4c8eb 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden;">
        ${profilePic
          ? `<img src="${profilePic}" style="width: 100%; height: 100%; object-fit: cover;">`
          : `<span style="font-size: 48px; font-weight: 600; color: #805ad5;">${initial}</span>`
        }
      </div>

      <!-- Info -->
      <div style="flex: 1;">
        <h2 style="font-size: 28px; font-weight: 700; color: #1a1a2e; margin-bottom: 4px;">${fullName}</h2>
        <p style="font-size: 18px; color: #805ad5; font-weight: 600; margin-bottom: 16px;">${orgName}</p>

        <!-- Contact -->
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${email ? `
            <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
              <svg width="16" height="16" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              ${email}
            </div>
          ` : ''}
          ${phone ? `
            <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
              <svg width="16" height="16" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
              ${phone}
            </div>
          ` : ''}
          ${website ? `
            <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
              <svg width="16" height="16" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
              ${website.replace(/^https?:\/\//, '')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>

    <!-- About -->
    <div style="border-top: 1px solid #e9e3f5; padding-top: 20px; margin-bottom: 20px;">
      <h3 style="font-size: 14px; font-weight: 600; color: #805ad5; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">About ${orgName}</h3>
      <p style="color: #4a4a68; font-size: 15px; line-height: 1.7;">${about}</p>
    </div>

    <!-- Verified Badge -->
    <div style="display: flex; justify-content: center; padding-top: 16px; border-top: 1px solid #e9e3f5;">
      <span style="display: inline-flex; align-items: center; gap: 6px; color: #805ad5; font-size: 14px; font-weight: 500;">
        <svg width="18" height="18" fill="#805ad5" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        Verified Programmer
      </span>
    </div>
  `;

  console.log("[PUBLIC VIEW] Public preview card rendered");
}

/**
 * Populate edit form with current user data
 */
function populateProgrammerEditor() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData) {
    console.warn("[EDIT] No user data to populate");
    return;
  }

  // Populate form fields
  const firstNameInput = document.getElementById('programmer-edit-firstname');
  const lastNameInput = document.getElementById('programmer-edit-lastname');
  const phoneInput = document.getElementById('programmer-edit-phone');
  const orgNameInput = document.getElementById('programmer-edit-org-name');
  const websiteInput = document.getElementById('programmer-edit-website');
  const orgAboutInput = document.getElementById('programmer-edit-org-about');
  const picPreview = document.getElementById('programmer-edit-pic-preview');

  if (firstNameInput) firstNameInput.value = currentUserData.firstName || '';
  if (lastNameInput) lastNameInput.value = currentUserData.lastName || '';
  if (phoneInput) phoneInput.value = currentUserData.phone || '';
  if (orgNameInput) orgNameInput.value = currentUserData.organizationName || '';
  if (websiteInput) websiteInput.value = currentUserData.website || '';
  if (orgAboutInput) orgAboutInput.value = currentUserData.organizationAbout || '';

  // Update profile picture preview
  if (picPreview && currentUserData.profilePicUrl) {
    picPreview.src = currentUserData.profilePicUrl;
  }

  console.log("[EDIT] Form populated with current data");
}

/**
 * Setup programmer dashboard
 * Only handles the profile overview display and navigation
 */
export function setupProgrammerDashboard() {
  console.log("[SETUP PROGRAMMER DASHBOARD] Starting programmer dashboard setup...");

  // Display profile overview
  displayProgrammerProfileOverview();

  // Setup edit profile button
  setupEditProfileButton();

  console.log("[SETUP PROGRAMMER DASHBOARD] ‚úÖ Programmer dashboard setup complete");
}

/**
 * Setup navigation event handlers using event delegation
 */
function setupProgrammerNavigation() {
  const dashboard = document.getElementById('programmer-dashboard');

  if (!dashboard) {
    console.warn("[NAVIGATION] Dashboard container not found");
    return;
  }

  // Prevent duplicate listeners
  if (dashboard.dataset.navListenersAttached === 'true') {
    console.log("[NAVIGATION] Listeners already attached, skipping");
    return;
  }

  // Use event delegation for all navigation clicks
  dashboard.addEventListener('click', (e) => {
    // Edit Profile button (both mobile and desktop)
    if (e.target.closest('#edit-programmer-profile-btn') || e.target.closest('#edit-programmer-profile-btn-mobile')) {
      e.preventDefault();
      showProgrammerEditView();
      return;
    }

    // View Public Profile button
    if (e.target.closest('#view-public-profile-btn')) {
      e.preventDefault();
      showProgrammerPublicView();
      return;
    }

    // Back from Edit (both back button and cancel button)
    if (e.target.closest('#back-from-edit-btn') || e.target.closest('#cancel-edit-btn')) {
      e.preventDefault();
      showProgrammerProfileView();
      return;
    }

    // Back from Public
    if (e.target.closest('#back-from-public-btn')) {
      e.preventDefault();
      showProgrammerProfileView();
      return;
    }
  });

  // Form submit handler
  dashboard.addEventListener('submit', (e) => {
    if (e.target.id === 'programmer-profile-form') {
      e.preventDefault();
      handleProgrammerProfileSubmit(e);
    }
  });

  // Profile picture preview on file select
  dashboard.addEventListener('change', (e) => {
    if (e.target.id === 'programmer-edit-profile-pic') {
      const file = e.target.files?.[0];
      const preview = document.getElementById('programmer-edit-pic-preview');

      if (file && preview) {
        const reader = new FileReader();
        reader.onload = (event) => {
          preview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
  });

  // Mobile Save button (for edit view)
  const mobileSaveBtn = document.getElementById('mobile-save-profile-btn');
  if (mobileSaveBtn) {
    mobileSaveBtn.addEventListener('click', async () => {
      await saveMobileProfileChanges();
    });
  }

  // Mobile Cancel button (for edit view)
  const mobileCancelBtn = document.getElementById('mobile-cancel-edit-btn');
  if (mobileCancelBtn) {
    mobileCancelBtn.addEventListener('click', () => {
      showProgrammerProfileView();
    });
  }

  // Mobile photo upload (for edit view)
  const mobilePhotoInput = document.getElementById('mobile-edit-photo-input');
  if (mobilePhotoInput) {
    mobilePhotoInput.addEventListener('change', handleMobilePhotoUpload);
  }

  dashboard.dataset.navListenersAttached = 'true';

  console.log("[NAVIGATION] Event listeners attached via event delegation (including mobile)");
}

/**
 * Handles form submission to save profile changes
 * Navigates back to profile view after successful save
 */
async function handleProgrammerProfileSubmit(e) {
  e.preventDefault();

  const successMsg = document.getElementById('programmer-profile-success');
  const errorMsg = document.getElementById('programmer-profile-error');
  const submitBtn = document.getElementById('save-programmer-profile-btn');

  // Reset messages
  if (successMsg) successMsg.style.display = 'none';
  if (errorMsg) errorMsg.style.display = 'none';

  // Disable button
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
  }

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error("No user logged in");
    }

    const uid = currentUser.uid;
    const docRef = doc(db, 'programmers', uid);

    // Collect form data
    const dataToUpdate = {
      firstName: document.getElementById('programmer-edit-firstname')?.value.trim() || '',
      lastName: document.getElementById('programmer-edit-lastname')?.value.trim() || '',
      phone: document.getElementById('programmer-edit-phone')?.value.trim() || '',
      organizationName: document.getElementById('programmer-edit-org-name')?.value.trim() || '',
      organizationAbout: document.getElementById('programmer-edit-org-about')?.value.trim() || '',
      website: document.getElementById('programmer-edit-website')?.value.trim() || ''
    };

    // Validate required fields
    if (!dataToUpdate.firstName || !dataToUpdate.lastName || !dataToUpdate.organizationName) {
      throw new Error("Please fill in all required fields (marked with *)");
    }

    // Handle profile picture upload
    const fileInput = document.getElementById('programmer-edit-profile-pic');
    const file = fileInput?.files?.[0];

    if (file) {
      console.log("[SAVE] Uploading profile picture...");

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('File size must be less than 5MB');
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error('Please select an image file');
      }

      const storage = getStorage();
      const storageRef = ref(storage, `programmers/${uid}/profile.jpg`);

      // Upload file
      const snapshot = await uploadBytes(storageRef, file);

      // Get download URL
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("[SAVE] Profile picture uploaded:", downloadURL);

      // Add URL to data
      dataToUpdate.profilePicUrl = downloadURL;
    }

    // Update Firestore
    await updateDoc(docRef, dataToUpdate);
    console.log("[SAVE] Profile updated successfully");

    // Update local store
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...dataToUpdate });

    // Show success message
    if (successMsg) {
      successMsg.textContent = '‚úì Profile updated successfully!';
      successMsg.style.display = 'block';
    }

    // Clear file input
    if (file && fileInput) {
      fileInput.value = '';
    }

    // Navigate back to profile view after 1.5 seconds
    setTimeout(() => {
      showProgrammerProfileView();
    }, 1500);

  } catch (error) {
    console.error("[SAVE] Error saving profile:", error);
    if (errorMsg) {
      errorMsg.textContent = error.message || 'Failed to save profile';
      errorMsg.style.display = 'block';
    }
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Changes';
    }
  }
}

/**
 * Populates mobile profile view with user data
 */
export function populateMobileProfile(userData) {
  if (!userData) return;

  const photoEl = document.getElementById('mobile-profile-photo');
  const nameEl = document.getElementById('mobile-profile-name');
  const orgEl = document.getElementById('mobile-profile-org');
  const aboutEl = document.getElementById('mobile-profile-about');
  const emailLink = document.getElementById('mobile-profile-email-link');
  const websiteLink = document.getElementById('mobile-profile-website-link');

  const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Naam';

  if (photoEl) {
    photoEl.src = userData.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=e0e7ff&color=6366f1&size=280`;
  }
  if (nameEl) nameEl.textContent = fullName;
  if (orgEl) orgEl.textContent = userData.organizationName || userData.companyName || 'Organisatie';
  if (aboutEl) aboutEl.textContent = userData.organizationAbout || userData.bio || userData.about || 'Geen beschrijving beschikbaar.';

  const currentUser = getStore('currentUser');
  if (emailLink && currentUser?.email) {
    emailLink.href = `mailto:${currentUser.email}`;
    emailLink.style.display = 'flex';
  }
  if (websiteLink && userData.website) {
    websiteLink.href = userData.website;
    websiteLink.style.display = 'flex';
  } else if (websiteLink) {
    websiteLink.style.display = 'none';
  }

  console.log('[MOBILE PROFILE] Mobile profile populated');
}

/**
 * Populates mobile edit form with user data
 */
export function populateMobileEditForm(userData) {
  if (!userData) return;

  const photoPreview = document.getElementById('mobile-edit-photo-preview');
  const phoneInput = document.getElementById('mobile-edit-phone');
  const orgNameInput = document.getElementById('mobile-edit-org-name');
  const websiteInput = document.getElementById('mobile-edit-website');
  const aboutInput = document.getElementById('mobile-edit-about');
  const languageSelect = document.getElementById('mobile-edit-language');

  const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'User';

  if (photoPreview) {
    photoPreview.src = userData.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=e0e7ff&color=6366f1&size=60`;
  }
  if (phoneInput) phoneInput.value = userData.phone || '';
  if (orgNameInput) orgNameInput.value = userData.organizationName || userData.companyName || '';
  if (websiteInput) websiteInput.value = userData.website || '';
  if (aboutInput) aboutInput.value = userData.organizationAbout || userData.bio || userData.about || '';
  if (languageSelect) languageSelect.value = userData.language || 'nl';

  console.log('[MOBILE EDIT] Mobile edit form populated');
}

/**
 * Saves mobile profile changes to Firestore
 */
async function saveMobileProfileChanges() {
  // Collect values from mobile form
  const phone = document.getElementById('mobile-edit-phone')?.value || '';
  const orgName = document.getElementById('mobile-edit-org-name')?.value || '';
  const website = document.getElementById('mobile-edit-website')?.value || '';
  const about = document.getElementById('mobile-edit-about')?.value || '';
  const language = document.getElementById('mobile-edit-language')?.value || 'nl';

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error('No user logged in');
    }

    const docRef = doc(db, 'programmers', currentUser.uid);

    await updateDoc(docRef, {
      phone,
      organizationName: orgName,
      website,
      organizationAbout: about,
      language,
      updatedAt: new Date()
    });

    // Update local store
    const userData = getStore('currentUserData');
    setStore('currentUserData', {
      ...userData,
      phone,
      organizationName: orgName,
      website,
      organizationAbout: about,
      language
    });

    // Show success and go back
    alert('Profiel opgeslagen!');
    showProgrammerProfileView();

    console.log('[MOBILE SAVE] Profile saved successfully');
  } catch (error) {
    console.error('[MOBILE SAVE] Error saving profile:', error);
    alert('Fout bij opslaan. Probeer opnieuw.');
  }
}

/**
 * Handles mobile photo upload
 */
async function handleMobilePhotoUpload(e) {
  const file = e.target.files?.[0];
  if (!file) return;

  // Update preview immediately
  const preview = document.getElementById('mobile-edit-photo-preview');
  if (preview) {
    preview.src = URL.createObjectURL(file);
  }

  try {
    const currentUser = getStore('currentUser');
    if (!currentUser) {
      throw new Error('No user logged in');
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      throw new Error('File size must be less than 5MB');
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      throw new Error('Please select an image file');
    }

    const storage = getStorage();
    const storageRef = ref(storage, `programmers/${currentUser.uid}/profile.jpg`);

    // Upload file
    const snapshot = await uploadBytes(storageRef, file);

    // Get download URL
    const downloadURL = await getDownloadURL(snapshot.ref);

    // Update Firestore
    const docRef = doc(db, 'programmers', currentUser.uid);
    await updateDoc(docRef, {
      profilePicUrl: downloadURL,
      updatedAt: new Date()
    });

    // Update local store
    const userData = getStore('currentUserData');
    setStore('currentUserData', {
      ...userData,
      profilePicUrl: downloadURL
    });

    console.log('[MOBILE PHOTO] Profile photo uploaded:', downloadURL);
  } catch (error) {
    console.error('[MOBILE PHOTO] Error uploading photo:', error);
    alert('Fout bij uploaden foto. Probeer opnieuw.');
  }
}

/**
 * Displays the programmer profile overview (read-only)
 * UPDATED: Supports separate mobile and desktop element IDs
 */
export function displayProgrammerProfileOverview() {
  const currentUserData = getStore('currentUserData');
  const currentUser = getStore('currentUser');

  if (!currentUserData || !currentUser) {
    console.log("[PROFILE] No user data yet, skipping profile overview display");
    return;
  }

  // Extract data with fallbacks
  const firstName = currentUserData.firstName || '';
  const lastName = currentUserData.lastName || '';
  const fullName = `${firstName} ${lastName}`.trim() || 'Programmer Name';
  const initial = (firstName.charAt(0) || 'P').toUpperCase();
  const organizationName = currentUserData.organizationName || 'Organization Name';
  const email = currentUser?.email || 'email@example.com';
  const phone = currentUserData.phone || 'Not specified';
  const website = currentUserData.website || '';
  const about = currentUserData.organizationAbout || 'No description available';
  const profilePicUrl = currentUserData.profilePicUrl || '';

  // Helper: Set text content safely
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  // Helper: Set link safely
  const setLink = (id, url) => {
    const el = document.getElementById(id);
    if (el) {
      if (url) {
        el.href = url.startsWith('http') ? url : `https://${url}`;
        el.textContent = url.replace(/^https?:\/\//, '');
      } else {
        el.href = '#';
        el.textContent = 'Not specified';
      }
    }
  };

  // ===== MOBILE ELEMENTS =====
  const mobilePic = document.getElementById('programmer-overview-pic-mobile');
  if (mobilePic) {
    mobilePic.src = profilePicUrl || `https://placehold.co/200x200/e0e7ff/6366f1?text=${encodeURIComponent(initial)}`;
  }
  setText('programmer-overview-name-mobile', fullName);
  setText('programmer-overview-org-mobile', organizationName);
  setText('programmer-overview-email-mobile', email);
  setText('programmer-overview-phone-mobile', phone);
  setLink('programmer-overview-website-mobile', website);
  setText('programmer-overview-about-mobile', about);

  // ===== DESKTOP ELEMENTS =====
  // Avatar: show photo OR placeholder with initial
  const avatarPlaceholder = document.getElementById('programmer-avatar-placeholder');
  const avatarInitial = document.getElementById('programmer-avatar-initial');
  const desktopPic = document.getElementById('programmer-overview-pic-desktop');

  if (profilePicUrl) {
    // Has profile picture - show image, hide placeholder
    if (desktopPic) {
      desktopPic.src = profilePicUrl;
      desktopPic.classList.remove('hidden');
      desktopPic.style.display = 'block';
    }
    if (avatarPlaceholder) {
      avatarPlaceholder.classList.add('hidden');
      avatarPlaceholder.style.display = 'none';
    }
    console.log("[PROFILE] Desktop: Showing profile picture");
  } else {
    // No profile picture - show placeholder with initial
    if (desktopPic) {
      desktopPic.classList.add('hidden');
      desktopPic.style.display = 'none';
    }
    if (avatarPlaceholder) {
      avatarPlaceholder.classList.remove('hidden');
      avatarPlaceholder.style.display = 'flex';
    }
    if (avatarInitial) {
      avatarInitial.textContent = initial;
    }
    console.log("[PROFILE] Desktop: Showing avatar placeholder with initial:", initial);
  }

  // Desktop text fields
  setText('programmer-overview-name-desktop', fullName);
  setText('programmer-overview-org-desktop', organizationName);
  setText('programmer-overview-email-desktop', email);
  setText('programmer-overview-phone-desktop', phone);
  setLink('programmer-overview-website-desktop', website);
  setText('programmer-overview-about-desktop', about);

  console.log("[PROFILE] Profile overview displayed (mobile + desktop)");
}

/**
 * Setup edit profile button click handlers
 * Supports both mobile and desktop edit buttons
 */
function setupEditProfileButton() {
  const container = document.getElementById('programmer-dashboard');
  const editor = document.getElementById('programmer-profile-editor');

  if (!container || !editor) {
    console.warn("[SETUP EDIT BTN] Dashboard container or editor not found");
    return;
  }

  // Prevent duplicate listeners
  if (container.dataset.editListenerAttached === 'true') {
    console.log("[PROGRAMMER DASHBOARD] Edit button listener already attached, skipping");
    return;
  }

  container.addEventListener('click', (e) => {
    // Handle BOTH edit buttons (mobile: #edit-programmer-profile-btn-mobile, desktop: #edit-programmer-profile-btn)
    const clickedEditBtn = e.target.closest('#edit-programmer-profile-btn, #edit-programmer-profile-btn-mobile');

    if (clickedEditBtn) {
      e.preventDefault();
      e.stopPropagation();
      console.log("[PROGRAMMER DASHBOARD] Edit profile button clicked");

      // Navigate to edit profile page
      import('../../ui/ui.js').then(module => {
        module.showEditProfile();
      });
    }

    // Handle View Public Profile button
    const clickedViewBtn = e.target.closest('#view-public-profile-btn');
    if (clickedViewBtn) {
      e.preventDefault();
      e.stopPropagation();
      console.log("[PROGRAMMER DASHBOARD] View public profile clicked");

      // Navigate to public profile page
      import('../../ui/ui.js').then(module => {
        module.showPublicProfile();
      });
    }
  });

  container.dataset.editListenerAttached = 'true';
  console.log("[PROGRAMMER DASHBOARD] Button listeners attached (mobile + desktop)");
}
</file>

<file path="src/modules/dashboard/dashboard-ui.js">
/**
 * dashboard-ui.js
 * Apple-style UI rendering for artist dashboard
 * Focuses on clean, minimal widgets with premium styling
 */

import { calculateAge } from './dashboard-service.js';
import { getStore } from '../../utils/store.js';

/**
 * Renders the artist dashboard HTML structure
 * Apple-esque design: white cards, rounded corners, subtle shadows
 */
export function renderArtistDashboard() {
  const container = document.getElementById('artist-dashboard');

  if (!container) {
    console.warn("Artist dashboard container not found");
    return;
  }

  container.innerHTML = `
    <!-- Profile Overview Card -->
    <div id="artist-profile-overview" class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 mb-8">
      <div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-100">
        <h3 class="text-3xl font-bold text-gray-900 tracking-tight">Your Profile</h3>
        <button id="edit-artist-profile-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-indigo-700 transition-all shadow-sm hover:shadow">
          Edit Profile
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
        <!-- Profile Picture -->
        <div class="flex justify-center md:justify-start">
          <img id="artist-overview-pic" src="https://placehold.co/200x200/e0e7ff/6366f1?text=A" alt="Profile" class="w-52 h-52 md:w-72 md:h-72 object-cover rounded-3xl shadow-lg border border-gray-100">
        </div>

        <!-- Profile Info -->
        <div class="space-y-5">
          <div class="pb-5 border-b border-gray-50">
            <h4 id="artist-overview-name" class="text-4xl font-bold text-gray-900 tracking-tight mb-2">Artist Name</h4>
            <p id="artist-overview-stagename" class="text-2xl text-indigo-600 font-semibold">Stage Name</p>
          </div>

          <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-50 p-3 rounded-xl">
              <span class="block text-xs font-semibold text-gray-500 mb-1">LOCATION</span>
              <span id="artist-overview-location" class="font-medium text-gray-900">Location</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl">
              <span class="block text-xs font-semibold text-gray-500 mb-1">PHONE</span>
              <span id="artist-overview-phone" class="font-medium text-gray-900">Phone</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl">
              <span class="block text-xs font-semibold text-gray-500 mb-1">GENDER</span>
              <span id="artist-overview-gender" class="font-medium text-gray-900">Gender</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl">
              <span class="block text-xs font-semibold text-gray-500 mb-1">AGE</span>
              <span id="artist-overview-age" class="font-medium text-gray-900">Age</span>
            </div>
          </div>

          <!-- Genres -->
          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-2">GENRES</span>
            <div id="artist-overview-genres" class="flex flex-wrap gap-2">
              <!-- Badges will be inserted here -->
            </div>
          </div>

          <!-- Languages -->
          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-2">LANGUAGES</span>
            <div id="artist-overview-languages" class="flex flex-wrap gap-2">
              <!-- Badges will be inserted here -->
            </div>
          </div>

          <!-- Payment Methods -->
          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-2">PAYMENT METHODS</span>
            <div id="artist-overview-payment" class="flex flex-wrap gap-2">
              <!-- Badges will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Bio & Pitch -->
      <div class="mt-8 space-y-4">
        <div class="bg-gray-50 p-4 rounded-xl">
          <p class="text-xs font-semibold text-gray-500 mb-2">BIO</p>
          <p id="artist-overview-bio" class="text-gray-700 leading-relaxed">Bio content here</p>
        </div>

        <div class="bg-gray-50 p-4 rounded-xl">
          <p class="text-xs font-semibold text-gray-500 mb-2">PITCH</p>
          <p id="artist-overview-pitch" class="text-gray-700 leading-relaxed">Pitch content here</p>
        </div>
      </div>
    </div>

    <!-- Profile Editor (Hidden by default) -->
    <div id="artist-profile-editor" class="hidden">
      <!-- Editor content will be rendered dynamically -->
    </div>

    <!-- Artist Recommendations Section -->
    <div id="artist-recommendations-section" class="hidden bg-white p-10 rounded-3xl shadow-sm border border-gray-100">
      <h3 class="text-3xl font-bold text-gray-900 tracking-tight mb-8 pb-6 border-b border-gray-100">My Recommendations</h3>

      <!-- Loading State -->
      <div id="recommendations-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="text-gray-600 mt-4">Loading recommendations...</p>
      </div>

      <!-- Error State -->
      <div id="recommendations-error" class="text-center py-8 text-red-600" style="display: none;">
        Error loading recommendations
      </div>

      <!-- Empty State -->
      <div id="recommendations-empty" class="text-center py-8 bg-gray-50 rounded-xl" style="display: none;">
        <p class="text-gray-600">No recommendations yet. Programmers can write recommendations after viewing your profile.</p>
      </div>

      <!-- Recommendations List -->
      <div id="recommendations-list" class="space-y-4" style="display: none;">
        <!-- Recommendations will be inserted here dynamically -->
      </div>
    </div>

    <!-- Version Badge -->
    <div class="text-center py-6 text-xs text-gray-400">
      Staging v2.1 (Modular Dashboard) [23-12-2025]
    </div>
  `;

  console.log("Artist dashboard HTML rendered with Apple-esque styling");
}

/**
 * Render the profile editor form
 */
export function renderProfileEditor() {
  const container = document.getElementById('artist-profile-editor');
  if (!container) return;

  container.innerHTML = `
    <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">

      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-100">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Edit Artist Profile</h2>
          <p class="text-sm text-gray-500 mt-1">Update your information below.</p>
        </div>
        <button id="cancel-edit-profile-btn" class="text-gray-600 hover:text-gray-900 font-medium px-4 py-2 rounded-xl hover:bg-gray-50">
          Cancel
        </button>
      </div>

      <!-- Main Content: 2-column on desktop -->
      <div class="flex flex-col lg:flex-row">

        <!-- LEFT COLUMN: Profile Photo -->
        <div class="lg:w-72 lg:border-r border-gray-100 p-6 lg:sticky lg:top-0 lg:self-start bg-gray-50 lg:bg-white">
          <div class="text-center">
            <img id="artist-profile-pic-preview"
                 src="https://placehold.co/150x150/e0e7ff/6366f1?text=A"
                 alt="Profile"
                 class="w-32 h-32 lg:w-36 lg:h-36 rounded-full object-cover mx-auto border-4 border-white shadow-lg">
            <label class="mt-4 inline-block cursor-pointer bg-gray-900 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-800">
              Change Photo
              <input id="artist-edit-profile-pic" type="file" accept="image/*" class="sr-only">
            </label>
            <p class="text-xs text-gray-400 mt-2">JPG, PNG or GIF. Max 5MB.</p>
          </div>
          <button id="view-public-profile-btn" type="button" class="w-full mt-6 py-3 bg-gray-900 text-white rounded-xl font-semibold hover:bg-gray-800">
            View Public Profile
          </button>
        </div>

        <!-- RIGHT COLUMN: Tabbed Content -->
        <div class="flex-1 min-w-0">

          <!-- Tab Navigation (desktop only) -->
          <div id="editor-tabs" class="hidden lg:flex border-b border-gray-200 bg-gray-50">
            <button type="button" class="tab-btn px-6 py-4 font-semibold border-b-2 text-indigo-600 border-indigo-600 bg-white" data-tab="basics">
              Basics & Identity
            </button>
            <button type="button" class="tab-btn px-6 py-4 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="media">
              Bio & Media
            </button>
            <button type="button" class="tab-btn px-6 py-4 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="contact">
              Contact & Socials
            </button>
          </div>

          <!-- Form -->
          <form id="artist-profile-form">

            <!-- TAB 1: Basics & Identity -->
            <div class="tab-panel" data-tab-content="basics">
              <!-- MOBILE: Accordion Header -->
              <button type="button" class="accordion-header lg:hidden w-full flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200" data-accordion="basics">
                <span class="font-semibold text-gray-900">1. Basics & Identity</span>
                <svg class="accordion-chevron w-5 h-5 text-gray-500 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <!-- Content -->
              <div id="tab-basics" class="accordion-content p-6 space-y-6">

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Display Name (Stage Name) *</label>
                  <input id="artist-edit-stagename" type="text" required
                         class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Location (City, Country) *</label>
                  <input id="artist-edit-location" type="text" required
                         class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Genres *</label>
                <div id="artist-edit-genres" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Languages *</label>
                <div id="artist-edit-languages" class="flex flex-wrap gap-2"></div>
              </div>

              <!-- Themes -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                  Thema's <span class="text-gray-400 font-normal">(selecteer meerdere)</span>
                </label>
                <div id="artist-edit-themes" class="flex flex-wrap gap-2"></div>
              </div>

              <!-- Energy Levels -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                  Vibe <span class="text-gray-400 font-normal">(selecteer meerdere)</span>
                </label>
                <div id="artist-edit-energy" class="flex flex-wrap gap-2"></div>
              </div>

              <!-- Formats -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                  Diensten / Format <span class="text-gray-400 font-normal">(selecteer meerdere)</span>
                </label>
                <div id="artist-edit-formats" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Short Pitch * <span class="font-normal text-gray-400">(max 150 chars)</span>
                </label>
                <textarea id="artist-edit-pitch" maxlength="150" rows="3" required
                          class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
                <p class="text-xs text-gray-400 mt-1 text-right"><span id="pitch-char-count">0</span>/150</p>
              </div>
              </div>
            </div>

            <!-- TAB 2: Bio & Media -->
            <div class="tab-panel" data-tab-content="media">
              <!-- MOBILE: Accordion Header -->
              <button type="button" class="accordion-header lg:hidden w-full flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200" data-accordion="media">
                <span class="font-semibold text-gray-900">2. Biography & Media</span>
                <svg class="accordion-chevron w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <!-- Content (hidden by default on mobile) -->
              <div id="tab-media" class="accordion-content p-6 space-y-6 hidden lg:hidden">

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Bio / Background Info *</label>
                <textarea id="artist-edit-bio" rows="5" required
                          class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">YouTube/Vimeo Link</label>
                <input id="artist-edit-video" type="url"
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Spotify/SoundCloud Link</label>
                <input id="artist-edit-audio" type="url"
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Text Material <span class="font-normal text-gray-400">(up to 2000 words)</span></label>
                <textarea id="artist-edit-text" rows="5"
                          class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
              </div>

              <div>
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold text-gray-700">Documents (PDF, DOC, DOCX)</label>
                  <label class="cursor-pointer bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-indigo-700">
                    + Add Document
                    <input id="artist-add-document" type="file" accept=".pdf,.doc,.docx" class="sr-only">
                  </label>
                </div>
                <p class="text-xs text-gray-400 mb-3">Maximum 10MB per file</p>
                <div id="artist-documents-preview" class="space-y-2">
                  <!-- Documents rendered via JS -->
                </div>
              </div>

              <div>
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold text-gray-700">Gallery Photos</label>
                  <label class="cursor-pointer bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-indigo-700">
                    + Add Photo
                    <input id="artist-add-gallery-photo" type="file" accept="image/*" class="sr-only">
                  </label>
                </div>
                <div id="artist-gallery-preview" class="grid grid-cols-3 gap-3">
                  <!-- Photos rendered via JS -->
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">YouTube Videos</label>
                <div class="flex gap-2 mb-3">
                  <input id="youtube-url-input" type="url"
                         class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                         placeholder="https://www.youtube.com/watch?v=...">
                  <button type="button" id="add-youtube-btn" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 whitespace-nowrap">
                    Add Video
                  </button>
                </div>
                <div id="artist-youtube-preview" class="grid grid-cols-2 gap-3">
                  <!-- Videos rendered via JS -->
                </div>
              </div>
              </div>
            </div>

            <!-- TAB 3: Contact & Socials -->
            <div class="tab-panel" data-tab-content="contact">
              <!-- MOBILE: Accordion Header -->
              <button type="button" class="accordion-header lg:hidden w-full flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200" data-accordion="contact">
                <span class="font-semibold text-gray-900">3. Contact & Socials</span>
                <svg class="accordion-chevron w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <!-- Content (hidden by default on mobile) -->
              <div id="tab-contact" class="accordion-content p-6 space-y-6 hidden lg:hidden">

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number *</label>
                  <input id="artist-edit-phone" type="tel" required
                         class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                  <input id="artist-edit-website" type="url"
                         class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Payment Methods *</label>
                <div id="artist-edit-payment" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="pt-4 border-t border-gray-100">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Notification Settings</label>
                <div class="space-y-3">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input id="artist-edit-notify-email" type="checkbox" class="w-5 h-5 rounded text-indigo-600 border-gray-300">
                    <span class="text-sm text-gray-700">Receive email notifications</span>
                  </label>
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input id="artist-edit-notify-sms" type="checkbox" class="w-5 h-5 rounded text-indigo-600 border-gray-300">
                    <span class="text-sm text-gray-700">Receive SMS notifications</span>
                  </label>
                </div>
              </div>
              </div>
            </div>

            <!-- Hidden fields -->
            <input type="hidden" id="artist-edit-firstname">
            <input type="hidden" id="artist-edit-lastname">
            <input type="hidden" id="artist-edit-dob">
            <input type="hidden" id="artist-edit-gender">

          </form>
        </div>
      </div>

      <!-- Sticky Footer -->
      <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 shadow-lg">
        <div class="flex items-center justify-end gap-4 max-w-4xl mx-auto">
          <p id="artist-profile-error" class="text-red-500 text-sm mr-auto hidden"></p>
          <p id="artist-profile-success" class="text-green-600 text-sm mr-auto hidden"></p>
          <button type="submit" form="artist-profile-form" id="save-artist-profile-btn"
                  class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">
            Save All Changes
          </button>
        </div>
      </div>
    </div>
  `;

  // Initialize all handlers
  initEditorTabs();
  initMobileAccordions();
  renderEditorCheckboxes();
  setupChipToggle();
  initPitchCounter();
  setupGalleryUploadHandler();
  setupYouTubeAddHandler();
  setupDocumentUploadHandler();
  setupProfilePicPreview();
  setupViewPublicProfileHandler();

  // Attach form submit handler
  const form = document.getElementById('artist-profile-form');
  if (form) {
    form.addEventListener('submit', handleProfileSubmit);
  }

  // Populate with current data
  const currentUserData = getStore('currentUserData');
  if (currentUserData) {
    populateProfileEditor(currentUserData);
  }
}

function initEditorTabs() {
  const tabBtns = document.querySelectorAll('#editor-tabs .tab-btn');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.dataset.tab;

      // Update button styling
      tabBtns.forEach(b => {
        const isActive = b.dataset.tab === targetTab;
        b.classList.toggle('text-indigo-600', isActive);
        b.classList.toggle('border-indigo-600', isActive);
        b.classList.toggle('bg-white', isActive);
        b.classList.toggle('text-gray-500', !isActive);
        b.classList.toggle('border-transparent', !isActive);
      });

      // Show/hide content panels
      document.querySelectorAll('.accordion-content').forEach(content => {
        const panelId = content.id; // tab-basics, tab-media, tab-contact
        const panelTab = panelId.replace('tab-', '');

        if (panelTab === targetTab) {
          content.classList.remove('hidden', 'lg:hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    });
  });
}

function initMobileAccordions() {
  const headers = document.querySelectorAll('.accordion-header');

  headers.forEach(header => {
    header.addEventListener('click', () => {
      // Alleen op mobile
      if (window.innerWidth >= 1024) return;

      const targetId = header.dataset.accordion;
      const content = document.getElementById(`tab-${targetId}`);
      const chevron = header.querySelector('.accordion-chevron');
      const isOpen = !content.classList.contains('hidden');

      if (isOpen) {
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
      } else {
        content.classList.remove('hidden', 'lg:hidden');
        chevron.classList.add('rotate-180');
        setTimeout(() => {
          header.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    });
  });
}

function renderEditorCheckboxes() {
  // Genres - Updated list based on wireframe
  const genresContainer = document.getElementById('artist-edit-genres');
  if (genresContainer) {
    const genres = [
      { value: 'performance-poetry', label: 'Performance Poetry' },
      { value: 'slam-poetry', label: 'Slam Poetry' },
      { value: 'hip-hop-poetry', label: 'Hip Hop Poetry' },
      { value: 'storytelling', label: 'Storytelling' },
      { value: 'experimental', label: 'Experimental' },
      { value: 'musical-poetry', label: 'Musical Poetry' },
      { value: 'lyrical', label: 'Lyrical' },
      { value: 'political-poetry', label: 'Political Poetry' }
    ];
    genresContainer.innerHTML = genres.map(g => createChip('genre', g.value, g.label)).join('');
  }

  // Languages - Updated list based on wireframe
  const langsContainer = document.getElementById('artist-edit-languages');
  if (langsContainer) {
    const langs = [
      { value: 'nl', label: 'Dutch (NL)' },
      { value: 'en', label: 'English (EN)' },
      { value: 'fr', label: 'French (FR)' },
      { value: 'de', label: 'German (DE)' },
      { value: 'es', label: 'Spanish (ES)' }
    ];
    langsContainer.innerHTML = langs.map(l => createChip('language', l.value, l.label)).join('');
  }

  // Payment Methods
  const paymentContainer = document.getElementById('artist-edit-payment');
  if (paymentContainer) {
    const payments = [
      { value: 'invoice', label: 'Factuur' },
      { value: 'payrolling', label: 'Payrolling' },
      { value: 'sbk', label: 'SBK' },
      { value: 'volunteer', label: 'Vrijwilligersvergoeding' },
      { value: 'other', label: 'Anders' }
    ];
    paymentContainer.innerHTML = payments.map(p => createChip('payment', p.value, p.label)).join('');
  }

  // Themes - New field based on wireframe
  const themesContainer = document.getElementById('artist-edit-themes');
  if (themesContainer) {
    const themes = [
      { value: 'identity', label: 'Identity' },
      { value: 'social-justice', label: 'Social Justice' },
      { value: 'mental-health', label: 'Mental Health' },
      { value: 'love-relationships', label: 'Love/Relationships' },
      { value: 'politics', label: 'Politics' },
      { value: 'climate-change', label: 'Climate Change' },
      { value: 'coming-of-age', label: 'Coming of Age' }
    ];
    themesContainer.innerHTML = themes.map(t => createChip('theme', t.value, t.label)).join('');
  }

  // Energy Levels (Vibe) - New field based on wireframe
  const energyContainer = document.getElementById('artist-edit-energy');
  if (energyContainer) {
    const energyLevels = [
      { value: 'intiem', label: 'Intiem' },
      { value: 'interactief', label: 'Interactief' },
      { value: 'energiek', label: 'Energiek' }
    ];
    energyContainer.innerHTML = energyLevels.map(e => createChip('energy', e.value, e.label)).join('');
  }

  // Formats - New field
  const formatsContainer = document.getElementById('artist-edit-formats');
  if (formatsContainer) {
    const formats = [
      { value: 'podiumperformance', label: 'Podiumperformance' },
      { value: 'workshops', label: 'Workshops' },
      { value: 'hosting', label: 'Hosting / Presentatie' },
      { value: 'gedichten-op-maat', label: 'Gedichten op Maat' }
    ];
    formatsContainer.innerHTML = formats.map(f => createChip('format', f.value, f.label)).join('');
  }
}

function createChip(name, value, label) {
  return `
    <label class="chip-label inline-flex items-center px-4 py-2 rounded-full border-2 border-gray-300 bg-white cursor-pointer transition-all duration-200 hover:border-purple-400 hover:bg-purple-50 select-none">
      <input type="checkbox" name="${name}" value="${value}" class="chip-input sr-only">
      <span class="chip-text text-sm font-medium text-gray-700">${label}</span>
    </label>
  `;
}

function initPitchCounter() {
  const pitch = document.getElementById('artist-edit-pitch');
  const counter = document.getElementById('pitch-char-count');
  if (pitch && counter) {
    const update = () => { counter.textContent = pitch.value.length; };
    pitch.addEventListener('input', update);
    update();
  }
}

function setupChipToggle() {
  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('chip-input')) {
      const label = e.target.closest('.chip-label');
      if (label) {
        if (e.target.checked) {
          label.classList.add('chip-selected');
        } else {
          label.classList.remove('chip-selected');
        }
      }
    }
  });
}


/**
 * Display artist profile overview
 */
export function displayProfileOverview(currentUserData) {
  if (!currentUserData) {
    console.warn("No artist data found for overview");
    return;
  }

  // Profile Picture
  const overviewPic = document.getElementById('artist-overview-pic');
  if (overviewPic) {
    overviewPic.src = currentUserData.profilePicUrl ||
      `https://placehold.co/200x200/e0e7ff/6366f1?text=${encodeURIComponent((currentUserData.stageName || currentUserData.firstName || 'A').charAt(0))}`;
  }

  // Name & Stage Name
  document.getElementById('artist-overview-name').textContent =
    `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim() || 'Artist Name';
  document.getElementById('artist-overview-stagename').textContent =
    currentUserData.stageName || 'No stage name';

  // Basic Info
  document.getElementById('artist-overview-location').textContent = currentUserData.location || 'Not specified';
  document.getElementById('artist-overview-phone').textContent = currentUserData.phone || 'Not specified';

  // Gender
  const genderMap = { 'f': 'Female', 'm': 'Male', 'x': 'Other' };
  document.getElementById('artist-overview-gender').textContent = genderMap[currentUserData.gender] || 'Not specified';

  // Age
  if (currentUserData.dob) {
    const age = calculateAge(currentUserData.dob);
    document.getElementById('artist-overview-age').textContent = `${age} years old`;
  } else {
    document.getElementById('artist-overview-age').textContent = 'Not specified';
  }

  // Genres
  const genresContainer = document.getElementById('artist-overview-genres');
  genresContainer.innerHTML = '';
  if (currentUserData.genres && currentUserData.genres.length > 0) {
    currentUserData.genres.forEach(genre => {
      const badge = document.createElement('span');
      badge.className = 'inline-block bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-medium';
      badge.textContent = genre;
      genresContainer.appendChild(badge);
    });
  } else {
    genresContainer.textContent = 'No genres specified';
  }

  // Languages
  const languagesContainer = document.getElementById('artist-overview-languages');
  languagesContainer.innerHTML = '';
  if (currentUserData.languages && currentUserData.languages.length > 0) {
    currentUserData.languages.forEach(lang => {
      const badge = document.createElement('span');
      badge.className = 'inline-block bg-green-50 text-green-700 px-3 py-1 rounded-lg text-sm font-medium';
      badge.textContent = lang.toUpperCase();
      languagesContainer.appendChild(badge);
    });
  } else {
    languagesContainer.textContent = 'No languages specified';
  }

  // Payment Methods
  const paymentContainer = document.getElementById('artist-overview-payment');
  paymentContainer.innerHTML = '';
  if (currentUserData.paymentMethods && currentUserData.paymentMethods.length > 0) {
    currentUserData.paymentMethods.forEach(method => {
      const badge = document.createElement('span');
      badge.className = 'inline-block bg-purple-50 text-purple-700 px-3 py-1 rounded-lg text-sm font-medium';
      badge.textContent = method;
      paymentContainer.appendChild(badge);
    });
  } else {
    paymentContainer.textContent = 'No payment methods specified';
  }

  // Bio & Pitch
  document.getElementById('artist-overview-bio').textContent = currentUserData.bio || 'No bio available';
  document.getElementById('artist-overview-pitch').textContent = currentUserData.pitch || 'No pitch available';
}

/**
 * Populate the profile editor with current data
 */
export function populateProfileEditor(data) {
  if (!data) return;

  // === TAB 1: Basics & Identity ===
  setValue('artist-edit-stagename', data.stageName || '');
  setValue('artist-edit-location', data.location || '');
  setValue('artist-edit-pitch', data.pitch || '');
  checkValues('genre', data.genres || []);
  checkValues('language', data.languages || []);
  checkValues('theme', data.themes || []);
  checkValues('energy', data.energyLevels || []);
  checkValues('format', data.formats || []);
  updatePitchCount();

  // === TAB 2: Bio & Media ===
  setValue('artist-edit-bio', data.bio || '');
  setValue('artist-edit-video', data.videoUrl || '');
  setValue('artist-edit-audio', data.audioUrl || '');
  setValue('artist-edit-text', data.textContent || '');
  renderGalleryPreview(data.galleryPhotos || []);
  renderYouTubePreview(data.youtubeVideos || []);
  renderDocumentsPreview(data.documents || []);

  // === TAB 3: Contact & Socials ===
  setValue('artist-edit-phone', data.phone || '');
  setValue('artist-edit-website', data.website || '');
  checkValues('payment', data.paymentMethods || []);
  setChecked('artist-edit-notify-email', data.notifyEmail !== false);
  setChecked('artist-edit-notify-sms', data.notifySms === true);

  // === Hidden fields ===
  setValue('artist-edit-firstname', data.firstName || '');
  setValue('artist-edit-lastname', data.lastName || '');
  setValue('artist-edit-dob', data.dob || '');
  setValue('artist-edit-gender', data.gender || '');

  // === Profile Picture ===
  const picPreview = document.getElementById('artist-profile-pic-preview');
  if (picPreview) {
    picPreview.src = data.profilePicUrl ||
      `https://placehold.co/150x150/e0e7ff/6366f1?text=${encodeURIComponent((data.stageName || 'A').charAt(0))}`;
  }

  console.log('[EDITOR] Form populated with user data');
}

// === Helper Functions ===

function setValue(id, value) {
  const el = document.getElementById(id);
  if (el) el.value = value;
}

function setChecked(id, checked) {
  const el = document.getElementById(id);
  if (el) el.checked = checked;
}

function checkValues(name, values) {
  document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
    const isChecked = values.includes(cb.value);
    cb.checked = isChecked;

    // Update chip styling for browsers without :has() support
    const label = cb.closest('.chip-label');
    if (label) {
      if (isChecked) {
        label.classList.add('chip-selected');
      } else {
        label.classList.remove('chip-selected');
      }
    }
  });
}

function updatePitchCount() {
  const pitch = document.getElementById('artist-edit-pitch');
  const counter = document.getElementById('pitch-char-count');
  if (pitch && counter) {
    counter.textContent = pitch.value.length;
  }
}

/**
 * Helper: Get checkbox values
 */
export function getCheckboxValues(name) {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

// === Gallery Functions ===

function renderGalleryPreview(photos) {
  const container = document.getElementById('artist-gallery-preview');
  if (!container) return;

  if (!photos || photos.length === 0) {
    container.innerHTML = `
      <div class="col-span-3 py-8 text-center text-gray-400 text-sm bg-gray-50 rounded-xl">
        No photos uploaded yet
      </div>
    `;
    return;
  }

  container.innerHTML = photos.map((url, index) => `
    <div class="relative group aspect-square">
      <img src="${url}" alt="Gallery photo" class="w-full h-full object-cover rounded-xl">
      <button type="button"
              class="delete-gallery-photo absolute top-2 right-2 w-7 h-7 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-lg"
              data-index="${index}">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  `).join('');

  // Attach delete handlers
  container.querySelectorAll('.delete-gallery-photo').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const index = parseInt(btn.dataset.index);
      await deleteGalleryPhoto(index);
    });
  });
}

async function deleteGalleryPhoto(index) {
  if (!confirm('Delete this photo?')) return;

  try {
    const { doc, updateDoc } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');
    const { getStore, setStore } = await import('../../utils/store.js');

    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');
    const photos = [...(currentUserData.galleryPhotos || [])];
    photos.splice(index, 1);

    await updateDoc(doc(db, 'artists', currentUser.uid), { galleryPhotos: photos });

    setStore('currentUserData', { ...currentUserData, galleryPhotos: photos });
    renderGalleryPreview(photos);
    console.log('[GALLERY] Photo deleted');
  } catch (error) {
    console.error('[GALLERY] Delete error:', error);
    alert('Error deleting photo');
  }
}

function setupGalleryUploadHandler() {
  const input = document.getElementById('artist-add-gallery-photo');
  if (!input) return;

  input.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const { getStorage, ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
      const { doc, updateDoc, arrayUnion } = await import('firebase/firestore');
      const { db } = await import('../../services/firebase.js');
      const { getStore, setStore } = await import('../../utils/store.js');

      const currentUser = getStore('currentUser');
      const currentUserData = getStore('currentUserData');

      // Upload
      const storage = getStorage();
      const fileName = `gallery_${Date.now()}_${file.name}`;
      const storageRef = ref(storage, `artists/${currentUser.uid}/${fileName}`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);

      // Update Firestore
      await updateDoc(doc(db, 'artists', currentUser.uid), {
        galleryPhotos: arrayUnion(downloadURL)
      });

      // Update local
      const photos = [...(currentUserData.galleryPhotos || []), downloadURL];
      setStore('currentUserData', { ...currentUserData, galleryPhotos: photos });
      renderGalleryPreview(photos);

      // Reset input
      input.value = '';
      console.log('[GALLERY] Photo uploaded');
    } catch (error) {
      console.error('[GALLERY] Upload error:', error);
      alert('Error uploading photo');
    }
  });
}

// === YouTube Functions ===

function renderYouTubePreview(videos) {
  const container = document.getElementById('artist-youtube-preview');
  if (!container) return;

  if (!videos || videos.length === 0) {
    container.innerHTML = `
      <div class="col-span-2 py-8 text-center text-gray-400 text-sm bg-gray-50 rounded-xl">
        No videos added yet
      </div>
    `;
    return;
  }

  container.innerHTML = videos.map((video, index) => {
    const videoId = video.videoId || extractYouTubeId(video.url || video);
    if (!videoId) return '';

    return `
      <div class="relative group aspect-video">
        <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg"
             alt="Video thumbnail"
             class="w-full h-full object-cover rounded-xl">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
          <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
        </div>
        <button type="button"
                class="delete-youtube-video absolute top-2 right-2 w-7 h-7 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-lg"
                data-index="${index}">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    `;
  }).join('');

  // Attach delete handlers
  container.querySelectorAll('.delete-youtube-video').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const index = parseInt(btn.dataset.index);
      await deleteYouTubeVideo(index);
    });
  });
}

function extractYouTubeId(url) {
  if (!url) return null;
  const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
  return match ? match[1] : null;
}

async function deleteYouTubeVideo(index) {
  if (!confirm('Delete this video?')) return;

  try {
    const { doc, updateDoc } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');
    const { getStore, setStore } = await import('../../utils/store.js');

    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');
    const videos = [...(currentUserData.youtubeVideos || [])];
    videos.splice(index, 1);

    await updateDoc(doc(db, 'artists', currentUser.uid), { youtubeVideos: videos });

    setStore('currentUserData', { ...currentUserData, youtubeVideos: videos });
    renderYouTubePreview(videos);
    console.log('[YOUTUBE] Video deleted');
  } catch (error) {
    console.error('[YOUTUBE] Delete error:', error);
    alert('Error deleting video');
  }
}

function setupYouTubeAddHandler() {
  const addBtn = document.getElementById('add-youtube-btn');
  const input = document.getElementById('youtube-url-input');
  if (!addBtn || !input) return;

  addBtn.addEventListener('click', async () => {
    const url = input.value.trim();
    if (!url) {
      alert('Please enter a YouTube URL');
      return;
    }

    const videoId = extractYouTubeId(url);
    if (!videoId) {
      alert('Invalid YouTube URL');
      return;
    }

    try {
      const { doc, updateDoc, arrayUnion } = await import('firebase/firestore');
      const { db } = await import('../../services/firebase.js');
      const { getStore, setStore } = await import('../../utils/store.js');

      const currentUser = getStore('currentUser');
      const currentUserData = getStore('currentUserData');

      const videoData = { url, videoId, addedAt: new Date().toISOString() };

      await updateDoc(doc(db, 'artists', currentUser.uid), {
        youtubeVideos: arrayUnion(videoData)
      });

      const videos = [...(currentUserData.youtubeVideos || []), videoData];
      setStore('currentUserData', { ...currentUserData, youtubeVideos: videos });
      renderYouTubePreview(videos);

      input.value = '';
      console.log('[YOUTUBE] Video added');
    } catch (error) {
      console.error('[YOUTUBE] Add error:', error);
      alert('Error adding video');
    }
  });
}

// === Document Functions ===

function renderDocumentsPreview(documents) {
  const container = document.getElementById('artist-documents-preview');
  if (!container) return;

  if (!documents || documents.length === 0) {
    container.innerHTML = `
      <div class="py-6 text-center text-gray-400 text-sm bg-gray-50 rounded-xl">
        No documents uploaded yet
      </div>
    `;
    return;
  }

  container.innerHTML = documents.map((doc, index) => `
    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl group">
      <div class="flex items-center gap-3 min-w-0">
        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div class="min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">${doc.name || 'Document'}</p>
          <a href="${doc.url}" target="_blank" class="text-xs text-indigo-600 hover:underline">View</a>
        </div>
      </div>
      <button type="button"
              class="delete-document w-8 h-8 bg-red-100 text-red-600 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-200"
              data-index="${index}">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  `).join('');

  // Attach delete handlers
  container.querySelectorAll('.delete-document').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const index = parseInt(btn.dataset.index);
      await deleteDocument(index);
    });
  });
}

async function deleteDocument(index) {
  if (!confirm('Delete this document?')) return;

  try {
    const { doc, updateDoc } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');
    const { getStore, setStore } = await import('../../utils/store.js');

    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');
    const documents = [...(currentUserData.documents || [])];
    documents.splice(index, 1);

    await updateDoc(doc(db, 'artists', currentUser.uid), { documents });

    setStore('currentUserData', { ...currentUserData, documents });
    renderDocumentsPreview(documents);
    console.log('[DOCUMENTS] Document deleted');
  } catch (error) {
    console.error('[DOCUMENTS] Delete error:', error);
    alert('Error deleting document');
  }
}

function setupDocumentUploadHandler() {
  const input = document.getElementById('artist-add-document');
  if (!input) return;

  input.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Document must be less than 10MB');
      input.value = '';
      return;
    }

    try {
      const { getStorage, ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
      const { doc, updateDoc, arrayUnion } = await import('firebase/firestore');
      const { db } = await import('../../services/firebase.js');
      const { getStore, setStore } = await import('../../utils/store.js');

      const currentUser = getStore('currentUser');
      const currentUserData = getStore('currentUserData');

      // Upload
      const storage = getStorage();
      const fileName = `${Date.now()}_${file.name}`;
      const storageRef = ref(storage, `artists/${currentUser.uid}/docs/${fileName}`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);

      const docData = {
        name: file.name,
        url: downloadURL,
        uploadedAt: new Date().toISOString()
      };

      // Update Firestore
      await updateDoc(doc(db, 'artists', currentUser.uid), {
        documents: arrayUnion(docData)
      });

      // Update local
      const documents = [...(currentUserData.documents || []), docData];
      setStore('currentUserData', { ...currentUserData, documents });
      renderDocumentsPreview(documents);

      input.value = '';
      console.log('[DOCUMENTS] Document uploaded');
    } catch (error) {
      console.error('[DOCUMENTS] Upload error:', error);
      alert('Error uploading document');
    }
  });
}

/**
 * Setup profile picture preview
 */
function setupProfilePicPreview() {
  const input = document.getElementById('artist-edit-profile-pic');
  const preview = document.getElementById('artist-profile-pic-preview');
  if (!input || !preview) return;

  input.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

/**
 * Get checked checkbox values by name
 */
function getCheckedValues(name) {
  return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
    .map(cb => cb.value);
}

/**
 * Handle profile form submission
 */
async function handleProfileSubmit(e) {
  e.preventDefault();

  const errorMsg = document.getElementById('artist-profile-error');
  const successMsg = document.getElementById('artist-profile-success');
  const submitBtn = document.getElementById('save-artist-profile-btn');

  // Reset messages
  if (errorMsg) {
    errorMsg.classList.add('hidden');
    errorMsg.textContent = '';
  }
  if (successMsg) {
    successMsg.classList.add('hidden');
    successMsg.textContent = '';
  }

  // Disable button
  const originalBtnText = submitBtn?.textContent;
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
  }

  try {
    const { doc, updateDoc } = await import('firebase/firestore');
    const { getStorage, ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
    const { db } = await import('../../services/firebase.js');
    const { getStore, setStore } = await import('../../utils/store.js');

    const currentUser = getStore('currentUser');
    if (!currentUser) throw new Error('Not logged in');

    // === Collect data from all tabs ===
    const profileData = {
      // Tab 1: Basics & Identity
      stageName: document.getElementById('artist-edit-stagename')?.value.trim() || '',
      location: document.getElementById('artist-edit-location')?.value.trim() || '',
      pitch: document.getElementById('artist-edit-pitch')?.value.trim() || '',
      genres: getCheckedValues('genre'),
      languages: getCheckedValues('language'),
      themes: getCheckedValues('theme'),
      energyLevels: getCheckedValues('energy'),
      formats: getCheckedValues('format'),

      // Tab 2: Bio & Media
      bio: document.getElementById('artist-edit-bio')?.value.trim() || '',
      videoUrl: document.getElementById('artist-edit-video')?.value.trim() || '',
      audioUrl: document.getElementById('artist-edit-audio')?.value.trim() || '',
      textContent: document.getElementById('artist-edit-text')?.value.trim() || '',

      // Tab 3: Contact & Socials
      phone: document.getElementById('artist-edit-phone')?.value.trim() || '',
      website: document.getElementById('artist-edit-website')?.value.trim() || '',
      paymentMethods: getCheckedValues('payment'),
      notifyEmail: document.getElementById('artist-edit-notify-email')?.checked ?? true,
      notifySms: document.getElementById('artist-edit-notify-sms')?.checked ?? false,

      // Hidden fields (preserve existing data)
      firstName: document.getElementById('artist-edit-firstname')?.value || '',
      lastName: document.getElementById('artist-edit-lastname')?.value || '',
      dob: document.getElementById('artist-edit-dob')?.value || '',
      gender: document.getElementById('artist-edit-gender')?.value || ''
    };

    // === Validation ===
    if (!profileData.stageName) {
      throw new Error('Display name is required');
    }
    if (!profileData.location) {
      throw new Error('Location is required');
    }
    if (!profileData.pitch) {
      throw new Error('Short pitch is required');
    }
    if (profileData.genres.length === 0) {
      throw new Error('Please select at least one genre');
    }
    if (profileData.languages.length === 0) {
      throw new Error('Please select at least one language');
    }
    if (!profileData.bio) {
      throw new Error('Bio is required');
    }
    if (!profileData.phone) {
      throw new Error('Phone number is required');
    }
    if (profileData.paymentMethods.length === 0) {
      throw new Error('Please select at least one payment method');
    }

    // === Profile Picture Upload ===
    const picInput = document.getElementById('artist-edit-profile-pic');
    if (picInput?.files?.[0]) {
      const file = picInput.files[0];

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('Profile picture must be less than 5MB');
      }

      const storage = getStorage();
      const storageRef = ref(storage, `artists/${currentUser.uid}/profile_${Date.now()}.jpg`);
      await uploadBytes(storageRef, file);
      profileData.profilePicUrl = await getDownloadURL(storageRef);
      console.log('[SAVE] Profile picture uploaded');
    }

    // === Save to Firestore ===
    const docRef = doc(db, 'artists', currentUser.uid);
    await updateDoc(docRef, profileData);

    // === Update local store ===
    const currentUserData = getStore('currentUserData');
    setStore('currentUserData', { ...currentUserData, ...profileData });

    // === Success feedback ===
    if (successMsg) {
      successMsg.textContent = '‚úì Profile saved successfully!';
      successMsg.classList.remove('hidden');
    }

    console.log('[SAVE] Profile saved successfully');

    // === Redirect to profile page after short delay ===
    setTimeout(async () => {
      const { showArtistOwnProfile } = await import('../../ui/ui.js');

      // Hide editor
      const editor = document.getElementById('artist-profile-editor');
      if (editor) editor.classList.add('hidden');

      // Show profile
      if (showArtistOwnProfile) {
        showArtistOwnProfile();
      }
    }, 1000); // 1 second delay to show success message

  } catch (error) {
    console.error('[SAVE] Error:', error);

    if (errorMsg) {
      errorMsg.textContent = error.message || 'Error saving profile';
      errorMsg.classList.remove('hidden');
    }
  } finally {
    // Re-enable button
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText || 'Save All Changes';
    }
  }
}

/**
 * Setup view public profile button handler
 */
function setupViewPublicProfileHandler() {
  const btn = document.getElementById('view-public-profile-btn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    // Hide editor, show public profile view
    const editor = document.getElementById('artist-profile-editor');
    if (editor) editor.classList.add('hidden');

    // Trigger the artist own profile view
    const { showArtistOwnProfile } = await import('../../ui/ui.js');
    if (showArtistOwnProfile) {
      showArtistOwnProfile();
    }
  });
}
</file>

<file path="src/ui/ui.js">
/**
 * ui.js
 * Beheert alle UI-interacties: pagina's tonen/verbergen,
 * navigatieknoppen en de status van de UI bijwerken.
 */

// Importeer de "store" (globale state) om de data van de ingelogde gebruiker te lezen
import { getStore, setStore } from '../utils/store.js';

// Importeer de functies die we nodig hebben van andere modules
import { handleLogout, handleLogin, handleArtistSignup, handleProgrammerSignup, updateUserEmail, updateUserPassword } from '../services/auth.js';
import { setupArtistDashboard, populateArtistEditor } from '../modules/dashboard/dashboard-controller.js';
import { renderProgrammerDashboard, setupProgrammerDashboard } from '../modules/programmer/programmer-dashboard.js';
import { loadArtists, setupArtistSearch } from '../modules/search/search-controller.js';
import { renderArtistSearch } from '../modules/search/search-ui.js';
import { loadConversations } from '../modules/messaging/messaging-controller.js';
import { populateProgrammerEditor, renderProgrammerProfileEditor, setupProfileFormHandlers } from '../modules/programmer/programmer-profile.js';
import { setNavigationVisibility, updateDesktopNav, updateMobileNavActive } from '../modules/navigation/navigation.js';

// Importeer de view renderers
import {
  renderHome,
  renderLogin,
  renderSignup,
  renderArtistSignup,
  renderProgrammerSignup,
  renderMessages as renderMessagesView,
  renderDashboard as renderDashboardView,
  renderAccountSettings,
  renderEditProfile
} from './view-renderers.js'; 

// --- DOM Elementen ---
// We slaan alle belangrijke UI-elementen √©√©n keer op voor snelle toegang
const elements = {
  // Pagina-secties
  pageSections: document.querySelectorAll('.page-section'),
  loadingView: document.getElementById('loading-view'),
  homeView: document.getElementById('home-view'),
  loginView: document.getElementById('login-view'),
  signupView: document.getElementById('signup-view'),
  artistSignupView: document.getElementById('artist-signup-view'),
  programmerSignupView: document.getElementById('programmer-signup-view'),
  dashboardView: document.getElementById('dashboard-view'),

  // Navigatie & Gebruikersmenu
  navButtons: document.querySelectorAll('.nav-button'),
  navHome: document.getElementById('nav-home'),
  navLogin: document.getElementById('nav-login'),
  navSignup: document.getElementById('nav-signup'),
  navDashboard: document.getElementById('nav-dashboard'),
  navMessages: document.getElementById('nav-messages'),
  navSettings: document.getElementById('nav-settings'),
  navLogout: document.getElementById('nav-logout'),
  authLinks: document.getElementById('auth-links'),
  userMenu: document.getElementById('user-menu'),
  userEmailSpan: document.getElementById('user-email'),

  // Knoppen op de Homepagina
  homeCtaArtist: document.getElementById('home-cta-artist'),
  homeCtaProgrammer: document.getElementById('home-cta-programmer'),

  // Knoppen op de Aanmeld-keuzepagina
  signupChoiceArtist: document.getElementById('signup-choice-artist'),
  signupChoiceProgrammer: document.getElementById('signup-choice-programmer'),

  // Dashboard Specifieke Views
  artistDashboard: document.getElementById('artist-dashboard'),
  programmerDashboard: document.getElementById('programmer-dashboard'),
  programmerPendingView: document.getElementById('programmer-pending-view'),
  programmerProfileEditor: document.getElementById('programmer-profile-editor'),
  artistSearchSection: document.getElementById('artist-search-section'),
};

/**
 * Toont √©√©n specifieke pagina-sectie en verbergt alle andere.
 * NIEUWE ARCHITECTUUR: Alle content wordt dynamisch gerenderd in #app-content
 * @param {string} pageId - De ID van de pagina-sectie die getoond moet worden.
 * @param {boolean} updateHistory - Whether to update browser history (default: true)
 */
export function showPage(pageId, updateHistory = true) {
  const appContent = document.getElementById('app-content');

  // KRITIEK: Maak de container ALTIJD leeg voordat we nieuwe content renderen
  // Dit voorkomt dat oude views zichtbaar blijven
  if (appContent) {
    appContent.innerHTML = '';
  }

  // Update browser history with hash
  if (updateHistory) {
    const hash = pageId.replace('-view', '');
    if (window.location.hash !== `#${hash}`) {
      window.history.pushState({ pageId }, '', `#${hash}`);
    }
  }

  // Render de juiste view op basis van pageId
  switch(pageId) {
    case 'home-view':
      renderHome();
      break;
    case 'login-view':
      renderLogin();
      break;
    case 'signup-view':
      renderSignup();
      break;
    case 'artist-signup-view':
      renderArtistSignup();
      break;
    case 'programmer-signup-view':
      renderProgrammerSignup();
      break;
    case 'messages-view':
      renderMessagesView();
      break;
    case 'dashboard-view':
      renderDashboardView();
      break;
    case 'account-settings-view':
      renderAccountSettings();
      // Setup account settings form handlers after rendering
      setupAccountSettingsHandlers();
      break;
    default:
      console.warn(`Unknown page: ${pageId}`);
      renderHome();
  }

  // Re-initialize Lucide icons after rendering new content
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Setup global form handlers with event delegation
 * Handles all auth forms (login, signup) regardless of when they're rendered
 * Uses capture phase to intercept events before any other handlers
 */
let globalFormHandlersInitialized = false;

export function setupGlobalFormHandlers() {
  if (globalFormHandlersInitialized) {
    console.log('[UI] Global form handlers already initialized, skipping');
    return;
  }

  console.log('[UI] Setting up global form handlers with capture phase');

  // PRIMARY: Use event delegation on document (highest level) with capture phase
  document.addEventListener('submit', async (e) => {
    console.log('‚ö°Ô∏è Global SUBMIT caught:', e.target.tagName, 'id:', e.target.id);

    const form = e.target;

    // Login form
    if (form.id === 'login-form') {
      console.log('[UI] ‚úÖ Login form submit intercepted - calling handleLogin');
      await handleLogin(e);
      return;
    }

    // Artist signup form
    if (form.id === 'artist-signup-form') {
      console.log('[UI] ‚úÖ Artist signup form submit intercepted');
      await handleArtistSignup(e);
      return;
    }

    // Programmer signup form
    if (form.id === 'programmer-signup-form') {
      console.log('[UI] ‚úÖ Programmer signup form submit intercepted');
      await handleProgrammerSignup(e);
      return;
    }

    // ‚úÖ FIX: Message form (inline chat messages)
    if (form.id === 'message-form') {
      console.log('[UI] ‚úÖ Message form submit intercepted');
      await handleInlineMessageSubmit(e);
      return;
    }

    // ‚úÖ FIX: Mobile message form (separate handler for mobile)
    if (form.id === 'mobile-message-form') {
      e.preventDefault();
      const input = document.getElementById('mobile-message-input');
      const text = input?.value?.trim();
      if (!text) return;

      const chatContainer = document.getElementById('chat-container');
      const conversationId = chatContainer?.dataset?.conversationId;
      if (!conversationId) {
        console.error('[UI] No conversation ID found for mobile message');
        return;
      }

      input.value = '';

      // Import and call message functions
      import('../modules/messaging/messaging-controller.js').then(async ({ addMessage, loadMessages }) => {
        const { getStore } = await import('../utils/store.js');
        const currentUser = getStore('currentUser');
        const currentUserData = getStore('currentUserData');
        if (currentUser && currentUserData) {
          await addMessage(conversationId, currentUser.uid, currentUserData, text);
          await loadMessages(conversationId);
        }
      });
      return;
    }
  }, { capture: true }); // CRITICAL: Capture phase ensures we intercept FIRST

  globalFormHandlersInitialized = true;
  console.log('[UI] ‚úÖ Global form handlers initialized successfully');
}

/**
 * ‚ú® OPTIMISTIC UI: Handle inline message form submission (chat replies)
 * Messages are added to UI immediately without re-rendering the entire chat
 */
async function handleInlineMessageSubmit(e) {
  e.preventDefault();

  // Support both desktop and mobile forms
  const messageInput = document.getElementById('message-input');
  const mobileMessageInput = document.getElementById('mobile-message-input');
  const activeInput = messageInput || mobileMessageInput;
  const messageText = activeInput?.value.trim();

  if (!messageText) return;

  // Get conversation ID from either desktop or mobile container
  const chatContainer = document.getElementById('chat-container');
  const mobileChatView = document.getElementById('mobile-chat-view');
  const conversationId = chatContainer?.dataset.conversationId || mobileChatView?.dataset.conversationId;

  if (!conversationId) {
    console.error('[UI] No conversation ID found');
    return;
  }

  try {
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser || !currentUserData) {
      throw new Error('User not logged in');
    }

    console.log('[UI] Sending message to conversation:', conversationId);

    // ‚ú® OPTIMISTIC UI: Create message object for immediate display
    const optimisticMessage = {
      senderId: currentUser.uid,
      senderName: `${currentUserData.firstName} ${currentUserData.lastName}`,
      senderRole: currentUserData.role,
      senderProfilePic: currentUserData.profilePicUrl || '',
      text: messageText,
      createdAt: null, // Will show "Just now"
      read: false
    };

    // Clear input immediately (better UX)
    activeInput.value = '';

    // Import messaging functions dynamically
    const { addMessage, appendMessageToUI } = await import('../modules/messaging/messaging-controller.js');

    // ‚ú® OPTIMISTIC UI: Add message to UI immediately (no re-render!)
    appendMessageToUI(optimisticMessage);

    // Send message to Firestore in background
    await addMessage(conversationId, currentUser.uid, currentUserData, messageText);

    console.log('[UI] ‚úÖ Message sent successfully with optimistic UI');

  } catch (error) {
    console.error('[UI] Error sending message:', error);
    alert('Failed to send message. Please try again.');
  }
}


/**
 * Werkt de navigatiebalk bij op basis van de inlogstatus.
 * @param {object | null} user - Het Firebase user-object (of null als uitgelogd).
 */
export function updateNav(user) {
  const appHeader = document.getElementById('app-header');
  const navLogoutMobile = document.getElementById('nav-logout-mobile');
  const userEmailMobile = document.getElementById('user-email-mobile');

  if (user) {
    // Ingelogd - Show navigation using centralized function
    setNavigationVisibility(true);

    // Update desktop nav with current user data
    updateDesktopNav();

    // Show app header
    if (appHeader) {
      appHeader.classList.remove('hidden');
    }

    // Show mobile logout button
    if (navLogoutMobile) {
      navLogoutMobile.classList.remove('hidden');
    }

    // Update mobile email
    if (userEmailMobile) {
      userEmailMobile.textContent = user.email;
      userEmailMobile.classList.remove('hidden');
    }

    // Re-initialize icons
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 100);
    }
  } else {
    // Uitgelogd - Hide navigation using centralized function
    setNavigationVisibility(false);

    // Hide app header
    if (appHeader) {
      appHeader.classList.add('hidden');
    }

    // Hide mobile elements
    if (navLogoutMobile) {
      navLogoutMobile.classList.add('hidden');
    }

    if (userEmailMobile) {
      userEmailMobile.textContent = '';
      userEmailMobile.classList.add('hidden');
    }
  }
}

/**
 * Helper: Show/hide artist search section consistently
 * @param {boolean} show - Whether to show (true) or hide (false) the search section
 * Note: Full visibility forcing happens in loadArtists() via forceSearchResultsVisible()
 */
function toggleArtistSearchSection(show) {
  const artistSearchSection = document.getElementById('artist-search-section');
  if (!artistSearchSection) return;

  if (show) {
    // üî• NUCLEAR VISIBILITY FORCING
    artistSearchSection.style.display = 'block';
    artistSearchSection.style.opacity = '1';
    artistSearchSection.style.visibility = 'visible';
    artistSearchSection.style.zIndex = '1';
    artistSearchSection.classList.remove('hidden');
    console.log('[UI] üî• Artist search section FORCED VISIBLE');
  } else {
    artistSearchSection.style.display = 'none';
    artistSearchSection.classList.add('hidden');
    console.log('[UI] Artist search section hidden');
  }
}

/**
 * Helper: Show/hide profile sections (overview, preview, editor)
 * @param {boolean} show - Whether to show (true) or hide (false)
 */
function toggleProfileSections(show) {
  const profileOverview = document.getElementById('programmer-profile-overview');
  const publicPreview = document.getElementById('programmer-public-preview');

  if (profileOverview) {
    if (show) {
      profileOverview.style.display = 'block';
      profileOverview.classList.remove('hidden');
    } else {
      profileOverview.style.display = 'none';
      profileOverview.classList.add('hidden');
    }
  }

  if (publicPreview) {
    if (show) {
      publicPreview.style.display = 'block';
      publicPreview.classList.remove('hidden');
    } else {
      publicPreview.style.display = 'none';
      publicPreview.classList.add('hidden');
    }
  }
}

/**
 * Toont het juiste dashboard (Artiest of Programmeur) op basis van de rol.
 */
export function showDashboard() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData) {
    console.warn("Geen gebruikersdata gevonden, kan dashboard niet tonen. Terug naar home.");
    showPage('home-view');
    return;
  }

  // STAP 1: Render de dashboard container structuur
  showPage('dashboard-view');

  // STAP 2: Render de specifieke dashboard content op basis van rol
  const { role, status } = currentUserData;

  if (role === 'artist') {
    // Get the dynamically rendered containers
    const artistDashboard = document.getElementById('artist-dashboard');
    const programmerDashboard = document.getElementById('programmer-dashboard');

    if (artistDashboard) {
      artistDashboard.style.display = 'block';
      artistDashboard.classList.remove('hidden');
    }
    if (programmerDashboard) {
      programmerDashboard.style.display = 'none';
      programmerDashboard.classList.add('hidden');
    }

    // Show artist own profile view (programmer-style layout)
    showArtistOwnProfile();
  } else if (role === 'programmer') {
    // Get the dynamically rendered containers
    const artistDashboard = document.getElementById('artist-dashboard');
    const programmerDashboard = document.getElementById('programmer-dashboard');

    if (artistDashboard) {
      artistDashboard.style.display = 'none';
      artistDashboard.classList.add('hidden');
    }
    if (programmerDashboard) {
      // üî• FORCE VISIBILITY on programmer dashboard
      programmerDashboard.style.display = 'block';
      programmerDashboard.style.opacity = '1';
      programmerDashboard.style.visibility = 'visible';
      programmerDashboard.style.zIndex = '1';
      programmerDashboard.classList.remove('hidden');
      console.log('[UI] üëÄ Programmer dashboard FORCED VISIBLE');
    }

    // Render the programmer dashboard HTML
    renderProgrammerDashboard();
    // Setup dashboard AFTER rendering HTML (so elements exist)
    setupProgrammerDashboard();

    // Get pending view dynamically
    const pendingView = document.getElementById('programmer-pending-view');

    // Get profile editor dynamically
    const programmerProfileEditor = document.getElementById('programmer-profile-editor');
    if (programmerProfileEditor) {
      programmerProfileEditor.classList.add('hidden');
      programmerProfileEditor.style.display = 'none';
    }

    // ‚úÖ FIX: Show profile sections in dashboard view
    toggleProfileSections(true);

    if (status === 'pending') {
      // Verberg de zoekfilters, toon "pending" bericht
      if (pendingView) pendingView.style.display = 'block';
      // ‚úÖ FIX: Hide artist search in pending state
      toggleArtistSearchSection(false);
    } else {
      // Toon de zoekfilters en verberg "pending"
      if (pendingView) pendingView.style.display = 'none';

      // ‚úÖ FIX: Show artist search section
      toggleArtistSearchSection(true);

      // Render the artist search view dynamically
      renderArtistSearch();

      // ‚úÖ FIX: Setup search after rendering HTML (so event listeners can attach)
      setupArtistSearch();

      // Auto-load all artists when dashboard loads
      loadArtists();
    }
  }

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows ONLY the search view (hides profile sections)
 * Used when clicking "Zoeken" in navigation
 */
export function showSearchOnly() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData) {
    console.warn("No user data, cannot show search");
    showPage('home-view');
    return;
  }

  console.log('[UI] Showing search-only view');

  // Ensure navigation is visible FIRST
  setNavigationVisibility(true);
  import('../modules/navigation/navigation.js').then(navModule => {
    navModule.renderDesktopNav();
    navModule.renderMobileNav();
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 50);
    }
  });

  // Render the dashboard container structure
  showPage('dashboard-view', false);

  // Update URL
  window.history.pushState({ view: 'search' }, '', '#search');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  // Hide artist dashboard
  if (artistDashboard) {
    artistDashboard.style.display = 'none';
  }

  // Show programmer dashboard container (needed for search section)
  if (programmerDashboard) {
    programmerDashboard.style.display = 'block';
  }

  // Import programmer dashboard
  import('../modules/programmer/programmer-dashboard.js').then(dashboardModule => {
    dashboardModule.renderProgrammerDashboard();

    // HIDE all profile sections
    const sectionsToHide = [
      'programmer-profile-overview',
      'programmer-public-preview',
      'programmer-profile-editor',
      'programmer-about-card',
      'programmer-pending-view'
    ];

    sectionsToHide.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = 'none';
      }
    });

    // SHOW search section
    const searchSection = document.getElementById('artist-search-section');
    if (searchSection) {
      searchSection.style.display = 'block';
    }

    // Import search UI (renderArtistSearch is in search-ui.js)
    import('../modules/search/search-ui.js').then(searchUiModule => {
      searchUiModule.renderArtistSearch();

      // Import search controller (setupArtistSearch and loadArtists are in search-controller.js)
      import('../modules/search/search-controller.js').then(searchControllerModule => {
        searchControllerModule.setupArtistSearch();
        searchControllerModule.loadArtists();
      });
    });

  });
}

/**
 * Shows ONLY the programmer profile view (hides search)
 * Used when clicking "Profiel" in navigation
 */
export function showProgrammerProfile() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn("Only programmers can view profile");
    showPage('home-view');
    return;
  }

  console.log('[UI] Showing programmer profile view');

  // Ensure navigation is visible FIRST
  setNavigationVisibility(true);
  import('../modules/navigation/navigation.js').then(navModule => {
    navModule.renderDesktopNav();
    navModule.renderMobileNav();
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 50);
    }
  });

  // Render the dashboard container structure
  showPage('dashboard-view', false);

  // Set correct hash
  window.history.pushState({ view: 'profile' }, '', '#profile');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  // Hide artist dashboard
  if (artistDashboard) {
    artistDashboard.style.display = 'none';
  }

  // Show programmer dashboard
  if (programmerDashboard) {
    programmerDashboard.style.display = 'block';
  }

  // Import, render and setup
  import('../modules/programmer/programmer-dashboard.js').then(module => {
    module.renderProgrammerDashboard();
    module.setupProgrammerDashboard();

    // SHOW profile sections
    const sectionsToShow = [
      'programmer-profile-overview',
      'programmer-public-preview',
      'programmer-about-card'
    ];

    sectionsToShow.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = 'block';
        el.classList.remove('hidden');
      }
    });

    // HIDE search section and editor on profile page
    const searchSection = document.getElementById('artist-search-section');
    if (searchSection) {
      searchSection.style.display = 'none';
      searchSection.classList.add('hidden');
    }

    // Hide editor
    const editor = document.getElementById('programmer-profile-editor');
    if (editor) {
      editor.style.display = 'none';
      editor.classList.add('hidden');
    }
  });

  updateMobileNavActive('profile');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows programmer settings (profile editor)
 */
export function showProgrammerSettings() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn("Only programmers can access settings");
    return;
  }

  console.log('[UI] Showing programmer settings view');

  // STAP 1: Render de dashboard container structuur
  showPage('dashboard-view');

  // STAP 2: Get the dynamically rendered containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  // Show programmer dashboard
  if (artistDashboard) {
    artistDashboard.style.display = 'none';
    artistDashboard.classList.add('hidden');
  }
  if (programmerDashboard) {
    programmerDashboard.style.display = 'block';
    programmerDashboard.classList.remove('hidden');
  }

  // Render the programmer dashboard HTML first
  renderProgrammerDashboard();
  // Setup dashboard AFTER rendering HTML
  setupProgrammerDashboard();

  // Get dynamically rendered elements
  const pendingView = document.getElementById('programmer-pending-view');

  // Hide the pending view
  if (pendingView) pendingView.style.display = 'none';

  // ‚úÖ FIX: Hide artist search section in Settings view
  toggleArtistSearchSection(false);

  // ‚úÖ FIX: Show profile sections in Settings view
  toggleProfileSections(true);

  // Get the profile editor dynamically
  const programmerProfileEditor = document.getElementById('programmer-profile-editor');

  // Show the profile editor
  if (programmerProfileEditor) {
    // Render the editor HTML first
    renderProgrammerProfileEditor();

    programmerProfileEditor.classList.remove('hidden');
    programmerProfileEditor.style.display = 'block';

    // Setup form handlers after rendering
    setupProfileFormHandlers();

    // Populate the editor with current data
    populateProgrammerEditor();

    // Scroll to the profile editor
    setTimeout(() => {
      programmerProfileEditor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows the Edit Profile page
 */
export async function showEditProfile() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn("Only programmers can edit profile");
    showPage('home-view');
    return;
  }

  console.log('[UI] Showing edit profile page');

  // Render the edit profile view
  renderEditProfile();

  // Populate form with current data
  populateEditProfileForm(currentUserData);

  // Setup form handlers
  setupEditProfileHandlers();

  // Update URL
  window.history.pushState({ view: 'edit-profile' }, '', '#edit-profile');

  // Re-initialize icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows the Public Profile Preview page
 */
export function showPublicProfile() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn("Only programmers can view public profile");
    showPage('home-view');
    return;
  }

  console.log('[UI] Showing public profile page');

  // Render the public profile view
  import('./view-renderers.js').then(module => {
    module.renderPublicProfilePage();

    // Setup back button handler
    const backBtn = document.getElementById('back-to-profile-btn');
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        showProgrammerProfile();
      });
    }
  });

  // Update URL
  window.history.pushState({ view: 'public-profile' }, '', '#public-profile');
}

/**
 * Populate the edit profile form with current user data
 */
function populateEditProfileForm(userData) {
  const currentUser = getStore('currentUser');

  // Personal Details
  const firstNameInput = document.getElementById('edit-first-name');
  const lastNameInput = document.getElementById('edit-last-name');
  const phoneInput = document.getElementById('edit-phone');

  if (firstNameInput) firstNameInput.value = userData.firstName || '';
  if (lastNameInput) lastNameInput.value = userData.lastName || '';
  if (phoneInput) phoneInput.value = userData.phone || '';

  // Avatar
  const avatarPlaceholder = document.getElementById('edit-avatar-placeholder');
  const avatarInitial = document.getElementById('edit-avatar-initial');
  const avatarPic = document.getElementById('edit-profile-pic-preview');

  if (userData.profilePicUrl) {
    if (avatarPic) {
      avatarPic.src = userData.profilePicUrl;
      avatarPic.classList.remove('hidden');
    }
    if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
  } else {
    const initial = (userData.firstName?.charAt(0) || 'P').toUpperCase();
    if (avatarInitial) avatarInitial.textContent = initial;
  }

  // Organization Details
  const orgNameInput = document.getElementById('edit-organization-name');
  const websiteInput = document.getElementById('edit-website');
  const aboutInput = document.getElementById('edit-about');

  if (orgNameInput) orgNameInput.value = userData.organizationName || '';
  if (websiteInput) websiteInput.value = userData.website || '';
  if (aboutInput) aboutInput.value = userData.organizationAbout || '';

  // Preferences
  const languageSelect = document.getElementById('edit-language');
  if (languageSelect) languageSelect.value = userData.language || 'nl';
}

/**
 * Setup form handlers for edit profile page
 */
function setupEditProfileHandlers() {
  const form = document.getElementById('edit-profile-form');
  const cancelBtn = document.getElementById('cancel-edit-btn');
  const fileInput = document.getElementById('edit-profile-pic-input');

  // Cancel button - go back to profile
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      showProgrammerProfile();
    });
  }

  // File input - preview image
  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const avatarPic = document.getElementById('edit-profile-pic-preview');
          const avatarPlaceholder = document.getElementById('edit-avatar-placeholder');

          if (avatarPic) {
            avatarPic.src = event.target.result;
            avatarPic.classList.remove('hidden');
          }
          if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Form submit
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await handleEditProfileSubmit();
    });
  }
}

/**
 * Handle edit profile form submission
 */
async function handleEditProfileSubmit() {
  const successEl = document.getElementById('edit-profile-success');
  const errorEl = document.getElementById('edit-profile-error');
  const saveBtn = document.getElementById('save-profile-btn');

  // Hide previous messages
  if (successEl) successEl.classList.add('hidden');
  if (errorEl) errorEl.classList.add('hidden');

  // Disable button
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
  }

  try {
    const currentUser = getStore('currentUser');
    const currentUserData = getStore('currentUserData');

    if (!currentUser) throw new Error('No user logged in');

    // Gather form data
    const dataToUpdate = {
      firstName: document.getElementById('edit-first-name')?.value.trim() || '',
      lastName: document.getElementById('edit-last-name')?.value.trim() || '',
      phone: document.getElementById('edit-phone')?.value.trim() || '',
      organizationName: document.getElementById('edit-organization-name')?.value.trim() || '',
      website: document.getElementById('edit-website')?.value.trim() || '',
      organizationAbout: document.getElementById('edit-about')?.value.trim() || '',
      language: document.getElementById('edit-language')?.value || 'nl'
    };

    // Handle profile picture upload
    const fileInput = document.getElementById('edit-profile-pic-input');
    const file = fileInput?.files[0];

    if (file) {
      const { getStorage, ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
      const storage = getStorage();
      const storageRef = ref(storage, `programmers/${currentUser.uid}/profile.jpg`);

      const snapshot = await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(snapshot.ref);
      dataToUpdate.profilePicUrl = downloadURL;
    }

    // Update Firestore
    const { doc, updateDoc } = await import('firebase/firestore');
    const { db } = await import('../services/firebase.js');

    const docRef = doc(db, 'users', currentUser.uid);
    await updateDoc(docRef, dataToUpdate);

    // Update local store
    setStore('currentUserData', { ...currentUserData, ...dataToUpdate });

    // Apply language change
    const { setLanguage } = await import('../utils/translations.js');
    setLanguage(dataToUpdate.language);

    // Update navigation to reflect new profile picture
    const { renderDesktopNav, renderMobileNav } = await import('../modules/navigation/navigation.js');
    renderDesktopNav();
    renderMobileNav();

    // Show success
    if (successEl) {
      successEl.textContent = '‚úì Profile updated successfully!';
      successEl.classList.remove('hidden');
    }

    // Navigate back after short delay
    setTimeout(() => {
      showProgrammerProfile();
    }, 1500);

  } catch (error) {
    console.error('Error updating profile:', error);
    if (errorEl) {
      errorEl.textContent = `Error: ${error.message}`;
      errorEl.classList.remove('hidden');
    }
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save All Changes';
    }
  }
}

/**
 * Toont de messages/conversations pagina
 */
export function showMessages() {
  console.log("Showing messages view");

  // Render the messages view
  showPage('messages-view');

  // Laad conversaties AFTER rendering the view
  loadConversations();
}

/**
 * Show artist search view
 */
export function showArtistSearch() {
  console.log("Showing artist search view");

  // Show the dashboard view (artists see search by default)
  showPage('dashboard-view');

  // Render the search UI
  renderArtistSearch();

  // Load artists
  loadArtists();
}

/**
 * Voegt alle event listeners toe voor de navigatieknoppen.
 * Wordt √©√©n keer uitgevoerd bij het laden van de app.
 * ‚úÖ Uses event delegation for all dynamically rendered elements
 */
export function initNavigation() {
  // ‚úÖ Global click handler with event delegation
  document.body.addEventListener('click', (e) => {
    // Mobile logout button
    if (e.target.closest('#nav-logout-mobile')) {
      console.log('[UI] Mobile logout clicked');
      handleLogout();
      return;
    }

    // Home CTA buttons
    if (e.target.closest('#home-cta-artist')) {
      showPage('artist-signup-view');
      return;
    }

    if (e.target.closest('#home-cta-programmer')) {
      showPage('programmer-signup-view');
      return;
    }

    // Home login button
    if (e.target.closest('#home-login-btn')) {
      showPage('login-view');
      return;
    }

    // Signup choice buttons
    if (e.target.closest('#signup-choice-artist')) {
      showPage('artist-signup-view');
      return;
    }

    if (e.target.closest('#signup-choice-programmer')) {
      showPage('programmer-signup-view');
      return;
    }

    // Back buttons
    if (e.target.closest('#back-to-home-from-login')) {
      showPage('home-view');
      return;
    }

    if (e.target.closest('#back-to-home-from-signup')) {
      showPage('home-view');
      return;
    }

    if (e.target.closest('#back-from-artist-signup')) {
      showPage('signup-view');
      return;
    }

    if (e.target.closest('#back-from-programmer-signup')) {
      showPage('signup-view');
      return;
    }
  });

  // Bottom Navigation
  setupBottomNavigation();

  // Desktop Navigation
  setupDesktopNavigation();

  console.log('[UI] Navigation initialization complete with event delegation');
}

/**
 * Setup bottom navigation with event delegation
 */
function setupBottomNavigation() {
  // Use event delegation on document.body so it works even when bottom-nav is re-rendered
  document.body.addEventListener('click', (e) => {
    const navItem = e.target.closest('.bottom-nav-item, [data-nav]');
    if (!navItem) return;

    // Only handle if it's actually in the bottom nav
    const bottomNav = document.getElementById('bottom-nav');
    if (!bottomNav || !bottomNav.contains(navItem)) return;

    const navAction = navItem.dataset.nav;
    if (!navAction) return;

    e.preventDefault();
    e.stopPropagation();

    console.log('[NAV] Mobile nav clicked:', navAction);

    // Update active state
    updateBottomNavActive(navAction);

    // Handle navigation (showPage/showDashboard/etc. handle hash updates now)
    switch(navAction) {
      case 'search':
        showSearch();
        break;
      case 'profile':
        const currentUserData = getStore('currentUserData');
        if (currentUserData?.role === 'artist') {
          showArtistOwnProfile();
        } else if (currentUserData?.role === 'programmer') {
          showProgrammerProfile();
        }
        break;
      case 'messages':
        showMessages(); // Updates hash internally
        break;
      case 'settings':
        showAccountSettings(); // Updates hash internally
        break;
      case 'gigs':
        import('../modules/calendar/calendar-views.js').then(module => {
          module.showGigsPage();
        });
        break;
      case 'agenda':
        import('../modules/calendar/calendar-views.js').then(module => {
          module.showAgendaPage();
        });
        break;
      case 'events':
        import('../modules/calendar/calendar-views.js').then(module => {
          module.showEventsPage();
        });
        break;
    }

    // Re-initialize icons after navigation
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 100);
    }
  });
}

/**
 * Update active state of bottom navigation items
 * (Wrapper function - delegates to navigation.js)
 */
function updateBottomNavActive(activeNav) {
  updateMobileNavActive(activeNav);
}

/**
 * Setup desktop navigation with dropdown and search
 * ‚úÖ FIX: Uses event delegation to handle dynamically rendered navigation
 */
function setupDesktopNavigation() {
  // ‚úÖ Use event delegation on document body to catch clicks from dynamically rendered nav
  document.body.addEventListener('click', (e) => {
    // Desktop Search (Zoeken)
    if (e.target.closest('#desktop-nav-search')) {
      showSearchOnly();
      return;
    }

    // Desktop Profile (Profiel)
    if (e.target.closest('#desktop-nav-profile')) {
      e.preventDefault();
      const currentUserData = getStore('currentUserData');

      if (currentUserData?.role === 'artist') {
        showArtistOwnProfile();
      } else if (currentUserData?.role === 'programmer') {
        showProgrammerProfile();
      } else {
        showProfile();
      }
      return;
    }

    // Desktop Messages
    if (e.target.closest('#desktop-nav-messages')) {
      showMessages(); // Updates hash internally
      return;
    }

    // Desktop Gigs (for artists)
    if (e.target.closest('#desktop-nav-gigs')) {
      import('../modules/calendar/calendar-views.js').then(module => {
        module.showGigsPage();
      });
      return;
    }

    // Desktop Agenda (for programmers)
    if (e.target.closest('#desktop-nav-agenda')) {
      import('../modules/calendar/calendar-views.js').then(module => {
        module.showAgendaPage();
      });
      return;
    }

    // Desktop Events (for artists)
    if (e.target.closest('#desktop-nav-events')) {
      import('../modules/calendar/calendar-views.js').then(module => {
        module.showEventsPage();
      });
      return;
    }

    // Desktop Account Settings (Email/Password)
    if (e.target.closest('#desktop-account-settings')) {
      const dropdown = document.getElementById('desktop-profile-dropdown');
      if (dropdown) dropdown.classList.add('hidden');
      showAccountSettings(); // Updates hash internally
      return;
    }

    // ‚úÖ FIX: Desktop Logout with event delegation
    if (e.target.closest('#desktop-logout')) {
      console.log('[UI] Desktop logout clicked');
      const dropdown = document.getElementById('desktop-profile-dropdown');
      if (dropdown) dropdown.classList.add('hidden');
      handleLogout();
      return;
    }

    // Desktop Profile Button (toggle dropdown)
    const profileBtn = e.target.closest('#desktop-profile-btn');
    if (profileBtn) {
      e.stopPropagation();
      const dropdown = document.getElementById('desktop-profile-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('hidden');
      }
      return;
    }

    // Close dropdown when clicking outside
    const dropdown = document.getElementById('desktop-profile-dropdown');
    const profileBtnElement = document.getElementById('desktop-profile-btn');
    if (dropdown && profileBtnElement) {
      if (!dropdown.classList.contains('hidden') &&
          !profileBtnElement.contains(e.target) &&
          !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    }
  });

  console.log('[UI] Desktop navigation event delegation setup complete');
}

/**
 * Setup Account Settings form handlers
 * Called after rendering the Account Settings view
 */
function setupAccountSettingsHandlers() {
  const changeEmailForm = document.getElementById('change-email-form');
  const changePasswordForm = document.getElementById('change-password-form');

  if (!changeEmailForm || !changePasswordForm) {
    console.warn('[UI] Account settings forms not found');
    return;
  }

  // Handle email change
  changeEmailForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const newEmail = document.getElementById('new-email').value;
    const currentPassword = document.getElementById('confirm-email-password').value;
    const successMsg = document.getElementById('email-success');
    const errorMsg = document.getElementById('email-error');
    const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

    // Reset messages
    successMsg.textContent = '';
    errorMsg.textContent = '';

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      await updateUserEmail(newEmail, currentPassword);
      successMsg.textContent = '‚úì Email updated successfully! Please log in again with your new email.';

      // Clear form
      changeEmailForm.reset();

      // Log out user after email change (Firebase requirement)
      setTimeout(() => {
        handleLogout();
      }, 2000);
    } catch (error) {
      console.error('[UI] Error updating email:', error);
      errorMsg.textContent = `Error: ${error.message}`;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Email';
    }
  });

  // Handle password change
  changePasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const successMsg = document.getElementById('password-success');
    const errorMsg = document.getElementById('password-error');
    const submitBtn = e.submitter || e.target.querySelector('button[type="submit"]');

    // Reset messages
    successMsg.textContent = '';
    errorMsg.textContent = '';

    // Validate passwords match
    if (newPassword !== confirmPassword) {
      errorMsg.textContent = 'New passwords do not match';
      return;
    }

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      await updateUserPassword(currentPassword, newPassword);
      successMsg.textContent = '‚úì Password updated successfully!';

      // Clear form
      changePasswordForm.reset();
    } catch (error) {
      console.error('[UI] Error updating password:', error);
      errorMsg.textContent = `Error: ${error.message}`;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });

  console.log('[UI] Account settings handlers setup complete');
}

/**
 * Shows the Account Settings page
 */
export function showAccountSettings() {
  console.log('[UI] Showing account settings view');
  showPage('account-settings-view');
}

/**
 * Toon Search view
 */
export function showSearch() {
  console.log('[UI] Showing search view');

  const currentUserData = getStore('currentUserData');

  // Only programmers can access search
  if (!currentUserData || currentUserData.role !== 'programmer') {
    console.warn('[UI] Access denied: Only programmers can access search');
    showDashboard();
    return;
  }

  // Ensure navigation is visible FIRST
  setNavigationVisibility(true);
  import('../modules/navigation/navigation.js').then(navModule => {
    navModule.renderDesktopNav();
    navModule.renderMobileNav();
    if (window.lucide) {
      setTimeout(() => lucide.createIcons(), 50);
    }
  });

  // Render dashboard zonder hash update
  showPage('dashboard-view', false);

  // Zet correcte hash
  window.history.pushState({ view: 'search' }, '', '#search');

  // Setup dashboard
  if (currentUserData.role === 'programmer') {
    const programmerDashboard = document.getElementById('programmer-dashboard');
    if (programmerDashboard) {
      programmerDashboard.style.display = 'block';
      programmerDashboard.classList.remove('hidden');
    }

    // Render programmer dashboard
    import('../modules/programmer/programmer-dashboard.js').then(module => {
      module.renderProgrammerDashboard();
      module.setupProgrammerDashboard();

      // CRITICAL: Hide profile sections, show only search
      const sectionsToHide = [
        'programmer-profile-overview',
        'programmer-public-preview',
        'programmer-about-card',
        'programmer-profile-editor',
        'programmer-pending-view'
      ];

      sectionsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.display = 'none';
          el.classList.add('hidden');
        }
      });

      // Show search section
      const searchSection = document.getElementById('artist-search-section');
      if (searchSection) {
        searchSection.style.display = 'block';
        searchSection.classList.remove('hidden');
        searchSection.dataset.setupComplete = 'false';  // Reset flag
      }

      // Render search UI EERST, dan setup
      import('../modules/search/search-ui.js').then(uiModule => {
        uiModule.renderArtistSearch();

        // Dan setup interactions en load data
        import('../modules/search/search-controller.js').then(ctrlModule => {
          ctrlModule.setupArtistSearch();
          setTimeout(() => ctrlModule.loadArtists(), 100);
        });
      });
    });
  }

  updateMobileNavActive('search');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 150);
  }
}

/**
 * Toon Profile view
 */
export function showProfile() {
  console.log('[UI] Showing profile view');

  const currentUserData = getStore('currentUserData');
  if (!currentUserData) {
    console.warn("[UI] No user data found, cannot show profile");
    // Don't redirect to home, just return
    return;
  }

  if (currentUserData.role === 'artist') {
    showArtistOwnProfile();
  } else if (currentUserData.role === 'programmer') {
    showProgrammerProfile();
  }
}

/**
 * Shows the artist's own profile in programmer-view style
 */
export async function showArtistOwnProfile() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData) {
    console.warn("Geen gebruikersdata gevonden");
    return;
  }

  console.log('[UI] Showing artist own profile view');

  // ALWAYS ensure navigation is visible FIRST
  setNavigationVisibility(true);
  const navModule = await import('../modules/navigation/navigation.js');
  navModule.renderDesktopNav();
  navModule.renderMobileNav();

  // Render de dashboard container structuur ZONDER hash update
  showPage('dashboard-view', false);

  // Zet correcte hash voor artist profile (use replaceState to avoid duplicate history)
  if (window.location.hash !== '#profile') {
    window.history.pushState({ view: 'artist-profile' }, '', '#profile');
  }

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  // Show artist dashboard, hide programmer
  if (artistDashboard) {
    artistDashboard.style.display = 'block';
    artistDashboard.classList.remove('hidden');
  }
  if (programmerDashboard) {
    programmerDashboard.style.display = 'none';
    programmerDashboard.classList.add('hidden');
  }

  // Import and render artist own profile view
  const { renderArtistOwnProfile } = await import('../modules/artist/artist-own-profile.js');
  renderArtistOwnProfile(currentUserData);

  // Update mobile nav
  updateMobileNavActive('profile');

  // Re-initialize Lucide icons
  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}

/**
 * Shows artist profile editor with correct URL
 */
export async function showArtistEditProfile() {
  const currentUserData = getStore('currentUserData');

  if (!currentUserData || currentUserData.role !== 'artist') {
    console.warn('[UI] Only artists can access edit profile');
    return;
  }

  console.log('[UI] Showing artist edit profile');

  // Render dashboard container without hash update
  showPage('dashboard-view', false);

  // Set correct hash
  window.history.pushState({ view: 'artist-edit-profile' }, '', '#edit-profile');

  // Get containers
  const artistDashboard = document.getElementById('artist-dashboard');
  const programmerDashboard = document.getElementById('programmer-dashboard');

  if (artistDashboard) {
    artistDashboard.style.display = 'block';
    artistDashboard.classList.remove('hidden');
  }
  if (programmerDashboard) {
    programmerDashboard.style.display = 'none';
    programmerDashboard.classList.add('hidden');
  }

  // Import and show profile editor
  const { showProfileEditorView } = await import('../modules/artist/artist-own-profile.js');
  if (showProfileEditorView) {
    showProfileEditorView();
  }

  updateMobileNavActive('profile');

  if (window.lucide) {
    setTimeout(() => lucide.createIcons(), 100);
  }
}
</file>

<file path="src/ui/view-renderers.js">
/**
 * view-renderers.js
 * Centralized view rendering functions
 * All views are rendered dynamically into #app-content
 */

import { getStore } from '../utils/store.js';

/**
 * Renders the Home/Welcome view
 */
export function renderHome() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="home-view" class="min-h-screen flex flex-col">
      <!-- Hero Section -->
      <div class="flex-1 flex flex-col justify-center px-6 py-12 bg-gradient-to-br from-indigo-50 to-white">
        <div class="text-center mb-8">
          <div class="mb-6">
            <svg class="h-16 w-16 mx-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
              <path d="M12 5 9 8h6l-3-3Z"/>
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-gray-900 mb-3 tracking-tight">
            SPOKEN WORD<br/>PLATFORM
          </h1>
          <p class="text-lg text-gray-600 mb-2">Find Your Voice.</p>
          <p class="text-lg text-indigo-600 font-semibold">Book Your Artist.</p>
        </div>

        <div class="space-y-3 max-w-sm mx-auto w-full px-6">
          <button id="home-cta-artist" class="btn-press w-full bg-indigo-600 text-white px-6 py-4 rounded-xl text-base font-semibold shadow-lg hover:bg-indigo-700 transition duration-200">
            Ik ben een Artiest
          </button>
          <button id="home-cta-programmer" class="btn-press w-full bg-gray-900 text-white px-6 py-4 rounded-xl text-base font-semibold shadow-lg hover:bg-gray-800 transition duration-200">
            Ik ben een Programmator
          </button>
          <button id="home-login-btn" class="btn-press w-full bg-white text-gray-900 px-6 py-4 rounded-xl text-base font-semibold border border-gray-300 hover:bg-gray-50 transition duration-200">
            Inloggen
          </button>
        </div>
      </div>

      <!-- Featured Artists Preview -->
      <div class="px-6 py-8 bg-white">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Featured Artists</h3>
        <div class="space-y-4">
          <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex-shrink-0"></div>
            <div class="flex-1">
              <h4 class="font-semibold text-gray-900">Artist Name</h4>
              <p class="text-sm text-indigo-600">Performance Poetry</p>
              <p class="text-xs text-gray-500 mt-1">Amsterdam</p>
            </div>
          </div>
          <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex-shrink-0"></div>
            <div class="flex-1">
              <h4 class="font-semibold text-gray-900">Stage Name</h4>
              <p class="text-sm text-indigo-600">Poetry Slam</p>
              <p class="text-xs text-gray-500 mt-1">Brussels</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Version Badge -->
      <div class="text-center py-6 text-xs text-gray-400">
        Release v2.5 [Final Build] - 23-12-2025
      </div>
    </div>
  `;
}

/**
 * Renders the Login view
 * Clean, standard implementation with proper form submission
 * Uses global event delegation via setupGlobalFormHandlers()
 */
export function renderLogin() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="login-view" class="min-h-screen flex items-center justify-center px-6 py-12">
      <div class="w-full max-w-sm">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Welkom terug</h2>
          <p class="text-gray-600">Log in op je account</p>
        </div>

        <form id="login-form" class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
            <input id="login-email" name="email" type="email" autocomplete="email" required
              class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-2">Wachtwoord</label>
            <input id="login-password" name="password" type="password" autocomplete="current-password" required
              class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <button type="submit" id="login-submit-btn"
            class="w-full py-3 px-4 rounded-xl text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors mt-6">
            Inloggen
          </button>
          <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </form>

        <div class="mt-6 text-center">
          <button id="back-to-home-from-login" class="text-indigo-600 text-sm font-medium hover:text-indigo-800 transition-colors">
            ‚Üê Terug naar home
          </button>
        </div>
      </div>
    </div>
  `;
}

/**
 * Renders the Signup Choice view
 */
export function renderSignup() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="signup-view" class="min-h-screen flex items-center justify-center px-6 py-12">
      <div class="w-full max-w-sm">
        <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Meld je aan als...</h2>
        <div class="space-y-4">
          <button id="signup-choice-artist" class="btn-press w-full py-4 px-4 rounded-xl text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700">
            Artiest / Spoken Word Member
          </button>
          <button id="signup-choice-programmer" class="btn-press w-full py-4 px-4 rounded-xl text-base font-semibold text-white bg-gray-900 hover:bg-gray-800">
            Programmator / Organisatie
          </button>
        </div>
        <div class="mt-6 text-center">
          <button id="back-to-home-from-signup" class="text-indigo-600 text-sm font-medium">
            ‚Üê Terug naar home
          </button>
        </div>
      </div>
    </div>
  `;
}

/**
 * Renders the Artist Signup Form view
 */
export function renderArtistSignup() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="artist-signup-view">
      <div class="px-6 py-8">
        <div class="mb-6">
          <button id="back-from-artist-signup" class="text-indigo-600 text-sm font-medium mb-4">
            ‚Üê Terug
          </button>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Maak je Artiest Profiel</h2>
          <p class="text-gray-600 text-sm">Vul zoveel mogelijk in. Je kunt later meer toevoegen.</p>
        </div>

        <form id="artist-signup-form" class="space-y-6">
          <!-- Account Credentials -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Account Details</h3>
            <div class="space-y-4">
              <div>
                <label for="artist-email" class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                <input id="artist-email" type="email" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="artist-password" class="block text-sm font-semibold text-gray-700 mb-2">Wachtwoord (min. 6 tekens) *</label>
                <input id="artist-password" type="password" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
          </div>

          <!-- Personal Details -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Persoonlijke Gegevens</h3>
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="artist-firstname" class="block text-sm font-semibold text-gray-700 mb-2">Voornaam *</label>
                  <input id="artist-firstname" type="text" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label for="artist-lastname" class="block text-sm font-semibold text-gray-700 mb-2">Achternaam *</label>
                  <input id="artist-lastname" type="text" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>
              <div>
                <label for="artist-stagename" class="block text-sm font-semibold text-gray-700 mb-2">Artiestennaam</label>
                <input id="artist-stagename" type="text" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="artist-phone" class="block text-sm font-semibold text-gray-700 mb-2">Telefoon *</label>
                <input id="artist-phone" type="tel" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="artist-dob" class="block text-sm font-semibold text-gray-700 mb-2">Geboortedatum *</label>
                <input id="artist-dob" type="date" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="artist-gender" class="block text-sm font-semibold text-gray-700 mb-2">Geslacht *</label>
                <select id="artist-gender" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <option value="">Selecteer...</option>
                  <option value="f">Vrouw</option>
                  <option value="m">Man</option>
                  <option value="x">Anders / Wil niet zeggen</option>
                </select>
              </div>
              <div>
                <label for="artist-location" class="block text-sm font-semibold text-gray-700 mb-2">Locatie *</label>
                <input id="artist-location" type="text" required placeholder="bijv. Amsterdam, Nederland" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
          </div>

          <!-- Professional Details -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Professionele Details</h3>

            <!-- Genres -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Genres (selecteer meerdere) *</label>
              <div class="space-y-2">
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="performance-poetry" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Performance Poetry</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="poetry-slam" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Poetry Slam</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="jazz-poetry" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Jazz Poetry</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="rap" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Rap</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="storytelling" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Storytelling</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="comedy" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Comedy</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-genres" value="1-on-1" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">1-op-1 Sessies</span>
                </label>
              </div>
            </div>

            <!-- Languages -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Talen (selecteer meerdere) *</label>
              <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-languages" value="nl" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Nederlands</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-languages" value="en" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Engels</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-languages" value="fr" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Frans</span>
                </label>
              </div>
            </div>

            <!-- Payment Methods -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Betaalmethoden *</label>
              <div class="space-y-2">
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-payment" value="invoice" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Factuur</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-payment" value="payrolling" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Payrolling</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-payment" value="sbk" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Anders (SBK)</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-payment" value="volunteer-fee" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Vrijwilligersvergoeding</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" name="artist-payment" value="other" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                  <span class="text-sm font-medium">Anders</span>
                </label>
              </div>
            </div>

            <!-- Bio & Pitch -->
            <div class="space-y-4">
              <div>
                <label for="artist-bio" class="block text-sm font-semibold text-gray-700 mb-2">Bio *</label>
                <textarea id="artist-bio" rows="4" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
              </div>
              <div>
                <label for="artist-pitch" class="block text-sm font-semibold text-gray-700 mb-2">Pitch *</label>
                <textarea id="artist-pitch" rows="2" required placeholder="Korte samenvatting voor programmatoren" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
              </div>
            </div>
          </div>

          <!-- Terms -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <div class="space-y-3">
              <label class="flex items-start space-x-3">
                <input id="artist-notify-email" type="checkbox" checked class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 mt-0.5">
                <span class="text-sm text-gray-700">OK om email notificaties te ontvangen</span>
              </label>
              <label class="flex items-start space-x-3">
                <input id="artist-notify-sms" type="checkbox" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 mt-0.5">
                <span class="text-sm text-gray-700">OK om SMS notificaties te ontvangen</span>
              </label>
              <label class="flex items-start space-x-3">
                <input id="artist-terms" type="checkbox" required class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 mt-0.5">
                <span class="text-sm text-gray-700">Ik ga akkoord met de <a href="#" class="font-semibold text-indigo-600">Algemene Voorwaarden</a> *</span>
              </label>
            </div>
          </div>

          <button type="submit"
            class="btn-press w-full py-4 px-4 rounded-xl text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
            Account Aanmaken
          </button>
          <p id="artist-signup-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </form>
      </div>
    </div>
  `;
}

/**
 * Renders the Programmer Signup Form view
 */
export function renderProgrammerSignup() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="programmer-signup-view">
      <div class="px-6 py-8">
        <div class="mb-6">
          <button id="back-from-programmer-signup" class="text-indigo-600 text-sm font-medium mb-4">
            ‚Üê Terug
          </button>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Maak je Programmator Account</h2>
          <p class="text-gray-600 text-sm">Start je 7-daagse gratis proefperiode.</p>
        </div>

        <form id="programmer-signup-form" class="space-y-6">
          <!-- Account Details -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Account Details</h3>
            <div class="space-y-4">
              <div>
                <label for="prog-email" class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                <input id="prog-email" type="email" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="prog-password" class="block text-sm font-semibold text-gray-700 mb-2">Wachtwoord (min. 6 tekens) *</label>
                <input id="prog-password" type="password" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
          </div>

          <!-- Organization Details -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Organisatie Details</h3>
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="prog-firstname" class="block text-sm font-semibold text-gray-700 mb-2">Voornaam *</label>
                  <input id="prog-firstname" type="text" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label for="prog-lastname" class="block text-sm font-semibold text-gray-700 mb-2">Achternaam *</label>
                  <input id="prog-lastname" type="text" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>
              <div>
                <label for="prog-org-name" class="block text-sm font-semibold text-gray-700 mb-2">Organisatie Naam *</label>
                <input id="prog-org-name" type="text" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="prog-phone" class="block text-sm font-semibold text-gray-700 mb-2">Telefoon *</label>
                <input id="prog-phone" type="tel" required class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="prog-website" class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                <input id="prog-website" type="url" placeholder="https://..." class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label for="prog-org-about" class="block text-sm font-semibold text-gray-700 mb-2">Over Organisatie</label>
                <textarea id="prog-org-about" rows="3" class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
              </div>
            </div>
          </div>

          <!-- Terms -->
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <div class="space-y-3">
              <label class="flex items-start space-x-3">
                <input id="prog-notify-email" type="checkbox" checked class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 mt-0.5">
                <span class="text-sm text-gray-700">OK om email notificaties te ontvangen</span>
              </label>
              <label class="flex items-start space-x-3">
                <input id="prog-terms" type="checkbox" required class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 mt-0.5">
                <span class="text-sm text-gray-700">Ik ga akkoord met de <a href="#" class="font-semibold text-indigo-600">Algemene Voorwaarden</a> *</span>
              </label>
            </div>
          </div>

          <button type="submit"
            class="btn-press w-full py-4 px-4 rounded-xl text-base font-semibold text-white bg-gray-900 hover:bg-gray-800 focus:outline-none">
            Start Gratis Proefperiode
          </button>
          <p id="programmer-signup-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </form>
      </div>
    </div>
  `;
}

/**
 * Renders the Messages view
 */
export function renderMessages() {
  const appContent = document.getElementById('app-content');

  // Hide profile picture on messages page
  const profilePicContainer = document.querySelector('.programmer-profile-pattern, #programmer-profile-overview, #programmer-dashboard');
  if (profilePicContainer) {
    profilePicContainer.style.display = 'none';
  }

  appContent.innerHTML = `
    <div id="messages-view" style="min-height: 100vh; background: #F8F9FA;">

      <!-- DESKTOP: Two columns -->
      <div id="desktop-messages-layout" style="height: calc(100vh - 80px); display: none;">

        <!-- Left: Conversation list -->
        <div style="width: 380px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; height: 100%;">
          <div style="padding: 24px 20px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="font-size: 26px; font-weight: 700; margin: 0 0 16px;">Berichten</h2>
            <input id="desktop-search" type="text" placeholder="Zoek in berichten..."
              style="width: 100%; padding: 12px 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 14px;">
          </div>
          <div id="conversations-list" style="flex: 1; overflow-y: auto; padding: 8px 12px;"></div>
          <div id="conversations-loading" style="padding: 40px; text-align: center; color: #9ca3af;">Laden...</div>
          <div id="conversations-empty" style="display: none; padding: 60px 20px; text-align: center; color: #9ca3af;">Geen berichten</div>
        </div>

        <!-- Right: Chat area -->
        <div style="flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;">
          <div id="chat-placeholder" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
            <p>Selecteer een gesprek</p>
          </div>
          <div id="chat-container" style="display: none; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">
            <div id="chat-header" style="padding: 16px 24px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
              <div id="chat-avatar" style="width: 48px; height: 48px; border-radius: 50%; background: #e9d5ff;"></div>
              <div>
                <h3 id="chat-name" style="font-size: 17px; font-weight: 600; margin: 0;">Gesprek</h3>
                <p id="chat-role" style="font-size: 13px; color: #805ad5; margin: 0;"></p>
              </div>
            </div>
            <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 20px 24px; background: #F8F9FA; min-height: 0;"></div>
            <div style="padding: 16px 24px; background: white; border-top: 1px solid #e5e7eb;">
              <form id="message-form" style="display: flex; gap: 12px;">
                <input id="message-input" type="text" placeholder="Typ een bericht..." required
                  style="flex: 1; padding: 14px 18px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 15px;">
                <button type="submit" style="padding: 14px 24px; background: #805ad5; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">Verstuur</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- MOBILE: List view -->
      <div id="mobile-conversations-view" style="min-height: 100vh; padding-bottom: 100px; display: block;">
        <div style="padding: 20px 16px; background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 20;">
          <h2 style="font-size: 24px; font-weight: 700; margin: 0 0 14px;">Berichten</h2>
          <input type="text" placeholder="Zoek..." style="width: 100%; padding: 11px 16px; background: #f3f4f6; border: none; border-radius: 10px; font-size: 14px;">
        </div>
        <div id="mobile-conversations-list" style="padding: 8px 12px;"></div>
        <div id="mobile-conversations-empty" style="display: none; padding: 60px; text-align: center; color: #9ca3af;">Geen berichten</div>
        <button id="mobile-fab" style="position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: #805ad5; color: white; border: none; border-radius: 50%; box-shadow: 0 4px 12px rgba(128,90,213,0.4); cursor: pointer; z-index: 30;">+</button>
      </div>

      <!-- MOBILE: Chat view (overlay) -->
      <div id="mobile-chat-view" style="display: none; position: fixed; inset: 0; background: white; z-index: 100; flex-direction: column;">
        <div style="padding: 12px 16px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
          <button id="mobile-back-btn" style="padding: 8px; background: none; border: none; cursor: pointer; font-size: 24px;">‚Üê</button>
          <div id="mobile-chat-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #e9d5ff;"></div>
          <div style="flex: 1;">
            <h3 id="mobile-chat-name" style="font-size: 16px; font-weight: 600; margin: 0;"></h3>
            <p id="mobile-chat-role" style="font-size: 12px; color: #805ad5; margin: 0;"></p>
          </div>
        </div>
        <div id="mobile-messages-container" style="flex: 1; overflow-y: auto; padding: 16px; background: #F8F9FA;"></div>
        <div style="padding: 12px 16px 90px 16px; background: white; border-top: 1px solid #e5e7eb;">
          <form id="mobile-message-form" style="display: flex; gap: 10px;">
            <input id="mobile-message-input" type="text" placeholder="Typ een bericht..." required
              style="flex: 1; padding: 12px 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 15px;">
            <button type="submit" style="width: 48px; height: 48px; background: #805ad5; color: white; border: none; border-radius: 12px; cursor: pointer;">‚Üí</button>
          </form>
        </div>
      </div>

    </div>
  `;

  // Handle responsive layout with JavaScript
  function handleMessagesResize() {
    const isDesktop = window.innerWidth >= 1024;
    const desktopLayout = document.getElementById('desktop-messages-layout');
    const mobileListView = document.getElementById('mobile-conversations-view');
    const mobileChatView = document.getElementById('mobile-chat-view');

    if (desktopLayout && mobileListView) {
      if (isDesktop) {
        desktopLayout.style.display = 'flex';
        mobileListView.style.display = 'none';
        if (mobileChatView) mobileChatView.style.display = 'none';
      } else {
        desktopLayout.style.display = 'none';
        mobileListView.style.display = 'block';
      }
    }
  }

  // Run on load and resize
  handleMessagesResize();
  window.addEventListener('resize', handleMessagesResize);
}

/**
 * Renders the Account Settings view
 */
export function renderAccountSettings() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="account-settings-view" class="min-h-screen bg-gray-50 py-8 px-6">
      <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-4xl font-bold text-gray-900 tracking-tight mb-2">Account Settings</h1>
          <p class="text-gray-600">Manage your email and password</p>
        </div>

        <!-- Change Email Section -->
        <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 mb-6">
          <div class="mb-6 pb-6 border-b border-gray-100">
            <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Change Email</h2>
            <p class="text-sm text-gray-500 mt-1">Update your account email address</p>
          </div>

          <form id="change-email-form" class="space-y-4">
            <div>
              <label for="new-email" class="block text-sm font-semibold text-gray-700 mb-2">New Email Address</label>
              <input id="new-email" type="email" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                     placeholder="your.new.email@example.com">
            </div>
            <div>
              <label for="confirm-email-password" class="block text-sm font-semibold text-gray-700 mb-2">Current Password (for verification)</label>
              <input id="confirm-email-password" type="password" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                     placeholder="Enter your current password">
            </div>
            <button type="submit"
                    class="w-full bg-indigo-600 text-white px-6 py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-sm hover:shadow">
              Update Email
            </button>
            <p id="email-success" class="text-green-600 text-sm text-center"></p>
            <p id="email-error" class="text-red-600 text-sm text-center"></p>
          </form>
        </div>

        <!-- Change Password Section -->
        <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 mb-6">
          <div class="mb-6 pb-6 border-b border-gray-100">
            <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Change Password</h2>
            <p class="text-sm text-gray-500 mt-1">Update your account password</p>
          </div>

          <form id="change-password-form" class="space-y-4">
            <div>
              <label for="current-password" class="block text-sm font-semibold text-gray-700 mb-2">Current Password</label>
              <input id="current-password" type="password" required
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                     placeholder="Enter your current password">
            </div>
            <div>
              <label for="new-password" class="block text-sm font-semibold text-gray-700 mb-2">New Password</label>
              <input id="new-password" type="password" required minlength="6"
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                     placeholder="Enter new password (min. 6 characters)">
            </div>
            <div>
              <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">Confirm New Password</label>
              <input id="confirm-password" type="password" required minlength="6"
                     class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                     placeholder="Confirm new password">
            </div>
            <button type="submit"
                    class="w-full bg-indigo-600 text-white px-6 py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-sm hover:shadow">
              Update Password
            </button>
            <p id="password-success" class="text-green-600 text-sm text-center"></p>
            <p id="password-error" class="text-red-600 text-sm text-center"></p>
          </form>
        </div>
      </div>
    </div>
  `;
}

/**
 * Renders the Dashboard view (wrapper for artist/programmer dashboards)
 */
export function renderDashboard() {
  const appContent = document.getElementById('app-content');
  appContent.innerHTML = `
    <div id="dashboard-view" style="min-height: 100vh; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);">
      <!-- Artist Dashboard -->
      <div id="artist-dashboard" class="hidden">
        <!-- Content rendered by renderArtistDashboard() in artist-dashboard.js -->
      </div>

      <!-- Programmer Dashboard -->
      <div id="programmer-dashboard">
        <!-- Content rendered by renderProgrammerDashboard() in programmer-dashboard.js -->
      </div>

      <!-- ARTIST DETAIL VIEW -->
      <section id="artist-detail-view" class="hidden">
        <div class="artist-detail-pattern" style="min-height: 100vh; padding: 24px;">
          <div style="max-width: 1400px; margin: 0 auto;">

            <!-- Back Button (beide layouts) -->
            <button id="back-to-search-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; color: #4a4a68; cursor: pointer; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              Terug naar zoeken
            </button>

            <!-- ==================== MOBILE LAYOUT ==================== -->
            <div id="mobile-artist-detail" class="lg:hidden" style="padding: 0 0 100px;">

              <!-- Profile Photo -->
              <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; border: 3px solid #1a1a2e;">
                  <img id="mobile-detail-photo" src="" alt="Artist" style="width: 100%; height: 100%; object-fit: cover; background: #f3f4f6;">
                </div>
              </div>

              <!-- Name -->
              <h1 id="mobile-detail-name" style="font-size: 28px; font-weight: 700; color: #1a1a2e; text-align: center; margin-bottom: 16px;">Artist Name</h1>

              <!-- Meta Info -->
              <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  <span id="mobile-detail-age">-- years old</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  <span id="mobile-detail-gender">Gender</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; color: #4a4a68; font-size: 15px;">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span id="mobile-detail-location">Location</span>
                </div>
              </div>

              <!-- Genres -->
              <div style="margin-bottom: 20px;">
                <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Genres</p>
                <div id="mobile-detail-genres" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>

              <!-- Languages -->
              <div style="margin-bottom: 24px;">
                <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Languages</p>
                <div id="mobile-detail-languages" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>

              <!-- Themes -->
              <div style="margin-bottom: 20px;">
                <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Themes</p>
                <div id="mobile-detail-themes-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <span style="color: #9ca3af; font-size: 14px;">Geen themes</span>
                </div>
              </div>

              <!-- Vibe -->
              <div style="margin-bottom: 20px;">
                <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Vibe</p>
                <div id="mobile-detail-vibe-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <span style="color: #9ca3af; font-size: 14px;">Geen vibe</span>
                </div>
              </div>

              <!-- Diensten -->
              <div style="margin-bottom: 24px;">
                <p style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Diensten</p>
                <div id="mobile-detail-formats-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <span style="color: #9ca3af; font-size: 14px;">Geen diensten</span>
                </div>
              </div>

              <!-- Send Message Button -->
              <button id="mobile-send-message-btn"
                      style="width: 100%; padding: 14px; background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                Send Message
              </button>

              <!-- Biography -->
              <div style="margin-bottom: 20px;">
                <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Biography</h2>
                <p id="mobile-detail-bio" style="font-size: 15px; color: #4a4a68; line-height: 1.6;">No biography available.</p>
              </div>

              <!-- Pitch -->
              <div style="margin-bottom: 24px;">
                <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Pitch</h2>
                <p id="mobile-detail-pitch" style="font-size: 15px; color: #4a4a68; line-height: 1.6;">No pitch available.</p>
              </div>

              <!-- Contact Information -->
              <div style="margin-bottom: 24px;">
                <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px;">Contact Information</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <div id="mobile-detail-email-container" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="18" height="18" fill="none" stroke="#4a4a68" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    <a id="mobile-detail-email" href="#" style="font-size: 15px; color: #4a4a68; text-decoration: none;">email@example.com</a>
                  </div>
                  <div id="mobile-detail-phone-container" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="18" height="18" fill="none" stroke="#4a4a68" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    <span id="mobile-detail-phone" style="font-size: 15px; color: #4a4a68;">+31 6 12345678</span>
                  </div>
                </div>
              </div>

              <!-- Recommendations -->
              <div>
                <h2 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Recommendations</h2>
                <button id="mobile-write-recommendation-btn"
                        style="width: 100%; padding: 14px; background: white; color: #1a1a2e; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 16px;">
                  Write Recommendation
                </button>
                <div id="mobile-detail-recommendations" style="display: flex; flex-direction: column; gap: 12px;"></div>
              </div>

            </div>

            <!-- ==================== DESKTOP 3-COLUMN LAYOUT ==================== -->
            <div id="desktop-artist-detail" class="hidden lg:grid" style="grid-template-columns: 280px 1fr 320px; gap: 24px; align-items: start;">

              <!-- LEFT COLUMN: Media Gallery -->
              <aside style="background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1);">
                <h2 style="font-size: 20px; font-weight: 700; color: #1a1a2e; margin-bottom: 20px;">Media Gallery</h2>
                <div id="detail-media-gallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                  <div style="aspect-ratio: 1; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: #9ca3af; font-size: 13px;">Geen media</span>
                  </div>
                </div>
              </aside>

              <!-- MIDDLE COLUMN: Artist Profile -->
              <main style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1);">

                <!-- Profile Header -->
                <div style="display: flex; gap: 24px; margin-bottom: 24px;">
                  <div style="flex-shrink: 0;">
                    <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; border: 4px solid #805ad5;">
                      <img id="detail-profile-pic" src="" alt="Artist" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                  </div>
                  <div style="flex: 1;">
                    <h1 id="detail-artist-name" style="font-size: 32px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px;">Artist Name</h1>
                    <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                      <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        <span id="detail-age">-- years old</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span id="detail-gender">Gender</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px; color: #4a4a68; font-size: 14px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span id="detail-location">Location</span>
                      </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Genres</p>
                      <div id="detail-genres" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Languages</p>
                      <div id="detail-languages" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Themes</p>
                      <div id="detail-themes-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span style="color: #9ca3af; font-size: 14px;">Geen themes</span>
                      </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Vibe</p>
                      <div id="detail-vibe-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span style="color: #9ca3af; font-size: 14px;">Geen vibe</span>
                      </div>
                    </div>
                    <div>
                      <p style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Diensten</p>
                      <div id="detail-formats-full" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span style="color: #9ca3af; font-size: 14px;">Geen diensten</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Biography Section -->
                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e9e3f5;">
                  <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px;">Biography</h3>
                  <p id="detail-bio" style="font-size: 14px; color: #4a4a68; line-height: 1.7;">No biography available.</p>
                  <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin: 20px 0 12px;">Pitch</h3>
                  <p id="detail-pitch" style="font-size: 14px; color: #4a4a68; line-height: 1.7;">No pitch available.</p>
                </div>

                <!-- Contact Information -->
                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e9e3f5;">
                  <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Contact Information</h3>
                  <div style="display: flex; flex-wrap: wrap; gap: 24px;">
                    <div id="detail-email-container" style="display: flex; align-items: center; gap: 10px;">
                      <svg width="18" height="18" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                      <a id="detail-email" href="#" style="font-size: 14px; color: #4a4a68; text-decoration: none;">email@example.com</a>
                    </div>
                    <div id="detail-phone-container" style="display: flex; align-items: center; gap: 10px;">
                      <svg width="18" height="18" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                      <span id="detail-phone" style="font-size: 14px; color: #4a4a68;">+31 6 12345678</span>
                    </div>
                  </div>
                </div>

                <!-- Recommendations Section -->
                <div>
                  <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Recommendations</h3>
                  <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button id="write-recommendation-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                      Write Recommendation
                    </button>
                    <button id="view-recommendations-btn" style="padding: 10px 20px; background: white; color: #1a1a2e; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                      View All Recommendations
                    </button>
                  </div>
                  <div id="detail-recommendations" style="display: flex; flex-direction: column; gap: 12px;"></div>
                </div>

              </main>

              <!-- RIGHT COLUMN: Chat Panel -->
              <aside id="artist-chat-panel" style="position: relative; width: 320px; height: 600px; align-self: start; flex-shrink: 0;">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(128,90,213,0.08); border: 1px solid rgba(128,90,213,0.1); display: flex; flex-direction: column; overflow: hidden;">
                  <div style="padding: 20px 24px; border-bottom: 1px solid #e9e3f5; flex-shrink: 0;">
                    <h2 id="chat-header-name" style="font-size: 18px; font-weight: 700; color: #1a1a2e; margin: 0;">Chat met Artist</h2>
                  </div>
                  <div id="profile-chat-messages" style="flex: 1; min-height: 0; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 16px;">
                    <div id="chat-empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af;">
                      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-bottom: 12px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                      <p style="font-size: 14px; margin: 0;">Start een gesprek</p>
                    </div>
                  </div>
                  <div style="padding: 16px 24px; border-top: 1px solid #e9e3f5; flex-shrink: 0; background: white;">
                    <form id="profile-chat-form" style="display: flex; gap: 12px; margin: 0;">
                      <input type="text" id="profile-chat-input" placeholder="Type je bericht..." style="flex: 1; padding: 12px 16px; border: 1px solid #e9e3f5; border-radius: 24px; font-size: 14px; outline: none;">
                      <button type="submit" style="width: 44px; height: 44px; background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="20" height="20" fill="none" stroke="white" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                      </button>
                    </form>
                  </div>
                </div>
              </aside>

            </div>
          </div>
        </div>
      </section>
    </div>
  `;
}

/**
 * Renders the Edit Profile page for programmers
 */
export function renderEditProfile() {
  const appContent = document.getElementById('app-content');

  appContent.innerHTML = `
    <div id="edit-profile-view" class="min-h-screen" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);">

      <!-- Header -->
      <div class="max-w-6xl mx-auto px-6 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Edit Profile</h1>

        <!-- Form Container -->
        <form id="edit-profile-form">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Column 1: Personal Details -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <h2 class="text-lg font-bold text-gray-900 mb-6">Personal Details</h2>

              <!-- Profile Photo -->
              <div class="flex items-center gap-4 mb-6">
                <div id="edit-avatar-placeholder" class="w-16 h-16 rounded-xl flex items-center justify-center"
                     style="background-color: #c4b5fd;">
                  <span id="edit-avatar-initial" class="text-2xl font-bold" style="color: #7c3aed;">T</span>
                </div>
                <img id="edit-profile-pic-preview" src="" alt="Profile"
                     class="hidden w-16 h-16 rounded-xl object-cover">
                <div>
                  <label for="edit-profile-pic-input"
                         class="cursor-pointer px-4 py-2 rounded-lg text-sm font-medium text-white"
                         style="background-color: #7c3aed;">
                    Change Photo
                  </label>
                  <input type="file" id="edit-profile-pic-input" accept="image/*" class="hidden">
                </div>
              </div>

              <!-- First Name -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                <input type="text" id="edit-first-name"
                       class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="Enter first name">
              </div>

              <!-- Last Name -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                <input type="text" id="edit-last-name"
                       class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="Enter last name">
              </div>

              <!-- Phone Number -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                <input type="tel" id="edit-phone"
                       class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="Enter phone number">
              </div>
            </div>

            <!-- Column 2: Organization Details -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <h2 class="text-lg font-bold text-gray-900 mb-6">Organization Details</h2>

              <!-- Organization Name -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                <input type="text" id="edit-organization-name"
                       class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="Enter organization name">
              </div>

              <!-- Website -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                <input type="url" id="edit-website"
                       class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="https://example.com">
              </div>

              <!-- About Organization -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">About Organization</label>
                <textarea id="edit-about" rows="5"
                          class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                          placeholder="Describe your organization..."></textarea>
              </div>
            </div>

            <!-- Column 3: Preferences -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <h2 class="text-lg font-bold text-gray-900 mb-6">Preferences</h2>

              <!-- Language -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Language</label>
                <select id="edit-language"
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
                  <option value="nl">Nederlands</option>
                  <option value="en">English</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex justify-center gap-4 mt-8">
            <button type="submit" id="save-profile-btn"
                    class="px-8 py-3 rounded-lg font-semibold text-white text-sm transition-all"
                    style="background-color: #7c3aed;">
              Save All Changes
            </button>
            <button type="button" id="cancel-edit-btn"
                    class="px-8 py-3 rounded-lg font-semibold text-sm transition-all bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300">
              Cancel
            </button>
          </div>

          <!-- Status Messages -->
          <div id="edit-profile-success" class="hidden mt-4 text-center text-green-600 font-medium"></div>
          <div id="edit-profile-error" class="hidden mt-4 text-center text-red-600 font-medium"></div>
        </form>
      </div>
    </div>
  `;
}

/**
 * Renders the Public Profile Preview page for programmers
 */
export function renderPublicProfilePage() {
  const appContent = document.getElementById('app-content');
  const currentUserData = getStore('currentUserData');
  const currentUser = getStore('currentUser');

  // Extract data
  const firstName = currentUserData?.firstName || '';
  const lastName = currentUserData?.lastName || '';
  const fullName = `${firstName} ${lastName}`.trim() || 'Programmer Name';
  const initial = (firstName.charAt(0) || 'P').toUpperCase();
  const organizationName = currentUserData?.organizationName || 'Organization Name';
  const email = currentUser?.email || 'email@example.com';
  const phone = currentUserData?.phone || 'Not specified';
  const website = currentUserData?.website || '';
  const about = currentUserData?.organizationAbout || 'No description available';
  const profilePicUrl = currentUserData?.profilePicUrl || '';

  appContent.innerHTML = `
    <div id="public-profile-view" class="min-h-screen" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);">

      <!-- Header with Back Button -->
      <div class="max-w-4xl mx-auto px-6 py-8">
        <button id="back-to-profile-btn" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="font-medium">Back to Profile</span>
        </button>

        <h1 class="text-3xl font-bold text-gray-900 mb-2">Public Profile Preview</h1>
        <p class="text-gray-600 mb-8">This is how artists see your profile when they view your organization information.</p>

        <!-- Public Profile Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

          <!-- Profile Header -->
          <div class="p-8">
            <div class="flex items-start gap-6">

              <!-- Avatar -->
              <div class="flex-shrink-0">
                ${profilePicUrl ? `
                  <img src="${profilePicUrl}" alt="${fullName}"
                       class="w-24 h-24 rounded-2xl object-cover border-2"
                       style="border-color: #a78bfa;">
                ` : `
                  <div class="w-24 h-24 rounded-2xl flex items-center justify-center border-2"
                       style="background-color: #c4b5fd; border-color: #a78bfa;">
                    <span class="text-4xl font-bold" style="color: #7c3aed;">${initial}</span>
                  </div>
                `}
              </div>

              <!-- Info -->
              <div class="flex-grow">
                <div class="flex items-start justify-between mb-4">
                  <div>
                    <h2 class="text-2xl font-bold" style="color: #7c3aed;">${fullName}</h2>
                    <p class="text-lg text-gray-600">${organizationName}</p>
                  </div>
                  <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium border"
                       style="background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0;">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Verified Programmer</span>
                  </div>
                </div>

                <!-- Contact Info -->
                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span>${email}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <span>${phone}</span>
                  </div>
                  ${website ? `
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4" style="color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                      </svg>
                      <a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank" style="color: #7c3aed;">${website.replace(/^https?:\/\//, '')}</a>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>

          <!-- About Section -->
          <div class="border-t border-gray-100 p-8">
            <h3 class="text-lg font-bold text-gray-900 mb-3">About Organization</h3>
            <p class="text-gray-600 leading-relaxed">${about}</p>
          </div>

        </div>

        <!-- Info Note -->
        <div class="mt-6 flex items-start gap-3 text-sm text-gray-500">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p>Artists can view this information when you contact them or when they view your messages.</p>
        </div>

      </div>
    </div>
  `;
}
</file>

<file path="src/modules/search/search-ui.js">
/**
 * search-ui.js
 * Handles all HTML generation for artist search
 * Responsive layout - mobile pills & desktop sidebar
 */

import { collection, getDocs } from 'firebase/firestore';
import { db } from '../../services/firebase.js';
import { loadArtistsData, calculateAge, isProgrammer } from './search-data.js';
import { showArtistDetail } from './search-controller.js';
import { getStore } from '../../utils/store.js';
import { openMessageModal } from '../messaging/messaging-controller.js';

/**
 * Format genre name for display
 * Converts "performance-poetry" to "Performance Poetry"
 */
function formatGenreName(genre) {
  if (!genre) return '';
  return genre
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

/**
 * Render the artist search view - Responsive with Tailwind
 * Mobile: Horizontal pills + dropdown panels + 2-col grid
 * Desktop: Sidebar filters + 4-col grid
 */
export function renderArtistSearch() {
  const searchSection = document.getElementById('artist-search-section');
  if (!searchSection) {
    console.error('[RENDER] artist-search-section not found');
    return;
  }

  // Apply pattern background
  searchSection.className = 'search-pattern';
  searchSection.style.cssText = 'display: block; opacity: 1; visibility: visible;';

  // Detect if desktop
  const isDesktop = window.innerWidth >= 1024;

  searchSection.innerHTML = `
    <div id="search-module-root" style="max-width: 1400px; margin: 0 auto; position: relative; z-index: 1;">

      <!-- ===================== MOBILE LAYOUT ===================== -->
      <div id="mobile-search-layout" style="display: ${isDesktop ? 'none' : 'block'};">

        <h1 style="font-size: 24px; font-weight: 700; color: #1a1a2e; margin-bottom: 16px;">Zoeken</h1>

        <!-- Filter Pills -->
        <div class="no-scrollbar" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 8px;">
          <button data-action="toggle-filter" data-target="name" id="btn-filter-name"
                  style="flex-shrink: 0; padding: 10px 18px; background: white; border: 1px solid #e5e7eb; border-radius: 24px; font-size: 14px; font-weight: 500; color: #4a4a68; cursor: pointer;">
            Naam
          </button>
          <button data-action="toggle-filter" data-target="location" id="btn-filter-location"
                  style="flex-shrink: 0; padding: 10px 18px; background: white; border: 1px solid #e5e7eb; border-radius: 24px; font-size: 14px; font-weight: 500; color: #4a4a68; cursor: pointer;">
            Locatie
          </button>
          <button data-action="toggle-filter" data-target="keywords" id="btn-filter-keywords"
                  style="flex-shrink: 0; padding: 10px 18px; background: white; border: 1px solid #e5e7eb; border-radius: 24px; font-size: 14px; font-weight: 500; color: #4a4a68; cursor: pointer;">
            Keywords
          </button>
        </div>

        <!-- Filter Panels -->
        <div id="filter-name" style="display: none; background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(128,90,213,0.1);">
          <div style="display: flex; gap: 8px;">
            <input type="text" id="mobile-input-name" placeholder="Naam artiest..."
                   style="flex: 1; padding: 12px 16px; background: #f9fafb; border-radius: 12px; border: none; font-size: 14px; outline: none;">
            <button data-action="apply-filter" data-target="name"
                    style="width: 44px; height: 44px; background: #805ad5; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 18px;">‚úì</button>
          </div>
        </div>

        <div id="filter-location" style="display: none; background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(128,90,213,0.1);">
          <div style="display: flex; gap: 8px;">
            <input type="text" id="mobile-input-location" placeholder="Stad of regio..."
                   style="flex: 1; padding: 12px 16px; background: #f9fafb; border-radius: 12px; border: none; font-size: 14px; outline: none;">
            <button data-action="apply-filter" data-target="location"
                    style="width: 44px; height: 44px; background: #805ad5; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 18px;">‚úì</button>
          </div>
        </div>

        <!-- ===== COLLAPSIBLE FILTER PANELS ===== -->

        <!-- GENRE FILTER -->
        <div class="filter-section" style="background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
          <button data-action="toggle-filter" data-target="genre"
                  style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px; background: none; border: none; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600; color: #1a1a2e;">Genre</span>
            <svg id="chevron-genre" style="width: 20px; height: 20px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="filter-genre" style="display: none; padding: 0 16px 16px 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="performance-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Performance Poetry</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="slam-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Slam Poetry</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="hip-hop-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Hip Hop Poetry</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="storytelling" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Storytelling</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="experimental" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Experimental</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="musical-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Musical Poetry</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="lyrical" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Lyrical</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-genre" value="political-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Political Poetry</span>
              </label>
            </div>
          </div>
        </div>

        <!-- THEMES FILTER -->
        <div class="filter-section" style="background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
          <button data-action="toggle-filter" data-target="themes"
                  style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px; background: none; border: none; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600; color: #1a1a2e;">Themes</span>
            <svg id="chevron-themes" style="width: 20px; height: 20px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="filter-themes" style="display: none; padding: 0 16px 16px 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="identity" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Identity</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="social-justice" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Social Justice</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="mental-health" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Mental Health</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="love-relationships" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Love/Relationships</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="politics" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Politics</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="climate-change" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Climate Change</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-theme" value="coming-of-age" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Coming of Age</span>
              </label>
            </div>
          </div>
        </div>

        <!-- VIBE FILTER -->
        <div class="filter-section" style="background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
          <button data-action="toggle-filter" data-target="vibe"
                  style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px; background: none; border: none; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600; color: #1a1a2e;">Vibe</span>
            <svg id="chevron-vibe" style="width: 20px; height: 20px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="filter-vibe" style="display: none; padding: 0 16px 16px 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-energy" value="intiem" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Intiem</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-energy" value="interactief" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Interactief</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-energy" value="energiek" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Energiek</span>
              </label>
            </div>
          </div>
        </div>

        <!-- FORMATS FILTER -->
        <div class="filter-section" style="background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
          <button data-action="toggle-filter" data-target="formats"
                  style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px; background: none; border: none; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600; color: #1a1a2e;">Diensten</span>
            <svg id="chevron-formats" style="width: 20px; height: 20px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="filter-formats" style="display: none; padding: 0 16px 16px 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-format" value="podiumperformance" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Podiumperformance</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-format" value="workshops" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Workshops</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-format" value="hosting" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Hosting / Presentatie</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-format" value="gedichten-op-maat" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Gedichten op Maat</span>
              </label>
            </div>
          </div>
        </div>

        <!-- LANGUAGES FILTER -->
        <div class="filter-section" style="background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
          <button data-action="toggle-filter" data-target="languages"
                  style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px; background: none; border: none; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600; color: #1a1a2e;">Talen</span>
            <svg id="chevron-languages" style="width: 20px; height: 20px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="filter-languages" style="display: none; padding: 0 16px 16px 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-language" value="nl" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Nederlands</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-language" value="en" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Engels</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-language" value="fr" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Frans</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-language" value="de" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Duits</span>
              </label>
              <label class="chip-label" style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" name="mobile-language" value="es" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                <span class="chip-text" style="font-size: 14px; font-weight: 500; color: #374151;">Spaans</span>
              </label>
            </div>
          </div>
        </div>

        <!-- ===== END COLLAPSIBLE FILTER PANELS ===== -->

        <div id="filter-keywords" style="display: none; background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(128,90,213,0.1);">
          <div style="display: flex; gap: 8px;">
            <input type="text" id="mobile-input-keywords" placeholder="bijv. slam, poetry, rap..."
                   style="flex: 1; padding: 12px 16px; background: #f9fafb; border-radius: 12px; border: none; font-size: 14px; outline: none;">
            <button data-action="apply-filter" data-target="keywords"
                    style="width: 44px; height: 44px; background: #805ad5; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 18px;">‚úì</button>
          </div>
        </div>

        <!-- Results -->
        <p id="mobile-results-count" style="color: #9ca3af; font-size: 14px; margin-bottom: 12px;">0 gevonden</p>
        <div id="mobile-search-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <!-- Cards here -->
        </div>
      </div>

      <!-- ===================== DESKTOP 3-COLUMN LAYOUT ===================== -->
      <div id="desktop-search-layout" style="display: ${isDesktop ? 'flex' : 'none'}; gap: 24px; align-items: flex-start;">

        <!-- LEFT COLUMN: Filters -->
        <aside style="width: 220px; flex-shrink: 0;">
          <h1 style="font-size: 28px; font-weight: 700; color: #1a1a2e; margin-bottom: 24px;">Zoeken</h1>

          <div style="background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(128, 90, 213, 0.08); border: 1px solid rgba(128, 90, 213, 0.1);">

            <!-- Keywords (moved to top) -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: 14px; font-weight: 600; color: #1a1a2e; display: block; margin-bottom: 8px;">Keywords</label>
              <input id="desktop-input-keywords" type="text" placeholder="bijv. slam, poetry, rap..."
                     style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e9e3f5; font-size: 14px; outline: none; box-sizing: border-box;">
            </div>

            <hr style="border: none; border-top: 1px solid #e9e3f5; margin: 20px 0;">

            <!-- Name Search -->
            <div style="margin-bottom: 16px;">
              <input id="desktop-input-name" type="text" placeholder="Zoek op naam..."
                     style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e9e3f5; font-size: 14px; outline: none; box-sizing: border-box;">
            </div>

            <!-- Location Search -->
            <div style="margin-bottom: 20px;">
              <input id="desktop-input-location" type="text" placeholder="Locatie..."
                     style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e9e3f5; font-size: 14px; outline: none; box-sizing: border-box;">
            </div>

            <!-- ===== DESKTOP COLLAPSIBLE FILTERS ===== -->

            <!-- GENRE FILTER -->
            <div style="background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <button data-action="toggle-filter" data-target="desktop-genre"
                      style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: none; border: none; cursor: pointer;">
                <span style="font-size: 14px; font-weight: 600; color: #1a1a2e;">Genre</span>
                <svg id="chevron-desktop-genre" style="width: 18px; height: 18px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="filter-desktop-genre" style="display: none; padding: 0 16px 16px 16px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="performance-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Performance Poetry</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="slam-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Slam Poetry</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="hip-hop-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Hip Hop Poetry</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="storytelling" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Storytelling</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="experimental" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Experimental</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="musical-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Musical Poetry</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="lyrical" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Lyrical</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-genre" value="political-poetry" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Political Poetry</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- THEMES FILTER -->
            <div style="background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <button data-action="toggle-filter" data-target="desktop-themes"
                      style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: none; border: none; cursor: pointer;">
                <span style="font-size: 14px; font-weight: 600; color: #1a1a2e;">Themes</span>
                <svg id="chevron-desktop-themes" style="width: 18px; height: 18px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="filter-desktop-themes" style="display: none; padding: 0 16px 16px 16px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="identity" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Identity</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="social-justice" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Social Justice</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="mental-health" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Mental Health</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="love-relationships" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Love/Relationships</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="politics" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Politics</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="climate-change" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Climate Change</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-theme" value="coming-of-age" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Coming of Age</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- VIBE FILTER -->
            <div style="background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <button data-action="toggle-filter" data-target="desktop-vibe"
                      style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: none; border: none; cursor: pointer;">
                <span style="font-size: 14px; font-weight: 600; color: #1a1a2e;">Vibe</span>
                <svg id="chevron-desktop-vibe" style="width: 18px; height: 18px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="filter-desktop-vibe" style="display: none; padding: 0 16px 16px 16px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-energy" value="intiem" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Intiem</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-energy" value="interactief" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Interactief</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-energy" value="energiek" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Energiek</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- FORMATS FILTER -->
            <div style="background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <button data-action="toggle-filter" data-target="desktop-formats"
                      style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: none; border: none; cursor: pointer;">
                <span style="font-size: 14px; font-weight: 600; color: #1a1a2e;">Diensten</span>
                <svg id="chevron-desktop-formats" style="width: 18px; height: 18px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="filter-desktop-formats" style="display: none; padding: 0 16px 16px 16px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-format" value="podiumperformance" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Podiumperformance</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-format" value="workshops" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Workshops</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-format" value="hosting" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Hosting / Presentatie</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-format" value="gedichten-op-maat" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Gedichten op Maat</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Desktop Languages Filter -->
            <div style="background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <button data-action="toggle-filter" data-target="desktop-languages"
                      style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: none; border: none; cursor: pointer;">
                <span style="font-size: 14px; font-weight: 600; color: #1a1a2e;">Talen</span>
                <svg id="chevron-desktop-languages" style="width: 18px; height: 18px; color: #9ca3af; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="filter-desktop-languages" style="display: none; padding: 0 16px 16px 16px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-language" value="nl" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Nederlands</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-language" value="en" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Engels</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-language" value="fr" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Frans</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-language" value="de" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Duits</span>
                  </label>
                  <label class="chip-label" style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 9999px; border: 2px solid #d1d5db; background: white; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                    <input type="checkbox" name="desktop-language" value="es" class="chip-input" style="position: absolute; opacity: 0; width: 0; height: 0;">
                    <span class="chip-text" style="color: #374151;">Spaans</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- ===== END DESKTOP FILTERS ===== -->

          </div>
        </aside>

        <!-- MIDDLE COLUMN: Results Grid (3 cols) -->
        <main style="flex: 1; min-width: 0;">
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
            <p id="desktop-results-count" style="color: #9ca3af; font-size: 14px; margin: 0;">0 gevonden</p>
            <div id="desktop-active-filters" style="display: flex; flex-wrap: wrap; gap: 8px;">
              <!-- Active filter tags worden hier geplaatst -->
            </div>
          </div>
          <div id="desktop-search-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <!-- Cards here -->
          </div>
        </main>

        <!-- RIGHT COLUMN: Artist Detail Panel -->
        <aside id="search-detail-panel" style="width: 300px; flex-shrink: 0;">
          <div style="background: white; border-radius: 20px; padding: 28px; box-shadow: 0 4px 20px rgba(128, 90, 213, 0.08); border: 1px solid rgba(128, 90, 213, 0.1); position: sticky; top: 100px;">

            <!-- Empty State -->
            <div id="detail-empty-state" style="text-align: center; padding: 40px 0;">
              <div style="width: 80px; height: 80px; background: #f3e8ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                <svg width="32" height="32" fill="none" stroke="#805ad5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </div>
              <p style="color: #9ca3af; font-size: 14px;">Selecteer een artiest</p>
            </div>

            <!-- Filled State (hidden by default) -->
            <div id="detail-content" style="display: none;">
              <h2 style="font-size: 22px; font-weight: 700; color: #1a1a2e; margin-bottom: 24px;">Profiel</h2>

              <!-- Photo -->
              <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 3px solid #805ad5;">
                  <img id="detail-photo" src="" alt="Artist" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
              </div>

              <!-- Name -->
              <h3 id="detail-name" style="font-size: 20px; font-weight: 600; color: #1a1a2e; text-align: center; margin-bottom: 20px;">Artist Name</h3>

              <!-- Edit Button -->
              <button id="detail-edit-btn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 24px;">
                Edit Profile
              </button>

              <!-- Themes -->
              <div style="margin-bottom: 16px;">
                <h4 style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Themes</h4>
                <div id="detail-themes" style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <span style="color: #9ca3af; font-size: 12px;">-</span>
                </div>
              </div>

              <!-- Vibe -->
              <div style="margin-bottom: 16px;">
                <h4 style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Vibe</h4>
                <div id="detail-vibe" style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <span style="color: #9ca3af; font-size: 12px;">-</span>
                </div>
              </div>

              <!-- Diensten -->
              <div style="margin-bottom: 16px;">
                <h4 style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Diensten</h4>
                <div id="detail-formats" style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <span style="color: #9ca3af; font-size: 12px;">-</span>
                </div>
              </div>

              <!-- Over Mij -->
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 15px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Over Mij</h4>
                <p id="detail-bio" style="font-size: 13px; color: #4a4a68; line-height: 1.7;">Bio komt hier...</p>
              </div>

              <!-- Mijn Werk -->
              <div>
                <h4 style="font-size: 15px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px;">Mijn Werk</h4>
                <p id="detail-work" style="font-size: 13px; color: #4a4a68; line-height: 1.7;">Mijn Werk</p>
              </div>
            </div>
          </div>
        </aside>

      </div>

    </div>
  `;

  // Populate filter checkboxes
  // populateGenreFilters(); // Nu statisch in HTML

  // Setup interactions
  setupSearchInteractions();

  // Load artists
  loadArtists();

  // Handle resize
  window.removeEventListener('resize', handleSearchResize);
  window.addEventListener('resize', handleSearchResize);

  searchSection.dataset.setupComplete = 'false';

  console.log('[RENDER] Search UI rendered, isDesktop:', isDesktop);
}

function handleSearchResize() {
  const isDesktop = window.innerWidth >= 1024;
  const mobileLayout = document.getElementById('mobile-search-layout');
  const desktopLayout = document.getElementById('desktop-search-layout');

  if (mobileLayout) mobileLayout.style.display = isDesktop ? 'none' : 'block';
  if (desktopLayout) desktopLayout.style.display = isDesktop ? 'flex' : 'none';
}

/*
async function populateGenreFilters() {
  try {
    const { collection, getDocs } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');

    const snapshot = await getDocs(collection(db, 'artists'));
    const genres = new Set();
    snapshot.forEach(doc => {
      (doc.data().genres || []).forEach(g => genres.add(g));
    });

    const sorted = Array.from(genres).sort();

    // Desktop genre checkboxes only (mobile now has static chips)
    const desktopGenres = document.getElementById('desktop-genre-checkboxes');
    if (desktopGenres) {
      desktopGenres.innerHTML = sorted.map(g => `
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" name="desktop-genre" value="${g}"
                 style="width: 18px; height: 18px; accent-color: #805ad5; cursor: pointer;">
          <span style="font-size: 14px; color: #4a4a68;">${g}</span>
        </label>
      `).join('');
    }

    console.log('[FILTERS] Populated', sorted.length, 'desktop genres');
  } catch (err) {
    console.error('[FILTERS] Error:', err);
  }
}
*/

/**
 * Populate genre checkboxes in both mobile and desktop
 */
async function populateGenres() {
  try {
    const snapshot = await getDocs(collection(db, 'artists'));
    const genres = new Set();
    snapshot.forEach(doc => {
      (doc.data().genres || []).forEach(g => genres.add(g));
    });

    const sorted = Array.from(genres).sort();

    // Desktop checkboxes
    const desktopContainer = document.getElementById('desktop-genre-checkboxes');
    if (desktopContainer) {
      desktopContainer.innerHTML = sorted.map(g => `
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="desktop-genre" value="${g}"
                 style="width: 16px; height: 16px; accent-color: #805ad5; cursor: pointer;">
          <span style="font-size: 13px; color: #4a4a68;">${g}</span>
        </label>
      `).join('');
    }

    // Mobile checkboxes
    const mobileContainer = document.getElementById('mobile-genre-checkboxes');
    if (mobileContainer) {
      mobileContainer.innerHTML = sorted.map(g => `
        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer">
          <input type="checkbox" name="mobile-genre" value="${g}" class="w-5 h-5 rounded text-purple-600">
          <span class="text-gray-900">${g}</span>
        </label>
      `).join('');
    }
  } catch (err) {
    console.error('[GENRES] Error:', err);
  }
}

/**
 * Render active filter tags on desktop
 */
function renderActiveFilters() {
  const container = document.getElementById('desktop-active-filters');
  if (!container) return;

  const activeFilters = [];

  // Collect all checked filters
  const filterTypes = [
    { name: 'desktop-genre', label: 'Genre' },
    { name: 'desktop-theme', label: 'Theme' },
    { name: 'desktop-energy', label: 'Vibe' },
    { name: 'desktop-format', label: 'Dienst' },
    { name: 'desktop-language', label: 'Taal' }
  ];

  filterTypes.forEach(type => {
    document.querySelectorAll(`input[name="${type.name}"]:checked`).forEach(checkbox => {
      activeFilters.push({
        name: type.name,
        value: checkbox.value,
        label: checkbox.closest('.chip-label')?.querySelector('.chip-text')?.textContent || checkbox.value
      });
    });
  });

  // Render tags
  if (activeFilters.length === 0) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = activeFilters.map(filter => `
    <button
      data-action="remove-filter"
      data-filter-name="${filter.name}"
      data-filter-value="${filter.value}"
      style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: #7c3aed; color: white; border: none; border-radius: 9999px; font-size: 12px; font-weight: 500; cursor: pointer; transition: background 0.2s;"
      onmouseover="this.style.background='#6d28d9'"
      onmouseout="this.style.background='#7c3aed'"
    >
      ${filter.label}
      <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  `).join('');
}

/**
 * Setup search interactions for responsive layout
 */
function setupSearchInteractions() {
  const root = document.getElementById('search-module-root');
  if (!root) return;

  // Mobile: Toggle filter panels
  root.addEventListener('click', (e) => {
    // Toggle filter button
    const toggleBtn = e.target.closest('[data-action="toggle-filter"]');
    if (toggleBtn) {
      const target = toggleBtn.dataset.target;
      const panel = document.getElementById(`filter-${target}`);
      const chevron = document.getElementById(`chevron-${target}`);

      if (panel) {
        const isOpen = panel.style.display !== 'none';

        // Toggle panel
        panel.style.display = isOpen ? 'none' : 'block';

        // Rotate chevron
        if (chevron) {
          chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      }
      return;
    }

    // Chip click handler
    const chipLabel = e.target.closest('.chip-label');
    if (chipLabel) {
      const checkbox = chipLabel.querySelector('.chip-input');
      if (checkbox) {
        // Toggle checkbox
        checkbox.checked = !checkbox.checked;

        // Update styling
        if (checkbox.checked) {
          chipLabel.style.backgroundColor = '#7c3aed';
          chipLabel.style.borderColor = '#7c3aed';
          chipLabel.querySelector('.chip-text').style.color = 'white';
        } else {
          chipLabel.style.backgroundColor = 'white';
          chipLabel.style.borderColor = '#d1d5db';
          chipLabel.querySelector('.chip-text').style.color = '#374151';
        }

        // Update active filters display
        renderActiveFilters();

        // Reload artists
        loadArtists();
      }
      return;
    }

    // Remove filter tag click
    const removeFilterBtn = e.target.closest('[data-action="remove-filter"]');
    if (removeFilterBtn) {
      const filterName = removeFilterBtn.dataset.filterName;
      const filterValue = removeFilterBtn.dataset.filterValue;

      // Find and uncheck the corresponding checkbox
      const checkbox = document.querySelector(`input[name="${filterName}"][value="${filterValue}"]`);
      if (checkbox) {
        checkbox.checked = false;

        // Update chip styling
        const chipLabel = checkbox.closest('.chip-label');
        if (chipLabel) {
          chipLabel.style.backgroundColor = 'white';
          chipLabel.style.borderColor = '#d1d5db';
          const chipText = chipLabel.querySelector('.chip-text');
          if (chipText) chipText.style.color = '#374151';
        }
      }

      // Re-render active filters and reload artists
      renderActiveFilters();
      loadArtists();
      return;
    }

    // Apply filter button
    const applyBtn = e.target.closest('[data-action="apply-filter"]');
    if (applyBtn) {
      const target = applyBtn.dataset.target;
      const panel = document.getElementById(`filter-${target}`);
      if (panel) panel.style.display = 'none';
      loadArtists();
      return;
    }

    // Artist card click
    const card = e.target.closest('[data-artist-id]');
    if (card) {
      const artistId = card.dataset.artistId;
      console.log('[SEARCH] Card clicked:', artistId);

      // Desktop: show in detail panel
      const detailPanel = document.getElementById('search-detail-panel');
      const isDesktop = window.innerWidth >= 1024;

      if (detailPanel && isDesktop) {
        import('./search-data.js').then(dataModule => {
          dataModule.fetchArtistById(artistId).then(artist => {
            if (artist) {
              showArtistInDetailPanel(artist);
            }
          });
        });
      } else {
        // Mobile: navigate to full page
        showArtistDetail(artistId);
      }
      return;
    }
  });

  // Desktop: Apply filters button
  const applyFiltersBtn = document.getElementById('apply-filters-btn');
  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener('click', () => {
      loadArtists();
    });
  }

  // Desktop: Input changes - debounced
  root.addEventListener('input', (e) => {
    if (e.target.matches('#desktop-input-name, #desktop-input-location, #desktop-input-keywords')) {
      clearTimeout(window.searchDebounce);
      window.searchDebounce = setTimeout(() => loadArtists(), 500);
    }
  });

  // Desktop: Checkbox changes - immediate
  root.addEventListener('change', (e) => {
    // Handle chip selection visual feedback
    if (e.target.matches('.chip-input')) {
      const label = e.target.closest('.chip-label');
      if (label) {
        if (e.target.checked) {
          label.style.backgroundColor = '#7c3aed';
          label.style.borderColor = '#7c3aed';
          const chipText = label.querySelector('.chip-text');
          if (chipText) chipText.style.color = 'white';
        } else {
          label.style.backgroundColor = 'white';
          label.style.borderColor = '#d1d5db';
          const chipText = label.querySelector('.chip-text');
          if (chipText) chipText.style.color = '#374151';
        }
      }
      // Trigger search update
      loadArtists();
    } else if (e.target.matches('[name="desktop-genre"], [name="mobile-genre"]')) {
      loadArtists();
    }
  });

  console.log('[SETUP] Interactions ready');
}

/**
 * Load artists with filters from both mobile and desktop
 */
async function loadArtists() {
  const desktopGrid = document.getElementById('desktop-search-grid');
  const mobileGrid = document.getElementById('mobile-search-grid');
  const desktopCount = document.getElementById('desktop-results-count');
  const mobileCount = document.getElementById('mobile-results-count');

  // Show loading
  if (desktopGrid) desktopGrid.style.opacity = '0.5';
  if (mobileGrid) mobileGrid.style.opacity = '0.5';

  try {
    // Collect filters from both mobile and desktop
    const nameFilter = (
      document.getElementById('desktop-input-name')?.value ||
      document.getElementById('mobile-input-name')?.value || ''
    ).toLowerCase().trim();

    const locationFilter = (
      document.getElementById('desktop-input-location')?.value ||
      document.getElementById('mobile-input-location')?.value || ''
    ).toLowerCase().trim();

    const genreCheckboxes = document.querySelectorAll(
      'input[name="desktop-genre"]:checked, input[name="mobile-genre"]:checked'
    );
    // Normalize genres same way as search-data.js: trim, lowercase, replace spaces with dashes
    const genreFilters = Array.from(genreCheckboxes).map(cb =>
      cb.value.trim().toLowerCase().replace(/\s+/g, '-')
    );

    const themeCheckboxes = document.querySelectorAll('input[name="mobile-theme"]:checked, input[name="desktop-theme"]:checked');
    const themeFilters = Array.from(themeCheckboxes).map(cb =>
      cb.value.trim().toLowerCase().replace(/\s+/g, '-')
    );

    const energyCheckboxes = document.querySelectorAll('input[name="mobile-energy"]:checked, input[name="desktop-energy"]:checked');
    const energyFilters = Array.from(energyCheckboxes).map(cb =>
      cb.value.trim().toLowerCase()
    );

    const formatCheckboxes = document.querySelectorAll('input[name="mobile-format"]:checked, input[name="desktop-format"]:checked');
    const formatFilters = Array.from(formatCheckboxes).map(cb =>
      cb.value.trim().toLowerCase().replace(/\s+/g, '-')
    );

    // Language filters
    const languageFilters = Array.from(
      document.querySelectorAll('input[name="desktop-language"]:checked, input[name="mobile-language"]:checked')
    ).map(cb => cb.value.toLowerCase().trim());

    console.log('[FILTERS] Languages:', languageFilters);

    const keywordsFilter = (
      document.getElementById('desktop-input-keywords')?.value ||
      document.getElementById('mobile-input-keywords')?.value || ''
    ).toLowerCase().trim();

    console.log('[SEARCH UI] Filters collected:', { nameFilter, locationFilter, genreFilters, themeFilters, energyFilters, formatFilters, languageFilters, keywordsFilter });

    // Load and filter
    const artists = await loadArtistsData({ nameFilter, locationFilter, genreFilters, themeFilters, energyFilters, formatFilters, languageFilters, keywordsFilter });

    // Update counts
    const countText = `${artists.length} gevonden`;
    if (desktopCount) desktopCount.textContent = countText;
    if (mobileCount) mobileCount.textContent = countText;

    // Render to both grids
    renderArtists(artists);

  } catch (error) {
    console.error('Error loading artists:', error);
  } finally {
    if (desktopGrid) desktopGrid.style.opacity = '1';
    if (mobileGrid) mobileGrid.style.opacity = '1';
  }
}

/**
 * Render artists to both mobile and desktop grids
 */
export function renderArtists(artists) {
  const desktopGrid = document.getElementById('desktop-search-grid');
  const mobileGrid = document.getElementById('mobile-search-grid');
  const desktopCount = document.getElementById('desktop-results-count');
  const mobileCount = document.getElementById('mobile-results-count');

  const countText = `${artists.length} gevonden`;
  if (desktopCount) desktopCount.textContent = countText;
  if (mobileCount) mobileCount.textContent = countText;

  // Generate desktop card HTML
  const desktopCardHTML = (artist) => {
    const pic = artist.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(artist.stageName || 'A')}&background=e0e7ff&color=6366f1&size=150`;
    const name = artist.stageName || `${artist.firstName || ''} ${artist.lastName || ''}`.trim() || 'Unknown';
    const genres = artist.genres || [];

    // Render genre badges
    const genreBadges = genres.length > 0
      ? genres.map(g => `<span style="display: inline-block; padding: 2px 8px; background: #f3e8ff; color: #7c3aed; border-radius: 10px; font-size: 10px; font-weight: 500;">${formatGenreName(g)}</span>`).join('')
      : '';

    return `
      <div class="artist-card" data-artist-id="${artist.id}"
           style="background: white; border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s, box-shadow 0.2s; box-shadow: 0 2px 12px rgba(128,90,213,0.06);">
        <div style="width: 80px; height: 80px; margin: 0 auto 12px; border-radius: 50%; overflow: hidden; border: 2px solid #e9e3f5; background: #f3e8ff;">
          <img src="${pic}" alt="${name}"
               style="width: 100%; height: 100%; object-fit: cover;"
               onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;color:#805ad5;\\'>${name.charAt(0)}</div>'">
        </div>
        <h3 style="font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</h3>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; min-height: 20px;">
          ${genreBadges || '<span style="color: #d1d5db; font-size: 11px;">-</span>'}
        </div>
      </div>
    `;
  };

  // Generate mobile card HTML
  const mobileCardHTML = (artist) => {
    const pic = artist.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(artist.stageName || 'A')}&background=e0e7ff&color=6366f1&size=150`;
    const name = artist.stageName || `${artist.firstName || ''} ${artist.lastName || ''}`.trim() || 'Unknown';
    const genre = (artist.genres || [])[0] || '';

    return `
      <div data-artist-id="${artist.id}" style="text-align: center; cursor: pointer;">
        <div style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 2px solid #e9e3f5; background: #f3e8ff;">
          <img src="${pic}" alt="${name}"
               style="width: 100%; height: 100%; object-fit: cover;"
               onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;color:#805ad5;\\'>${name.charAt(0)}</div>'">
        </div>
        <h3 style="font-size: 13px; font-weight: 600; color: #1a1a2e; margin-top: 10px;">${name}</h3>
        ${genre ? `<p style="font-size: 11px; color: #9ca3af;">${genre}</p>` : ''}
      </div>
    `;
  };

  // Render desktop grid
  if (desktopGrid) {
    desktopGrid.innerHTML = artists.length > 0
      ? artists.map(desktopCardHTML).join('')
      : '<p style="grid-column: span 3; text-align: center; color: #9ca3af; padding: 60px 0;">Geen artiesten gevonden</p>';
  }

  // Render mobile grid
  if (mobileGrid) {
    mobileGrid.innerHTML = artists.length > 0
      ? artists.map(mobileCardHTML).join('')
      : '<p style="grid-column: span 2; text-align: center; color: #9ca3af; padding: 40px 0;">Geen artiesten gevonden</p>';
  }

  console.log('[RENDER] Rendered', artists.length, 'artists');
}

/**
 * Show artist in detail panel (desktop 3-column layout)
 */
export function showArtistInDetailPanel(artist) {
  const emptyState = document.getElementById('detail-empty-state');
  const detailContent = document.getElementById('detail-content');

  if (!emptyState || !detailContent) return;

  emptyState.style.display = 'none';
  detailContent.style.display = 'block';

  const photo = document.getElementById('detail-photo');
  const name = document.getElementById('detail-name');
  const bio = document.getElementById('detail-bio');
  const work = document.getElementById('detail-work');
  const editBtn = document.getElementById('detail-edit-btn');

  const artistName = artist.stageName || `${artist.firstName || ''} ${artist.lastName || ''}`.trim() || 'Unknown';
  const pic = artist.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(artistName)}&background=e0e7ff&color=6366f1&size=150`;

  if (photo) photo.src = pic;
  if (name) name.textContent = artistName;

  // Render new profile fields
  const detailThemes = document.getElementById('detail-themes');
  const detailVibe = document.getElementById('detail-vibe');
  const detailFormats = document.getElementById('detail-formats');

  if (detailThemes) {
    const themes = artist.themes || [];
    detailThemes.innerHTML = themes.length > 0
      ? themes.map(t => `<span style="padding: 4px 10px; background: #f3e8ff; color: #7c3aed; border-radius: 12px; font-size: 12px; font-weight: 500;">${formatGenreName(t)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 12px;">-</span>';
  }

  if (detailVibe) {
    const vibe = artist.energyLevels || [];
    detailVibe.innerHTML = vibe.length > 0
      ? vibe.map(v => `<span style="padding: 4px 10px; background: #fef3c7; color: #d97706; border-radius: 12px; font-size: 12px; font-weight: 500;">${formatGenreName(v)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 12px;">-</span>';
  }

  if (detailFormats) {
    const formats = artist.formats || [];
    detailFormats.innerHTML = formats.length > 0
      ? formats.map(f => `<span style="padding: 4px 10px; background: #d1fae5; color: #059669; border-radius: 12px; font-size: 12px; font-weight: 500;">${formatGenreName(f)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 12px;">-</span>';
  }

  if (bio) bio.textContent = artist.bio || artist.pitch || 'Geen bio beschikbaar.';
  if (work) work.textContent = artist.work || 'Geen werk beschikbaar.';

  if (editBtn) {
    editBtn.textContent = 'Bekijk Profiel';
    editBtn.onclick = () => {
      import('./search-controller.js').then(m => m.showArtistDetail(artist.id));
    };
  }

  // Highlight selected card
  document.querySelectorAll('.artist-card').forEach(card => {
    card.style.borderColor = card.dataset.artistId === artist.id ? '#805ad5' : 'transparent';
    card.style.boxShadow = card.dataset.artistId === artist.id
      ? '0 4px 20px rgba(128,90,213,0.2)'
      : '0 2px 12px rgba(128,90,213,0.06)';
  });
}

/**
 * Populate artist detail view with artist data
 */
export function populateArtistDetail(artist) {
  if (!artist) {
    console.error('[DETAIL] No artist data provided');
    return;
  }

  console.log('[DETAIL] Populating artist:', artist.stageName || artist.id);

  const artistName = artist.stageName || `${artist.firstName || ''} ${artist.lastName || ''}`.trim() || 'Unknown Artist';
  const profilePicUrl = artist.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(artistName)}&background=f3f4f6&color=1a1a2e&size=140`;
  const age = artist.dob ? calculateAge(artist.dob) : null;
  const genderMap = { 'f': 'Female', 'm': 'Male', 'x': 'Other' };
  const genderText = genderMap[artist.gender] || artist.gender || 'Not specified';

  // ========== DESKTOP ELEMENTS ==========

  const detailProfilePic = document.getElementById('detail-profile-pic');
  if (detailProfilePic) detailProfilePic.src = profilePicUrl;

  const detailArtistName = document.getElementById('detail-artist-name');
  if (detailArtistName) detailArtistName.textContent = artistName;

  const detailAge = document.getElementById('detail-age');
  if (detailAge) detailAge.textContent = age ? `${age} years old` : 'Age unknown';

  const detailGender = document.getElementById('detail-gender');
  if (detailGender) detailGender.textContent = genderText;

  const detailLocation = document.getElementById('detail-location');
  if (detailLocation) detailLocation.textContent = artist.location || 'Location unknown';

  const detailGenres = document.getElementById('detail-genres');
  if (detailGenres) {
    const genres = artist.genres || [];
    detailGenres.innerHTML = genres.length > 0
      ? genres.map(g => `<span style="padding: 6px 14px; background: #f3e8ff; color: #805ad5; border-radius: 20px; font-size: 13px; font-weight: 500;">${formatGenreName(g)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 13px;">No genres specified</span>';
  }

  const detailLanguages = document.getElementById('detail-languages');
  if (detailLanguages) {
    const languages = artist.languages || [];
    detailLanguages.innerHTML = languages.length > 0
      ? languages.map(l => `<span style="padding: 6px 12px; background: #805ad5; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${(l || '').substring(0,2).toUpperCase()}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 13px;">No languages specified</span>';
  }

  // Themes
  const detailThemesContainer = document.getElementById('detail-themes-full');
  if (detailThemesContainer) {
    const themes = artist.themes || [];
    detailThemesContainer.innerHTML = themes.length > 0
      ? themes.map(t => `<span style="padding: 6px 14px; background: #f3e8ff; color: #7c3aed; border-radius: 20px; font-size: 13px; font-weight: 500;">${formatGenreName(t)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen themes</span>';
  }

  // Vibe
  const detailVibeContainer = document.getElementById('detail-vibe-full');
  if (detailVibeContainer) {
    const vibe = artist.energyLevels || [];
    detailVibeContainer.innerHTML = vibe.length > 0
      ? vibe.map(v => `<span style="padding: 6px 14px; background: #fef3c7; color: #d97706; border-radius: 20px; font-size: 13px; font-weight: 500;">${formatGenreName(v)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen vibe</span>';
  }

  // Formats
  const detailFormatsContainer = document.getElementById('detail-formats-full');
  if (detailFormatsContainer) {
    const formats = artist.formats || [];
    detailFormatsContainer.innerHTML = formats.length > 0
      ? formats.map(f => `<span style="padding: 6px 14px; background: #d1fae5; color: #059669; border-radius: 20px; font-size: 13px; font-weight: 500;">${formatGenreName(f)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen diensten</span>';
  }

  const detailBio = document.getElementById('detail-bio');
  if (detailBio) detailBio.textContent = artist.bio || 'No biography available.';

  const detailPitch = document.getElementById('detail-pitch');
  if (detailPitch) detailPitch.textContent = artist.pitch || 'No pitch available.';

  const detailEmailContainer = document.getElementById('detail-email-container');
  const detailEmail = document.getElementById('detail-email');
  if (detailEmail && artist.email) {
    detailEmail.textContent = artist.email;
    detailEmail.href = `mailto:${artist.email}`;
    if (detailEmailContainer) detailEmailContainer.style.display = 'flex';
  } else if (detailEmailContainer) {
    detailEmailContainer.style.display = 'none';
  }

  const detailPhoneContainer = document.getElementById('detail-phone-container');
  const detailPhone = document.getElementById('detail-phone');
  if (detailPhone && artist.phone) {
    detailPhone.textContent = artist.phone;
    if (detailPhoneContainer) detailPhoneContainer.style.display = 'flex';
  } else if (detailPhoneContainer) {
    detailPhoneContainer.style.display = 'none';
  }

  const chatHeader = document.getElementById('chat-header-name');
  if (chatHeader) chatHeader.textContent = `Chat met ${artistName}`;

  // Media Gallery
  const galleryEl = document.getElementById('detail-media-gallery');
  if (galleryEl) {
    const mediaItems = [];

    if (artist.galleryPhotos && artist.galleryPhotos.length > 0) {
      artist.galleryPhotos.forEach((photo) => {
        mediaItems.push(`
          <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
            <img src="${photo}" alt="Gallery photo" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
        `);
      });
    }

    if (mediaItems.length === 0 && artist.profilePicUrl) {
      mediaItems.push(`
        <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
          <img src="${artist.profilePicUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      `);
    }

    if (artist.youtubeVideos && artist.youtubeVideos.length > 0) {
      artist.youtubeVideos.forEach((video) => {
        const videoId = video.videoId || (video.url ? video.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/)?.[1] : null);
        if (videoId) {
          mediaItems.push(`
            <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative;">
              <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="Video" style="width: 100%; height: 100%; object-fit: cover;">
              <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3);">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <svg width="20" height="20" fill="#805ad5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
              </div>
            </div>
          `);
        }
      });
    }

    galleryEl.innerHTML = mediaItems.length > 0
      ? mediaItems.join('')
      : '<div style="grid-column: span 2; aspect-ratio: 16/9; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><span style="color: #9ca3af; font-size: 14px;">Geen media beschikbaar</span></div>';
  }

  // ========== MOBILE ELEMENTS ==========

  const mobilePhoto = document.getElementById('mobile-detail-photo');
  if (mobilePhoto) mobilePhoto.src = profilePicUrl;

  const mobileName = document.getElementById('mobile-detail-name');
  if (mobileName) mobileName.textContent = artistName;

  const mobileAge = document.getElementById('mobile-detail-age');
  if (mobileAge) mobileAge.textContent = age ? `${age} years old` : 'Age unknown';

  const mobileGender = document.getElementById('mobile-detail-gender');
  if (mobileGender) mobileGender.textContent = genderText;

  const mobileLocation = document.getElementById('mobile-detail-location');
  if (mobileLocation) mobileLocation.textContent = artist.location || 'Location unknown';

  const mobileGenres = document.getElementById('mobile-detail-genres');
  if (mobileGenres) {
    const genres = artist.genres || [];
    mobileGenres.innerHTML = genres.length > 0
      ? genres.map(g => `<span style="padding: 8px 16px; background: white; border: 1px solid #1a1a2e; border-radius: 20px; font-size: 14px; color: #1a1a2e;">${formatGenreName(g)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">No genres specified</span>';
  }

  const mobileLanguages = document.getElementById('mobile-detail-languages');
  if (mobileLanguages) {
    const languages = artist.languages || [];
    mobileLanguages.innerHTML = languages.length > 0
      ? languages.map(l => `<span style="padding: 6px 12px; background: white; border: 1px solid #1a1a2e; border-radius: 20px; font-size: 13px; font-weight: 600; color: #1a1a2e;">${(l || '').substring(0,2).toUpperCase()}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">No languages specified</span>';
  }

  // Mobile Themes
  const mobileThemesContainer = document.getElementById('mobile-detail-themes-full');
  if (mobileThemesContainer) {
    const themes = artist.themes || [];
    mobileThemesContainer.innerHTML = themes.length > 0
      ? themes.map(t => `<span style="padding: 8px 16px; background: white; border: 1px solid #7c3aed; border-radius: 20px; font-size: 14px; color: #7c3aed;">${formatGenreName(t)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen themes</span>';
  }

  // Mobile Vibe
  const mobileVibeContainer = document.getElementById('mobile-detail-vibe-full');
  if (mobileVibeContainer) {
    const vibe = artist.energyLevels || [];
    mobileVibeContainer.innerHTML = vibe.length > 0
      ? vibe.map(v => `<span style="padding: 8px 16px; background: white; border: 1px solid #d97706; border-radius: 20px; font-size: 14px; color: #d97706;">${formatGenreName(v)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen vibe</span>';
  }

  // Mobile Formats
  const mobileFormatsContainer = document.getElementById('mobile-detail-formats-full');
  if (mobileFormatsContainer) {
    const formats = artist.formats || [];
    mobileFormatsContainer.innerHTML = formats.length > 0
      ? formats.map(f => `<span style="padding: 8px 16px; background: white; border: 1px solid #059669; border-radius: 20px; font-size: 14px; color: #059669;">${formatGenreName(f)}</span>`).join('')
      : '<span style="color: #9ca3af; font-size: 14px;">Geen diensten</span>';
  }

  const mobileBio = document.getElementById('mobile-detail-bio');
  if (mobileBio) mobileBio.textContent = artist.bio || 'No biography available.';

  const mobilePitch = document.getElementById('mobile-detail-pitch');
  if (mobilePitch) mobilePitch.textContent = artist.pitch || 'No pitch available.';

  const mobileEmailContainer = document.getElementById('mobile-detail-email-container');
  const mobileEmail = document.getElementById('mobile-detail-email');
  if (mobileEmail && artist.email) {
    mobileEmail.textContent = artist.email;
    mobileEmail.href = `mailto:${artist.email}`;
    if (mobileEmailContainer) mobileEmailContainer.style.display = 'flex';
  } else if (mobileEmailContainer) {
    mobileEmailContainer.style.display = 'none';
  }

  const mobilePhoneContainer = document.getElementById('mobile-detail-phone-container');
  const mobilePhone = document.getElementById('mobile-detail-phone');
  if (mobilePhone && artist.phone) {
    mobilePhone.textContent = artist.phone;
    if (mobilePhoneContainer) mobilePhoneContainer.style.display = 'flex';
  } else if (mobilePhoneContainer) {
    mobilePhoneContainer.style.display = 'none';
  }

  // ========== ROLE-BASED VISIBILITY ==========
  const isUserProgrammer = isProgrammer();
  console.log('[DETAIL VIEW] User is programmer:', isUserProgrammer);

  // === DESKTOP ELEMENTS ===
  // Hide/show email
  if (detailEmailContainer) {
    detailEmailContainer.style.display = isUserProgrammer && artist.email ? 'flex' : 'none';
  }

  // Hide/show phone
  if (detailPhoneContainer) {
    detailPhoneContainer.style.display = isUserProgrammer && artist.phone ? 'flex' : 'none';
  }

  // Hide/show Contact Information section (desktop)
  // Find the parent section and hide if not programmer
  const contactSection = detailEmailContainer?.closest('div[style*="border-bottom"]');
  if (contactSection && !isUserProgrammer) {
    contactSection.style.display = 'none';
  }

  // Hide/show chat panel (desktop - right column)
  const chatPanel = document.querySelector('#desktop-artist-detail aside:last-child');
  if (chatPanel) {
    chatPanel.style.display = isUserProgrammer ? 'block' : 'none';
  }

  // === MOBILE ELEMENTS ===
  // Hide/show email
  if (mobileEmailContainer) {
    mobileEmailContainer.style.display = isUserProgrammer && artist.email ? 'flex' : 'none';
  }

  // Hide/show phone
  if (mobilePhoneContainer) {
    mobilePhoneContainer.style.display = isUserProgrammer && artist.phone ? 'flex' : 'none';
  }

  // Hide/show Send Message button (mobile)
  const mobileSendMessageBtn = document.getElementById('mobile-send-message-btn');
  if (mobileSendMessageBtn) {
    mobileSendMessageBtn.style.display = isUserProgrammer ? 'flex' : 'none';
  }

  // Hide/show Contact Information section header (mobile)
  const mobileContactHeader = mobileEmailContainer?.parentElement?.previousElementSibling;
  if (mobileContactHeader && mobileContactHeader.tagName === 'H2' && mobileContactHeader.textContent.includes('Contact')) {
    mobileContactHeader.style.display = isUserProgrammer ? 'block' : 'none';
  }

  // Also hide the contact info container div for artists
  const mobileContactContainer = mobileEmailContainer?.parentElement;
  if (mobileContactContainer && !isUserProgrammer) {
    mobileContactContainer.style.display = 'none';
  }

  // ========== BUTTON HANDLERS ==========

  // Mobile Send Message - only for programmers
  if (mobileSendMessageBtn && isUserProgrammer) {
    mobileSendMessageBtn.onclick = () => {
      import('../messaging/messaging-controller.js').then(module => {
        if (module.openMessageModal) module.openMessageModal(artist);
      }).catch(err => console.error('[MESSAGE] Error:', err));
    };
  }

  // Write Recommendation button - only for programmers
  const mobileWriteRecBtn = document.getElementById('mobile-write-recommendation-btn');
  if (mobileWriteRecBtn) {
    if (isUserProgrammer) {
      mobileWriteRecBtn.style.display = 'block';
      mobileWriteRecBtn.onclick = () => alert('Schrijf recommendation functie komt binnenkort.');
    } else {
      mobileWriteRecBtn.style.display = 'none';
    }
  }

  const writeRecBtn = document.getElementById('write-recommendation-btn');
  if (writeRecBtn) {
    if (isUserProgrammer) {
      writeRecBtn.style.display = 'inline-block';
      writeRecBtn.onclick = () => alert('Schrijf recommendation functie komt binnenkort.');
    } else {
      writeRecBtn.style.display = 'none';
    }
  }

  const viewRecsBtn = document.getElementById('view-recommendations-btn');
  if (viewRecsBtn) {
    viewRecsBtn.onclick = () => alert('View recommendations functie komt binnenkort.');
  }

  // ========== FORCE RESPONSIVE LAYOUT ==========
  const isDesktop = window.innerWidth >= 1024;
  const mobileLayout = document.getElementById('mobile-artist-detail');
  const desktopLayout = document.getElementById('desktop-artist-detail');

  console.log('[DETAIL] Layout switch - isDesktop:', isDesktop);
  console.log('[DETAIL] Mobile element:', mobileLayout);
  console.log('[DETAIL] Desktop element:', desktopLayout);

  if (mobileLayout) {
    mobileLayout.style.display = isDesktop ? 'none' : 'block';
    console.log('[DETAIL] Mobile display set to:', mobileLayout.style.display);
  }

  if (desktopLayout) {
    // Remove hidden class and force display
    desktopLayout.classList.remove('hidden');
    desktopLayout.style.display = isDesktop ? 'grid' : 'none';
    console.log('[DETAIL] Desktop display set to:', desktopLayout.style.display);
  }

  // Resize listener
  const handleResize = () => {
    const nowDesktop = window.innerWidth >= 1024;
    if (mobileLayout) mobileLayout.style.display = nowDesktop ? 'none' : 'block';
    if (desktopLayout) {
      desktopLayout.classList.remove('hidden');
      desktopLayout.style.display = nowDesktop ? 'grid' : 'none';
    }
  };
  window.removeEventListener('resize', handleResize);
  window.addEventListener('resize', handleResize);

  console.log('[DETAIL] Artist detail populated successfully');
}

function populateMediaGallery(artist) {
  const galleryEl = document.getElementById('detail-media-gallery');
  if (!galleryEl) return;

  const mediaItems = [];

  // Add photos from gallery
  if (artist.galleryPhotos && artist.galleryPhotos.length > 0) {
    artist.galleryPhotos.forEach((photo, index) => {
      mediaItems.push(`
        <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer;">
          <img src="${photo}" alt="Gallery photo" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      `);
    });
  }

  // Add profile pic if no gallery photos
  if (mediaItems.length === 0 && artist.profilePicUrl) {
    mediaItems.push(`
      <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden;">
        <img src="${artist.profilePicUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    `);
  }

  // Add YouTube videos
  if (artist.youtubeVideos && artist.youtubeVideos.length > 0) {
    artist.youtubeVideos.forEach((video) => {
      const videoId = video.videoId || extractYouTubeId(video.url || video);
      if (videoId) {
        mediaItems.push(`
          <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; position: relative;">
            <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="Video thumbnail" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3);">
              <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="#805ad5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>
          </div>
        `);
      }
    });
  }

  // Render gallery
  if (mediaItems.length > 0) {
    galleryEl.innerHTML = mediaItems.join('');
  } else {
    galleryEl.innerHTML = `
      <div style="grid-column: span 2; aspect-ratio: 16/9; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
        <span style="color: #9ca3af; font-size: 14px;">Geen media beschikbaar</span>
      </div>
    `;
  }
}

function extractYouTubeId(url) {
  if (!url) return null;
  const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
  return match ? match[1] : null;
}

/**
 * Populate mobile recommendations
 */
async function populateMobileRecommendations(artist) {
  const container = document.getElementById('mobile-detail-recommendations');
  if (!container || !artist) return;

  try {
    const { collection, query, where, orderBy, getDocs } = await import('firebase/firestore');
    const { db } = await import('../../services/firebase.js');

    const recsRef = collection(db, 'recommendations');
    const q = query(
      recsRef,
      where('artistId', '==', artist.id),
      orderBy('createdAt', 'desc')
    );

    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      container.innerHTML = '<p style="color: #9ca3af; font-size: 14px; text-align: center; padding: 20px;">Nog geen recommendations.</p>';
      return;
    }

    const currentUser = getStore('currentUser');

    container.innerHTML = '';
    snapshot.forEach(doc => {
      const rec = doc.data();
      const date = rec.createdAt?.toDate?.() || new Date();
      const formattedDate = date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });
      const isOwn = currentUser && rec.authorId === currentUser.uid;

      const card = document.createElement('div');
      card.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; position: relative;';
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
          <div>
            <p style="font-size: 15px; font-weight: 600; color: #1a1a2e;">${rec.authorName || 'Anonymous'}</p>
            <p style="font-size: 13px; color: #9ca3af;">${formattedDate}</p>
          </div>
          ${isOwn ? `
            <button onclick="window.deleteRecommendation && window.deleteRecommendation('${doc.id}')"
                    style="background: none; border: none; cursor: pointer; padding: 4px;">
              <svg width="20" height="20" fill="none" stroke="#9ca3af" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          ` : ''}
        </div>
        <p style="font-size: 14px; color: #4a4a68; line-height: 1.6;">"${rec.text || rec.content || ''}"</p>
      `;
      container.appendChild(card);
    });

    // Expose delete function
    window.deleteRecommendation = async (recId) => {
      if (!confirm('Weet je zeker dat je deze recommendation wilt verwijderen?')) return;
      try {
        const { doc, deleteDoc } = await import('firebase/firestore');
        const { db } = await import('../../services/firebase.js');
        await deleteDoc(doc(db, 'recommendations', recId));
        populateMobileRecommendations(artist);
      } catch (err) {
        console.error('Error deleting recommendation:', err);
        alert('Fout bij verwijderen.');
      }
    };

  } catch (error) {
    console.error('[RECOMMENDATIONS] Error loading:', error);
    container.innerHTML = '<p style="color: #9ca3af; font-size: 14px;">Kon recommendations niet laden.</p>';
  }
}

/**
 * Convert video/audio URL to embed URL
 */
function getEmbedUrl(url, type) {
  if (!url) return null;

  if (type === 'video') {
    // YouTube
    const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
    if (youtubeMatch) {
      return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
    }

    // Vimeo
    const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
    if (vimeoMatch) {
      return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
    }
  }

  if (type === 'audio') {
    // SoundCloud
    if (url.includes('soundcloud.com')) {
      return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
    }

    // Spotify
    const spotifyMatch = url.match(/spotify\.com\/(track|album|playlist)\/([^?]+)/);
    if (spotifyMatch) {
      return `https://open.spotify.com/embed/${spotifyMatch[1]}/${spotifyMatch[2]}`;
    }
  }

  return null;
}
</file>

</files>
